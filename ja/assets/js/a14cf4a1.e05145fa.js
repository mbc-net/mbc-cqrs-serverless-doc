"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[9902],{3132:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"multi-tenant-patterns","title":"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30d1\u30bf\u30fc\u30f3","description":"MBC CQRS Serverless\u3067\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u306e\u30c7\u30fc\u30bf\u5206\u96e2\u3068\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/multi-tenant-patterns.md","sourceDirName":".","slug":"/multi-tenant-patterns","permalink":"/ja/docs/multi-tenant-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"sidebar_position":17,"description":"MBC CQRS Serverless\u3067\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u306e\u30c7\u30fc\u30bf\u5206\u96e2\u3068\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"Service\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3","permalink":"/ja/docs/service-patterns"},"next":{"title":"\u30a4\u30f3\u30dd\u30fc\u30c8/\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3","permalink":"/ja/docs/import-export-patterns"}}');var r=t(4848),a=t(8453);const o={sidebar_position:17,description:"MBC CQRS Serverless\u3067\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u306e\u30c7\u30fc\u30bf\u5206\u96e2\u3068\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},i="\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30d1\u30bf\u30fc\u30f3",d={},c=[{value:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",level:2},{value:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",id:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",level:2},{value:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8",id:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8",level:2},{value:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u62bd\u51fa",id:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u62bd\u51fa",level:3},{value:"\u30c6\u30ca\u30f3\u30c8\u30ac\u30fc\u30c9",id:"\u30c6\u30ca\u30f3\u30c8\u30ac\u30fc\u30c9",level:3},{value:"\u30c7\u30fc\u30bf\u5206\u96e2\u30d1\u30bf\u30fc\u30f3",id:"\u30c7\u30fc\u30bf\u5206\u96e2\u30d1\u30bf\u30fc\u30f3",level:2},{value:"\u30d1\u30bf\u30fc\u30f31: \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b",id:"\u30d1\u30bf\u30fc\u30f31-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b",level:3},{value:"\u30d1\u30bf\u30fc\u30f32: \u5171\u6709\u30c7\u30fc\u30bf\u7528\u306e\u5171\u901a\u30c6\u30ca\u30f3\u30c8",id:"\u30d1\u30bf\u30fc\u30f32-\u5171\u6709\u30c7\u30fc\u30bf\u7528\u306e\u5171\u901a\u30c6\u30ca\u30f3\u30c8",level:3},{value:"\u30d1\u30bf\u30fc\u30f33: \u30e6\u30fc\u30b6\u30fc\u30fb\u30c6\u30ca\u30f3\u30c8\u95a2\u9023\u4ed8\u3051",id:"\u30d1\u30bf\u30fc\u30f33-\u30e6\u30fc\u30b6\u30fc\u30c6\u30ca\u30f3\u30c8\u95a2\u9023\u4ed8\u3051",level:3},{value:"\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c",id:"\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c",level:2},{value:"\u30d1\u30bf\u30fc\u30f31: \u30c6\u30ca\u30f3\u30c8\u9593\u306e\u30c7\u30fc\u30bf\u540c\u671f",id:"\u30d1\u30bf\u30fc\u30f31-\u30c6\u30ca\u30f3\u30c8\u9593\u306e\u30c7\u30fc\u30bf\u540c\u671f",level:3},{value:"\u30d1\u30bf\u30fc\u30f32: \u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u30ec\u30dd\u30fc\u30c8",id:"\u30d1\u30bf\u30fc\u30f32-\u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u30ec\u30dd\u30fc\u30c8",level:3},{value:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a",id:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a",level:2},{value:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u30d1\u30bf\u30fc\u30f3",id:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u30d1\u30bf\u30fc\u30f3",level:3},{value:"Prisma\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30b9\u30ad\u30fc\u30de",id:"prisma\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30b9\u30ad\u30fc\u30de",level:2},{value:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u7528RDS\u30b9\u30ad\u30fc\u30de",id:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u7528rds\u30b9\u30ad\u30fc\u30de",level:3},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"1. \u30af\u30a8\u30ea\u306b\u306f\u5e38\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b",id:"1-\u30af\u30a8\u30ea\u306b\u306f\u5e38\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b",level:3},{value:"2. \u30c6\u30ca\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3",id:"2-\u30c6\u30ca\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3",level:3},{value:"3. \u30c6\u30ca\u30f3\u30c8\u8a8d\u8b58\u30ed\u30ae\u30f3\u30b0",id:"3-\u30c6\u30ca\u30f3\u30c8\u8a8d\u8b58\u30ed\u30ae\u30f3\u30b0",level:3},{value:"4. \u30b7\u30b9\u30c6\u30e0\u64cd\u4f5c\u3068\u30c6\u30ca\u30f3\u30c8\u64cd\u4f5c\u306e\u5206\u96e2",id:"4-\u30b7\u30b9\u30c6\u30e0\u64cd\u4f5c\u3068\u30c6\u30ca\u30f3\u30c8\u64cd\u4f5c\u306e\u5206\u96e2",level:3},{value:"TenantModule API\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9",id:"tenantmodule-api\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9",level:2},{value:"\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",id:"\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",level:3},{value:"\u30e2\u30b8\u30e5\u30fc\u30eb\u767b\u9332",id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u767b\u9332",level:3},{value:"\u30e2\u30b8\u30e5\u30fc\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3",id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"TenantService\u30e1\u30bd\u30c3\u30c9",id:"tenantservice\u30e1\u30bd\u30c3\u30c9",level:3},{value:"<code>getTenant(key: DetailKey): Promise&lt;DataModel&gt;</code>",id:"gettenantkey-detailkey-promisedatamodel",level:4},{value:"<code>createCommonTenant(dto, context): Promise&lt;CommandModel&gt;</code>",id:"createcommontenantdto-context-promisecommandmodel",level:4},{value:"<code>createTenant(dto, context): Promise&lt;CommandModel&gt;</code>",id:"createtenantdto-context-promisecommandmodel",level:4},{value:"<code>updateTenant(key, dto, context): Promise&lt;CommandModel&gt;</code>",id:"updatetenantkey-dto-context-promisecommandmodel",level:4},{value:"<code>deleteTenant(key, context): Promise&lt;CommandModel&gt;</code>",id:"deletetenantkey-context-promisecommandmodel",level:4},{value:"<code>addTenantGroup(dto, context): Promise&lt;CommandModel&gt;</code>",id:"addtenantgroupdto-context-promisecommandmodel",level:4},{value:"<code>createTenantGroup(tenantGroupCode, dto, context): Promise&lt;CommandModel&gt;</code>",id:"createtenantgrouptenantgroupcode-dto-context-promisecommandmodel",level:4},{value:"<code>customizeSettingGroups(dto, context): Promise&lt;CommandModel&gt;</code>",id:"customizesettinggroupsdto-context-promisecommandmodel",level:4},{value:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30d1\u30bf\u30fc\u30f3",children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30d1\u30bf\u30fc\u30f3"})}),"\n",(0,r.jsx)(n.p,{children:"\u3053\u306e\u30ac\u30a4\u30c9\u3067\u306f\u3001\u9069\u5207\u306a\u30c7\u30fc\u30bf\u5206\u96e2\u3001\u5171\u6709\u30ea\u30bd\u30fc\u30b9\u3001\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3092\u5099\u3048\u305f\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",children:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0"}),"\n",(0,r.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u5834\u5408\u306b\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u30c6\u30ca\u30f3\u30c8\uff08\u9867\u5ba2/\u7d44\u7e54\uff09\u9593\u3067\u30c7\u30fc\u30bf\u3092\u5206\u96e2\u3059\u308b"}),"\n",(0,r.jsx)(n.li,{children:"\u3059\u3079\u3066\u306e\u30c6\u30ca\u30f3\u30c8\u3067\u5171\u901a\u30c7\u30fc\u30bf\u3092\u5171\u6709\u3059\u308b"}),"\n",(0,r.jsx)(n.li,{children:"\u30e6\u30fc\u30b6\u30fc\u304c\u8907\u6570\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u6240\u5c5e\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b"}),"\n",(0,r.jsx)(n.li,{children:"\u30c6\u30ca\u30f3\u30c8\u56fa\u6709\u306e\u8a2d\u5b9a\u3092\u5b9f\u88c5\u3059\u308b"}),"\n",(0,r.jsx)(n.li,{children:"\u30c6\u30ca\u30f3\u30c8\u9593\u3067\u30c7\u30fc\u30bf\u3092\u540c\u671f\u3059\u308b"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Application                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                  \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502   \u2502  Tenant A   \u2502   \u2502  Tenant B   \u2502   \u2502   Common    \u2502           \u2502\n\u2502   \u2502  PK: X#A    \u2502   \u2502  PK: X#B    \u2502   \u2502  PK: X#common\u2502          \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502          \u2502                 \u2502                  \u2502                  \u2502\n\u2502          \u25bc                 \u25bc                  \u25bc                  \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502                    DynamoDB Table                        \u2502   \u2502\n\u2502   \u2502  PK: ENTITY#tenantCode  |  SK: identifier                \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8",children:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8"}),"\n",(0,r.jsx)(n.admonition,{title:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u306e\u6b63\u898f\u5316",type:"info",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"getUserContext()"})," \u304c\u8fd4\u3059\u3059\u3079\u3066\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u306f\u5c0f\u6587\u5b57\u306b\u6b63\u898f\u5316\u3055\u308c\u307e\u3059\u3002\u3064\u307e\u308a\u3001",(0,r.jsx)(n.code,{children:"TenantA"}),"\u3001",(0,r.jsx)(n.code,{children:"TENANTA"}),"\u3001",(0,r.jsx)(n.code,{children:"tenanta"})," \u306f\u3059\u3079\u3066 ",(0,r.jsx)(n.code,{children:"tenanta"})," \u3068\u3057\u3066\u6271\u308f\u308c\u307e\u3059\u3002Cognito\u306e\u30ab\u30b9\u30bf\u30e0\u30af\u30ec\u30fc\u30e0\u3084HTTP\u30d8\u30c3\u30c0\u30fc\u3067\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u5b9a\u7fa9\u3059\u308b\u969b\u3001\u5927\u6587\u5b57\u5c0f\u6587\u5b57\u306f\u554f\u3044\u307e\u305b\u3093\u3002\u5185\u90e8\u7684\u306b\u306f\u4e00\u8cab\u3057\u305f\u30de\u30c3\u30c1\u30f3\u30b0\u306e\u305f\u3081\u5e38\u306b\u5c0f\u6587\u5b57\u306b\u306a\u308a\u307e\u3059\u3002"]})}),"\n",(0,r.jsx)(n.h3,{id:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u62bd\u51fa",children:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u62bd\u51fa"}),"\n",(0,r.jsx)(n.p,{children:"\u547c\u3073\u51fa\u3057\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304b\u3089\u30c6\u30ca\u30f3\u30c8\u60c5\u5831\u3092\u62bd\u51fa\u3059\u308b\u30d8\u30eb\u30d1\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// helpers/context.ts\nimport { IInvoke, getUserContext } from '@mbc-cqrs-serverless/core';\n\nexport interface CustomUserContext {\n  tenantCode: string;\n  userCode: string;\n  userId: string;\n  email?: string;\n  role?: string;\n}\n\n/**\n * Get custom user context from invoke context (\u547c\u3073\u51fa\u3057\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304b\u3089\u30ab\u30b9\u30bf\u30e0\u30e6\u30fc\u30b6\u30fc\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u53d6\u5f97)\n */\nexport function getCustomUserContext(invokeContext: IInvoke): CustomUserContext {\n  const userContext = getUserContext(invokeContext);\n\n  return {\n    tenantCode: userContext.tenantCode || DEFAULT_TENANT_CODE,\n    userCode: userContext.userCode || '',\n    userId: userContext.userId || '',\n    email: userContext.email,\n    role: userContext['custom:role'],\n  };\n}\n\n/**\n * Tenant code for shared/common data across all tenants (\u5168\u30c6\u30ca\u30f3\u30c8\u5171\u901a/\u5171\u6709\u30c7\u30fc\u30bf\u7528\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9)\n * Use this for master data, settings, and resources shared by all tenants (\u30de\u30b9\u30bf\u30fc\u30c7\u30fc\u30bf\u3001\u8a2d\u5b9a\u3001\u5168\u30c6\u30ca\u30f3\u30c8\u5171\u6709\u30ea\u30bd\u30fc\u30b9\u306b\u4f7f\u7528)\n */\nexport const TENANT_COMMON = 'common';\n\n/**\n * Default tenant code when no tenant is specified (\u30c6\u30ca\u30f3\u30c8\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9)\n * Used in single-tenant mode or when tenant context is not available (\u30b7\u30f3\u30b0\u30eb\u30c6\u30ca\u30f3\u30c8\u30e2\u30fc\u30c9\u307e\u305f\u306f\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c\u5229\u7528\u3067\u304d\u306a\u3044\u5834\u5408\u306b\u4f7f\u7528)\n */\nexport const DEFAULT_TENANT_CODE = 'single';\n"})}),"\n",(0,r.jsxs)(n.admonition,{title:"\u91cd\u8981: Master\u30e2\u30b8\u30e5\u30fc\u30eb\u3068Tenant\u30e2\u30b8\u30e5\u30fc\u30eb\u306eCOMMON\u5b9a\u6570",type:"warning",children:[(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"@mbc-cqrs-serverless/master"}),"\u3068",(0,r.jsx)(n.code,{children:"@mbc-cqrs-serverless/tenant"}),"\u30d1\u30c3\u30b1\u30fc\u30b8\u3067\u306f\u3001\u5171\u901a\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u7528\u306e\u5185\u90e8\u5b9a\u6570\u3068\u3057\u3066",(0,r.jsx)(n.code,{children:"'COMMON'"}),"\uff08\u5927\u6587\u5b57\uff09\u3092\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002"]}),(0,r.jsxs)(n.p,{children:["\u3053\u308c\u3089\u306e\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u7d44\u307f\u8fbc\u307f\u30e1\u30bd\u30c3\u30c9\uff08\u4f8b\uff1a",(0,r.jsx)(n.code,{children:"createCommonTenantSetting"}),"\u3001",(0,r.jsx)(n.code,{children:"createCommonTenant"}),"\uff09\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001\u30c7\u30fc\u30bf\u4fdd\u5b58\u6642\u306b\u5185\u90e8\u7684\u306b\u3053\u306e",(0,r.jsx)(n.code,{children:"'COMMON'"}),"\u5024\u304c\u81ea\u52d5\u7684\u306b\u4f7f\u7528\u3055\u308c\u307e\u3059\u3002"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// @mbc-cqrs-serverless/master\u3068@mbc-cqrs-serverless/tenant\u3067\nexport enum SettingTypeEnum {\n  TENANT_COMMON = 'COMMON',  // Internal constant for data storage (\u30c7\u30fc\u30bf\u4fdd\u5b58\u7528\u306e\u5185\u90e8\u5b9a\u6570)\n}\n"})}),(0,r.jsxs)(n.p,{children:["\u6ce8\u610f: \u4fdd\u5b58\u3055\u308c\u308b\u5024\u306f",(0,r.jsx)(n.code,{children:"'COMMON'"}),"\u3067\u3059\u304c\u3001HTTP\u30d8\u30c3\u30c0\u30fc\u3067",(0,r.jsx)(n.code,{children:"x-tenant-code: COMMON"}),"\u3092\u9001\u4fe1\u3059\u308b\u3068\u3001\u6b63\u898f\u5316\u306b\u3088\u308a",(0,r.jsx)(n.code,{children:"getUserContext()"}),"\u306f",(0,r.jsx)(n.code,{children:"'common'"}),"\uff08\u5c0f\u6587\u5b57\uff09\u3092\u8fd4\u3057\u307e\u3059\u3002\u30ab\u30b9\u30bf\u30e0\u5b9f\u88c5\u3067\u306f\u3001\u6b63\u898f\u5316\u3055\u308c\u305f\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3068\u306e\u4e00\u8cab\u6027\u306e\u305f\u3081\u5c0f\u6587\u5b57\u306e",(0,r.jsx)(n.code,{children:"'common'"}),"\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"\n/**\n * Check if user has access to tenant (\u30e6\u30fc\u30b6\u30fc\u304c\u30c6\u30ca\u30f3\u30c8\u3078\u306e\u30a2\u30af\u30bb\u30b9\u6a29\u3092\u6301\u3063\u3066\u3044\u308b\u304b\u78ba\u8a8d)\n */\nexport function hasTenantAccess(\n  userContext: CustomUserContext,\n  targetTenantCode: string,\n): boolean {\n  // System admin can access all tenants (\u30b7\u30b9\u30c6\u30e0\u7ba1\u7406\u8005\u306f\u5168\u30c6\u30ca\u30f3\u30c8\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd)\n  if (userContext.role === 'SYSTEM_ADMIN') {\n    return true;\n  }\n\n  // User can only access their own tenant (\u30e6\u30fc\u30b6\u30fc\u306f\u81ea\u5206\u306e\u30c6\u30ca\u30f3\u30c8\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd)\n  return userContext.tenantCode === targetTenantCode;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30c6\u30ca\u30f3\u30c8\u30ac\u30fc\u30c9",children:"\u30c6\u30ca\u30f3\u30c8\u30ac\u30fc\u30c9"}),"\n",(0,r.jsx)(n.p,{children:"\u30c6\u30ca\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u5f37\u5236\u3059\u308b\u30ac\u30fc\u30c9\u3092\u5b9f\u88c5\u3057\u307e\u3059\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// guards/tenant.guard.ts\nimport {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { getCustomUserContext, hasTenantAccess } from '../helpers/context';\n\n@Injectable()\nexport class TenantGuard implements CanActivate {\n  canActivate(context: ExecutionContext): boolean {\n    const request = context.switchToHttp().getRequest();\n    const invokeContext = request.invokeContext;\n    const userContext = getCustomUserContext(invokeContext);\n\n    // Get target tenant from path or body\n    const targetTenant = request.params.tenantCode ||\n                        request.body?.tenantCode ||\n                        this.extractTenantFromPk(request.body?.pk);\n\n    if (!targetTenant) {\n      return true; // No tenant specified, will use user's tenant\n    }\n\n    if (!hasTenantAccess(userContext, targetTenant)) {\n      throw new ForbiddenException(\n        `Access denied to tenant: ${targetTenant}`,\n      );\n    }\n\n    return true;\n  }\n\n  private extractTenantFromPk(pk: string | undefined): string | undefined {\n    if (!pk) return undefined;\n    const parts = pk.split('#');\n    return parts.length >= 2 ? parts[1] : undefined;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u30c7\u30fc\u30bf\u5206\u96e2\u30d1\u30bf\u30fc\u30f3",children:"\u30c7\u30fc\u30bf\u5206\u96e2\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,r.jsx)(n.h3,{id:"\u30d1\u30bf\u30fc\u30f31-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b",children:"\u30d1\u30bf\u30fc\u30f31: \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b"}),"\n",(0,r.jsx)(n.p,{children:"\u5b8c\u5168\u306a\u5206\u96e2\u306e\u305f\u3081\u306b\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u306b\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u542b\u3081\u307e\u3059\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Standard tenant isolation pattern (\u6a19\u6e96\u7684\u306a\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u30d1\u30bf\u30fc\u30f3)\n\nconst PRODUCT_PK_PREFIX = 'PRODUCT';\n\nfunction generateProductPk(tenantCode: string): string {\n  return `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n}\n\n// Example keys:\n// PK: PRODUCT#tenant-a\n// SK: 01HX7MBJK3V9WQBZ7XNDK5ZT2M\n\n// Query all products for a tenant\nasync function listProductsByTenant(tenantCode: string) {\n  const pk = generateProductPk(tenantCode);\n  return dataService.listItemsByPk(pk);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30d1\u30bf\u30fc\u30f32-\u5171\u6709\u30c7\u30fc\u30bf\u7528\u306e\u5171\u901a\u30c6\u30ca\u30f3\u30c8",children:"\u30d1\u30bf\u30fc\u30f32: \u5171\u6709\u30c7\u30fc\u30bf\u7528\u306e\u5171\u901a\u30c6\u30ca\u30f3\u30c8"}),"\n",(0,r.jsx)(n.p,{children:"\u3059\u3079\u3066\u306e\u30c6\u30ca\u30f3\u30c8\u3067\u5171\u6709\u3055\u308c\u308b\u30c7\u30fc\u30bf\u306b\u306f\u5171\u901a\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Shared data pattern for master data and configurations (\u5171\u6709\u30c7\u30fc\u30bf\u30d1\u30bf\u30fc\u30f3\uff1a\u30de\u30b9\u30bf\u30fc\u30c7\u30fc\u30bf\u3001\u8a2d\u5b9a)\n\nconst COMMON_TENANT = 'common';\n\n// System-wide settings\nconst settingsPk = `SETTINGS${KEY_SEPARATOR}${COMMON_TENANT}`;\n\n// User data (users can belong to multiple tenants)\nconst userPk = `USER${KEY_SEPARATOR}${COMMON_TENANT}`;\n\n// Example: Get system-wide email templates\nasync function getEmailTemplates() {\n  return dataService.listItemsByPk(`TEMPLATE${KEY_SEPARATOR}${COMMON_TENANT}`);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30d1\u30bf\u30fc\u30f33-\u30e6\u30fc\u30b6\u30fc\u30c6\u30ca\u30f3\u30c8\u95a2\u9023\u4ed8\u3051",children:"\u30d1\u30bf\u30fc\u30f33: \u30e6\u30fc\u30b6\u30fc\u30fb\u30c6\u30ca\u30f3\u30c8\u95a2\u9023\u4ed8\u3051"}),"\n",(0,r.jsx)(n.p,{children:"\u8907\u6570\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u6240\u5c5e\u3059\u308b\u30e6\u30fc\u30b6\u30fc\u3092\u51e6\u7406\u3057\u307e\u3059\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// user/dto/user-tenant.dto.ts\nexport interface UserTenantAssociation {\n  pk: string;           // USER_TENANT#common\n  sk: string;           // {tenantCode}#{userCode}\n  tenantCode: string;\n  userCode: string;\n  role: string;         // Role within this tenant\n  isDefault: boolean;   // Default tenant for user\n}\n\n// user/user.service.ts\n@Injectable()\nexport class UserService {\n  /**\n   * Get all tenants a user belongs to (\u30e6\u30fc\u30b6\u30fc\u304c\u6240\u5c5e\u3059\u308b\u5168\u30c6\u30ca\u30f3\u30c8\u3092\u53d6\u5f97)\n   */\n  async getUserTenants(userCode: string): Promise<UserTenantAssociation[]> {\n    const pk = `USER_TENANT${KEY_SEPARATOR}${COMMON_TENANT}`;\n\n    // Query with SK prefix to find all tenant associations\n    const result = await this.dataService.listItemsByPk(pk, {\n      skPrefix: '', // Get all, then filter\n    });\n\n    return result.items.filter(item =>\n      item.sk.endsWith(`${KEY_SEPARATOR}${userCode}`),\n    );\n  }\n\n  /**\n   * Add user to tenant (\u30e6\u30fc\u30b6\u30fc\u3092\u30c6\u30ca\u30f3\u30c8\u306b\u8ffd\u52a0)\n   */\n  async addUserToTenant(\n    userCode: string,\n    tenantCode: string,\n    role: string,\n    invokeContext: IInvoke,\n  ): Promise<void> {\n    const pk = `USER_TENANT${KEY_SEPARATOR}${COMMON_TENANT}`;\n    const sk = `${tenantCode}${KEY_SEPARATOR}${userCode}`;\n\n    await this.commandService.publishSync({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode: COMMON_TENANT,\n      code: `${tenantCode}-${userCode}`,\n      name: `User ${userCode} in ${tenantCode}`,\n      type: 'USER_TENANT',\n      attributes: {\n        userCode,\n        tenantCode,\n        role,\n        isDefault: false,\n      },\n    }, { invokeContext });\n  }\n\n  /**\n   * Switch user's active tenant (\u30e6\u30fc\u30b6\u30fc\u306e\u30a2\u30af\u30c6\u30a3\u30d6\u30c6\u30ca\u30f3\u30c8\u3092\u5207\u308a\u66ff\u3048)\n   */\n  async switchTenant(\n    userCode: string,\n    newTenantCode: string,\n    invokeContext: IInvoke,\n  ): Promise<{ token: string }> {\n    // Verify user belongs to tenant\n    const associations = await this.getUserTenants(userCode);\n    const association = associations.find(a =>\n      a.attributes.tenantCode === newTenantCode,\n    );\n\n    if (!association) {\n      throw new ForbiddenException(\n        `User does not belong to tenant: ${newTenantCode}`,\n      );\n    }\n\n    // Generate new token with updated tenant context\n    return this.authService.generateToken({\n      userCode,\n      tenantCode: newTenantCode,\n      role: association.attributes.role,\n    });\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c",children:"\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c"}),"\n",(0,r.jsx)(n.h3,{id:"\u30d1\u30bf\u30fc\u30f31-\u30c6\u30ca\u30f3\u30c8\u9593\u306e\u30c7\u30fc\u30bf\u540c\u671f",children:"\u30d1\u30bf\u30fc\u30f31: \u30c6\u30ca\u30f3\u30c8\u9593\u306e\u30c7\u30fc\u30bf\u540c\u671f"}),"\n",(0,r.jsx)(n.p,{children:"\u3042\u308b\u30c6\u30ca\u30f3\u30c8\u304b\u3089\u5225\u306e\u30c6\u30ca\u30f3\u30c8\u3078\u30c7\u30fc\u30bf\u3092\u540c\u671f\u3057\u307e\u3059\uff08\u4f8b\uff1a\u30de\u30b9\u30bf\u30fc\u30c7\u30fc\u30bf\u914d\u4fe1\uff09\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// sync/tenant-sync.service.ts\n@Injectable()\nexport class TenantSyncService {\n  private readonly logger = new Logger(TenantSyncService.name);\n\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n  ) {}\n\n  /**\n   * Sync master data from source to target tenants (\u30de\u30b9\u30bf\u30fc\u30c7\u30fc\u30bf\u3092\u30bd\u30fc\u30b9\u30c6\u30ca\u30f3\u30c8\u304b\u3089\u30bf\u30fc\u30b2\u30c3\u30c8\u30c6\u30ca\u30f3\u30c8\u306b\u540c\u671f)\n   */\n  async syncMasterData(\n    sourceTenantCode: string,\n    targetTenantCodes: string[],\n    entityType: string,\n    invokeContext: IInvoke,\n  ): Promise<{ synced: number; errors: string[] }> {\n    const sourcePk = `${entityType}${KEY_SEPARATOR}${sourceTenantCode}`;\n    const sourceData = await this.dataService.listItemsByPk(sourcePk);\n\n    let synced = 0;\n    const errors: string[] = [];\n\n    for (const targetTenant of targetTenantCodes) {\n      for (const item of sourceData.items) {\n        try {\n          await this.syncItem(item, targetTenant, invokeContext);\n          synced++;\n        } catch (error) {\n          errors.push(`Failed to sync ${item.id} to ${targetTenant}: ${error.message}`);\n        }\n      }\n    }\n\n    this.logger.log(`Synced ${synced} items to ${targetTenantCodes.length} tenants`);\n    return { synced, errors };\n  }\n\n  private async syncItem(\n    sourceItem: any,\n    targetTenantCode: string,\n    invokeContext: IInvoke,\n  ): Promise<void> {\n    // Create new keys for target tenant\n    const pkParts = sourceItem.pk.split(KEY_SEPARATOR);\n    const entityType = pkParts[0];\n    const targetPk = `${entityType}${KEY_SEPARATOR}${targetTenantCode}`;\n    const targetId = generateId(targetPk, sourceItem.sk);\n\n    await this.commandService.publishSync({\n      pk: targetPk,\n      sk: sourceItem.sk,\n      id: targetId,\n      tenantCode: targetTenantCode,\n      code: sourceItem.code,\n      name: sourceItem.name,\n      type: sourceItem.type,\n      attributes: sourceItem.attributes,\n      // Mark as synced from source\n      metadata: {\n        syncedFrom: sourceItem.id,\n        syncedAt: new Date().toISOString(),\n      },\n    }, { invokeContext });\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30d1\u30bf\u30fc\u30f32-\u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u30ec\u30dd\u30fc\u30c8",children:"\u30d1\u30bf\u30fc\u30f32: \u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u30ec\u30dd\u30fc\u30c8"}),"\n",(0,r.jsx)(n.p,{children:"\u30ec\u30dd\u30fc\u30c8\u7528\u306b\u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u3067\u30c7\u30fc\u30bf\u3092\u96c6\u8a08\u3057\u307e\u3059\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// reporting/cross-tenant-report.service.ts\n@Injectable()\nexport class CrossTenantReportService {\n  constructor(private readonly prismaService: PrismaService) {}\n\n  /**\n   * Get aggregated metrics across all tenants (\u5168\u30c6\u30ca\u30f3\u30c8\u306e\u96c6\u8a08\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u53d6\u5f97)\n   */\n  async getSystemMetrics(): Promise<SystemMetrics> {\n    const [totalProducts, productsByTenant, recentOrders] = await Promise.all([\n      // Total count across all tenants\n      this.prismaService.product.count({\n        where: { isDeleted: false },\n      }),\n\n      // Count by tenant\n      this.prismaService.product.groupBy({\n        by: ['tenantCode'],\n        _count: { id: true },\n        where: { isDeleted: false },\n      }),\n\n      // Recent orders across all tenants (admin only)\n      this.prismaService.order.findMany({\n        where: { isDeleted: false },\n        orderBy: { createdAt: 'desc' },\n        take: 100,\n      }),\n    ]);\n\n    return {\n      totalProducts,\n      productsByTenant: productsByTenant.map(t => ({\n        tenantCode: t.tenantCode,\n        count: t._count.id,\n      })),\n      recentOrdersCount: recentOrders.length,\n    };\n  }\n\n  /**\n   * Get tenant-specific metrics (\u30c6\u30ca\u30f3\u30c8\u56fa\u6709\u306e\u30e1\u30c8\u30ea\u30af\u30b9\u3092\u53d6\u5f97)\n   */\n  async getTenantMetrics(tenantCode: string): Promise<TenantMetrics> {\n    const [products, orders, users] = await Promise.all([\n      this.prismaService.product.count({\n        where: { tenantCode, isDeleted: false },\n      }),\n      this.prismaService.order.count({\n        where: { tenantCode, isDeleted: false },\n      }),\n      this.prismaService.user.count({\n        where: { tenantCode, isDeleted: false },\n      }),\n    ]);\n\n    return { tenantCode, products, orders, users };\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a",children:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a"}),"\n",(0,r.jsx)(n.h3,{id:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u30d1\u30bf\u30fc\u30f3",children:"\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// tenant/tenant-settings.service.ts\n@Injectable()\nexport class TenantSettingsService {\n  private readonly settingsCache = new Map<string, TenantSettings>();\n\n  constructor(\n    private readonly dataService: DataService,\n    private readonly commandService: CommandService,\n  ) {}\n\n  /**\n   * Get tenant settings with caching (\u30ad\u30e3\u30c3\u30b7\u30e5\u4ed8\u304d\u3067\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u3092\u53d6\u5f97)\n   */\n  async getSettings(tenantCode: string): Promise<TenantSettings> {\n    // Check cache first\n    if (this.settingsCache.has(tenantCode)) {\n      return this.settingsCache.get(tenantCode)!;\n    }\n\n    const pk = `SETTINGS${KEY_SEPARATOR}${tenantCode}`;\n    const sk = 'config';\n\n    try {\n      const settings = await this.dataService.getItem({ pk, sk });\n      this.settingsCache.set(tenantCode, settings.attributes);\n      return settings.attributes;\n    } catch (error) {\n      // Return default settings if not found\n      return this.getDefaultSettings();\n    }\n  }\n\n  /**\n   * Update tenant settings (\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u3092\u66f4\u65b0)\n   */\n  async updateSettings(\n    tenantCode: string,\n    settings: Partial<TenantSettings>,\n    invokeContext: IInvoke,\n  ): Promise<TenantSettings> {\n    const currentSettings = await this.getSettings(tenantCode);\n    const mergedSettings = { ...currentSettings, ...settings };\n\n    const pk = `SETTINGS${KEY_SEPARATOR}${tenantCode}`;\n    const sk = 'config';\n\n    await this.commandService.publishSync({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode,\n      code: 'config',\n      name: 'Tenant Configuration',\n      type: 'SETTINGS',\n      attributes: mergedSettings,\n    }, { invokeContext });\n\n    // Invalidate cache\n    this.settingsCache.delete(tenantCode);\n\n    return mergedSettings;\n  }\n\n  private getDefaultSettings(): TenantSettings {\n    return {\n      timezone: 'Asia/Tokyo',\n      locale: 'ja',\n      dateFormat: 'YYYY-MM-DD',\n      currency: 'JPY',\n      features: {\n        exportEnabled: true,\n        importEnabled: true,\n        apiEnabled: true,\n      },\n    };\n  }\n}\n\nexport interface TenantSettings {\n  timezone: string;\n  locale: string;\n  dateFormat: string;\n  currency: string;\n  features: {\n    exportEnabled: boolean;\n    importEnabled: boolean;\n    apiEnabled: boolean;\n  };\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"prisma\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30b9\u30ad\u30fc\u30de",children:"Prisma\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30b9\u30ad\u30fc\u30de"}),"\n",(0,r.jsx)(n.h3,{id:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u7528rds\u30b9\u30ad\u30fc\u30de",children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u7528RDS\u30b9\u30ad\u30fc\u30de"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-prisma",children:'// prisma/schema.prisma\n\n// Base fields for all entities (\u5168\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u57fa\u672c\u30d5\u30a3\u30fc\u30eb\u30c9)\nmodel Product {\n  id         String   @id\n  pk         String\n  sk         String\n  tenantCode String   // Tenant isolation field (\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u30d5\u30a3\u30fc\u30eb\u30c9)\n\n  code       String\n  name       String\n  attributes Json?\n\n  version    Int\n  isDeleted  Boolean  @default(false)\n  createdAt  DateTime\n  createdBy  String   @default("")\n  updatedAt  DateTime\n  updatedBy  String   @default("")\n\n  // Unique constraint includes tenant (\u4e00\u610f\u5236\u7d04\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b)\n  @@unique([tenantCode, code])\n  @@unique([pk, sk])\n\n  // Index for tenant queries (\u30c6\u30ca\u30f3\u30c8\u30af\u30a8\u30ea\u7528\u30a4\u30f3\u30c7\u30c3\u30af\u30b9)\n  @@index([tenantCode])\n  @@index([tenantCode, name])\n  @@index([tenantCode, createdAt])\n}\n\n// User-Tenant association (\u30e6\u30fc\u30b6\u30fc\u30fb\u30c6\u30ca\u30f3\u30c8\u95a2\u9023)\nmodel UserTenant {\n  id         String   @id\n  pk         String\n  sk         String\n\n  userCode   String\n  tenantCode String\n  role       String\n  isDefault  Boolean  @default(false)\n\n  createdAt  DateTime\n  updatedAt  DateTime\n\n  @@unique([userCode, tenantCode])\n  @@index([userCode])\n  @@index([tenantCode])\n}\n\n// Tenant settings (\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a)\nmodel TenantSettings {\n  id         String   @id\n  tenantCode String   @unique\n  settings   Json\n\n  createdAt  DateTime\n  updatedAt  DateTime\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,r.jsx)(n.h3,{id:"1-\u30af\u30a8\u30ea\u306b\u306f\u5e38\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b",children:"1. \u30af\u30a8\u30ea\u306b\u306f\u5e38\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Good: Tenant-scoped query (\u826f\u3044\u4f8b\uff1a\u30c6\u30ca\u30f3\u30c8\u30b9\u30b3\u30fc\u30d7\u306e\u30af\u30a8\u30ea)\nconst products = await prismaService.product.findMany({\n  where: {\n    tenantCode,\n    isDeleted: false,\n  },\n});\n\n// Bad: Missing tenant scope (data leak risk) (\u60aa\u3044\u4f8b\uff1a\u30c6\u30ca\u30f3\u30c8\u30b9\u30b3\u30fc\u30d7\u304c\u306a\u3044\u3001\u30c7\u30fc\u30bf\u6f0f\u6d29\u30ea\u30b9\u30af)\nconst products = await prismaService.product.findMany({\n  where: { isDeleted: false },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-\u30c6\u30ca\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3",children:"2. \u30c6\u30ca\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Always verify tenant access before operations (\u64cd\u4f5c\u524d\u306b\u5fc5\u305a\u30c6\u30ca\u30f3\u30c8\u30a2\u30af\u30bb\u30b9\u3092\u691c\u8a3c)\nasync updateProduct(\n  productId: string,\n  updateDto: UpdateProductDto,\n  invokeContext: IInvoke,\n): Promise<ProductDataEntity> {\n  const { tenantCode } = getCustomUserContext(invokeContext);\n\n  // Verify product belongs to user's tenant\n  const existing = await this.prismaService.product.findUnique({\n    where: { id: productId },\n  });\n\n  if (existing?.tenantCode !== tenantCode) {\n    throw new ForbiddenException('Access denied');\n  }\n\n  // Proceed with update\n  return this.publishCommand(updateDto, invokeContext);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-\u30c6\u30ca\u30f3\u30c8\u8a8d\u8b58\u30ed\u30ae\u30f3\u30b0",children:"3. \u30c6\u30ca\u30f3\u30c8\u8a8d\u8b58\u30ed\u30ae\u30f3\u30b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Include tenant in all logs for debugging (\u30c7\u30d0\u30c3\u30b0\u7528\u306b\u3059\u3079\u3066\u306e\u30ed\u30b0\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u542b\u3081\u308b)\nthis.logger.log({\n  message: 'Processing order',\n  tenantCode,\n  orderId,\n  userId: userContext.userId,\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-\u30b7\u30b9\u30c6\u30e0\u64cd\u4f5c\u3068\u30c6\u30ca\u30f3\u30c8\u64cd\u4f5c\u306e\u5206\u96e2",children:"4. \u30b7\u30b9\u30c6\u30e0\u64cd\u4f5c\u3068\u30c6\u30ca\u30f3\u30c8\u64cd\u4f5c\u306e\u5206\u96e2"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Use separate endpoints for system-wide vs tenant operations (\u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u3068\u30c6\u30ca\u30f3\u30c8\u64cd\u4f5c\u3067\u5225\u306e\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u4f7f\u7528)\n\n@Controller('api/admin/tenants')\n@UseGuards(SystemAdminGuard)\nexport class TenantAdminController {\n  // System admin operations across tenants\n}\n\n@Controller('api/products')\n@UseGuards(TenantGuard)\nexport class ProductController {\n  // Tenant-scoped operations\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"tenantmodule-api\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9",children:"TenantModule API\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"@mbc-cqrs-serverless/tenant"}),"\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u3001\u3059\u3050\u306b\u4f7f\u3048\u308b\u30c6\u30ca\u30f3\u30c8\u7ba1\u7406\u6a5f\u80fd\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",children:"\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install @mbc-cqrs-serverless/tenant\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u767b\u9332",children:"\u30e2\u30b8\u30e5\u30fc\u30eb\u767b\u9332"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { TenantModule } from '@mbc-cqrs-serverless/tenant';\n\n@Module({\n  imports: [\n    TenantModule.register({\n      enableController: true,\n      dataSyncHandlers: [TenantRdsSyncHandler], // Optional: sync to external systems\n    }),\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3",children:"\u30e2\u30b8\u30e5\u30fc\u30eb\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"\u30aa\u30d7\u30b7\u30e7\u30f3"}),(0,r.jsx)(n.th,{children:"\u578b"}),(0,r.jsx)(n.th,{children:"\u8aac\u660e"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"enableController"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"boolean"})}),(0,r.jsx)(n.td,{children:"\u30c6\u30ca\u30f3\u30c8CRUD\u64cd\u4f5c\u7528\u306eREST\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u6709\u52b9\u5316"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"dataSyncHandlers"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"Type<IDataSyncHandler>[]"})}),(0,r.jsx)(n.td,{children:"\u30c6\u30ca\u30f3\u30c8\u30c7\u30fc\u30bf\u3092\u5916\u90e8\u30b7\u30b9\u30c6\u30e0\uff08\u4f8b\uff1aRDS\uff09\u306b\u540c\u671f\u3059\u308b\u30aa\u30d7\u30b7\u30e7\u30f3\u30cf\u30f3\u30c9\u30e9\u30fc"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"tenantservice\u30e1\u30bd\u30c3\u30c9",children:"TenantService\u30e1\u30bd\u30c3\u30c9"}),"\n",(0,r.jsx)(n.h4,{id:"gettenantkey-detailkey-promisedatamodel",children:(0,r.jsx)(n.code,{children:"getTenant(key: DetailKey): Promise<DataModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u6307\u5b9a\u3055\u308c\u305f\u30ad\u30fc\u306b\u57fa\u3065\u3044\u3066\u30c6\u30ca\u30f3\u30c8\u8a73\u7d30\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.getTenant({\n  pk: 'TENANT#mbc',\n  sk: 'MASTER',\n});\n"})}),"\n",(0,r.jsx)(n.h4,{id:"createcommontenantdto-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"createCommonTenant(dto, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u3067\u5171\u6709\u3055\u308c\u308b\u5171\u901a\u30c6\u30ca\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.createCommonTenant({\n  name: 'Common',\n  description: 'Shared tenant for common data',\n}, { invokeContext });\n"})}),"\n",(0,r.jsx)(n.h4,{id:"createtenantdto-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"createTenant(dto, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u500b\u5225\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u7528\u306e\u30c6\u30ca\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.createTenant({\n  name: 'MBC tenant',\n  code: 'mbc',\n  description: 'Main business tenant',\n}, { invokeContext });\n"})}),"\n",(0,r.jsx)(n.h4,{id:"updatetenantkey-dto-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"updateTenant(key, dto, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u65e2\u5b58\u30c6\u30ca\u30f3\u30c8\u306e\u8a73\u7d30\u3092\u66f4\u65b0\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.updateTenant(\n  { pk: 'TENANT#mbc', sk: 'MASTER' },\n  { name: 'Updated MBC tenant', description: 'Updated description' },\n  { invokeContext },\n);\n"})}),"\n",(0,r.jsx)(n.h4,{id:"deletetenantkey-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"deleteTenant(key, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u6307\u5b9a\u3055\u308c\u305f\u30ad\u30fc\u306b\u57fa\u3065\u3044\u3066\u30c6\u30ca\u30f3\u30c8\u3092\u524a\u9664\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await tenantService.deleteTenant(\n  { pk: 'TENANT#mbc', sk: 'MASTER' },\n  { invokeContext },\n);\n"})}),"\n",(0,r.jsx)(n.h4,{id:"addtenantgroupdto-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"addTenantGroup(dto, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u7279\u5b9a\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u30b0\u30eb\u30fc\u30d7\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await tenantService.addTenantGroup({\n  tenantCode: 'abc',\n  groupId: '19',\n  role: 'company',\n}, { invokeContext });\n"})}),"\n",(0,r.jsx)(n.h4,{id:"createtenantgrouptenantgroupcode-dto-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"createTenantGroup(tenantGroupCode, dto, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u7279\u5b9a\u306e\u30c6\u30ca\u30f3\u30c8\u30b0\u30eb\u30fc\u30d7\u5185\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await tenantService.createTenantGroup(\n  'group-001',\n  {\n    code: 'mbc',\n    name: 'MBC Tenant',\n    description: 'Tenant in group-001',\n  },\n  { invokeContext },\n);\n"})}),"\n",(0,r.jsx)(n.h4,{id:"customizesettinggroupsdto-context-promisecommandmodel",children:(0,r.jsx)(n.code,{children:"customizeSettingGroups(dto, context): Promise<CommandModel>"})}),"\n",(0,r.jsx)(n.p,{children:"\u30c6\u30ca\u30f3\u30c8\u306b\u95a2\u9023\u4ed8\u3051\u3089\u308c\u305f\u30b0\u30eb\u30fc\u30d7\u306e\u8a2d\u5b9a\u3092\u30ab\u30b9\u30bf\u30de\u30a4\u30ba\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await tenantService.customizeSettingGroups({\n  tenantCode: 'mbc',\n  settingGroups: ['19', '20'],\n  role: 'company',\n}, { invokeContext });\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./backend-development",children:"\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u958b\u767a\u30ac\u30a4\u30c9"})," - \u30b3\u30a2\u30d1\u30bf\u30fc\u30f3"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./key-patterns",children:"\u30ad\u30fc\u30d1\u30bf\u30fc\u30f3"})," - \u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u7528PK/SK\u8a2d\u8a08"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./authentication",children:"\u8a8d\u8a3c"})," - \u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var s=t(6540);const r={},a=s.createContext(r);function o(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);