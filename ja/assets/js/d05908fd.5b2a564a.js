"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[5247],{7443:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>m,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"data-migration-patterns","title":"\u30c7\u30fc\u30bf\u79fb\u884c\u30d1\u30bf\u30fc\u30f3","description":"MBC CQRS Serverless\u306b\u304a\u3051\u308b\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3001\u30b9\u30ad\u30fc\u30de\u9032\u5316\u3001\u4e00\u62ec\u30c7\u30fc\u30bf\u51e6\u7406\u306e\u305f\u3081\u306e\u30c7\u30fc\u30bf\u79fb\u884c\u6226\u7565\u3092\u5b66\u3073\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/data-migration-patterns.md","sourceDirName":".","slug":"/data-migration-patterns","permalink":"/ja/docs/data-migration-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":18,"frontMatter":{"sidebar_position":18,"description":"MBC CQRS Serverless\u306b\u304a\u3051\u308b\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3001\u30b9\u30ad\u30fc\u30de\u9032\u5316\u3001\u4e00\u62ec\u30c7\u30fc\u30bf\u51e6\u7406\u306e\u305f\u3081\u306e\u30c7\u30fc\u30bf\u79fb\u884c\u6226\u7565\u3092\u5b66\u3073\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"API\u7d71\u5408\u30ac\u30a4\u30c9","permalink":"/ja/docs/api-integration-guide"},"next":{"title":"\u30e2\u30b8\u30e5\u30fc\u30eb","permalink":"/ja/docs/api-reference"}}');var i=t(4848),s=t(8453);const a={sidebar_position:18,description:"MBC CQRS Serverless\u306b\u304a\u3051\u308b\u30c6\u30ca\u30f3\u30c8\u9593\u64cd\u4f5c\u3001\u30b9\u30ad\u30fc\u30de\u9032\u5316\u3001\u4e00\u62ec\u30c7\u30fc\u30bf\u51e6\u7406\u306e\u305f\u3081\u306e\u30c7\u30fc\u30bf\u79fb\u884c\u6226\u7565\u3092\u5b66\u3073\u307e\u3059\u3002"},o="\u30c7\u30fc\u30bf\u79fb\u884c\u30d1\u30bf\u30fc\u30f3",c={},d=[{value:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",level:2},{value:"\u79fb\u884c\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981",id:"\u79fb\u884c\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981",level:2},{value:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u6b63\u898f\u5316\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",id:"tenant-code-normalization-migration",level:2},{value:"\u5f71\u97ff\u306e\u7406\u89e3",id:"\u5f71\u97ff\u306e\u7406\u89e3",level:3},{value:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u75651\uff1aDynamoDB\u30c7\u30fc\u30bf\u306e\u66f4\u65b0",id:"strategy-1-update-dynamodb",level:3},{value:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u75652\uff1aCognito\u30e6\u30fc\u30b6\u30fc\u5c5e\u6027\u306e\u66f4\u65b0",id:"strategy-2-update-cognito",level:3},{value:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u75653\uff1a\u30c7\u30e5\u30a2\u30eb\u30ea\u30fc\u30c9\u30a2\u30d7\u30ed\u30fc\u30c1",id:"strategy-3-dual-read",level:3},{value:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",id:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",level:3},{value:"RDS\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",id:"rds\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",level:3},{value:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8",id:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8",level:3},{value:"\u30c6\u30ca\u30f3\u30c8\u9593\u30c7\u30fc\u30bf\u79fb\u884c",id:"\u30c6\u30ca\u30f3\u30c8\u9593\u30c7\u30fc\u30bf\u79fb\u884c",level:2},{value:"\u30d1\u30bf\u30fc\u30f31\uff1a\u30c6\u30ca\u30f3\u30c8\u9593\u3067\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc",id:"\u30d1\u30bf\u30fc\u30f31\u30c6\u30ca\u30f3\u30c8\u9593\u3067\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc",level:3},{value:"\u30d1\u30bf\u30fc\u30f32\uff1a\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u305f\u4e00\u62ec\u79fb\u884c",id:"\u30d1\u30bf\u30fc\u30f32\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u305f\u4e00\u62ec\u79fb\u884c",level:3},{value:"\u30b9\u30ad\u30fc\u30de\u9032\u5316\u6226\u7565",id:"\u30b9\u30ad\u30fc\u30de\u9032\u5316\u6226\u7565",level:2},{value:"\u6226\u75651\uff1a\u5f8c\u65b9\u4e92\u63db\u6027\u306e\u3042\u308b\u5909\u66f4",id:"\u6226\u75651\u5f8c\u65b9\u4e92\u63db\u6027\u306e\u3042\u308b\u5909\u66f4",level:3},{value:"\u6226\u75652\uff1a\u30c7\u30fc\u30bf\u5909\u63db\u79fb\u884c",id:"\u6226\u75652\u30c7\u30fc\u30bf\u5909\u63db\u79fb\u884c",level:3},{value:"\u6226\u75653\uff1a\u30d0\u30fc\u30b8\u30e7\u30f3\u4ed8\u304d\u5c5e\u6027\u30d1\u30bf\u30fc\u30f3",id:"\u6226\u75653\u30d0\u30fc\u30b8\u30e7\u30f3\u4ed8\u304d\u5c5e\u6027\u30d1\u30bf\u30fc\u30f3",level:3},{value:"\u4e00\u62ec\u64cd\u4f5c\u3067\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f7f\u7528",id:"\u4e00\u62ec\u64cd\u4f5c\u3067\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f7f\u7528",level:2},{value:"CSV\u30d9\u30fc\u30b9\u306e\u4e00\u62ec\u79fb\u884c",id:"csv\u30d9\u30fc\u30b9\u306e\u4e00\u62ec\u79fb\u884c",level:3},{value:"\u79fb\u884c\u7528\u30a4\u30f3\u30dd\u30fc\u30c8\u30d7\u30ed\u30bb\u30b9\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc",id:"\u79fb\u884c\u7528\u30a4\u30f3\u30dd\u30fc\u30c8\u30d7\u30ed\u30bb\u30b9\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc",level:3},{value:"\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u624b\u9806",id:"\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u624b\u9806",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d9\u30fc\u30b9\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af",id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d9\u30fc\u30b9\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af",level:3},{value:"\u5b89\u5168\u306a\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u305f\u3081\u306e\u30bd\u30d5\u30c8\u524a\u9664\u30d1\u30bf\u30fc\u30f3",id:"\u5b89\u5168\u306a\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u305f\u3081\u306e\u30bd\u30d5\u30c8\u524a\u9664\u30d1\u30bf\u30fc\u30f3",level:3},{value:"\u79fb\u884c\u4e2d\u306e\u30c7\u30fc\u30bf\u691c\u8a3c",id:"\u79fb\u884c\u4e2d\u306e\u30c7\u30fc\u30bf\u691c\u8a3c",level:2},{value:"\u79fb\u884c\u524d\u691c\u8a3c",id:"\u79fb\u884c\u524d\u691c\u8a3c",level:3},{value:"\u79fb\u884c\u5f8c\u691c\u8a3c",id:"\u79fb\u884c\u5f8c\u691c\u8a3c",level:3},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"1. \u53ef\u80fd\u306a\u5834\u5408\u306f\u5e38\u306b\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u4f7f\u7528",id:"1-\u53ef\u80fd\u306a\u5834\u5408\u306f\u5e38\u306b\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u4f7f\u7528",level:3},{value:"2. \u79fb\u884c\u30e1\u30bf\u30c7\u30fc\u30bf\u306e\u8ffd\u8de1",id:"2-\u79fb\u884c\u30e1\u30bf\u30c7\u30fc\u30bf\u306e\u8ffd\u8de1",level:3},{value:"3. \u51aa\u7b49\u306a\u79fb\u884c\u306e\u5b9f\u88c5",id:"3-\u51aa\u7b49\u306a\u79fb\u884c\u306e\u5b9f\u88c5",level:3},{value:"4. \u5927\u898f\u6a21\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u306f\u30d0\u30c3\u30c1\u51e6\u7406\u3092\u4f7f\u7528",id:"4-\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u306f\u30d0\u30c3\u30c1\u51e6\u7406\u3092\u4f7f\u7528",level:3},{value:"5. \u79fb\u884c\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u306e\u4f5c\u6210",id:"5-\u79fb\u884c\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u306e\u4f5c\u6210",level:3},{value:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function l(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"\u30c7\u30fc\u30bf\u79fb\u884c\u30d1\u30bf\u30fc\u30f3",children:"\u30c7\u30fc\u30bf\u79fb\u884c\u30d1\u30bf\u30fc\u30f3"})}),"\n",(0,i.jsx)(e.p,{children:"\u3053\u306e\u30ac\u30a4\u30c9\u3067\u306f\u3001\u30c6\u30ca\u30f3\u30c8\u9593\u30c7\u30fc\u30bf\u79fb\u884c\u3001\u30b9\u30ad\u30fc\u30de\u9032\u5316\u3001\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u305f\u4e00\u62ec\u30c7\u30fc\u30bf\u64cd\u4f5c\u3001\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u624b\u9806\u306a\u3069\u3001MBC CQRS Serverless\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u304a\u3051\u308b\u30c7\u30fc\u30bf\u79fb\u884c\u6226\u7565\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",children:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0"}),"\n",(0,i.jsx)(e.p,{children:"\u4ee5\u4e0b\u306e\u5834\u5408\u306b\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u30c6\u30ca\u30f3\u30c8\u9593\u3067\u30c7\u30fc\u30bf\u3092\u79fb\u884c\u3059\u308b"}),"\n",(0,i.jsx)(e.li,{children:"\u4e92\u63db\u6027\u3092\u7dad\u6301\u3057\u306a\u304c\u3089\u30c7\u30fc\u30bf\u30b9\u30ad\u30fc\u30de\u3092\u9032\u5316\u3055\u305b\u308b"}),"\n",(0,i.jsx)(e.li,{children:"\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3067\u4e00\u62ec\u30c7\u30fc\u30bf\u64cd\u4f5c\u3092\u5b9f\u884c\u3059\u308b"}),"\n",(0,i.jsx)(e.li,{children:"\u5931\u6557\u3057\u305f\u79fb\u884c\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u624b\u9806\u3092\u5b9f\u88c5\u3059\u308b"}),"\n",(0,i.jsx)(e.li,{children:"\u79fb\u884c\u30d7\u30ed\u30bb\u30b9\u4e2d\u306b\u30c7\u30fc\u30bf\u3092\u691c\u8a3c\u3059\u308b"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u79fb\u884c\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981",children:"\u79fb\u884c\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        \u30c7\u30fc\u30bf\u79fb\u884c\u30d5\u30ed\u30fc                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                          \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510               \u2502\n\u2502   \u2502   \u30bd\u30fc\u30b9  \u2502\u2500\u2500\u2500\u2500>\u2502 \u5909\u63db \u2502\u2500\u2500\u2500\u2500>\u2502  \u30bf\u30fc\u30b2\u30c3\u30c8   \u2502               \u2502\n\u2502   \u2502   \u30c7\u30fc\u30bf    \u2502     \u2502 & \u691c\u8a3c \u2502     \u2502   \u30c7\u30fc\u30bf    \u2502               \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502\n\u2502          \u2502                   \u2502                    \u2502                      \u2502\n\u2502          \u2502                   \u25bc                    \u2502                      \u2502\n\u2502          \u2502          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502                      \u2502\n\u2502          \u2502          \u2502  \u30a4\u30f3\u30dd\u30fc\u30c8   \u2502              \u2502                      \u2502\n\u2502          \u2502          \u2502  \u30e2\u30b8\u30e5\u30fc\u30eb   \u2502              \u2502                      \u2502\n\u2502          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502  \u30b9\u30c8\u30e9\u30c6\u30b8\u30fc \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                      \u2502\n\u2502                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                      \u2502\n\u2502                            \u2502                                             \u2502\n\u2502                            \u25bc                                             \u2502\n\u2502                     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                 \u2502\n\u2502                     \u2502 CommandSvc\u2502\u2500\u2500\u2500\u2500>\u2502  DynamoDB \u2502                 \u2502\n\u2502                     \u2502 (\u30d0\u30fc\u30b8\u30e7\u30f3) \u2502     \u2502 (\u5c65\u6b74) \u2502                 \u2502\n\u2502                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                                                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(e.h2,{id:"tenant-code-normalization-migration",children:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u6b63\u898f\u5316\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,i.jsxs)(e.admonition,{title:"\u7834\u58ca\u7684\u5909\u66f4",type:"danger",children:[(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"getUserContext()"}),"\u95a2\u6570\u306f",(0,i.jsx)(e.code,{children:"tenantCode"}),"\u3092\u5c0f\u6587\u5b57\u306b\u6b63\u898f\u5316\u3057\u307e\u3059\u3002\u65e2\u5b58\u306e\u30c7\u30fc\u30bf\u304c\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u306b\u5927\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u3001\u3053\u308c\u306f\u30c7\u30fc\u30bf\u30a2\u30af\u30bb\u30b9\u306b\u5f71\u97ff\u3059\u308b\u7834\u58ca\u7684\u5909\u66f4\u3067\u3059\u3002"]}),(0,i.jsxs)(e.p,{children:["\u5b8c\u5168\u306a\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u3068\u30b9\u30c6\u30c3\u30d7\u30d0\u30a4\u30b9\u30c6\u30c3\u30d7\u306e\u624b\u9806\u306b\u3064\u3044\u3066\u306f\u3001",(0,i.jsx)(e.a,{href:"/docs/migration/v1.1.0",children:"v1.1.0 \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30ac\u30a4\u30c9"}),"\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]})]}),"\n",(0,i.jsx)(e.h3,{id:"\u5f71\u97ff\u306e\u7406\u89e3",children:"\u5f71\u97ff\u306e\u7406\u89e3"}),"\n",(0,i.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u5927\u6587\u5b57\u5c0f\u6587\u5b57\u3092\u533a\u5225\u3057\u306a\u3044\u30de\u30c3\u30c1\u30f3\u30b0\u306e\u305f\u3081\u306b\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u5c0f\u6587\u5b57\u306b\u6b63\u898f\u5316\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:'// Before: Cognito stores uppercase (\u5909\u66f4\u524d\uff1aCognito\u306b\u306f\u5927\u6587\u5b57\u3067\u4fdd\u5b58)\ncustom:tenant = "MY_TENANT"\n\n// After: getUserContext() returns lowercase (\u5909\u66f4\u5f8c\uff1agetUserContext()\u306f\u5c0f\u6587\u5b57\u3092\u8fd4\u3059)\nconst userContext = getUserContext(ctx);\nconsole.log(userContext.tenantCode); // "my_tenant"\n\n// Partition key generation uses lowercase (\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u751f\u6210\u306f\u5c0f\u6587\u5b57\u3092\u4f7f\u7528)\nconst pk = `PRODUCT#${userContext.tenantCode}`; // "PRODUCT#my_tenant"\n'})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u554f\u984c:"})," \u65e2\u5b58\u306eDynamoDB\u30c7\u30fc\u30bf\u306b\u5927\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u6301\u3064\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\uff08\u4f8b\uff1a",(0,i.jsx)(e.code,{children:"PRODUCT#MY_TENANT"}),"\uff09\u304c\u3042\u308b\u5834\u5408\u3001\u6b63\u898f\u5316\u3055\u308c\u305f\u5c0f\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u4f7f\u7528\u3057\u305f\u30af\u30a8\u30ea\u3067\u306f\u305d\u306e\u30c7\u30fc\u30bf\u3092\u898b\u3064\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002"]}),"\n",(0,i.jsx)(e.h3,{id:"strategy-1-update-dynamodb",children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u75651\uff1aDynamoDB\u30c7\u30fc\u30bf\u306e\u66f4\u65b0"}),"\n",(0,i.jsx)(e.p,{children:"\u65e2\u5b58\u306eDynamoDB\u30c7\u30fc\u30bf\u3092\u79fb\u884c\u3057\u3066\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u3067\u5c0f\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3088\u3046\u306b\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/tenant-normalization-migration.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  DynamoDbService,\n  CommandService,\n  KEY_SEPARATOR,\n  generateId,\n  getTenantCode,\n  IInvoke,\n} from '@mbc-cqrs-serverless/core';\n\n@Injectable()\nexport class TenantNormalizationMigrationService {\n  private readonly logger = new Logger(TenantNormalizationMigrationService.name);\n\n  constructor(\n    private readonly dynamoDbService: DynamoDbService,\n    private readonly commandService: CommandService,\n  ) {}\n\n  /**\n   * Migrate all entities of a type to lowercase tenant codes (\u30bf\u30a4\u30d7\u306e\u3059\u3079\u3066\u306e\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u5c0f\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u306b\u79fb\u884c)\n   */\n  async migrateEntityType(\n    tableName: string,\n    entityPrefix: string,\n    invokeContext: IInvoke,\n  ): Promise<{ migrated: number; errors: string[] }> {\n    let migrated = 0;\n    const errors: string[] = [];\n\n    // Scan for items with uppercase tenant codes (\u5927\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u6301\u3064\u30a2\u30a4\u30c6\u30e0\u3092\u30b9\u30ad\u30e3\u30f3)\n    const items = await this.scanForUppercaseTenants(tableName, entityPrefix);\n\n    for (const item of items) {\n      try {\n        const oldTenantCode = getTenantCode(item.pk);\n        const newTenantCode = oldTenantCode?.toLowerCase();\n\n        if (!newTenantCode || oldTenantCode === newTenantCode) {\n          continue; // Already lowercase or no tenant code (\u3059\u3067\u306b\u5c0f\u6587\u5b57\u307e\u305f\u306f\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u306a\u3057)\n        }\n\n        // Create new record with lowercase tenant code (\u5c0f\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3067\u65b0\u3057\u3044\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210)\n        const newPk = `${entityPrefix}${KEY_SEPARATOR}${newTenantCode}`;\n        const newId = generateId(newPk, item.sk);\n\n        await this.commandService.publishSync({\n          pk: newPk,\n          sk: item.sk,\n          id: newId,\n          tenantCode: newTenantCode,\n          code: item.code,\n          name: item.name,\n          type: item.type,\n          version: 0, // New entity (\u65b0\u3057\u3044\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3)\n          attributes: {\n            ...item.attributes,\n            _migratedFrom: item.id,\n            _migrationReason: 'tenant_code_normalization',\n            _migratedAt: new Date().toISOString(),\n          },\n        }, { invokeContext });\n\n        // Mark old record as migrated (soft delete) (\u53e4\u3044\u30ec\u30b3\u30fc\u30c9\u3092\u79fb\u884c\u6e08\u307f\u3068\u3057\u3066\u30de\u30fc\u30af\uff08\u30bd\u30d5\u30c8\u524a\u9664\uff09)\n        await this.commandService.publishPartialUpdateSync({\n          pk: item.pk,\n          sk: item.sk,\n          version: item.version,\n          isDeleted: true,\n          attributes: {\n            ...item.attributes,\n            _migratedTo: newId,\n          },\n        }, { invokeContext });\n\n        migrated++;\n        this.logger.log(`Migrated ${item.id} to ${newId}`);\n      } catch (error) {\n        errors.push(`Failed to migrate ${item.id}: ${error.message}`);\n        this.logger.error(`Migration error for ${item.id}`, error);\n      }\n    }\n\n    return { migrated, errors };\n  }\n\n  private async scanForUppercaseTenants(\n    tableName: string,\n    entityPrefix: string,\n  ): Promise<any[]> {\n    // Implement scanning logic to find items with uppercase tenant codes (\u5927\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u6301\u3064\u30a2\u30a4\u30c6\u30e0\u3092\u898b\u3064\u3051\u308b\u30b9\u30ad\u30e3\u30f3\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5)\n    // Filter for PKs that start with entityPrefix and contain uppercase letters (entityPrefix\u3067\u59cb\u307e\u308a\u5927\u6587\u5b57\u3092\u542b\u3080PK\u3092\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0)\n    return [];\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"strategy-2-update-cognito",children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u75652\uff1aCognito\u30e6\u30fc\u30b6\u30fc\u5c5e\u6027\u306e\u66f4\u65b0"}),"\n",(0,i.jsx)(e.p,{children:"Cognito\u30e6\u30fc\u30b6\u30fc\u5c5e\u6027\u3092\u5c0f\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u4f7f\u7528\u3059\u308b\u3088\u3046\u306b\u66f4\u65b0\u3057\u307e\u3059\u3002\u3053\u306e\u30a2\u30d7\u30ed\u30fc\u30c1\u306f\u30c7\u30fc\u30bf\u79fb\u884c\u3092\u56de\u907f\u3057\u307e\u3059\u304c\u3001Cognito\u7ba1\u7406\u8005\u30a2\u30af\u30bb\u30b9\u304c\u5fc5\u8981\u3067\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/cognito-tenant-migration.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  CognitoIdentityProviderClient,\n  ListUsersCommand,\n  AdminUpdateUserAttributesCommand,\n} from '@aws-sdk/client-cognito-identity-provider';\n\n@Injectable()\nexport class CognitoTenantMigrationService {\n  private readonly logger = new Logger(CognitoTenantMigrationService.name);\n  private readonly cognitoClient: CognitoIdentityProviderClient;\n\n  constructor() {\n    this.cognitoClient = new CognitoIdentityProviderClient({});\n  }\n\n  /**\n   * Migrate all users' custom:tenant to lowercase (\u3059\u3079\u3066\u306e\u30e6\u30fc\u30b6\u30fc\u306ecustom:tenant\u3092\u5c0f\u6587\u5b57\u306b\u79fb\u884c)\n   */\n  async migrateAllUsers(userPoolId: string): Promise<{\n    migrated: number;\n    errors: string[];\n  }> {\n    let migrated = 0;\n    const errors: string[] = [];\n    let paginationToken: string | undefined;\n\n    do {\n      const listResponse = await this.cognitoClient.send(\n        new ListUsersCommand({\n          UserPoolId: userPoolId,\n          PaginationToken: paginationToken,\n        }),\n      );\n\n      for (const user of listResponse.Users ?? []) {\n        try {\n          const tenantAttr = user.Attributes?.find(\n            (a) => a.Name === 'custom:tenant',\n          );\n          const rolesAttr = user.Attributes?.find(\n            (a) => a.Name === 'custom:roles',\n          );\n\n          if (!tenantAttr?.Value) continue;\n\n          const oldTenant = tenantAttr.Value;\n          const newTenant = oldTenant.toLowerCase();\n\n          if (oldTenant === newTenant) continue; // Already lowercase (\u3059\u3067\u306b\u5c0f\u6587\u5b57)\n\n          // Update tenant attribute (\u30c6\u30ca\u30f3\u30c8\u5c5e\u6027\u3092\u66f4\u65b0)\n          const attributes = [\n            { Name: 'custom:tenant', Value: newTenant },\n          ];\n\n          // Update roles if they contain tenant references (\u30c6\u30ca\u30f3\u30c8\u53c2\u7167\u304c\u542b\u307e\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u30ed\u30fc\u30eb\u3092\u66f4\u65b0)\n          if (rolesAttr?.Value) {\n            const roles = JSON.parse(rolesAttr.Value);\n            const updatedRoles = roles.map((r: any) => ({\n              ...r,\n              tenant: (r.tenant || '').toLowerCase(),\n            }));\n            attributes.push({\n              Name: 'custom:roles',\n              Value: JSON.stringify(updatedRoles),\n            });\n          }\n\n          await this.cognitoClient.send(\n            new AdminUpdateUserAttributesCommand({\n              UserPoolId: userPoolId,\n              Username: user.Username,\n              UserAttributes: attributes,\n            }),\n          );\n\n          migrated++;\n          this.logger.log(`Migrated user ${user.Username}`);\n        } catch (error) {\n          errors.push(`Failed to migrate ${user.Username}: ${error.message}`);\n        }\n      }\n\n      paginationToken = listResponse.PaginationToken;\n    } while (paginationToken);\n\n    return { migrated, errors };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"strategy-3-dual-read",children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u75653\uff1a\u30c7\u30e5\u30a2\u30eb\u30ea\u30fc\u30c9\u30a2\u30d7\u30ed\u30fc\u30c1"}),"\n",(0,i.jsx)(e.p,{children:"\u6bb5\u968e\u7684\u306a\u79fb\u884c\u306e\u305f\u3081\u306b\u3001\u5c0f\u6587\u5b57\u3068\u5927\u6587\u5b57\u306e\u4e21\u65b9\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u8a66\u3059\u30c7\u30e5\u30a2\u30eb\u30ea\u30fc\u30c9\u30a2\u30d7\u30ed\u30fc\u30c1\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// services/tenant-compatible-data.service.ts\nimport { Injectable } from '@nestjs/common';\nimport {\n  DataService,\n  KEY_SEPARATOR,\n  getTenantCode,\n} from '@mbc-cqrs-serverless/core';\n\n@Injectable()\nexport class TenantCompatibleDataService {\n  constructor(private readonly dataService: DataService) {}\n\n  /**\n   * Get item with fallback to uppercase tenant code (\u5927\u6587\u5b57\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3078\u306e\u30d5\u30a9\u30fc\u30eb\u30d0\u30c3\u30af\u4ed8\u304d\u3067\u30a2\u30a4\u30c6\u30e0\u3092\u53d6\u5f97)\n   */\n  async getItemWithFallback(\n    entityPrefix: string,\n    tenantCode: string,\n    sk: string,\n  ): Promise<any | null> {\n    // Try lowercase first (new format) (\u307e\u305a\u5c0f\u6587\u5b57\u3092\u8a66\u3059\uff08\u65b0\u5f62\u5f0f\uff09)\n    const lowercasePk = `${entityPrefix}${KEY_SEPARATOR}${tenantCode.toLowerCase()}`;\n    let item = await this.dataService.getItem({ pk: lowercasePk, sk });\n\n    if (item) {\n      return item;\n    }\n\n    // Fallback to uppercase (legacy format) (\u5927\u6587\u5b57\u306b\u30d5\u30a9\u30fc\u30eb\u30d0\u30c3\u30af\uff08\u30ec\u30ac\u30b7\u30fc\u5f62\u5f0f\uff09)\n    const uppercasePk = `${entityPrefix}${KEY_SEPARATOR}${tenantCode.toUpperCase()}`;\n    item = await this.dataService.getItem({ pk: uppercasePk, sk });\n\n    if (item) {\n      // Log for tracking migration progress (\u79fb\u884c\u9032\u6357\u8ffd\u8de1\u306e\u305f\u3081\u30ed\u30b0)\n      console.warn(\n        `Found legacy uppercase data: ${uppercasePk}#${sk}. Consider migrating.`,\n      );\n    }\n\n    return item;\n  }\n\n  /**\n   * List items with fallback to uppercase tenant code (\u5927\u6587\u5b57\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3078\u306e\u30d5\u30a9\u30fc\u30eb\u30d0\u30c3\u30af\u4ed8\u304d\u3067\u30a2\u30a4\u30c6\u30e0\u3092\u30ea\u30b9\u30c8)\n   */\n  async listItemsWithFallback(\n    entityPrefix: string,\n    tenantCode: string,\n  ): Promise<any[]> {\n    const lowercasePk = `${entityPrefix}${KEY_SEPARATOR}${tenantCode.toLowerCase()}`;\n    const uppercasePk = `${entityPrefix}${KEY_SEPARATOR}${tenantCode.toUpperCase()}`;\n\n    // Query both partitions (\u4e21\u65b9\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u30af\u30a8\u30ea)\n    const [lowercaseItems, uppercaseItems] = await Promise.all([\n      this.dataService.listItemsByPk(lowercasePk),\n      this.dataService.listItemsByPk(uppercasePk),\n    ]);\n\n    // Merge results, preferring lowercase (newer) data (\u7d50\u679c\u3092\u30de\u30fc\u30b8\u3057\u3001\u5c0f\u6587\u5b57\uff08\u65b0\u3057\u3044\uff09\u30c7\u30fc\u30bf\u3092\u512a\u5148)\n    const itemMap = new Map<string, any>();\n\n    for (const item of uppercaseItems.items) {\n      itemMap.set(item.sk, item);\n    }\n    for (const item of lowercaseItems.items) {\n      itemMap.set(item.sk, item); // Overwrites uppercase if exists (\u5927\u6587\u5b57\u304c\u5b58\u5728\u3059\u308b\u5834\u5408\u306f\u4e0a\u66f8\u304d)\n    }\n\n    return Array.from(itemMap.values());\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8"}),"\n",(0,i.jsx)(e.p,{children:"\u5c0f\u6587\u5b57\u306e\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u306b\u79fb\u884c\u3059\u308b\u969b\u306f\u3001\u3053\u306e\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u306b\u5f93\u3063\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,i.jsxs)(e.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u79fb\u884c\u524d\u306b",(0,i.jsx)(e.strong,{children:"\u3059\u3079\u3066\u306e\u30c7\u30fc\u30bf\u3092\u30d0\u30c3\u30af\u30a2\u30c3\u30d7"})]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(e.strong,{children:"\u5f71\u97ff\u3092\u53d7\u3051\u308b\u30c6\u30fc\u30d6\u30eb\u3092\u7279\u5b9a"})," - PK\u306e\u5927\u6587\u5b57\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u30b9\u30ad\u30e3\u30f3"]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(e.strong,{children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u6226\u7565\u3092\u9078\u629e\uff1a"}),"\n",(0,i.jsxs)(e.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u6226\u75651\uff1aDynamoDB\u30c7\u30fc\u30bf\u3092\u66f4\u65b0\uff08\u30af\u30ea\u30fc\u30f3\u306a\u79fb\u884c\u306b\u63a8\u5968\uff09"]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u6226\u75652\uff1aCognito\u5c5e\u6027\u3092\u66f4\u65b0\uff08\u30c7\u30fc\u30bf\u304c\u3059\u3067\u306b\u5c0f\u6587\u5b57\u306e\u5834\u5408\uff09"]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u6226\u75653\uff1a\u30c7\u30e5\u30a2\u30eb\u30ea\u30fc\u30c9\uff08\u6700\u5c0f\u9650\u306e\u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u3067\u6bb5\u968e\u7684\u306b\u79fb\u884c\uff09"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u975e\u672c\u756a\u74b0\u5883\u3067",(0,i.jsx)(e.strong,{children:"\u79fb\u884c\u3092\u30c6\u30b9\u30c8"})]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u30c8\u30e9\u30d5\u30a3\u30c3\u30af\u306e\u5c11\u306a\u3044\u6642\u9593\u5e2f\u306b",(0,i.jsx)(e.strong,{children:"\u79fb\u884c\u3092\u5b9f\u884c"})]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u79fb\u884c\u5f8c\u306b",(0,i.jsx)(e.strong,{children:"\u30c7\u30fc\u30bf\u30a2\u30af\u30bb\u30b9\u3092\u691c\u8a3c"})]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","RDS\u540c\u671f\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306f",(0,i.jsx)(e.strong,{children:"RDS\u30c7\u30fc\u30bf\u3092\u66f4\u65b0"}),"\uff08tenantCode\u30ab\u30e9\u30e0\uff09"]}),"\n",(0,i.jsxs)(e.li,{className:"task-list-item",children:[(0,i.jsx)(e.input,{type:"checkbox",disabled:!0})," ","\u79fb\u884c\u6210\u529f\u3092\u78ba\u8a8d\u5f8c\u3001",(0,i.jsx)(e.strong,{children:"\u30ec\u30ac\u30b7\u30fc\u30c7\u30fc\u30bf\u3092\u524a\u9664"})]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"rds\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",children:"RDS\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,i.jsxs)(e.p,{children:["RDS\u540c\u671f\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001",(0,i.jsx)(e.code,{children:"tenantCode"}),"\u30ab\u30e9\u30e0\u3082\u66f4\u65b0\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\uff1a"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- Update tenantCode to lowercase in RDS (RDS\u3067tenantCode\u3092\u5c0f\u6587\u5b57\u306b\u66f4\u65b0)\nUPDATE your_table\nSET tenant_code = LOWER(tenant_code)\nWHERE tenant_code != LOWER(tenant_code);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8",children:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8"}),"\n",(0,i.jsx)(e.p,{children:"\u79fb\u884c\u5f8c\u3001\u3059\u3079\u3066\u306e\u30c7\u30fc\u30bf\u304c\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3042\u308b\u3053\u3068\u3092\u691c\u8a3c\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// scripts/verify-tenant-migration.ts\nasync function verifyMigration(\n  dataService: DataService,\n  entityPrefix: string,\n  tenantCode: string,\n): Promise<{ success: boolean; issues: string[] }> {\n  const issues: string[] = [];\n\n  // Check lowercase data exists (\u5c0f\u6587\u5b57\u30c7\u30fc\u30bf\u304c\u5b58\u5728\u3059\u308b\u304b\u78ba\u8a8d)\n  const pk = `${entityPrefix}#${tenantCode.toLowerCase()}`;\n  const items = await dataService.listItemsByPk(pk);\n\n  if (items.items.length === 0) {\n    issues.push(`No items found for ${pk}`);\n  }\n\n  // Check no uppercase data remains (\u5927\u6587\u5b57\u30c7\u30fc\u30bf\u304c\u6b8b\u3063\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d)\n  const uppercasePk = `${entityPrefix}#${tenantCode.toUpperCase()}`;\n  const legacyItems = await dataService.listItemsByPk(uppercasePk);\n\n  if (legacyItems.items.length > 0) {\n    issues.push(\n      `Found ${legacyItems.items.length} legacy items in ${uppercasePk}`,\n    );\n  }\n\n  return {\n    success: issues.length === 0,\n    issues,\n  };\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u30c6\u30ca\u30f3\u30c8\u9593\u30c7\u30fc\u30bf\u79fb\u884c",children:"\u30c6\u30ca\u30f3\u30c8\u9593\u30c7\u30fc\u30bf\u79fb\u884c"}),"\n",(0,i.jsx)(e.h3,{id:"\u30d1\u30bf\u30fc\u30f31\u30c6\u30ca\u30f3\u30c8\u9593\u3067\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc",children:"\u30d1\u30bf\u30fc\u30f31\uff1a\u30c6\u30ca\u30f3\u30c8\u9593\u3067\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc"}),"\n",(0,i.jsx)(e.p,{children:"CommandService\u3092\u4f7f\u7528\u3057\u3066\u3042\u308b\u30c6\u30ca\u30f3\u30c8\u304b\u3089\u5225\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u30c7\u30fc\u30bf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002\u3053\u308c\u306b\u3088\u308a\u3001\u30bf\u30fc\u30b2\u30c3\u30c8\u30c6\u30ca\u30f3\u30c8\u3067\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u5c65\u6b74\u304c\u4fdd\u6301\u3055\u308c\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/tenant-migration.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  CommandService,\n  DataService,\n  KEY_SEPARATOR,\n  generateId,\n  IInvoke,\n} from '@mbc-cqrs-serverless/core';\n\n@Injectable()\nexport class TenantMigrationService {\n  private readonly logger = new Logger(TenantMigrationService.name);\n\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n  ) {}\n\n  /**\n   * Copy all entities of a type from source to target tenant (\u30bd\u30fc\u30b9\u304b\u3089\u30bf\u30fc\u30b2\u30c3\u30c8\u30c6\u30ca\u30f3\u30c8\u306b\u3059\u3079\u3066\u306e\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u30b3\u30d4\u30fc)\n   */\n  async copyEntities(\n    entityType: string,\n    sourceTenantCode: string,\n    targetTenantCode: string,\n    invokeContext: IInvoke,\n  ): Promise<{ copied: number; errors: string[] }> {\n    const sourcePk = `${entityType}${KEY_SEPARATOR}${sourceTenantCode}`;\n    const sourceData = await this.dataService.listItemsByPk(sourcePk);\n\n    let copied = 0;\n    const errors: string[] = [];\n\n    for (const item of sourceData.items) {\n      try {\n        // Create new keys for target tenant (\u30bf\u30fc\u30b2\u30c3\u30c8\u30c6\u30ca\u30f3\u30c8\u7528\u306e\u65b0\u3057\u3044\u30ad\u30fc\u3092\u4f5c\u6210)\n        const targetPk = `${entityType}${KEY_SEPARATOR}${targetTenantCode}`;\n        const targetId = generateId(targetPk, item.sk);\n\n        await this.commandService.publishSync({\n          pk: targetPk,\n          sk: item.sk,\n          id: targetId,\n          tenantCode: targetTenantCode,\n          code: item.code,\n          name: item.name,\n          type: item.type,\n          attributes: item.attributes,\n          // Track migration source (\u79fb\u884c\u30bd\u30fc\u30b9\u3092\u8ffd\u8de1)\n          metadata: {\n            migratedFrom: item.id,\n            migratedAt: new Date().toISOString(),\n            sourceTenant: sourceTenantCode,\n          },\n        }, { invokeContext });\n\n        copied++;\n      } catch (error) {\n        errors.push(`Failed to copy ${item.id}: ${error.message}`);\n        this.logger.error(`Migration error for ${item.id}`, error);\n      }\n    }\n\n    this.logger.log(`Copied ${copied} ${entityType} items from ${sourceTenantCode} to ${targetTenantCode}`);\n    return { copied, errors };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u30d1\u30bf\u30fc\u30f32\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u305f\u4e00\u62ec\u79fb\u884c",children:"\u30d1\u30bf\u30fc\u30f32\uff1a\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u305f\u4e00\u62ec\u79fb\u884c"}),"\n",(0,i.jsx)(e.p,{children:"\u5909\u63db\u30b5\u30dd\u30fc\u30c8\u4ed8\u304d\u306e\u5927\u898f\u6a21\u306a\u30c6\u30ca\u30f3\u30c8\u9593\u79fb\u884c\u306b\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/bulk-migration.strategy.ts\nimport { Injectable } from '@nestjs/common';\nimport { KEY_SEPARATOR, generateId } from '@mbc-cqrs-serverless/core';\nimport { BaseImportStrategy } from '@mbc-cqrs-serverless/import';\n\nexport interface MigrationInput {\n  sourcePk: string;\n  sourceSk: string;\n  code: string;\n  name: string;\n  attributes: Record<string, any>;\n  targetTenantCode: string;\n}\n\nexport interface MigrationDto {\n  pk: string;\n  sk: string;\n  id: string;\n  code: string;\n  name: string;\n  tenantCode: string;\n  type: string;\n  attributes: Record<string, any>;\n}\n\n@Injectable()\nexport class BulkMigrationImportStrategy\n  extends BaseImportStrategy<MigrationInput, MigrationDto>\n{\n  /**\n   * Transform source data to target tenant format (\u30bd\u30fc\u30b9\u30c7\u30fc\u30bf\u3092\u30bf\u30fc\u30b2\u30c3\u30c8\u30c6\u30ca\u30f3\u30c8\u5f62\u5f0f\u306b\u5909\u63db)\n   */\n  async transform(input: MigrationInput): Promise<MigrationDto> {\n    const { targetTenantCode } = input;\n\n    // Extract entity type from source PK (\u30bd\u30fc\u30b9PK\u304b\u3089\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u30bf\u30a4\u30d7\u3092\u62bd\u51fa)\n    const pkParts = input.sourcePk.split(KEY_SEPARATOR);\n    const entityType = pkParts[0];\n\n    // Build target keys (\u30bf\u30fc\u30b2\u30c3\u30c8\u30ad\u30fc\u3092\u69cb\u7bc9)\n    const targetPk = `${entityType}${KEY_SEPARATOR}${targetTenantCode}`;\n    const targetId = generateId(targetPk, input.sourceSk);\n\n    return {\n      pk: targetPk,\n      sk: input.sourceSk,\n      id: targetId,\n      code: input.code,\n      name: input.name,\n      tenantCode: targetTenantCode,\n      type: entityType,\n      attributes: {\n        ...input.attributes,\n        // Add migration metadata (\u79fb\u884c\u30e1\u30bf\u30c7\u30fc\u30bf\u3092\u8ffd\u52a0)\n        _migrated: true,\n        _sourceKey: `${input.sourcePk}#${input.sourceSk}`,\n      },\n    };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u30b9\u30ad\u30fc\u30de\u9032\u5316\u6226\u7565",children:"\u30b9\u30ad\u30fc\u30de\u9032\u5316\u6226\u7565"}),"\n",(0,i.jsx)(e.h3,{id:"\u6226\u75651\u5f8c\u65b9\u4e92\u63db\u6027\u306e\u3042\u308b\u5909\u66f4",children:"\u6226\u75651\uff1a\u5f8c\u65b9\u4e92\u63db\u6027\u306e\u3042\u308b\u5909\u66f4"}),"\n",(0,i.jsx)(e.p,{children:"\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3092\u6301\u3064\u65b0\u3057\u3044\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002\u65e2\u5b58\u306e\u30c7\u30fc\u30bf\u306f\u79fb\u884c\u306a\u3057\u3067\u5f15\u304d\u7d9a\u304d\u52d5\u4f5c\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// Backward compatible attribute evolution (\u5f8c\u65b9\u4e92\u63db\u6027\u306e\u3042\u308b\u5c5e\u6027\u9032\u5316)\ninterface ProductAttributesV1 {\n  name: string;\n  price: number;\n}\n\ninterface ProductAttributesV2 extends ProductAttributesV1 {\n  category?: string;        // New optional field (\u65b0\u3057\u3044\u30aa\u30d7\u30b7\u30e7\u30f3\u30d5\u30a3\u30fc\u30eb\u30c9)\n  tags?: string[];          // New optional field (\u65b0\u3057\u3044\u30aa\u30d7\u30b7\u30e7\u30f3\u30d5\u30a3\u30fc\u30eb\u30c9)\n  description?: string;     // New optional field (\u65b0\u3057\u3044\u30aa\u30d7\u30b7\u30e7\u30f3\u30d5\u30a3\u30fc\u30eb\u30c9)\n}\n\n// product/product.service.ts\n@Injectable()\nexport class ProductService {\n  /**\n   * Get product with schema version handling (\u30b9\u30ad\u30fc\u30de\u30d0\u30fc\u30b8\u30e7\u30f3\u51e6\u7406\u3092\u542b\u3080\u88fd\u54c1\u3092\u53d6\u5f97)\n   */\n  async getProduct(key: DetailKey): Promise<ProductDataEntity> {\n    const product = await this.dataService.getItem(key);\n\n    // Apply defaults for missing fields (\u6b20\u843d\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u30c7\u30d5\u30a9\u30eb\u30c8\u3092\u9069\u7528)\n    return {\n      ...product,\n      attributes: {\n        ...product.attributes,\n        category: product.attributes.category ?? 'uncategorized',\n        tags: product.attributes.tags ?? [],\n        description: product.attributes.description ?? '',\n      },\n    };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u6226\u75652\u30c7\u30fc\u30bf\u5909\u63db\u79fb\u884c",children:"\u6226\u75652\uff1a\u30c7\u30fc\u30bf\u5909\u63db\u79fb\u884c"}),"\n",(0,i.jsx)(e.p,{children:"\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc\u3092\u4f7f\u7528\u3057\u3066\u65e2\u5b58\u30c7\u30fc\u30bf\u3092\u65b0\u3057\u3044\u30b9\u30ad\u30fc\u30de\u5f62\u5f0f\u306b\u5909\u63db\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/schema-migration.strategy.ts\nimport { Injectable } from '@nestjs/common';\nimport {\n  CommandService,\n  DataService,\n  DataModel,\n} from '@mbc-cqrs-serverless/core';\nimport {\n  BaseProcessStrategy,\n  ComparisonResult,\n  ComparisonStatus,\n} from '@mbc-cqrs-serverless/import';\n\ninterface OldProductAttributes {\n  productName: string;      // Old field name (\u65e7\u30d5\u30a3\u30fc\u30eb\u30c9\u540d)\n  unitPrice: number;        // Old field name (\u65e7\u30d5\u30a3\u30fc\u30eb\u30c9\u540d)\n  categoryCode: string;     // Renamed field (\u540d\u524d\u5909\u66f4\u3055\u308c\u305f\u30d5\u30a3\u30fc\u30eb\u30c9)\n}\n\ninterface NewProductAttributes {\n  name: string;             // New field name (\u65b0\u30d5\u30a3\u30fc\u30eb\u30c9\u540d)\n  price: number;            // New field name (\u65b0\u30d5\u30a3\u30fc\u30eb\u30c9\u540d)\n  category: string;         // New field name (\u65b0\u30d5\u30a3\u30fc\u30eb\u30c9\u540d)\n  version: 'v2';            // Schema version marker (\u30b9\u30ad\u30fc\u30de\u30d0\u30fc\u30b8\u30e7\u30f3\u30de\u30fc\u30ab\u30fc)\n}\n\n@Injectable()\nexport class SchemaTransformationStrategy\n  extends BaseProcessStrategy<DataModel, NewProductAttributes>\n{\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n  ) {\n    super();\n  }\n\n  getCommandService(): CommandService {\n    return this.commandService;\n  }\n\n  /**\n   * Compare to detect schema version differences (\u30b9\u30ad\u30fc\u30de\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u9055\u3044\u3092\u691c\u51fa\u3059\u308b\u305f\u3081\u306b\u6bd4\u8f03)\n   */\n  async compare(\n    dto: NewProductAttributes,\n    tenantCode: string,\n  ): Promise<ComparisonResult<DataModel>> {\n    // Check if data needs transformation (\u30c7\u30fc\u30bf\u304c\u5909\u63db\u3092\u5fc5\u8981\u3068\u3059\u308b\u304b\u78ba\u8a8d)\n    const existing = await this.dataService.getItem({\n      pk: dto.pk,\n      sk: dto.sk,\n    });\n\n    if (!existing) {\n      return { status: ComparisonStatus.NOT_EXIST };\n    }\n\n    // Check schema version (\u30b9\u30ad\u30fc\u30de\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u78ba\u8a8d)\n    if (existing.attributes?.version !== 'v2') {\n      return { status: ComparisonStatus.CHANGED, existingData: existing };\n    }\n\n    return { status: ComparisonStatus.EQUAL };\n  }\n\n  /**\n   * Map old schema to new schema (\u65e7\u30b9\u30ad\u30fc\u30de\u3092\u65b0\u30b9\u30ad\u30fc\u30de\u306b\u30de\u30c3\u30d4\u30f3\u30b0)\n   */\n  async map(\n    status: ComparisonStatus,\n    dto: NewProductAttributes,\n    tenantCode: string,\n    existingData?: DataModel,\n  ) {\n    if (status === ComparisonStatus.CHANGED && existingData) {\n      const oldAttrs = existingData.attributes as OldProductAttributes;\n\n      return {\n        pk: existingData.pk,\n        sk: existingData.sk,\n        version: existingData.version,\n        attributes: {\n          // Transform field names (\u30d5\u30a3\u30fc\u30eb\u30c9\u540d\u3092\u5909\u63db)\n          name: oldAttrs.productName,\n          price: oldAttrs.unitPrice,\n          category: oldAttrs.categoryCode,\n          version: 'v2',\n        },\n      };\n    }\n\n    return { ...dto, version: 0 };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u6226\u75653\u30d0\u30fc\u30b8\u30e7\u30f3\u4ed8\u304d\u5c5e\u6027\u30d1\u30bf\u30fc\u30f3",children:"\u6226\u75653\uff1a\u30d0\u30fc\u30b8\u30e7\u30f3\u4ed8\u304d\u5c5e\u6027\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,i.jsx)(e.p,{children:"\u6bb5\u968e\u7684\u306a\u79fb\u884c\u306e\u305f\u3081\u306b\u5c5e\u6027\u306b\u30b9\u30ad\u30fc\u30de\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u4fdd\u5b58\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// entity/versioned-entity.ts\nexport interface VersionedAttributes {\n  _schemaVersion: number;\n  [key: string]: any;\n}\n\n// migration/attribute-migrator.service.ts\n@Injectable()\nexport class AttributeMigratorService {\n  private readonly migrations: Map<number, (attrs: any) => any> = new Map();\n\n  constructor() {\n    // Register migration functions (\u79fb\u884c\u95a2\u6570\u3092\u767b\u9332)\n    this.migrations.set(1, this.migrateV1ToV2.bind(this));\n    this.migrations.set(2, this.migrateV2ToV3.bind(this));\n  }\n\n  /**\n   * Apply all necessary migrations to bring attributes to current version (\u5c5e\u6027\u3092\u73fe\u5728\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u306a\u3059\u3079\u3066\u306e\u79fb\u884c\u3092\u9069\u7528)\n   */\n  migrate(attributes: VersionedAttributes, currentVersion: number): any {\n    let version = attributes._schemaVersion || 1;\n    let result = { ...attributes };\n\n    while (version < currentVersion) {\n      const migrationFn = this.migrations.get(version);\n      if (migrationFn) {\n        result = migrationFn(result);\n        version++;\n      } else {\n        throw new Error(`No migration found for version ${version}`);\n      }\n    }\n\n    result._schemaVersion = currentVersion;\n    return result;\n  }\n\n  private migrateV1ToV2(attrs: any): any {\n    return {\n      ...attrs,\n      // V1 to V2: Split fullName into firstName and lastName (V1\u304b\u3089V2\uff1afullName\u3092firstName\u3068lastName\u306b\u5206\u5272)\n      firstName: attrs.fullName?.split(' ')[0] ?? '',\n      lastName: attrs.fullName?.split(' ').slice(1).join(' ') ?? '',\n    };\n  }\n\n  private migrateV2ToV3(attrs: any): any {\n    return {\n      ...attrs,\n      // V2 to V3: Add new required fields with defaults (V2\u304b\u3089V3\uff1a\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3092\u6301\u3064\u65b0\u3057\u3044\u5fc5\u9808\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u8ffd\u52a0)\n      createdAt: attrs.createdAt ?? new Date().toISOString(),\n      status: attrs.status ?? 'active',\n    };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u4e00\u62ec\u64cd\u4f5c\u3067\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f7f\u7528",children:"\u4e00\u62ec\u64cd\u4f5c\u3067\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f7f\u7528"}),"\n",(0,i.jsx)(e.h3,{id:"csv\u30d9\u30fc\u30b9\u306e\u4e00\u62ec\u79fb\u884c",children:"CSV\u30d9\u30fc\u30b9\u306e\u4e00\u62ec\u79fb\u884c"}),"\n",(0,i.jsx)(e.p,{children:"\u30c7\u30fc\u30bf\u3092CSV\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3057\u3001\u5909\u63db\u3057\u3066\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f7f\u7528\u3057\u3066\u518d\u30a4\u30f3\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/csv-migration.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { S3Service, DataService, KEY_SEPARATOR } from '@mbc-cqrs-serverless/core';\nimport { ProcessingMode } from '@mbc-cqrs-serverless/import';\nimport { PutObjectCommand } from '@aws-sdk/client-s3';\n\n@Injectable()\nexport class CsvMigrationService {\n  private readonly logger = new Logger(CsvMigrationService.name);\n\n  constructor(\n    private readonly s3Service: S3Service,\n    private readonly dataService: DataService,\n  ) {}\n\n  /**\n   * Export entities to CSV for migration (\u79fb\u884c\u7528\u306b\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092CSV\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8)\n   */\n  async exportToMigrationCsv(\n    entityType: string,\n    tenantCode: string,\n    targetTenantCode: string,\n  ): Promise<{ bucket: string; key: string }> {\n    const pk = `${entityType}${KEY_SEPARATOR}${tenantCode}`;\n    const data = await this.dataService.listItemsByPk(pk);\n\n    // Build CSV with migration columns (\u79fb\u884c\u30ab\u30e9\u30e0\u3092\u542b\u3080CSV\u3092\u69cb\u7bc9)\n    const headers = ['sourcePk', 'sourceSk', 'code', 'name', 'attributes', 'targetTenantCode'];\n    const rows = data.items.map(item => [\n      item.pk,\n      item.sk,\n      item.code,\n      item.name,\n      JSON.stringify(item.attributes),\n      targetTenantCode,\n    ]);\n\n    const csvContent = [\n      headers.join(','),\n      ...rows.map(row => row.map(this.escapeCsvValue).join(',')),\n    ].join('\\n');\n\n    // Upload to S3 (S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9)\n    const bucket = this.s3Service.privateBucket;\n    const key = `migrations/${Date.now()}/migration-${entityType}-${tenantCode}-to-${targetTenantCode}.csv`;\n\n    await this.s3Service.client.send(new PutObjectCommand({\n      Bucket: bucket,\n      Key: key,\n      Body: csvContent,\n      ContentType: 'text/csv; charset=utf-8',\n    }));\n\n    this.logger.log(`Exported ${data.items.length} items to ${key}`);\n    return { bucket, key };\n  }\n\n  /**\n   * Create migration import job (\u79fb\u884c\u30a4\u30f3\u30dd\u30fc\u30c8\u30b8\u30e7\u30d6\u3092\u4f5c\u6210)\n   */\n  async startMigrationImport(\n    bucket: string,\n    key: string,\n    tenantCode: string,\n  ): Promise<{ jobId: string }> {\n    // Import module handles the migration via configured strategy (\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u304c\u8a2d\u5b9a\u3055\u308c\u305f\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc\u3067\u79fb\u884c\u3092\u51e6\u7406)\n    // The strategy will transform data to target tenant format (\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc\u304c\u30c7\u30fc\u30bf\u3092\u30bf\u30fc\u30b2\u30c3\u30c8\u30c6\u30ca\u30f3\u30c8\u5f62\u5f0f\u306b\u5909\u63db)\n    return {\n      jobId: `migration-${Date.now()}`,\n      // Actual job creation would use ImportModule API (\u5b9f\u969b\u306e\u30b8\u30e7\u30d6\u4f5c\u6210\u306fImportModule API\u3092\u4f7f\u7528)\n    };\n  }\n\n  private escapeCsvValue(value: any): string {\n    if (value === null || value === undefined) return '';\n    const str = String(value);\n    if (str.includes(',') || str.includes('\"') || str.includes('\\n')) {\n      return `\"${str.replace(/\"/g, '\"\"')}\"`;\n    }\n    return str;\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u79fb\u884c\u7528\u30a4\u30f3\u30dd\u30fc\u30c8\u30d7\u30ed\u30bb\u30b9\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc",children:"\u79fb\u884c\u7528\u30a4\u30f3\u30dd\u30fc\u30c8\u30d7\u30ed\u30bb\u30b9\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc"}),"\n",(0,i.jsx)(e.p,{children:"\u79fb\u884c\u56fa\u6709\u306e\u30ed\u30b8\u30c3\u30af\u3092\u51e6\u7406\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u30b9\u30c8\u30e9\u30c6\u30b8\u30fc\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/migration-process.strategy.ts\nimport { Injectable } from '@nestjs/common';\nimport {\n  CommandService,\n  DataService,\n  DataModel,\n  CommandInputModel,\n  CommandPartialInputModel,\n} from '@mbc-cqrs-serverless/core';\nimport {\n  BaseProcessStrategy,\n  ComparisonResult,\n  ComparisonStatus,\n  IProcessStrategy,\n} from '@mbc-cqrs-serverless/import';\n\ninterface MigrationDto {\n  pk: string;\n  sk: string;\n  id: string;\n  code: string;\n  name: string;\n  tenantCode: string;\n  type: string;\n  attributes: Record<string, any>;\n}\n\n@Injectable()\nexport class MigrationProcessStrategy\n  extends BaseProcessStrategy<DataModel, MigrationDto>\n  implements IProcessStrategy<DataModel, MigrationDto>\n{\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n  ) {\n    super();\n  }\n\n  getCommandService(): CommandService {\n    return this.commandService;\n  }\n\n  /**\n   * Compare migrated data with existing target data (\u79fb\u884c\u30c7\u30fc\u30bf\u3092\u65e2\u5b58\u306e\u30bf\u30fc\u30b2\u30c3\u30c8\u30c7\u30fc\u30bf\u3068\u6bd4\u8f03)\n   */\n  async compare(\n    dto: MigrationDto,\n    tenantCode: string,\n  ): Promise<ComparisonResult<DataModel>> {\n    try {\n      const existing = await this.dataService.getItem({\n        pk: dto.pk,\n        sk: dto.sk,\n      });\n\n      if (!existing) {\n        return { status: ComparisonStatus.NOT_EXIST };\n      }\n\n      // Check if already migrated (\u3059\u3067\u306b\u79fb\u884c\u6e08\u307f\u304b\u78ba\u8a8d)\n      if (existing.attributes?._migrated) {\n        return { status: ComparisonStatus.EQUAL };\n      }\n\n      // Data exists but not migrated - update it (\u30c7\u30fc\u30bf\u306f\u5b58\u5728\u3059\u308b\u304c\u79fb\u884c\u3055\u308c\u3066\u3044\u306a\u3044 - \u66f4\u65b0)\n      return { status: ComparisonStatus.CHANGED, existingData: existing };\n    } catch (error) {\n      return { status: ComparisonStatus.NOT_EXIST };\n    }\n  }\n\n  /**\n   * Map migration data to command payload (\u79fb\u884c\u30c7\u30fc\u30bf\u3092\u30b3\u30de\u30f3\u30c9\u30da\u30a4\u30ed\u30fc\u30c9\u306b\u30de\u30c3\u30d4\u30f3\u30b0)\n   */\n  async map(\n    status: ComparisonStatus,\n    dto: MigrationDto,\n    tenantCode: string,\n    existingData?: DataModel,\n  ): Promise<CommandInputModel | CommandPartialInputModel> {\n    if (status === ComparisonStatus.NOT_EXIST) {\n      // Create new record (\u65b0\u3057\u3044\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210)\n      return {\n        pk: dto.pk,\n        sk: dto.sk,\n        id: dto.id,\n        tenantCode: dto.tenantCode,\n        code: dto.code,\n        name: dto.name,\n        type: dto.type,\n        version: 0,\n        attributes: dto.attributes,\n      };\n    }\n\n    // Update existing record (\u65e2\u5b58\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u66f4\u65b0)\n    return {\n      pk: dto.pk,\n      sk: dto.sk,\n      version: existingData?.version ?? 0,\n      attributes: {\n        ...existingData?.attributes,\n        ...dto.attributes,\n        _migrated: true,\n        _migratedAt: new Date().toISOString(),\n      },\n    };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u624b\u9806",children:"\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u624b\u9806"}),"\n",(0,i.jsx)(e.h3,{id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d9\u30fc\u30b9\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af",children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d9\u30fc\u30b9\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af"}),"\n",(0,i.jsx)(e.p,{children:"\u5c65\u6b74\u30c6\u30fc\u30d6\u30eb\u3092\u6d3b\u7528\u3057\u3066\u4ee5\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5fa9\u5143\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/rollback.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  CommandService,\n  DataService,\n  HistoryService,\n  IInvoke,\n} from '@mbc-cqrs-serverless/core';\n\n@Injectable()\nexport class RollbackService {\n  private readonly logger = new Logger(RollbackService.name);\n\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n    private readonly historyService: HistoryService,\n  ) {}\n\n  /**\n   * Rollback entity to a specific version (\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u7279\u5b9a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u30ed\u30fc\u30eb\u30d0\u30c3\u30af)\n   */\n  async rollbackToVersion(\n    pk: string,\n    sk: string,\n    targetVersion: number,\n    invokeContext: IInvoke,\n  ): Promise<void> {\n    // Get historical version (\u5c65\u6b74\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u53d6\u5f97)\n    const historicalData = await this.historyService.getVersion(\n      pk,\n      sk,\n      targetVersion,\n    );\n\n    if (!historicalData) {\n      throw new Error(`Version ${targetVersion} not found for ${pk}#${sk}`);\n    }\n\n    // Get current version for optimistic locking (\u697d\u89b3\u7684\u30ed\u30c3\u30af\u7528\u306e\u73fe\u5728\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u53d6\u5f97)\n    const currentData = await this.dataService.getItem({ pk, sk });\n\n    // Restore to historical state (\u5c65\u6b74\u72b6\u614b\u306b\u5fa9\u5143)\n    await this.commandService.publishSync({\n      pk,\n      sk,\n      id: currentData.id,\n      tenantCode: currentData.tenantCode,\n      code: historicalData.code,\n      name: historicalData.name,\n      type: historicalData.type,\n      version: currentData.version,\n      attributes: {\n        ...historicalData.attributes,\n        _rolledBackFrom: currentData.version,\n        _rolledBackAt: new Date().toISOString(),\n      },\n    }, { invokeContext });\n\n    this.logger.log(`Rolled back ${pk}#${sk} from v${currentData.version} to v${targetVersion}`);\n  }\n\n  /**\n   * Rollback migration by timestamp (\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3067\u79fb\u884c\u3092\u30ed\u30fc\u30eb\u30d0\u30c3\u30af)\n   */\n  async rollbackMigration(\n    entityType: string,\n    tenantCode: string,\n    migrationTimestamp: string,\n    invokeContext: IInvoke,\n  ): Promise<{ rolledBack: number; errors: string[] }> {\n    const pk = `${entityType}#${tenantCode}`;\n    const data = await this.dataService.listItemsByPk(pk);\n\n    let rolledBack = 0;\n    const errors: string[] = [];\n\n    for (const item of data.items) {\n      // Check if item was part of the migration (\u30a2\u30a4\u30c6\u30e0\u304c\u79fb\u884c\u306e\u4e00\u90e8\u3060\u3063\u305f\u304b\u78ba\u8a8d)\n      if (item.attributes?._migratedAt === migrationTimestamp) {\n        try {\n          // Find version before migration (\u79fb\u884c\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u691c\u7d22)\n          const history = await this.historyService.listVersions(\n            item.pk,\n            item.sk,\n          );\n\n          const preVersion = history.find(h =>\n            !h.attributes?._migrated ||\n            new Date(h.updatedAt) < new Date(migrationTimestamp)\n          );\n\n          if (preVersion) {\n            await this.rollbackToVersion(\n              item.pk,\n              item.sk,\n              preVersion.version,\n              invokeContext,\n            );\n            rolledBack++;\n          }\n        } catch (error) {\n          errors.push(`Failed to rollback ${item.id}: ${error.message}`);\n        }\n      }\n    }\n\n    return { rolledBack, errors };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u5b89\u5168\u306a\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u305f\u3081\u306e\u30bd\u30d5\u30c8\u524a\u9664\u30d1\u30bf\u30fc\u30f3",children:"\u5b89\u5168\u306a\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u305f\u3081\u306e\u30bd\u30d5\u30c8\u524a\u9664\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,i.jsx)(e.p,{children:"\u7c21\u5358\u306a\u30ea\u30ab\u30d0\u30ea\u30fc\u3092\u53ef\u80fd\u306b\u3059\u308b\u305f\u3081\u306b\u30bd\u30d5\u30c8\u524a\u9664\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/safe-migration.service.ts\n@Injectable()\nexport class SafeMigrationService {\n  /**\n   * Migrate with soft delete for rollback capability (\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u6a5f\u80fd\u306e\u305f\u3081\u306b\u30bd\u30d5\u30c8\u524a\u9664\u3067\u79fb\u884c)\n   */\n  async migrateWithSoftDelete(\n    sourcePk: string,\n    targetPk: string,\n    invokeContext: IInvoke,\n  ): Promise<{ migratedIds: string[]; originalIds: string[] }> {\n    const sourceData = await this.dataService.listItemsByPk(sourcePk);\n\n    const migratedIds: string[] = [];\n    const originalIds: string[] = [];\n\n    for (const item of sourceData.items) {\n      // Create new record in target (\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u65b0\u3057\u3044\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210)\n      const targetId = generateId(targetPk, item.sk);\n      await this.commandService.publishSync({\n        pk: targetPk,\n        sk: item.sk,\n        id: targetId,\n        tenantCode: this.extractTenant(targetPk),\n        code: item.code,\n        name: item.name,\n        type: item.type,\n        attributes: {\n          ...item.attributes,\n          _migratedFrom: item.id,\n        },\n      }, { invokeContext });\n      migratedIds.push(targetId);\n\n      // Soft delete original (don't hard delete) (\u5143\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u30bd\u30d5\u30c8\u524a\u9664\uff08\u30cf\u30fc\u30c9\u524a\u9664\u3057\u306a\u3044\uff09)\n      await this.commandService.publishPartialUpdateSync({\n        pk: item.pk,\n        sk: item.sk,\n        version: item.version,\n        isDeleted: true,\n        attributes: {\n          ...item.attributes,\n          _migratedTo: targetId,\n          _deletedAt: new Date().toISOString(),\n        },\n      }, { invokeContext });\n      originalIds.push(item.id);\n    }\n\n    return { migratedIds, originalIds };\n  }\n\n  /**\n   * Rollback by restoring soft-deleted records (\u30bd\u30d5\u30c8\u524a\u9664\u3055\u308c\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u5fa9\u5143\u3057\u3066\u30ed\u30fc\u30eb\u30d0\u30c3\u30af)\n   */\n  async rollbackSoftDeleteMigration(\n    originalIds: string[],\n    migratedIds: string[],\n    invokeContext: IInvoke,\n  ): Promise<void> {\n    // Restore original records (\u5143\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u5fa9\u5143)\n    for (const id of originalIds) {\n      const item = await this.dataService.getItemById(id);\n      if (item?.isDeleted) {\n        await this.commandService.publishPartialUpdateSync({\n          pk: item.pk,\n          sk: item.sk,\n          version: item.version,\n          isDeleted: false,\n          attributes: {\n            ...item.attributes,\n            _migratedTo: undefined,\n            _deletedAt: undefined,\n            _restoredAt: new Date().toISOString(),\n          },\n        }, { invokeContext });\n      }\n    }\n\n    // Hard delete migrated records (\u79fb\u884c\u3055\u308c\u305f\u30ec\u30b3\u30fc\u30c9\u3092\u30cf\u30fc\u30c9\u524a\u9664)\n    for (const id of migratedIds) {\n      const item = await this.dataService.getItemById(id);\n      if (item) {\n        await this.commandService.publishPartialUpdateSync({\n          pk: item.pk,\n          sk: item.sk,\n          version: item.version,\n          isDeleted: true,\n        }, { invokeContext });\n      }\n    }\n  }\n\n  private extractTenant(pk: string): string {\n    return pk.split('#')[1] ?? 'unknown';\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u79fb\u884c\u4e2d\u306e\u30c7\u30fc\u30bf\u691c\u8a3c",children:"\u79fb\u884c\u4e2d\u306e\u30c7\u30fc\u30bf\u691c\u8a3c"}),"\n",(0,i.jsx)(e.h3,{id:"\u79fb\u884c\u524d\u691c\u8a3c",children:"\u79fb\u884c\u524d\u691c\u8a3c"}),"\n",(0,i.jsx)(e.p,{children:"\u79fb\u884c\u3092\u958b\u59cb\u3059\u308b\u524d\u306b\u30c7\u30fc\u30bf\u3092\u691c\u8a3c\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/validation.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { DataService, KEY_SEPARATOR } from '@mbc-cqrs-serverless/core';\nimport { validate } from 'class-validator';\nimport { plainToInstance } from 'class-transformer';\n\nexport interface ValidationResult {\n  valid: boolean;\n  totalRecords: number;\n  validRecords: number;\n  invalidRecords: ValidationError[];\n}\n\nexport interface ValidationError {\n  id: string;\n  errors: string[];\n}\n\n@Injectable()\nexport class MigrationValidationService {\n  private readonly logger = new Logger(MigrationValidationService.name);\n\n  constructor(private readonly dataService: DataService) {}\n\n  /**\n   * Validate all records before migration (\u79fb\u884c\u524d\u306b\u3059\u3079\u3066\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u691c\u8a3c)\n   */\n  async validateBeforeMigration<T extends object>(\n    entityType: string,\n    tenantCode: string,\n    dtoClass: new () => T,\n  ): Promise<ValidationResult> {\n    const pk = `${entityType}${KEY_SEPARATOR}${tenantCode}`;\n    const data = await this.dataService.listItemsByPk(pk);\n\n    const invalidRecords: ValidationError[] = [];\n    let validCount = 0;\n\n    for (const item of data.items) {\n      const dto = plainToInstance(dtoClass, item.attributes);\n      const errors = await validate(dto);\n\n      if (errors.length > 0) {\n        invalidRecords.push({\n          id: item.id,\n          errors: errors.map(e => Object.values(e.constraints ?? {}).join(', ')),\n        });\n      } else {\n        validCount++;\n      }\n    }\n\n    const result: ValidationResult = {\n      valid: invalidRecords.length === 0,\n      totalRecords: data.items.length,\n      validRecords: validCount,\n      invalidRecords,\n    };\n\n    this.logger.log(`Validation result: ${validCount}/${data.items.length} valid`);\n    return result;\n  }\n\n  /**\n   * Validate referential integrity (\u53c2\u7167\u6574\u5408\u6027\u3092\u691c\u8a3c)\n   */\n  async validateReferences(\n    entityType: string,\n    tenantCode: string,\n    referenceField: string,\n    referenceEntityType: string,\n  ): Promise<ValidationError[]> {\n    const pk = `${entityType}${KEY_SEPARATOR}${tenantCode}`;\n    const data = await this.dataService.listItemsByPk(pk);\n\n    const refPk = `${referenceEntityType}${KEY_SEPARATOR}${tenantCode}`;\n    const refData = await this.dataService.listItemsByPk(refPk);\n    const validRefs = new Set(refData.items.map(r => r.id));\n\n    const errors: ValidationError[] = [];\n\n    for (const item of data.items) {\n      const refValue = item.attributes?.[referenceField];\n      if (refValue && !validRefs.has(refValue)) {\n        errors.push({\n          id: item.id,\n          errors: [`Invalid reference: ${referenceField}=${refValue} not found`],\n        });\n      }\n    }\n\n    return errors;\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u79fb\u884c\u5f8c\u691c\u8a3c",children:"\u79fb\u884c\u5f8c\u691c\u8a3c"}),"\n",(0,i.jsx)(e.p,{children:"\u79fb\u884c\u5f8c\u306b\u30c7\u30fc\u30bf\u6574\u5408\u6027\u3092\u691c\u8a3c\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// migration/verification.service.ts\n@Injectable()\nexport class MigrationVerificationService {\n  /**\n   * Verify migration completed successfully (\u79fb\u884c\u304c\u6b63\u5e38\u306b\u5b8c\u4e86\u3057\u305f\u3053\u3068\u3092\u691c\u8a3c)\n   */\n  async verifyMigration(\n    sourcePk: string,\n    targetPk: string,\n  ): Promise<{\n    success: boolean;\n    sourceCount: number;\n    targetCount: number;\n    missingItems: string[];\n    extraItems: string[];\n  }> {\n    const sourceData = await this.dataService.listItemsByPk(sourcePk);\n    const targetData = await this.dataService.listItemsByPk(targetPk);\n\n    const sourceIds = new Set(sourceData.items.map(i => i.sk));\n    const targetIds = new Set(targetData.items.map(i => i.sk));\n\n    const missingItems: string[] = [];\n    const extraItems: string[] = [];\n\n    // Find items in source but not in target (\u30bd\u30fc\u30b9\u306b\u3042\u308b\u304c\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u306a\u3044\u30a2\u30a4\u30c6\u30e0\u3092\u691c\u7d22)\n    for (const sk of sourceIds) {\n      if (!targetIds.has(sk)) {\n        missingItems.push(sk);\n      }\n    }\n\n    // Find items in target but not in source (\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u3042\u308b\u304c\u30bd\u30fc\u30b9\u306b\u306a\u3044\u30a2\u30a4\u30c6\u30e0\u3092\u691c\u7d22)\n    for (const sk of targetIds) {\n      if (!sourceIds.has(sk)) {\n        extraItems.push(sk);\n      }\n    }\n\n    return {\n      success: missingItems.length === 0,\n      sourceCount: sourceData.items.length,\n      targetCount: targetData.items.length,\n      missingItems,\n      extraItems,\n    };\n  }\n\n  /**\n   * Compare data content between source and target (\u30bd\u30fc\u30b9\u3068\u30bf\u30fc\u30b2\u30c3\u30c8\u9593\u306e\u30c7\u30fc\u30bf\u30b3\u30f3\u30c6\u30f3\u30c4\u3092\u6bd4\u8f03)\n   */\n  async compareContent(\n    sourcePk: string,\n    targetPk: string,\n    compareFields: string[],\n  ): Promise<{ differences: Array<{ sk: string; field: string; source: any; target: any }> }> {\n    const sourceData = await this.dataService.listItemsByPk(sourcePk);\n    const targetData = await this.dataService.listItemsByPk(targetPk);\n\n    const targetMap = new Map(targetData.items.map(i => [i.sk, i]));\n    const differences: Array<{ sk: string; field: string; source: any; target: any }> = [];\n\n    for (const sourceItem of sourceData.items) {\n      const targetItem = targetMap.get(sourceItem.sk);\n      if (!targetItem) continue;\n\n      for (const field of compareFields) {\n        const sourceValue = sourceItem.attributes?.[field];\n        const targetValue = targetItem.attributes?.[field];\n\n        if (JSON.stringify(sourceValue) !== JSON.stringify(targetValue)) {\n          differences.push({\n            sk: sourceItem.sk,\n            field,\n            source: sourceValue,\n            target: targetValue,\n          });\n        }\n      }\n    }\n\n    return { differences };\n  }\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,i.jsx)(e.h3,{id:"1-\u53ef\u80fd\u306a\u5834\u5408\u306f\u5e38\u306b\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u4f7f\u7528",children:"1. \u53ef\u80fd\u306a\u5834\u5408\u306f\u5e38\u306b\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u4f7f\u7528"}),"\n",(0,i.jsx)(e.p,{children:"DynamoDB\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306f\u30a2\u30c8\u30df\u30c3\u30af\u64cd\u4f5c\u3092\u4fdd\u8a3c\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// Use batch writes for related items (\u95a2\u9023\u30a2\u30a4\u30c6\u30e0\u306b\u30d0\u30c3\u30c1\u66f8\u304d\u8fbc\u307f\u3092\u4f7f\u7528)\nawait this.dataService.transactWrite([\n  { put: sourceUpdateItem },\n  { put: targetCreateItem },\n]);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"2-\u79fb\u884c\u30e1\u30bf\u30c7\u30fc\u30bf\u306e\u8ffd\u8de1",children:"2. \u79fb\u884c\u30e1\u30bf\u30c7\u30fc\u30bf\u306e\u8ffd\u8de1"}),"\n",(0,i.jsx)(e.p,{children:"\u76e3\u67fb\u306e\u305f\u3081\u306b\u79fb\u884c\u60c5\u5831\u3092\u4fdd\u5b58\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"attributes: {\n  ...originalAttributes,\n  _migrationId: migrationJobId,\n  _migratedAt: new Date().toISOString(),\n  _migratedBy: userContext.userId,\n  _sourceVersion: sourceItem.version,\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"3-\u51aa\u7b49\u306a\u79fb\u884c\u306e\u5b9f\u88c5",children:"3. \u51aa\u7b49\u306a\u79fb\u884c\u306e\u5b9f\u88c5"}),"\n",(0,i.jsx)(e.p,{children:"\u79fb\u884c\u3092\u518d\u5b9f\u884c\u3057\u3066\u3082\u5b89\u5168\u306b\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// Check if already migrated before processing (\u51e6\u7406\u524d\u306b\u3059\u3067\u306b\u79fb\u884c\u6e08\u307f\u304b\u78ba\u8a8d)\nif (item.attributes?._migrationId === currentMigrationId) {\n  this.logger.log(`Skipping already migrated item: ${item.id}`);\n  continue;\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"4-\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u306f\u30d0\u30c3\u30c1\u51e6\u7406\u3092\u4f7f\u7528",children:"4. \u5927\u898f\u6a21\u30c7\u30fc\u30bf\u30bb\u30c3\u30c8\u306b\u306f\u30d0\u30c3\u30c1\u51e6\u7406\u3092\u4f7f\u7528"}),"\n",(0,i.jsx)(e.p,{children:"\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3068\u30e1\u30e2\u30ea\u306e\u554f\u984c\u3092\u907f\u3051\u308b\u305f\u3081\u306b\u30d0\u30c3\u30c1\u3067\u51e6\u7406\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"const BATCH_SIZE = 25; // DynamoDB limit (DynamoDB\u306e\u5236\u9650)\n\nfor (let i = 0; i < items.length; i += BATCH_SIZE) {\n  const batch = items.slice(i, i + BATCH_SIZE);\n  await Promise.all(batch.map(item => this.migrateItem(item)));\n  this.logger.log(`Processed ${Math.min(i + BATCH_SIZE, items.length)}/${items.length}`);\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"5-\u79fb\u884c\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u306e\u4f5c\u6210",children:"5. \u79fb\u884c\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u306e\u4f5c\u6210"}),"\n",(0,i.jsx)(e.p,{children:"\u518d\u958b\u53ef\u80fd\u306a\u79fb\u884c\u306e\u305f\u3081\u306b\u9032\u6357\u3092\u4fdd\u5b58\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"interface MigrationCheckpoint {\n  migrationId: string;\n  lastProcessedSk: string;\n  processedCount: number;\n  status: 'in_progress' | 'completed' | 'failed';\n  updatedAt: string;\n}\n\n// Resume from checkpoint if migration was interrupted (\u79fb\u884c\u304c\u4e2d\u65ad\u3055\u308c\u305f\u5834\u5408\u306f\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u304b\u3089\u518d\u958b)\nconst checkpoint = await this.getCheckpoint(migrationId);\nconst startFrom = checkpoint?.lastProcessedSk ?? '';\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"./import-export-patterns",children:"\u30a4\u30f3\u30dd\u30fc\u30c8/\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3"})," - \u4e00\u62ec\u30c7\u30fc\u30bf\u64cd\u4f5c"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"./multi-tenant-patterns",children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30d1\u30bf\u30fc\u30f3"})," - \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u6226\u7565"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"./data-sync-handler-examples",children:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u4f8b"})," - \u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"./version-conflict-guide",children:"\u30d0\u30fc\u30b8\u30e7\u30f3\u30b3\u30f3\u30d5\u30ea\u30af\u30c8\u30ac\u30a4\u30c9"})," - \u30d0\u30fc\u30b8\u30e7\u30f3\u30b3\u30f3\u30d5\u30ea\u30af\u30c8\u306e\u51e6\u7406"]}),"\n"]})]})}function m(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(l,{...n})}):l(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>a,x:()=>o});var r=t(6540);const i={},s=r.createContext(i);function a(n){const e=r.useContext(s);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:a(n.components),r.createElement(s.Provider,{value:e},n.children)}}}]);