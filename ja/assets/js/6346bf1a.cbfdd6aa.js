"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[1386],{3908:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"architecture/event-sourcing","title":"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d1\u30bf\u30fc\u30f3","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001MBC CQRS Serverless\u306b\u304a\u3051\u308b\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u5b9f\u88c5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/architecture/event-sourcing.md","sourceDirName":"architecture","slug":"/architecture/event-sourcing","permalink":"/ja/docs/architecture/event-sourcing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"CQRS\u30d1\u30bf\u30fc\u30f3\u30d5\u30ed\u30fc","permalink":"/ja/docs/architecture/cqrs-flow"},"next":{"title":"\u30ad\u30fc\u8a2d\u8a08\u30d1\u30bf\u30fc\u30f3","permalink":"/ja/docs/key-patterns"}}');var i=r(4848),s=r(8453);const d={sidebar_position:3},l="\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d1\u30bf\u30fc\u30f3",a={},c=[{value:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u6982\u8981",id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u6982\u8981",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb",id:"\u30a4\u30d9\u30f3\u30c8\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb",level:2},{value:"DynamoDB\u30a4\u30d9\u30f3\u30c8\u30b9\u30c8\u30a2\u30b9\u30ad\u30fc\u30de",id:"dynamodb\u30a4\u30d9\u30f3\u30c8\u30b9\u30c8\u30a2\u30b9\u30ad\u30fc\u30de",level:2},{value:"\u30ad\u30fc\u69cb\u9020",id:"\u30ad\u30fc\u69cb\u9020",level:3},{value:"\u30a4\u30d9\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u4f8b",id:"\u30a4\u30d9\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u4f8b",level:3},{value:"\u697d\u89b3\u7684\u30ed\u30c3\u30af",id:"\u697d\u89b3\u7684\u30ed\u30c3\u30af",level:2},{value:"\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306e\u5b9f\u88c5",id:"\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306e\u5b9f\u88c5",level:3},{value:"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3",id:"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5",id:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u5229\u70b9",id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u5229\u70b9",level:2},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d1\u30bf\u30fc\u30f3",children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u30d1\u30bf\u30fc\u30f3"})}),"\n",(0,i.jsx)(n.p,{children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001MBC CQRS Serverless\u306b\u304a\u3051\u308b\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u5b9f\u88c5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u6982\u8981",children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u6982\u8981"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart TB\n    subgraph EventStore\n        ES[(DynamoDB)]\n    end\n\n    subgraph EventFlow\n        Command[Command]\n        Aggregate[Aggregate]\n        Event1[Event 1]\n        Event2[Event 2]\n        Event3[Event 3]\n    end\n\n    subgraph Projections\n        P1[Read Model A]\n        P2[Read Model B]\n        P3[Notification Service]\n    end\n\n    Command --\x3e Aggregate\n    Aggregate --\x3e Event1\n    Aggregate --\x3e Event2\n    Aggregate --\x3e Event3\n\n    Event1 --\x3e ES\n    Event2 --\x3e ES\n    Event3 --\x3e ES\n\n    ES --\x3e P1\n    ES --\x3e P2\n    ES --\x3e P3"}),"\n",(0,i.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb",children:"\u30a4\u30d9\u30f3\u30c8\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    Cmd->>Agg: Execute Command\n    Agg->>Agg: Validate Business Rules\n    Agg->>Agg: Apply State Change\n    Agg->>ES: Store Event\n    ES->>SNS: Publish Event\n    SNS->>SQS: Fan-out\n    SQS->>EH: Trigger Handler\n    EH->>RM: Update Projection"}),"\n",(0,i.jsx)(n.h2,{id:"dynamodb\u30a4\u30d9\u30f3\u30c8\u30b9\u30c8\u30a2\u30b9\u30ad\u30fc\u30de",children:"DynamoDB\u30a4\u30d9\u30f3\u30c8\u30b9\u30c8\u30a2\u30b9\u30ad\u30fc\u30de"}),"\n",(0,i.jsx)(n.h3,{id:"\u30ad\u30fc\u69cb\u9020",children:"\u30ad\u30fc\u69cb\u9020"}),"\n",(0,i.jsx)(n.p,{children:"\u30a4\u30d9\u30f3\u30c8\u30b9\u30c8\u30ec\u30fc\u30b8\u7528\u306eDynamoDB\u30ad\u30fc\u69cb\u9020\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"PK (Partition Key)"}),": ",(0,i.jsx)(n.code,{children:"{TENANT}#{ENTITY_TYPE}"})," (\u4f8b: ",(0,i.jsx)(n.code,{children:"TENANT001#ORDER"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SK (Sort Key)"}),": ",(0,i.jsx)(n.code,{children:"{ENTITY_TYPE}#{ID}"})," (\u4f8b: ",(0,i.jsx)(n.code,{children:"ORDER#20240101-001"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u30a4\u30d9\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u4f8b",children:"\u30a4\u30d9\u30f3\u30c8\u30ec\u30b3\u30fc\u30c9\u4f8b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "pk": "TENANT001#ORDER",\n  "sk": "ORDER#20240101-001",\n  "version": 3,\n  "type": "OrderCreated",\n  "data": {\n    "orderId": "20240101-001",\n    "customerId": "CUST-001",\n    "items": [],\n    "totalAmount": 15000\n  },\n  "createdAt": "2024-01-01T10:00:00Z",\n  "createdBy": "user-123"\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u697d\u89b3\u7684\u30ed\u30c3\u30af",children:"\u697d\u89b3\u7684\u30ed\u30c3\u30af"}),"\n",(0,i.jsx)(n.p,{children:"\u540c\u6642\u66f4\u65b0\u6642\u306e\u30c7\u30fc\u30bf\u6574\u5408\u6027\u3092\u78ba\u4fdd\u3059\u308b\u305f\u3081\u306e\u697d\u89b3\u7684\u30ed\u30c3\u30af\u30e1\u30ab\u30cb\u30ba\u30e0\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    C1->>DB: Read v1\n    C2->>DB: Read v1\n    C1->>DB: Update v1 to v2\n    DB--\x3e>C1: Success\n    C2->>DB: Update v1 to v2\n    DB--\x3e>C2: ConditionalCheckFailed\n    C2->>DB: Retry Read v2\n    C2->>DB: Update v2 to v3\n    DB--\x3e>C2: Success"}),"\n",(0,i.jsx)(n.h3,{id:"\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306e\u5b9f\u88c5",children:"\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u306e\u5b9f\u88c5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Command Service automatically handles versioning\nawait this.commandService.publishAsync(entity, {\n  invokeContext: context,\n});\n\n// DynamoDB ConditionExpression ensures optimistic locking\n// ConditionExpression: 'attribute_not_exists(pk) OR version = :currentVersion'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3",children:"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart LR\n    subgraph EventSource\n        ES[Event Store]\n    end\n\n    subgraph MessageBroker\n        SNS[SNS Topic]\n        SQS1[SQS Queue 1]\n        SQS2[SQS Queue 2]\n        SQS3[SQS Queue 3]\n    end\n\n    subgraph EventHandlers\n        EH1[Projection Handler]\n        EH2[Notification Handler]\n        EH3[Integration Handler]\n    end\n\n    subgraph Outputs\n        RM[(Read Model)]\n        Email[Email Service]\n        ExtAPI[External API]\n    end\n\n    ES --\x3e SNS\n    SNS --\x3e SQS1\n    SNS --\x3e SQS2\n    SNS --\x3e SQS3\n\n    SQS1 --\x3e EH1\n    SQS2 --\x3e EH2\n    SQS3 --\x3e EH3\n\n    EH1 --\x3e RM\n    EH2 --\x3e Email\n    EH3 --\x3e ExtAPI"}),"\n",(0,i.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5",children:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { EventHandler, IEventHandler } from '@mbc-cqrs-serverless/core';\n\n@EventHandler(OrderCreatedEvent)\nexport class OrderCreatedHandler implements IEventHandler<OrderCreatedEvent> {\n  constructor(\n    private readonly notificationService: NotificationService,\n    private readonly readModelService: ReadModelService,\n  ) {}\n\n  async execute(event: OrderCreatedEvent): Promise<void> {\n    // Update read model\n    await this.readModelService.updateOrderSummary(event);\n\n    // Send notification\n    await this.notificationService.sendOrderConfirmation(event);\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u5229\u70b9",children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u5229\u70b9"}),"\n",(0,i.jsx)(n.p,{children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u3092\u63a1\u7528\u3059\u308b\u3053\u3068\u3067\u4ee5\u4e0b\u306e\u5229\u70b9\u304c\u5f97\u3089\u308c\u307e\u3059\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5b8c\u5168\u306a\u76e3\u67fb\u8a3c\u8de1"}),": \u3059\u3079\u3066\u306e\u72b6\u614b\u5909\u66f4\u304c\u30a4\u30d9\u30f3\u30c8\u3068\u3057\u3066\u8a18\u9332\u3055\u308c\u308b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30bf\u30a4\u30e0\u30c8\u30e9\u30d9\u30eb"}),": \u4efb\u610f\u306e\u6642\u70b9\u3067\u306e\u72b6\u614b\u3092\u518d\u69cb\u7bc9\u53ef\u80fd"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30a4\u30d9\u30f3\u30c8\u30ea\u30d7\u30ec\u30a4"}),": \u30d7\u30ed\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u3092\u518d\u69cb\u7bc9\u3059\u308b\u305f\u3081\u306b\u30a4\u30d9\u30f3\u30c8\u3092\u30ea\u30d7\u30ec\u30a4"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30c7\u30d0\u30c3\u30b0"}),": \u64cd\u4f5c\u306e\u6b63\u78ba\u306a\u30b7\u30fc\u30b1\u30f3\u30b9\u3092\u8ffd\u8de1"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5206\u6790"}),": \u30d3\u30b8\u30cd\u30b9\u30a4\u30f3\u30c6\u30ea\u30b8\u30a7\u30f3\u30b9\u7528\u306e\u8c4a\u5bcc\u306a\u30a4\u30d9\u30f3\u30c8\u30c7\u30fc\u30bf"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u7d71\u5408"}),": \u30a4\u30d9\u30f3\u30c8\u304c\u5916\u90e8\u30b7\u30b9\u30c6\u30e0\u306e\u66f4\u65b0\u3092\u30c8\u30ea\u30ac\u30fc\u53ef\u80fd"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,i.jsx)(n.p,{children:"\u52b9\u679c\u7684\u306a\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0\u306e\u305f\u3081\u306e\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30a4\u30df\u30e5\u30fc\u30bf\u30d6\u30eb\u30a4\u30d9\u30f3\u30c8"}),": \u4fdd\u5b58\u3055\u308c\u305f\u30a4\u30d9\u30f3\u30c8\u3092\u5909\u66f4\u3057\u306a\u3044"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u3079\u304d\u7b49\u30cf\u30f3\u30c9\u30e9\u30fc"}),": \u91cd\u8907\u30a4\u30d9\u30f3\u30c8\u914d\u4fe1\u3092\u9069\u5207\u306b\u51e6\u7406"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30a4\u30d9\u30f3\u30c8\u30d0\u30fc\u30b8\u30e7\u30cb\u30f3\u30b0"}),": \u30a4\u30d9\u30f3\u30c8\u30b9\u30ad\u30fc\u30de\u306e\u9032\u5316\u3092\u8a08\u753b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u76f8\u95a2ID"}),": \u30b5\u30fc\u30d3\u30b9\u9593\u3067\u95a2\u9023\u30a4\u30d9\u30f3\u30c8\u3092\u8ffd\u8de1"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30c7\u30c3\u30c9\u30ec\u30bf\u30fc\u30ad\u30e5\u30fc"}),": \u5931\u6557\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u3092\u51e6\u7406"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>l});var t=r(6540);const i={},s=t.createContext(i);function d(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);