"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[9550],{4740:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"architecture/step-functions","title":"Step Functions","description":"MBC CQRS Serverless\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306b\u304a\u3051\u308bAWS Step Functions\u3092\u4f7f\u7528\u3057\u305f\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/architecture/step-functions.md","sourceDirName":"architecture","slug":"/architecture/step-functions","permalink":"/ja/docs/architecture/step-functions","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"description":"MBC CQRS Serverless\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306b\u304a\u3051\u308bAWS Step Functions\u3092\u4f7f\u7528\u3057\u305f\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"CDK\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3","permalink":"/ja/docs/architecture/cdk-infrastructure"},"next":{"title":"DynamoDB","permalink":"/ja/docs/dynamodb"}}');var s=t(4848),r=t(8453);const i={sidebar_position:4,description:"MBC CQRS Serverless\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306b\u304a\u3051\u308bAWS Step Functions\u3092\u4f7f\u7528\u3057\u305f\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},o="Step Functions",c={},l=[{value:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981",id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981",level:2},{value:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",id:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",level:2},{value:"\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",id:"\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",level:3},{value:"\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",id:"\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",level:3},{value:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",id:"csv\u30a4\u30f3\u30dd\u30fc\u30c8\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",level:3},{value:"\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u4f8b",id:"\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u4f8b",level:2},{value:"\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u4f8b",id:"\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u4f8b",level:3},{value:"CDK\u5b9f\u88c5\u4f8b",id:"cdk\u5b9f\u88c5\u4f8b",level:2},{value:"\u5b8c\u5168\u306a\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",id:"\u5b8c\u5168\u306a\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",level:3},{value:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027\u3092\u6301\u3064\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",id:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027\u3092\u6301\u3064\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",level:3},{value:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u7528\u306eDistributed Map",id:"csv\u30a4\u30f3\u30dd\u30fc\u30c8\u7528\u306edistributed-map",level:3},{value:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u8a2d\u5b9a",id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u8a2d\u5b9a",level:3},{value:"\u5b9f\u88c5\u30ac\u30a4\u30c9",id:"\u5b9f\u88c5\u30ac\u30a4\u30c9",level:2},{value:"\u30b9\u30c6\u30c3\u30d71\uff1a\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7",id:"\u30b9\u30c6\u30c3\u30d71\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7",level:3},{value:"\u30b9\u30c6\u30c3\u30d72\uff1aStep Function\u30a4\u30d9\u30f3\u30c8\u306e\u5b9a\u7fa9",id:"\u30b9\u30c6\u30c3\u30d72step-function\u30a4\u30d9\u30f3\u30c8\u306e\u5b9a\u7fa9",level:3},{value:"\u30b9\u30c6\u30c3\u30d73\uff1a\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5",id:"\u30b9\u30c6\u30c3\u30d73\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5",level:3},{value:"\u30b9\u30c6\u30c3\u30d74\uff1a\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u8a2d\u5b9a",id:"\u30b9\u30c6\u30c3\u30d74\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u8a2d\u5b9a",level:3},{value:"\u30b9\u30c6\u30c3\u30d75\uff1a\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9f\u884c\u306e\u30c8\u30ea\u30ac\u30fc",id:"\u30b9\u30c6\u30c3\u30d75\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9f\u884c\u306e\u30c8\u30ea\u30ac\u30fc",level:3},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b91\uff1a\u30c7\u30fc\u30bf\u540c\u671f",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b91\u30c7\u30fc\u30bf\u540c\u671f",level:3},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b92\uff1a\u30d0\u30c3\u30c1\u30bf\u30b9\u30af\u51e6\u7406",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b92\u30d0\u30c3\u30c1\u30bf\u30b9\u30af\u51e6\u7406",level:3},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b93\uff1a\u5927\u898f\u6a21CSV\u30a4\u30f3\u30dd\u30fc\u30c8",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b93\u5927\u898f\u6a21csv\u30a4\u30f3\u30dd\u30fc\u30c8",level:3},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b94\uff1a\u975e\u540c\u671f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b94\u975e\u540c\u671f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3",level:3},{value:"\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3",id:"\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3",level:2},{value:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306e\u4ed5\u7d44\u307f",id:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306e\u4ed5\u7d44\u307f",level:3},{value:"StepFunctionService\u5b9f\u88c5",id:"stepfunctionservice\u5b9f\u88c5",level:3},{value:"\u30d0\u30fc\u30b8\u30e7\u30f3\u30d9\u30fc\u30b9\u306e\u30b3\u30de\u30f3\u30c9\u30c1\u30a7\u30fc\u30f3",id:"\u30d0\u30fc\u30b8\u30e7\u30f3\u30d9\u30fc\u30b9\u306e\u30b3\u30de\u30f3\u30c9\u30c1\u30a7\u30fc\u30f3",level:3},{value:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306eCDK\u8a2d\u5b9a",id:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306ecdk\u8a2d\u5b9a",level:3},{value:"\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6226\u7565",id:"\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6226\u7565",level:2},{value:"ZIP\u30a4\u30f3\u30dd\u30fc\u30c8\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3",id:"zip\u30a4\u30f3\u30dd\u30fc\u30c8\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3",level:3},{value:"\u5b50\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3078\u306e\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u4f1d\u64ad",id:"\u5b50\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3078\u306e\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u4f1d\u64ad",level:3},{value:"\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u8a2d\u5b9a",id:"\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u8a2d\u5b9a",level:3},{value:"\u30a4\u30f3\u30dd\u30fc\u30c8/\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3\u3068\u306e\u7d71\u5408",id:"\u30a4\u30f3\u30dd\u30fc\u30c8\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3\u3068\u306e\u7d71\u5408",level:2},{value:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u30d5\u30ed\u30fc",id:"csv\u30a4\u30f3\u30dd\u30fc\u30c8\u30d5\u30ed\u30fc",level:3},{value:"\u30a2\u30c8\u30df\u30c3\u30af\u30ab\u30a6\u30f3\u30bf\u30fc\u306b\u3088\u308b\u9032\u6357\u8ffd\u8de1",id:"\u30a2\u30c8\u30df\u30c3\u30af\u30ab\u30a6\u30f3\u30bf\u30fc\u306b\u3088\u308b\u9032\u6357\u8ffd\u8de1",level:3},{value:"\u51e6\u7406\u30e2\u30fc\u30c9\u306e\u9078\u629e",id:"\u51e6\u7406\u30e2\u30fc\u30c9\u306e\u9078\u629e",level:3},{value:"Step Functions\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8",id:"step-functions\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8",level:2},{value:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",id:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",level:2},{value:"\u30cf\u30f3\u30c9\u30e9\u30fc\u30ec\u30d9\u30eb\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",id:"\u30cf\u30f3\u30c9\u30e9\u30fc\u30ec\u30d9\u30eb\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",level:3},{value:"\u7d99\u7d9a\u3092\u4f34\u3046\u30bf\u30b9\u30af\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",id:"\u7d99\u7d9a\u3092\u4f34\u3046\u30bf\u30b9\u30af\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",level:3},{value:"\u30a2\u30e9\u30fc\u30e0\u767a\u884c",id:"\u30a2\u30e9\u30fc\u30e0\u767a\u884c",level:3},{value:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u8a2d\u5b9a\uff1a",id:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u8a2d\u5b9a",level:3},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"\u8a2d\u8a08\u539f\u5247",id:"\u8a2d\u8a08\u539f\u5247",level:3},{value:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316",id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316",level:3},{value:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",id:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",level:3},{value:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"step-functions",children:"Step Functions"})}),"\n",(0,s.jsx)(e.p,{children:"AWS Step Functions\u306f\u3001\u5206\u6563\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u8abf\u6574\u3059\u308b\u305f\u3081\u306e\u30b5\u30fc\u30d0\u30fc\u30ec\u30b9\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002MBC CQRS Serverless\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u306f\u3001Step Functions\u306f\u4ee5\u4e0b\u306e\u76ee\u7684\u3067\u4f7f\u7528\u3055\u308c\u307e\u3059\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,s.jsx)(e.li,{children:"\u5206\u6563\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306e\u305f\u3081\u306eSaga\u30d1\u30bf\u30fc\u30f3\u5b9f\u88c5"}),"\n",(0,s.jsx)(e.li,{children:"Distributed Map\u3092\u4f7f\u7528\u3057\u305f\u4e26\u5217\u30d0\u30c3\u30c1\u51e6\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u3092\u4f7f\u7528\u3057\u305f\u975e\u540c\u671f\u30bf\u30b9\u30af\u8abf\u6574"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981",children:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981"}),"\n",(0,s.jsx)(e.mermaid,{value:"flowchart TB\n    subgraph Triggers\n        DDBStream[DynamoDB Streams]\n        SQS[SQS Queue]\n        API[API Gateway]\n    end\n\n    subgraph StepFunctions\n        CommandSM[Command State Machine]\n        TaskSM[Task State Machine]\n        ImportSM[Import CSV State Machine]\n    end\n\n    subgraph Processing\n        Lambda[Lambda Functions]\n        DDB[(DynamoDB)]\n        S3[(S3)]\n    end\n\n    DDBStream --\x3e CommandSM\n    DDBStream --\x3e TaskSM\n    SQS --\x3e ImportSM\n    API --\x3e CommandSM\n\n    CommandSM --\x3e Lambda\n    TaskSM --\x3e Lambda\n    ImportSM --\x3e Lambda\n\n    Lambda --\x3e DDB\n    Lambda --\x3e S3"}),"\n",(0,s.jsx)(e.h2,{id:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",children:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f3\u3064\u306e\u4e8b\u524d\u8a2d\u5b9a\u6e08\u307f\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u3092\u63d0\u4f9b\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.h3,{id:"\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",children:"\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u3068\u4e26\u5217\u51e6\u7406\u3092\u4f34\u3046\u30c7\u30fc\u30bf\u540c\u671f\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u51e6\u7406\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsx)(e.mermaid,{value:"flowchart LR\n    A[check_version] --\x3e B{version ok?}\n    B --\x3e|Yes| C[set_ttl_command]\n    B --\x3e|No| D[wait_prev_command]\n    D --\x3e C\n    C --\x3e E[history_copy]\n    E --\x3e F[transform_data]\n    F --\x3e G[sync_data_all]\n    G --\x3e H[finish]"}),"\n",(0,s.jsx)(e.p,{children:"\u4e3b\u306a\u6a5f\u80fd\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30d0\u30fc\u30b8\u30e7\u30f3\u30c1\u30a7\u30c3\u30af"}),"\uff1a\u30b3\u30de\u30f3\u30c9\u306e\u9806\u5e8f\u3092\u4fdd\u8a3c\u3057\u3001\u7af6\u5408\u3092\u9632\u6b62"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u975e\u540c\u671f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af"}),"\uff1a\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u3066\u524d\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5f85\u6a5f"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u4e26\u5217\u540c\u671f"}),"\uff1aMap\u72b6\u614b\u3092\u4f7f\u7528\u3057\u3066\u8907\u6570\u306e\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u30c7\u30fc\u30bf\u3092\u540c\u671f"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"TTL\u7ba1\u7406"}),"\uff1a\u30ec\u30b3\u30fc\u30c9\u306e\u6709\u52b9\u671f\u9650\u3092\u81ea\u52d5\u8a2d\u5b9a"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",children:"\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027\u3067\u4e26\u5217\u30b5\u30d6\u30bf\u30b9\u30af\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsx)(e.mermaid,{value:"flowchart LR\n    A[Start] --\x3e B[Map State]\n    B --\x3e C[iteration 1]\n    B --\x3e D[iteration 2]\n    B --\x3e E[iteration N]\n    C --\x3e F[End]\n    D --\x3e F\n    E --\x3e F"}),"\n",(0,s.jsx)(e.p,{children:"\u4e3b\u306a\u6a5f\u80fd\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027"}),"\uff1a\u4e26\u5217\u5b9f\u884c\u3092\u5236\u9650\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\uff1a2\uff09"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30b9\u30c6\u30fc\u30bf\u30b9\u8ffd\u8de1"}),"\uff1a\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306e\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30bf\u30b9\u66f4\u65b0"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0"}),"\uff1a\u81ea\u52d5\u7684\u306a\u969c\u5bb3\u691c\u51fa\u3068\u30ec\u30dd\u30fc\u30c8"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"csv\u30a4\u30f3\u30dd\u30fc\u30c8\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",children:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"AWS Distributed Map\u3092\u4f7f\u7528\u3057\u3066\u5927\u898f\u6a21\u306aCSV\u30d5\u30a1\u30a4\u30eb\u3092\u5927\u898f\u6a21\u4e26\u5217\u51e6\u7406\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsx)(e.mermaid,{value:"flowchart TB\n    A[Start] --\x3e B[Read CSV from S3]\n    B --\x3e C[Distributed Map]\n    C --\x3e D[Batch 1]\n    C --\x3e E[Batch 2]\n    C --\x3e F[Batch N]\n    D --\x3e G[Transform & Validate]\n    E --\x3e G\n    F --\x3e G\n    G --\x3e H[Create Commands]\n    H --\x3e I[End]"}),"\n",(0,s.jsx)(e.p,{children:"\u4e3b\u306a\u6a5f\u80fd\uff1a"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"S3\u30cd\u30a4\u30c6\u30a3\u30d6\u7d71\u5408"}),"\uff1aS3\u304b\u3089\u76f4\u63a5CSV\u3092\u8aad\u307f\u53d6\u308a"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30d0\u30c3\u30c1\u51e6\u7406"}),"\uff1a\u52b9\u7387\u7684\u306a\u51e6\u7406\u306e\u305f\u3081\u306b\u884c\u3092\u30b0\u30eb\u30fc\u30d7\u5316"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u9ad8\u4e26\u884c\u6027"}),"\uff1a\u6700\u592750\u306e\u540c\u6642\u30d0\u30c3\u30c1\u30d7\u30ed\u30bb\u30c3\u30b5\u3092\u30b5\u30dd\u30fc\u30c8"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"EXPRESS\u5b9f\u884c"}),"\uff1a\u5b50\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306bExpress\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u4f7f\u7528"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u4f8b",children:"\u30b7\u30b9\u30c6\u30e0\u69cb\u6210\u4f8b"}),"\n",(0,s.jsx)(e.p,{children:"\u4ee5\u4e0b\u306e\u56f3\u306f\u3001\u4e00\u822c\u7684\u306a\u672c\u756a\u74b0\u5883\u3067Step Functions\u304c\u3069\u306e\u3088\u3046\u306bAWS\u30b5\u30fc\u30d3\u30b9\u3068\u7d71\u5408\u3055\u308c\u308b\u304b\u3092\u793a\u3057\u3066\u3044\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.mermaid,{value:'flowchart TB\n    subgraph Client\n        Web[Web Application]\n        Mobile[Mobile App]\n    end\n\n    subgraph APILayer["API Layer"]\n        APIGW[API Gateway]\n        AppSync[AppSync GraphQL]\n    end\n\n    subgraph Compute["Compute Layer"]\n        Lambda[Lambda Function<br/>NestJS Application]\n    end\n\n    subgraph StepFunctions["Step Functions"]\n        CommandSFN[Command Handler<br/>State Machine]\n        TaskSFN[Task Handler<br/>State Machine]\n        ImportSFN[Import CSV<br/>State Machine]\n    end\n\n    subgraph EventDriven["Event-Driven Layer"]\n        SNS[SNS Topics]\n        SQS[SQS Queues]\n        DDBStream[DynamoDB Streams]\n    end\n\n    subgraph Storage["Storage Layer"]\n        DDB[(DynamoDB<br/>Event Store)]\n        S3[(S3<br/>File Storage)]\n        RDS[(RDS Aurora<br/>Read Models)]\n    end\n\n    subgraph Monitoring["Monitoring"]\n        CWLogs[CloudWatch Logs]\n        XRay[X-Ray Tracing]\n        CWAlarms[CloudWatch Alarms]\n    end\n\n    Web --\x3e APIGW\n    Mobile --\x3e APIGW\n    Web --\x3e AppSync\n    APIGW --\x3e Lambda\n    AppSync --\x3e Lambda\n\n    Lambda --\x3e DDB\n    Lambda --\x3e S3\n    Lambda --\x3e RDS\n    Lambda --\x3e SNS\n\n    DDBStream --\x3e Lambda\n    DDB --\x3e DDBStream\n    SNS --\x3e SQS\n    SQS --\x3e Lambda\n\n    Lambda --\x3e CommandSFN\n    Lambda --\x3e TaskSFN\n    Lambda --\x3e ImportSFN\n\n    CommandSFN --\x3e Lambda\n    TaskSFN --\x3e Lambda\n    ImportSFN --\x3e Lambda\n    ImportSFN --\x3e S3\n\n    CommandSFN --\x3e CWLogs\n    TaskSFN --\x3e CWLogs\n    ImportSFN --\x3e CWLogs\n    Lambda --\x3e XRay\n    CWLogs --\x3e CWAlarms'}),"\n",(0,s.jsx)(e.h3,{id:"\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u4f8b",children:"\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306e\u4f8b"}),"\n",(0,s.jsx)(e.p,{children:"Step Functions\u3092\u4f7f\u7528\u3057\u305f\u30b3\u30de\u30f3\u30c9\u5b9f\u884c\u306e\u4e00\u822c\u7684\u306a\u30c7\u30fc\u30bf\u30d5\u30ed\u30fc\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff1a"}),"\n",(0,s.jsx)(e.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant API as API Gateway\n    participant Lambda\n    participant DDB as DynamoDB\n    participant Stream as DynamoDB Stream\n    participant SFN as Step Functions\n    participant SNS\n    participant SQS\n\n    Client->>API: POST /orders\n    API->>Lambda: Invoke\n    Lambda->>DDB: PutItem (Command)\n    DDB--\x3e>Lambda: Success\n    Lambda--\x3e>API: 202 Accepted\n    API--\x3e>Client: Order Created\n\n    DDB->>Stream: INSERT Event\n    Stream->>Lambda: Trigger\n    Lambda->>SFN: StartExecution\n\n    loop Each State\n        SFN->>Lambda: Invoke (state handler)\n        Lambda->>DDB: Read/Write\n        Lambda--\x3e>SFN: State Output\n    end\n\n    SFN->>Lambda: Finish State\n    Lambda->>SNS: Publish Event\n    SNS->>SQS: Route Message\n    SQS->>Lambda: Process Async"}),"\n",(0,s.jsx)(e.h2,{id:"cdk\u5b9f\u88c5\u4f8b",children:"CDK\u5b9f\u88c5\u4f8b"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b8c\u5168\u306a\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",children:"\u5b8c\u5168\u306a\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u4ee5\u4e0b\u306eCDK\u30b3\u30fc\u30c9\u306f\u3001\u5b8c\u5168\u306a\u30b3\u30de\u30f3\u30c9\u30cf\u30f3\u30c9\u30e9\u30fc\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306e\u4f5c\u6210\u65b9\u6cd5\u3092\u793a\u3057\u3066\u3044\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import * as cdk from 'aws-cdk-lib';\nimport * as sfn from 'aws-cdk-lib/aws-stepfunctions';\nimport * as tasks from 'aws-cdk-lib/aws-stepfunctions-tasks';\nimport * as lambda from 'aws-cdk-lib/aws-lambda';\nimport * as logs from 'aws-cdk-lib/aws-logs';\nimport { Construct } from 'constructs';\n\nexport class CommandStateMachineConstruct extends Construct {\n  public readonly stateMachine: sfn.StateMachine;\n\n  constructor(scope: Construct, id: string, props: { lambdaFunction: lambda.IFunction }) {\n    super(scope, id);\n\n    const { lambdaFunction } = props;\n\n    // Helper function to create Lambda invoke tasks\n    const createLambdaTask = (\n      stateName: string,\n      integrationPattern: sfn.IntegrationPattern = sfn.IntegrationPattern.REQUEST_RESPONSE\n    ) => {\n      const payload: Record<string, any> = {\n        'source': 'step-function',\n        'context.$': '$$',\n        'input.$': '$',\n      };\n\n      // Add task token for callback pattern\n      if (integrationPattern === sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN) {\n        payload['taskToken'] = sfn.JsonPath.taskToken;\n      }\n\n      return new tasks.LambdaInvoke(this, stateName, {\n        lambdaFunction,\n        payload: sfn.TaskInput.fromObject(payload),\n        stateName,\n        outputPath: '$.Payload[0][0]',\n        integrationPattern,\n        retryOnServiceExceptions: true,\n      });\n    };\n\n    // Define states\n    const fail = new sfn.Fail(this, 'fail', {\n      stateName: 'fail',\n      causePath: '$.cause',\n      errorPath: '$.error',\n    });\n\n    const success = new sfn.Succeed(this, 'success', {\n      stateName: 'success',\n    });\n\n    // Create task states\n    const finish = createLambdaTask('finish').next(success);\n\n    const syncData = createLambdaTask('sync_data');\n\n    // Map state for parallel data sync\n    const syncDataAll = new sfn.Map(this, 'sync_data_all', {\n      stateName: 'sync_data_all',\n      maxConcurrency: 0, // Unlimited concurrency\n      itemsPath: sfn.JsonPath.stringAt('$'),\n    })\n      .itemProcessor(syncData)\n      .next(finish);\n\n    const transformData = createLambdaTask('transform_data').next(syncDataAll);\n    const historyCopy = createLambdaTask('history_copy').next(transformData);\n    const setTtlCommand = createLambdaTask('set_ttl_command').next(historyCopy);\n\n    // Callback pattern for waiting on previous command\n    const waitPrevCommand = createLambdaTask(\n      'wait_prev_command',\n      sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN\n    ).next(setTtlCommand);\n\n    // Choice state for version checking\n    const checkVersionResult = new sfn.Choice(this, 'check_version_result', {\n      stateName: 'check_version_result',\n    })\n      .when(sfn.Condition.numberEquals('$.result', 0), setTtlCommand)\n      .when(sfn.Condition.numberEquals('$.result', 1), waitPrevCommand)\n      .when(sfn.Condition.numberEquals('$.result', -1), fail)\n      .otherwise(waitPrevCommand);\n\n    const checkVersion = createLambdaTask('check_version').next(checkVersionResult);\n\n    // Create log group\n    const logGroup = new logs.LogGroup(this, 'StateMachineLogGroup', {\n      logGroupName: '/aws/vendedlogs/states/command-handler-logs',\n      removalPolicy: cdk.RemovalPolicy.DESTROY,\n      retention: logs.RetentionDays.SIX_MONTHS,\n    });\n\n    // Create state machine\n    this.stateMachine = new sfn.StateMachine(this, 'CommandHandlerStateMachine', {\n      stateMachineName: 'command-handler',\n      comment: 'Handles command stream processing with version control',\n      definitionBody: sfn.DefinitionBody.fromChainable(checkVersion),\n      tracingEnabled: true,\n      logs: {\n        destination: logGroup,\n        level: sfn.LogLevel.ALL,\n      },\n    });\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027\u3092\u6301\u3064\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3",children:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027\u3092\u6301\u3064\u30bf\u30b9\u30af\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"export class TaskStateMachineConstruct extends Construct {\n  public readonly stateMachine: sfn.StateMachine;\n\n  constructor(scope: Construct, id: string, props: { lambdaFunction: lambda.IFunction }) {\n    super(scope, id);\n\n    const { lambdaFunction } = props;\n\n    // Iterator task for each item\n    const iteratorTask = new tasks.LambdaInvoke(this, 'iterator', {\n      lambdaFunction,\n      payload: sfn.TaskInput.fromObject({\n        'source': 'step-function',\n        'context.$': '$$',\n        'input.$': '$',\n      }),\n      stateName: 'iterator',\n      outputPath: '$.Payload[0][0]',\n    });\n\n    // Map state with concurrency limit\n    const mapState = new sfn.Map(this, 'TaskMapState', {\n      stateName: 'map_state',\n      maxConcurrency: 2, // Process 2 items at a time\n      inputPath: '$',\n      itemsPath: sfn.JsonPath.stringAt('$'),\n    }).itemProcessor(iteratorTask);\n\n    // Create log group\n    const logGroup = new logs.LogGroup(this, 'TaskLogGroup', {\n      logGroupName: '/aws/vendedlogs/states/task-handler-logs',\n      removalPolicy: cdk.RemovalPolicy.DESTROY,\n      retention: logs.RetentionDays.SIX_MONTHS,\n    });\n\n    // Create state machine\n    this.stateMachine = new sfn.StateMachine(this, 'TaskHandlerStateMachine', {\n      stateMachineName: 'task-handler',\n      comment: 'Handles parallel task execution with concurrency control',\n      definition: mapState,\n      timeout: cdk.Duration.minutes(15),\n      tracingEnabled: true,\n      logs: {\n        destination: logGroup,\n        level: sfn.LogLevel.ALL,\n      },\n    });\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"csv\u30a4\u30f3\u30dd\u30fc\u30c8\u7528\u306edistributed-map",children:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u7528\u306eDistributed Map"}),"\n",(0,s.jsx)(e.p,{children:"\u5927\u898f\u6a21CSV\u30d5\u30a1\u30a4\u30eb\u306e\u51e6\u7406\u306b\u306f\u3001\u30cd\u30a4\u30c6\u30a3\u30d6S3\u7d71\u5408\u3092\u63d0\u4f9b\u3059\u308bDistributed Map\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import { Map as SfnMap, ProcessorMode, ProcessorConfig, IChainable, JsonPath } from 'aws-cdk-lib/aws-stepfunctions';\n\n// Custom Distributed Map class for S3 CSV processing\nexport class DistributedMap extends SfnMap {\n  public itemReader?: DistributedMapItemReader;\n  public itemBatcher?: DistributedMapItemBatcher;\n  public label?: string;\n\n  public override toStateJson(): object {\n    const mapStateJson = super.toStateJson();\n    return {\n      ...mapStateJson,\n      ItemReader: this.itemReader,\n      ItemBatcher: this.itemBatcher,\n      Label: this.label,\n    };\n  }\n\n  public itemProcessor(processor: IChainable, config: ProcessorConfig = {}): DistributedMap {\n    super.itemProcessor(processor, {\n      ...config,\n      mode: ProcessorMode.DISTRIBUTED,\n    });\n    return this;\n  }\n\n  public setItemReader(itemReader: DistributedMapItemReader): DistributedMap {\n    this.itemReader = itemReader;\n    return this;\n  }\n\n  public setItemBatcher(itemBatcher: DistributedMapItemBatcher): DistributedMap {\n    this.itemBatcher = itemBatcher;\n    return this;\n  }\n\n  public setLabel(label: string): DistributedMap {\n    this.label = label;\n    return this;\n  }\n}\n\n// Usage in your stack\nconst csvRowsHandler = new tasks.LambdaInvoke(this, 'csv_rows_handler', {\n  lambdaFunction,\n  payload: sfn.TaskInput.fromObject({\n    'source': 'step-function',\n    'context.$': '$$',\n    'input.$': '$',\n  }),\n  stateName: 'csv_rows_handler',\n});\n\nconst importCsvDefinition = new DistributedMap(this, 'import-csv', {\n  maxConcurrency: 50, // Process up to 50 batches in parallel\n})\n  .setLabel('import-csv')\n  .setItemReader({\n    Resource: 'arn:aws:states:::s3:getObject',\n    ReaderConfig: {\n      InputType: 'CSV',\n      CSVHeaderLocation: 'FIRST_ROW',\n    },\n    Parameters: {\n      'Bucket.$': '$.bucket',\n      'Key.$': '$.key',\n    },\n  })\n  .setItemBatcher({\n    MaxInputBytesPerBatch: 10,\n    BatchInput: {\n      'Attributes.$': '$',\n    },\n  })\n  .itemProcessor(csvRowsHandler, {\n    executionType: sfn.ProcessorType.EXPRESS, // Use EXPRESS for child executions\n  });\n\nconst importCsvStateMachine = new sfn.StateMachine(this, 'ImportCsvStateMachine', {\n  stateMachineName: 'import-csv',\n  comment: 'Processes large CSV files with distributed batch processing',\n  definitionBody: sfn.DefinitionBody.fromChainable(importCsvDefinition),\n  tracingEnabled: true,\n});\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u8a2d\u5b9a",children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u8a2d\u5b9a"}),"\n",(0,s.jsx)(e.p,{children:"DynamoDB Streams\u3068SQS\u3092\u8a2d\u5b9a\u3057\u3066Step Functions\u3092\u30c8\u30ea\u30ac\u30fc\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// DynamoDB Stream event source\nconst tableNames = ['tasks', 'commands', 'import_tmp'];\n\nfor (const tableName of tableNames) {\n  const table = dynamodb.Table.fromTableAttributes(this, `${tableName}-table`, {\n    tableArn: `arn:aws:dynamodb:${region}:${account}:table/${prefix}${tableName}`,\n    tableStreamArn: `arn:aws:dynamodb:${region}:${account}:table/${prefix}${tableName}/stream/*`,\n  });\n\n  lambdaFunction.addEventSource(\n    new lambdaEventSources.DynamoEventSource(table, {\n      startingPosition: lambda.StartingPosition.TRIM_HORIZON,\n      batchSize: 1,\n      filters: [\n        lambda.FilterCriteria.filter({\n          eventName: lambda.FilterRule.isEqual('INSERT'),\n        }),\n      ],\n    })\n  );\n}\n\n// SQS event sources\nconst queues = ['task-action-queue', 'notification-queue', 'import-action-queue'];\n\nfor (const queueName of queues) {\n  const queue = sqs.Queue.fromQueueArn(\n    this,\n    queueName,\n    `arn:aws:sqs:${region}:${account}:${prefix}${queueName}`\n  );\n\n  lambdaFunction.addEventSource(\n    new lambdaEventSources.SqsEventSource(queue, {\n      batchSize: 1,\n    })\n  );\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5b9f\u88c5\u30ac\u30a4\u30c9",children:"\u5b9f\u88c5\u30ac\u30a4\u30c9"}),"\n",(0,s.jsx)(e.h3,{id:"\u30b9\u30c6\u30c3\u30d71\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7",children:"\u30b9\u30c6\u30c3\u30d71\uff1a\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u306e\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306fAWS CDK\u3092\u4f7f\u7528\u3057\u3066Step Functions\u30a4\u30f3\u30d5\u30e9\u30b9\u30c8\u30e9\u30af\u30c1\u30e3\u3092\u81ea\u52d5\u7684\u306b\u30d7\u30ed\u30d3\u30b8\u30e7\u30cb\u30f3\u30b0\u3057\u307e\u3059\u3002\u4e3b\u8981\u306a\u30ea\u30bd\u30fc\u30b9\u306f\u4ee5\u4e0b\u306e\u901a\u308a\u3067\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// State machine definition in CDK\nconst commandStateMachine = new sfn.StateMachine(this, 'CommandHandler', {\n  stateMachineName: 'command',\n  definitionBody: sfn.DefinitionBody.fromChainable(definition),\n  timeout: Duration.minutes(15),\n  tracingEnabled: true,\n  logs: {\n    destination: logGroup,\n    level: sfn.LogLevel.ALL,\n  },\n});\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30b9\u30c6\u30c3\u30d72step-function\u30a4\u30d9\u30f3\u30c8\u306e\u5b9a\u7fa9",children:"\u30b9\u30c6\u30c3\u30d72\uff1aStep Function\u30a4\u30d9\u30f3\u30c8\u306e\u5b9a\u7fa9"}),"\n",(0,s.jsx)(e.p,{children:"\u57fa\u672c\u306eStep Function\u30a4\u30d9\u30f3\u30c8\u3092\u62e1\u5f35\u3059\u308b\u30a4\u30d9\u30f3\u30c8\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import { IEvent } from '@mbc-cqrs-serverless/core';\nimport { StepFunctionsContext } from '@mbc-cqrs-serverless/core';\n\nexport class CustomWorkflowEvent implements IEvent {\n  source: string;\n  context: StepFunctionsContext;\n  input?: WorkflowInput;\n  taskToken?: string;\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30b9\u30c6\u30c3\u30d73\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5",children:"\u30b9\u30c6\u30c3\u30d73\uff1a\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5b9f\u88c5"}),"\n",(0,s.jsx)(e.p,{children:"Step Function\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406\u3059\u308b\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import { EventHandler, IEventHandler } from '@mbc-cqrs-serverless/core';\nimport { Logger } from '@nestjs/common';\n\n@EventHandler(CustomWorkflowEvent)\nexport class CustomWorkflowHandler implements IEventHandler<CustomWorkflowEvent> {\n  private readonly logger = new Logger(CustomWorkflowHandler.name);\n\n  async execute(event: CustomWorkflowEvent): Promise<StepStateOutput> {\n    const stateName = event.context.State.Name;\n\n    switch (stateName) {\n      case 'initialize':\n        return this.handleInitialize(event);\n      case 'process':\n        return this.handleProcess(event);\n      case 'finalize':\n        return this.handleFinalize(event);\n      default:\n        throw new Error(`Unknown state: ${stateName}`);\n    }\n  }\n\n  private async handleInitialize(event: CustomWorkflowEvent) {\n    // Initialization logic\n    return { status: 'initialized', data: event.input };\n  }\n\n  private async handleProcess(event: CustomWorkflowEvent) {\n    // Processing logic\n    return { status: 'processed' };\n  }\n\n  private async handleFinalize(event: CustomWorkflowEvent) {\n    // Finalization logic\n    return { status: 'completed' };\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30b9\u30c6\u30c3\u30d74\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u8a2d\u5b9a",children:"\u30b9\u30c6\u30c3\u30d74\uff1a\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u8a2d\u5b9a"}),"\n",(0,s.jsx)(e.p,{children:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306bStep Function\u30a4\u30d9\u30f3\u30c8\u3092\u767b\u9332\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import { EventFactory, IEvent, StepFunctionsEvent } from '@mbc-cqrs-serverless/core';\n\n@EventFactory()\nexport class CustomEventFactory {\n  async transformStepFunction(event: StepFunctionsEvent<any>): Promise<IEvent[]> {\n    const stateMachineName = event.context.StateMachine.Name;\n\n    if (stateMachineName.includes('custom-workflow')) {\n      return [new CustomWorkflowEvent(event)];\n    }\n\n    return [];\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30b9\u30c6\u30c3\u30d75\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9f\u884c\u306e\u30c8\u30ea\u30ac\u30fc",children:"\u30b9\u30c6\u30c3\u30d75\uff1a\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9f\u884c\u306e\u30c8\u30ea\u30ac\u30fc"}),"\n",(0,s.jsx)(e.p,{children:"\u30b5\u30fc\u30d3\u30b9\u304b\u3089\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9f\u884c\u3092\u958b\u59cb\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import { StepFunctionService } from '@mbc-cqrs-serverless/core';\nimport { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class WorkflowService {\n  constructor(private readonly sfnService: StepFunctionService) {}\n\n  async startWorkflow(input: WorkflowInput): Promise<string> {\n    const executionArn = await this.sfnService.startExecution({\n      stateMachineArn: process.env.WORKFLOW_STATE_MACHINE_ARN,\n      input: JSON.stringify(input),\n      name: `workflow-${Date.now()}`,\n    });\n\n    return executionArn;\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9"}),"\n",(0,s.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b91\u30c7\u30fc\u30bf\u540c\u671f",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b91\uff1a\u30c7\u30fc\u30bf\u540c\u671f"}),"\n",(0,s.jsx)(e.p,{children:"\u30d0\u30fc\u30b8\u30e7\u30f3\u7ba1\u7406\u3068\u7af6\u5408\u89e3\u6c7a\u3092\u4f34\u3046\u8907\u6570\u30c6\u30fc\u30d6\u30eb\u9593\u306e\u30c7\u30fc\u30bf\u540c\u671f\u3002"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u30b7\u30ca\u30ea\u30aa"}),": \u30b3\u30de\u30f3\u30c9\u304c\u4f5c\u6210\u3055\u308c\u308b\u3068\u3001\u30c7\u30fc\u30bf\u3092\u8907\u6570\u306e\u30ea\u30fc\u30c9\u30e2\u30c7\u30eb\u306b\u540c\u671f\u3057\u307e\u3059\u3002"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Trigger: DynamoDB Stream INSERT event\n// Flow: check_version -> set_ttl -> history_copy -> transform -> sync_all -> finish\n\nawait this.commandService.publishAsync(\n  {\n    pk: 'TENANT#tenant1',\n    sk: 'ORDER#order123',\n    id: 'order-uuid',\n    code: 'order123',\n    name: 'Order',\n    type: 'ORDER',\n    version: 1,\n    tenantCode: 'tenant1',\n    attributes: { status: 'confirmed', total: 1000 },\n  },\n  { invokeContext },\n);\n// This triggers the command state machine automatically\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b92\u30d0\u30c3\u30c1\u30bf\u30b9\u30af\u51e6\u7406",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b92\uff1a\u30d0\u30c3\u30c1\u30bf\u30b9\u30af\u51e6\u7406"}),"\n",(0,s.jsx)(e.p,{children:"\u5236\u5fa1\u3055\u308c\u305f\u4e26\u884c\u6027\u3067\u8907\u6570\u306e\u95a2\u9023\u30bf\u30b9\u30af\u3092\u4e26\u5217\u5b9f\u884c\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u30b7\u30ca\u30ea\u30aa"}),": \u30b9\u30c6\u30fc\u30bf\u30b9\u8ffd\u8de1\u3092\u4f34\u3046\u30d0\u30c3\u30c1\u30b8\u30e7\u30d6\u3067\u8907\u6570\u306e\u30a2\u30a4\u30c6\u30e0\u3092\u51e6\u7406\u3057\u307e\u3059\u3002"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Create tasks that will be processed by the task state machine\nconst items = [\n  { itemId: 'item1', action: 'process' },\n  { itemId: 'item2', action: 'process' },\n  { itemId: 'item3', action: 'process' },\n];\n\nawait this.taskService.createStepFunctionTask({\n  input: items,\n  taskType: 'batch-processor',\n  tenantCode: 'tenant1',\n}, { invokeContext });\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b93\u5927\u898f\u6a21csv\u30a4\u30f3\u30dd\u30fc\u30c8",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b93\uff1a\u5927\u898f\u6a21CSV\u30a4\u30f3\u30dd\u30fc\u30c8"}),"\n",(0,s.jsx)(e.p,{children:"\u5206\u6563\u51e6\u7406\u3067CSV\u30d5\u30a1\u30a4\u30eb\u304b\u3089\u6570\u767e\u4e07\u884c\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u30b7\u30ca\u30ea\u30aa"}),": \u30d0\u30ea\u30c7\u30fc\u30b7\u30e7\u30f3\u3068\u5909\u63db\u3092\u4f34\u3046S3\u304b\u3089\u306e\u5927\u898f\u6a21CSV\u30d5\u30a1\u30a4\u30eb\u306e\u30a4\u30f3\u30dd\u30fc\u30c8\u3002"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Trigger CSV import via API or direct invocation\nawait this.importService.createCsvImport({\n  s3Bucket: 'my-bucket',\n  s3Key: 'imports/data.csv',\n  tableName: 'products',\n  processingMode: ProcessingMode.STEP_FUNCTION,\n});\n\n// The import-csv state machine will:\n// 1. Read CSV from S3\n// 2. Batch rows (default: 10 per batch)\n// 3. Process up to 50 batches concurrently\n// 4. Transform and validate each row\n// 5. Create import commands\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b94\u975e\u540c\u671f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b94\uff1a\u975e\u540c\u671f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u3066\u5916\u90e8\u30a4\u30d9\u30f3\u30c8\u3092\u5f85\u6a5f\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u30b7\u30ca\u30ea\u30aa"}),": \u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u7d9a\u884c\u3059\u308b\u524d\u306b\u627f\u8a8d\u3092\u5f85\u6a5f\u3057\u307e\u3059\u3002"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:'// In your state machine definition\n{\n  "WaitForApproval": {\n    "Type": "Task",\n    "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",\n    "Parameters": {\n      "FunctionName": "${LambdaFunction}",\n      "Payload": {\n        "taskToken.$": "$$.Task.Token",\n        "requestId.$": "$.requestId"\n      }\n    },\n    "Next": "ProcessApproval"\n  }\n}\n\n// In your handler, store the task token\nasync handleWaitForApproval(event: ApprovalEvent) {\n  await this.approvalService.createApprovalRequest({\n    requestId: event.input.requestId,\n    taskToken: event.taskToken, // Store for later callback\n  });\n}\n\n// When approval is received, resume the workflow\nasync approveRequest(requestId: string) {\n  const request = await this.approvalService.getRequest(requestId);\n\n  await this.sfnService.sendTaskSuccess({\n    taskToken: request.taskToken,\n    output: JSON.stringify({ approved: true }),\n  });\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3",children:"\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u3001\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u8abf\u6574\u3068\u5916\u90e8\u30a4\u30d9\u30f3\u30c8\u306e\u5f85\u6a5f\u306e\u305f\u3081\u306b\u3001AWS Step Functions\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u305f\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u3092\u5b9f\u88c5\u3057\u3066\u3044\u307e\u3059\u3002"}),"\n",(0,s.jsx)(e.h3,{id:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306e\u4ed5\u7d44\u307f",children:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306e\u4ed5\u7d44\u307f"}),"\n",(0,s.jsxs)(e.p,{children:["Step Function\u306e\u72b6\u614b\u304c",(0,s.jsx)(e.code,{children:"WAIT_FOR_TASK_TOKEN"}),"\u7d71\u5408\u30d1\u30bf\u30fc\u30f3\u3092\u4f7f\u7528\u3059\u308b\u3068\u3001\u5916\u90e8\u30d7\u30ed\u30bb\u30b9\u304c\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3068\u3068\u3082\u306b\u6210\u529f\u307e\u305f\u306f\u5931\u6557\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u9001\u4fe1\u3059\u308b\u307e\u3067\u5b9f\u884c\u304c\u4e00\u6642\u505c\u6b62\u3057\u307e\u3059\u3002"]}),"\n",(0,s.jsx)(e.mermaid,{value:"sequenceDiagram\n    participant SFN as Step Functions\n    participant Lambda\n    participant DDB as DynamoDB\n    participant External as External Process\n\n    SFN->>Lambda: Invoke with taskToken\n    Lambda->>DDB: Store taskToken\n    Lambda--\x3e>SFN: Return (execution pauses)\n    Note over SFN: Waiting for callback...\n    External->>Lambda: Trigger callback\n    Lambda->>DDB: Retrieve taskToken\n    Lambda->>SFN: SendTaskSuccess(taskToken)\n    Note over SFN: Execution resumes\n    SFN->>Lambda: Continue to next state"}),"\n",(0,s.jsx)(e.h3,{id:"stepfunctionservice\u5b9f\u88c5",children:"StepFunctionService\u5b9f\u88c5"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"StepFunctionService"}),"\u306f\u3001\u5b9f\u884c\u306e\u958b\u59cb\u3068\u4e00\u6642\u505c\u6b62\u3057\u305f\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306e\u518d\u958b\u306e\u305f\u3081\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u63d0\u4f9b\u3057\u307e\u3059\uff1a"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"import {\n  SFNClient,\n  SendTaskSuccessCommand,\n  StartExecutionCommand,\n} from '@aws-sdk/client-sfn';\n\n@Injectable()\nexport class StepFunctionService {\n  private readonly client: SFNClient;\n\n  constructor(private readonly config: ConfigService) {\n    this.client = new SFNClient({\n      endpoint: config.get<string>('SFN_ENDPOINT'),\n      region: config.get<string>('SFN_REGION'),\n    });\n  }\n\n  // Start a new state machine execution (\u65b0\u3057\u3044\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9f\u884c\u3092\u958b\u59cb)\n  startExecution(arn: string, input: any, name?: string) {\n    return this.client.send(\n      new StartExecutionCommand({\n        stateMachineArn: arn,\n        name: name && name.length <= 80 ? name : undefined,\n        input: JSON.stringify(input),\n      }),\n    );\n  }\n\n  // Resume a paused execution using task token (\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u3066\u4e00\u6642\u505c\u6b62\u3057\u305f\u5b9f\u884c\u3092\u518d\u958b)\n  async resumeExecution(taskToken: string, output: any = {}) {\n    // Wrap output in the expected format for Lambda integration (Lambda\u7d71\u5408\u306e\u671f\u5f85\u3055\u308c\u308b\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u51fa\u529b\u3092\u30e9\u30c3\u30d7)\n    const wrappedOutput = {\n      Payload: [[output]],\n    };\n\n    return await this.client.send(\n      new SendTaskSuccessCommand({\n        taskToken: taskToken,\n        output: JSON.stringify(wrappedOutput),\n      }),\n    );\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30d0\u30fc\u30b8\u30e7\u30f3\u30d9\u30fc\u30b9\u306e\u30b3\u30de\u30f3\u30c9\u30c1\u30a7\u30fc\u30f3",children:"\u30d0\u30fc\u30b8\u30e7\u30f3\u30d9\u30fc\u30b9\u306e\u30b3\u30de\u30f3\u30c9\u30c1\u30a7\u30fc\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u30b3\u30de\u30f3\u30c9\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306f\u3001\u30b3\u30de\u30f3\u30c9\u304c\u30d0\u30fc\u30b8\u30e7\u30f3\u9806\u306b\u51e6\u7406\u3055\u308c\u308b\u3053\u3068\u3092\u4fdd\u8a3c\u3059\u308b\u305f\u3081\u306b\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Wait for previous command to complete using task token (\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4f7f\u7528\u3057\u3066\u524d\u306e\u30b3\u30de\u30f3\u30c9\u306e\u5b8c\u4e86\u3092\u5f85\u6a5f)\nprotected async waitConfirmToken(\n  event: DataSyncCommandSfnEvent,\n): Promise<StepFunctionStateInput> {\n  // Store task token in DynamoDB for later callback (\u5f8c\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u305f\u3081\u306b\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092DynamoDB\u306b\u4fdd\u5b58)\n  await this.commandService.updateTaskToken(event.commandKey, event.taskToken);\n  return {\n    result: {\n      token: event.taskToken,\n    },\n  };\n}\n\n// When a command finishes, check if next version is waiting (\u30b3\u30de\u30f3\u30c9\u304c\u7d42\u4e86\u3057\u305f\u3089\u3001\u6b21\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u5f85\u6a5f\u4e2d\u304b\u30c1\u30a7\u30c3\u30af)\nprotected async checkNextToken(\n  event: DataSyncCommandSfnEvent,\n): Promise<StepFunctionStateInput> {\n  const nextCommand = await this.commandService.getNextCommand(\n    event.commandKey,\n  );\n\n  if (!nextCommand) {\n    return null; // No next command, chain ends (\u6b21\u306e\u30b3\u30de\u30f3\u30c9\u306a\u3057\u3001\u30c1\u30a7\u30fc\u30f3\u7d42\u4e86)\n  }\n\n  if (nextCommand.taskToken) {\n    // Resume the waiting command (\u5f85\u6a5f\u4e2d\u306e\u30b3\u30de\u30f3\u30c9\u3092\u518d\u958b)\n    try {\n      await this.sfnService.resumeExecution(nextCommand.taskToken, {\n        result: 'resumed_by_prev_version',\n        prevVersion: event.commandRecord.version,\n      });\n    } catch (e) {\n      this.logger.warn(\n        `Could not resume command v${nextCommand.version}: ${e.message}`,\n      );\n    }\n  }\n\n  return null;\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306ecdk\u8a2d\u5b9a",children:"\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u30d1\u30bf\u30fc\u30f3\u306eCDK\u8a2d\u5b9a"}),"\n",(0,s.jsx)(e.p,{children:"CDK\u30b9\u30bf\u30c3\u30af\u3067\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u5f85\u6a5f\u3059\u308b\u72b6\u614b\u3092\u8a2d\u5b9a\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Create a state that waits for callback (\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3092\u5f85\u6a5f\u3059\u308b\u72b6\u614b\u3092\u4f5c\u6210)\nconst waitPrevCommand = new tasks.LambdaInvoke(this, 'wait_prev_command', {\n  lambdaFunction,\n  payload: sfn.TaskInput.fromObject({\n    'input.$': '$',\n    'context.$': '$$',\n    'taskToken': sfn.JsonPath.taskToken, // Include task token in payload (\u30da\u30a4\u30ed\u30fc\u30c9\u306b\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u542b\u3081\u308b)\n  }),\n  stateName: 'wait_prev_command',\n  outputPath: '$.Payload[0][0]',\n  // Use WAIT_FOR_TASK_TOKEN integration pattern (WAIT_FOR_TASK_TOKEN\u7d71\u5408\u30d1\u30bf\u30fc\u30f3\u3092\u4f7f\u7528)\n  integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,\n});\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6226\u7565",children:"\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u6226\u7565"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u3001\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u51e6\u7406\u3059\u308b\u305f\u3081\u306e\u3044\u304f\u3064\u304b\u306e\u6226\u7565\u3092\u63d0\u4f9b\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.h3,{id:"zip\u30a4\u30f3\u30dd\u30fc\u30c8\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3",children:"ZIP\u30a4\u30f3\u30dd\u30fc\u30c8\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,s.jsx)(e.p,{children:"\u8907\u96d1\u306a\u30de\u30eb\u30c1\u30d5\u30a1\u30a4\u30eb\u30a4\u30f3\u30dd\u30fc\u30c8\u306e\u5834\u5408\u3001\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u968e\u5c64\u7684\u306a\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u30d1\u30bf\u30fc\u30f3\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.mermaid,{value:'flowchart TB\n    subgraph ZipOrchestrator["ZIP Orchestrator State Machine"]\n        A[Start] --\x3e B[Extract ZIP]\n        B --\x3e C[Map: Process Each CSV]\n        C --\x3e D1[CSV 1: trigger_single_csv_and_wait]\n        C --\x3e D2[CSV 2: trigger_single_csv_and_wait]\n        C --\x3e D3[CSV N: trigger_single_csv_and_wait]\n        D1 --\x3e E[finalize_zip_job]\n        D2 --\x3e E\n        D3 --\x3e E\n        E --\x3e F[End]\n    end\n\n    subgraph CsvStateMachine["CSV State Machine (per file)"]\n        G[csv_loader] --\x3e H[Distributed Map]\n        H --\x3e I[csv_rows_handler x N]\n        I --\x3e J[finalize_parent_job]\n    end\n\n    D1 -.->|taskToken| G\n    J -.->|SendTaskSuccess| D1'}),"\n",(0,s.jsx)(e.h3,{id:"\u5b50\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3078\u306e\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u4f1d\u64ad",children:"\u5b50\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3078\u306e\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u4f1d\u64ad"}),"\n",(0,s.jsx)(e.p,{children:"\u5b50\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u30c8\u30ea\u30ac\u30fc\u3059\u308b\u969b\u3001\u89aa\u306f\u5f8c\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u306e\u305f\u3081\u306b\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3092\u4fdd\u5b58\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Trigger a child CSV job and wait for completion (\u5b50CSV\u30b8\u30e7\u30d6\u3092\u30c8\u30ea\u30ac\u30fc\u3057\u3001\u5b8c\u4e86\u3092\u5f85\u6a5f)\nprivate async triggerSingleCsvJob(event: ZipImportSfnEvent) {\n  const s3Key = event.input?.s3Key || event.input;\n  const { taskToken } = event; // Task token from parent workflow (\u89aa\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u304b\u3089\u306e\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3)\n  const { masterJobKey, parameters } = event.context.Execution.Input;\n\n  // Create CSV job with stored task token (\u4fdd\u5b58\u3055\u308c\u305f\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u3067CSV\u30b8\u30e7\u30d6\u3092\u4f5c\u6210)\n  await this.importService.createCsvJobWithTaskToken(\n    {\n      processingMode: ProcessingMode.STEP_FUNCTION,\n      bucket: parameters.bucket,\n      key: s3Key,\n      tenantCode: parameters.tenantCode,\n      tableName: tableName,\n    },\n    taskToken, // Store for callback when CSV processing completes (CSV\u51e6\u7406\u5b8c\u4e86\u6642\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u7528\u306b\u4fdd\u5b58)\n    masterJobKey,\n  );\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u8a2d\u5b9a",children:"\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u8a2d\u5b9a"}),"\n",(0,s.jsx)(e.p,{children:"\u9577\u6642\u9593\u5b9f\u884c\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u306b\u9069\u5207\u306a\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const taskStateMachine = new sfn.StateMachine(this, 'task-handler', {\n  stateMachineName: 'task-handler',\n  definition: sfnTaskMapState,\n  timeout: cdk.Duration.minutes(15), // Overall workflow timeout (\u5168\u4f53\u306e\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8)\n  tracingEnabled: true,\n  logs: {\n    destination: logGroup,\n    level: sfn.LogLevel.ALL,\n  },\n});\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u30a4\u30f3\u30dd\u30fc\u30c8\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3\u3068\u306e\u7d71\u5408",children:"\u30a4\u30f3\u30dd\u30fc\u30c8/\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3\u3068\u306e\u7d71\u5408"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u3001\u30b9\u30b1\u30fc\u30e9\u30d6\u30eb\u306a\u30c7\u30fc\u30bf\u51e6\u7406\u306e\u305f\u3081\u306bStep Functions\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u30e2\u30b8\u30e5\u30fc\u30eb\u3068\u7d71\u5408\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.h3,{id:"csv\u30a4\u30f3\u30dd\u30fc\u30c8\u30d5\u30ed\u30fc",children:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u30d5\u30ed\u30fc"}),"\n",(0,s.jsx)(e.p,{children:"CSV\u30a4\u30f3\u30dd\u30fc\u30c8\u306f\u3001Step Functions\u3092\u4f7f\u7528\u3057\u305f2\u30d5\u30a7\u30fc\u30ba\u30a2\u30d7\u30ed\u30fc\u30c1\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Phase 1: Create import job and trigger Step Function (\u30d5\u30a7\u30fc\u30ba1\uff1a\u30a4\u30f3\u30dd\u30fc\u30c8\u30b8\u30e7\u30d6\u3092\u4f5c\u6210\u3057Step Function\u3092\u30c8\u30ea\u30ac\u30fc)\nasync handleCsvImport(\n  dto: CreateCsvImportDto,\n  options: ICommandOptions,\n): Promise<ImportEntity[] | ImportEntity> {\n  if (dto.processingMode === 'DIRECT') {\n    // Process directly in Lambda (for small files) (\u5c0f\u3055\u306a\u30d5\u30a1\u30a4\u30eb\u306e\u5834\u5408\u3001Lambda\u3067\u76f4\u63a5\u51e6\u7406)\n    return this._processCsvDirectly(dto, options);\n  } else {\n    // Create job and let Step Function handle processing (\u30b8\u30e7\u30d6\u3092\u4f5c\u6210\u3057\u3001Step Function\u306b\u51e6\u7406\u3092\u4efb\u305b\u308b)\n    return this.createCsvJob(dto, options);\n  }\n}\n\n// Phase 2: Step Function handler processes rows (\u30d5\u30a7\u30fc\u30ba2\uff1aStep Function\u30cf\u30f3\u30c9\u30e9\u30fc\u304c\u884c\u3092\u51e6\u7406)\n@EventHandler(CsvImportSfnEvent)\nexport class CsvImportSfnEventHandler {\n  async handleStepState(event: CsvImportSfnEvent): Promise<any> {\n    if (event.context.State.Name === 'csv_loader') {\n      // Count total rows and initialize job (\u5408\u8a08\u884c\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3057\u3001\u30b8\u30e7\u30d6\u3092\u521d\u671f\u5316)\n      const totalRows = await this.countCsvRows(input);\n      await this.importService.updateImportJob(parentKey, {\n        set: { totalRows },\n      });\n      return this.loadCsv(input);\n    }\n\n    if (event.context.State.Name === 'finalize_parent_job') {\n      return this.finalizeParentJob(event);\n    }\n\n    // Process batch of rows (\u884c\u306e\u30d0\u30c3\u30c1\u3092\u51e6\u7406)\n    const items = event.input.Items;\n    for (const item of items) {\n      const transformedData = await strategy.transform(item);\n      await strategy.validate(transformedData);\n      await this.importService.createImport(createImportDto, options);\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30a2\u30c8\u30df\u30c3\u30af\u30ab\u30a6\u30f3\u30bf\u30fc\u306b\u3088\u308b\u9032\u6357\u8ffd\u8de1",children:"\u30a2\u30c8\u30df\u30c3\u30af\u30ab\u30a6\u30f3\u30bf\u30fc\u306b\u3088\u308b\u9032\u6357\u8ffd\u8de1"}),"\n",(0,s.jsx)(e.p,{children:"\u30a4\u30f3\u30dd\u30fc\u30c8\u30b5\u30fc\u30d3\u30b9\u306f\u3001\u6b63\u78ba\u306a\u9032\u6357\u8ffd\u8de1\u306e\u305f\u3081\u306bDynamoDB\u306e\u30a2\u30c8\u30df\u30c3\u30af\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Atomically increment progress counters (\u9032\u6357\u30ab\u30a6\u30f3\u30bf\u30fc\u3092\u30a2\u30c8\u30df\u30c3\u30af\u306b\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8)\nasync incrementParentJobCounters(\n  parentKey: DetailKey,\n  childSucceeded: boolean,\n): Promise<ImportEntity> {\n  const countersToIncrement: { [key: string]: number } = {\n    processedRows: 1,\n  };\n  if (childSucceeded) {\n    countersToIncrement.succeededRows = 1;\n  } else {\n    countersToIncrement.failedRows = 1;\n  }\n\n  // Use atomic update expression (\u30a2\u30c8\u30df\u30c3\u30af\u66f4\u65b0\u5f0f\u3092\u4f7f\u7528)\n  const command = new UpdateItemCommand({\n    TableName: this.tableName,\n    Key: marshall(parentKey),\n    UpdateExpression: 'SET #processedRows = if_not_exists(#processedRows, :start) + :inc',\n    ExpressionAttributeNames: { '#processedRows': 'processedRows' },\n    ExpressionAttributeValues: marshall({ ':start': 0, ':inc': 1 }),\n    ReturnValues: 'ALL_NEW',\n  });\n\n  const response = await this.dynamoDbService.client.send(command);\n  const updatedEntity = unmarshall(response.Attributes) as ImportEntity;\n\n  // Check if job is complete and update final status (\u30b8\u30e7\u30d6\u304c\u5b8c\u4e86\u3057\u305f\u304b\u30c1\u30a7\u30c3\u30af\u3057\u3001\u6700\u7d42\u30b9\u30c6\u30fc\u30bf\u30b9\u3092\u66f4\u65b0)\n  if (updatedEntity.totalRows > 0 && updatedEntity.processedRows >= updatedEntity.totalRows) {\n    const finalStatus = updatedEntity.failedRows > 0\n      ? ImportStatusEnum.FAILED\n      : ImportStatusEnum.COMPLETED;\n    await this.updateStatus(parentKey, finalStatus);\n  }\n\n  return updatedEntity;\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u51e6\u7406\u30e2\u30fc\u30c9\u306e\u9078\u629e",children:"\u51e6\u7406\u30e2\u30fc\u30c9\u306e\u9078\u629e"}),"\n",(0,s.jsx)(e.p,{children:"\u30c7\u30fc\u30bf\u30b5\u30a4\u30ba\u306b\u57fa\u3065\u3044\u3066\u9069\u5207\u306a\u51e6\u7406\u30e2\u30fc\u30c9\u3092\u9078\u629e\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u51e6\u7406\u30e2\u30fc\u30c9"}),(0,s.jsx)(e.th,{children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9"}),(0,s.jsx)(e.th,{children:"\u6700\u5927\u884c\u6570"}),(0,s.jsx)(e.th,{children:"\u4e26\u884c\u6027"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"DIRECT"})}),(0,s.jsx)(e.td,{children:"\u5c0f\u3055\u306a\u30d5\u30a1\u30a4\u30eb\u3001\u5373\u6642\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af"}),(0,s.jsx)(e.td,{children:"~1,000"}),(0,s.jsx)(e.td,{children:"\u5358\u4e00Lambda"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:(0,s.jsx)(e.code,{children:"STEP_FUNCTION"})}),(0,s.jsx)(e.td,{children:"\u5927\u304d\u306a\u30d5\u30a1\u30a4\u30eb\u3001\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u51e6\u7406"}),(0,s.jsx)(e.td,{children:"\u6570\u767e\u4e07"}),(0,s.jsx)(e.td,{children:"\u6700\u592750"})]})]})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Example: Selecting processing mode based on file size (\u4f8b\uff1a\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u306b\u57fa\u3065\u304f\u51e6\u7406\u30e2\u30fc\u30c9\u306e\u9078\u629e)\nconst processingMode = estimatedRows > 1000\n  ? ProcessingMode.STEP_FUNCTION\n  : ProcessingMode.DIRECT;\n\nawait importService.handleCsvImport({\n  bucket: 'my-bucket',\n  key: 'data/large-file.csv',\n  tableName: 'products',\n  tenantCode: 'tenant1',\n  processingMode,\n}, { invokeContext });\n"})}),"\n",(0,s.jsx)(e.h2,{id:"step-functions\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8",children:"Step Functions\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8"}),"\n",(0,s.jsx)(e.p,{children:"\u3059\u3079\u3066\u306eStep Function\u30a4\u30d9\u30f3\u30c8\u306b\u306f\u3001\u5b9f\u884c\u306b\u95a2\u3059\u308b\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u60c5\u5831\u304c\u542b\u307e\u308c\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"interface StepFunctionsContext {\n  Execution: {\n    Id: string;        // Execution ARN\n    Input: object;     // Original input\n    Name: string;      // Execution name\n    RoleArn: string;   // IAM role\n    StartTime: string; // ISO timestamp\n  };\n  State: {\n    EnteredTime: string; // When this state started\n    Name: string;        // Current state name\n    RetryCount: number;  // Retry attempt number\n  };\n  StateMachine: {\n    Id: string;   // State machine ARN\n    Name: string; // State machine name\n  };\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",children:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0"}),"\n",(0,s.jsx)(e.p,{children:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306b\u5805\u7262\u306a\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3092\u5b9f\u88c5\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.h3,{id:"\u30cf\u30f3\u30c9\u30e9\u30fc\u30ec\u30d9\u30eb\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",children:"\u30cf\u30f3\u30c9\u30e9\u30fc\u30ec\u30d9\u30eb\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u3001Step Function\u30cf\u30f3\u30c9\u30e9\u30fc\u7528\u306e\u7d44\u307f\u8fbc\u307f\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u30d1\u30bf\u30fc\u30f3\u3092\u63d0\u4f9b\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Command event handler with status tracking and error handling (\u30b9\u30c6\u30fc\u30bf\u30b9\u8ffd\u8de1\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3092\u5099\u3048\u305f\u30b3\u30de\u30f3\u30c9\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc)\n@Injectable()\nexport class CommandEventHandler {\n  async execute(\n    event: DataSyncCommandSfnEvent,\n  ): Promise<StepFunctionStateInput | StepFunctionStateInput[]> {\n    // Update status to STARTED before processing (\u51e6\u7406\u524d\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u3092STARTED\u306b\u66f4\u65b0)\n    await this.commandService.updateStatus(\n      event.commandKey,\n      getCommandStatus(event.stepStateName, CommandStatus.STATUS_STARTED),\n      event.commandRecord.requestId,\n    );\n\n    try {\n      const ret = await this.handleStepState(event);\n      // Update status to FINISHED on success (\u6210\u529f\u6642\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u3092FINISHED\u306b\u66f4\u65b0)\n      await this.commandService.updateStatus(\n        event.commandKey,\n        getCommandStatus(event.stepStateName, CommandStatus.STATUS_FINISHED),\n        event.commandRecord.requestId,\n      );\n      return ret;\n    } catch (error) {\n      // Update status to FAILED and publish alarm on error (\u30a8\u30e9\u30fc\u6642\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u3092FAILED\u306b\u66f4\u65b0\u3057\u30a2\u30e9\u30fc\u30e0\u3092\u767a\u884c)\n      await this.commandService.updateStatus(\n        event.commandKey,\n        getCommandStatus(event.stepStateName, CommandStatus.STATUS_FAILED),\n        event.commandRecord.requestId,\n      );\n      await this.publishAlarm(event, (error as Error).stack);\n      throw error;\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u7d99\u7d9a\u3092\u4f34\u3046\u30bf\u30b9\u30af\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",children:"\u7d99\u7d9a\u3092\u4f34\u3046\u30bf\u30b9\u30af\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0"}),"\n",(0,s.jsx)(e.p,{children:"\u30bf\u30b9\u30af\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u5834\u5408\u3001\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u30a8\u30e9\u30fc\u5f8c\u3082\u5b9f\u884c\u3092\u7d99\u7d9a\u3059\u308b\u3053\u3068\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Task handler with error handling that allows workflow continuation (\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u7d99\u7d9a\u3092\u8a31\u53ef\u3059\u308b\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u4ed8\u304d\u30bf\u30b9\u30af\u30cf\u30f3\u30c9\u30e9\u30fc)\n@EventHandler(StepFunctionTaskEvent)\nexport class TaskSfnEventHandler implements IEventHandler<StepFunctionTaskEvent> {\n  async execute(event: StepFunctionTaskEvent): Promise<any> {\n    const taskKey = event.taskKey;\n\n    try {\n      await this.taskService.updateSubTaskStatus(taskKey, TaskStatusEnum.PROCESSING);\n      const events = await this.eventFactory.transformStepFunctionTask(event);\n      const result = await Promise.all(\n        events.map((event) => this.eventBus.execute(event)),\n      );\n      // Update status to COMPLETED on success (\u6210\u529f\u6642\u306b\u30b9\u30c6\u30fc\u30bf\u30b9\u3092COMPLETED\u306b\u66f4\u65b0)\n      await this.taskService.updateSubTaskStatus(taskKey, TaskStatusEnum.COMPLETED, {\n        result,\n      });\n    } catch (error) {\n      // Update status to FAILED and publish alarm, but don't throw (\u30b9\u30c6\u30fc\u30bf\u30b9\u3092FAILED\u306b\u66f4\u65b0\u3057\u30a2\u30e9\u30fc\u30e0\u3092\u767a\u884c\u3059\u308b\u304c\u3001\u30b9\u30ed\u30fc\u3057\u306a\u3044)\n      this.logger.error(error);\n      await Promise.all([\n        this.taskService.updateSubTaskStatus(taskKey, TaskStatusEnum.FAILED, {\n          error: (error as Error).stack,\n        }),\n        this.taskService.publishAlarm(event, (error as Error).stack),\n      ]);\n      // Note: Error is not re-thrown to allow Step Function to continue (\u6ce8\uff1aStep Function\u306e\u7d99\u7d9a\u3092\u8a31\u53ef\u3059\u308b\u305f\u3081\u30a8\u30e9\u30fc\u306f\u518d\u30b9\u30ed\u30fc\u3057\u306a\u3044)\n      // throw error // Uncomment to fail the entire workflow on error (\u30a8\u30e9\u30fc\u6642\u306b\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u5168\u4f53\u3092\u5931\u6557\u3055\u305b\u308b\u5834\u5408\u306f\u30b3\u30e1\u30f3\u30c8\u89e3\u9664)\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30a2\u30e9\u30fc\u30e0\u767a\u884c",children:"\u30a2\u30e9\u30fc\u30e0\u767a\u884c"}),"\n",(0,s.jsx)(e.p,{children:"\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u3001\u76e3\u8996\u3068\u30a2\u30e9\u30fc\u30c8\u306e\u305f\u3081\u306bSNS\u306b\u30a2\u30e9\u30fc\u30e0\u3092\u767a\u884c\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"// Publish alarm notification to SNS topic (SNS\u30c8\u30d4\u30c3\u30af\u306b\u30a2\u30e9\u30fc\u30e0\u901a\u77e5\u3092\u767a\u884c)\nasync publishAlarm(\n  event: DataSyncCommandSfnEvent,\n  errorDetails: any,\n): Promise<void> {\n  const alarm: INotification = {\n    action: 'sfn-alarm',\n    id: `${event.commandKey.pk}#${event.commandKey.sk}`,\n    table: this.options.tableName,\n    pk: event.commandKey.pk,\n    sk: event.commandKey.sk,\n    tenantCode: event.commandKey.pk.substring(\n      event.commandKey.pk.indexOf('#') + 1,\n    ),\n    content: {\n      errorMessage: errorDetails,\n      sfnId: event.context.Execution.Id,\n    },\n  };\n  await this.snsService.publish<INotification>(alarm, this.alarmTopicArn);\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u8a2d\u5b9a",children:"\u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u8a2d\u5b9a\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "ProcessStep": {\n    "Type": "Task",\n    "Resource": "${LambdaArn}",\n    "Retry": [\n      {\n        "ErrorEquals": ["States.TaskFailed"],\n        "IntervalSeconds": 2,\n        "MaxAttempts": 3,\n        "BackoffRate": 2\n      }\n    ],\n    "Catch": [\n      {\n        "ErrorEquals": ["States.ALL"],\n        "Next": "HandleError",\n        "ResultPath": "$.error"\n      }\n    ],\n    "Next": "NextStep"\n  }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,s.jsx)(e.h3,{id:"\u8a2d\u8a08\u539f\u5247",children:"\u8a2d\u8a08\u539f\u5247"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u51aa\u7b49\u6027"}),"\uff1a\u5404\u72b6\u614b\u3092\u5b89\u5168\u306b\u518d\u8a66\u884c\u53ef\u80fd\u306b\u8a2d\u8a08"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5358\u4e00\u8cac\u4efb"}),"\uff1a\u5404\u72b6\u614b\u306f\u4e00\u3064\u306e\u3053\u3068\u3092\u3046\u307e\u304f\u884c\u3046"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u8a2d\u5b9a"}),"\uff1a\u5404\u72b6\u614b\u306b\u9069\u5207\u306a\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30ed\u30ae\u30f3\u30b0"}),"\uff1a\u30c7\u30d0\u30c3\u30b0\u306e\u305f\u3081\u306e\u5305\u62ec\u7684\u306a\u30ed\u30ae\u30f3\u30b0\u3092\u6709\u52b9\u5316"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6700\u9069\u5316"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Express\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u4f7f\u7528"}),"\uff1a\u9ad8\u30dc\u30ea\u30e5\u30fc\u30e0\u3001\u77ed\u671f\u9593\u306e\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u5411\u3051"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30d0\u30c3\u30c1\u51e6\u7406"}),"\uff1a\u72b6\u614b\u9077\u79fb\u3092\u6e1b\u3089\u3059\u305f\u3081\u306b\u30a2\u30a4\u30c6\u30e0\u3092\u30b0\u30eb\u30fc\u30d7\u5316"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u4e26\u884c\u6027\u5236\u9650"}),"\uff1a\u30b9\u30ed\u30c3\u30c8\u30ea\u30f3\u30b0\u3092\u9632\u3050\u305f\u3081\u306e\u9069\u5207\u306a\u5236\u9650\u3092\u8a2d\u5b9a"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"S3\u7d71\u5408"}),"\uff1a\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u51e6\u7406\u306b\u306f\u30cd\u30a4\u30c6\u30a3\u30d6S3\u7d71\u5408\u3092\u4f7f\u7528"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",children:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"CloudWatch\u30e1\u30c8\u30ea\u30af\u30b9"}),"\uff1a\u5b9f\u884c\u56de\u6570\u3001\u5931\u6557\u3001\u671f\u9593\u3092\u76e3\u8996"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"X-Ray\u30c8\u30ec\u30fc\u30b7\u30f3\u30b0"}),"\uff1a\u30c7\u30d0\u30c3\u30b0\u306e\u305f\u3081\u306e\u5206\u6563\u30c8\u30ec\u30fc\u30b7\u30f3\u30b0\u3092\u6709\u52b9\u5316"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"CloudWatch Logs"}),"\uff1a\u8a73\u7d30\u306a\u5b9f\u884c\u30ed\u30b0\u3092\u30ad\u30e3\u30d7\u30c1\u30e3"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u30a2\u30e9\u30fc\u30e0"}),"\uff1a\u5931\u6557\u7387\u3068\u5b9f\u884c\u6642\u9593\u306b\u5bfe\u3059\u308b\u30a2\u30e9\u30fc\u30c8\u3092\u8a2d\u5b9a"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/ja/docs/tasks",children:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb"})," - Step Functions\u3092\u4f7f\u7528\u3057\u305f\u30bf\u30b9\u30af\u7ba1\u7406"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/ja/docs/import-export-patterns",children:"\u30a4\u30f3\u30dd\u30fc\u30c8/\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3"})," - Distributed Map\u3092\u4f7f\u7528\u3057\u305fCSV\u30a4\u30f3\u30dd\u30fc\u30c8"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/ja/docs/architecture/event-sourcing",children:"\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b7\u30f3\u30b0"})," - \u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/ja/docs/architecture/cqrs-flow",children:"CQRS\u30d5\u30ed\u30fc"})," - \u30b3\u30de\u30f3\u30c9\u3068\u30af\u30a8\u30ea\u306e\u5206\u96e2"]}),"\n"]})]})}function m(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>o});var a=t(6540);const s={},r=a.createContext(s);function i(n){const e=a.useContext(r);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:i(n.components),a.createElement(r.Provider,{value:e},n.children)}}}]);