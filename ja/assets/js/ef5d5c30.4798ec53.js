"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[8560],{6137:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"service-patterns","title":"Service\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3","description":"CommandService\u3068DataService\u3092\u4f7f\u7528\u3057\u305fCRUD\u64cd\u4f5c\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u30ec\u30a4\u30e4\u30fc\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/service-patterns.md","sourceDirName":".","slug":"/service-patterns","permalink":"/ja/docs/service-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"CommandService\u3068DataService\u3092\u4f7f\u7528\u3057\u305fCRUD\u64cd\u4f5c\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u30ec\u30a4\u30e4\u30fc\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"Data Sync Handler\u306e\u5b9f\u88c5\u4f8b","permalink":"/ja/docs/data-sync-handler-examples"},"next":{"title":"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30d1\u30bf\u30fc\u30f3","permalink":"/ja/docs/multi-tenant-patterns"}}');var o=t(4848),r=t(8453);const a={description:"CommandService\u3068DataService\u3092\u4f7f\u7528\u3057\u305fCRUD\u64cd\u4f5c\u306b\u3088\u308b\u30b5\u30fc\u30d3\u30b9\u30ec\u30a4\u30e4\u30fc\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},s="Service\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",c={},d=[{value:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",level:2},{value:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c",id:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c",level:2},{value:"\u57fa\u672c\u7684\u306aService\u69cb\u9020",id:"\u57fa\u672c\u7684\u306aservice\u69cb\u9020",level:2},{value:"Create\u64cd\u4f5c",id:"create\u64cd\u4f5c",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u65b0\u3057\u3044\u5546\u54c1\u3092\u4f5c\u6210\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u65b0\u3057\u3044\u5546\u54c1\u3092\u4f5c\u6210\u3059\u308b",level:3},{value:"Read\u64cd\u4f5c",id:"read\u64cd\u4f5c",level:2},{value:"\u30ad\u30fc\u306b\u3088\u308b\u5358\u4e00\u53d6\u5f97",id:"\u30ad\u30fc\u306b\u3088\u308b\u5358\u4e00\u53d6\u5f97",level:3},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5546\u54c1\u8a73\u7d30\u30da\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5546\u54c1\u8a73\u7d30\u30da\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b",level:4},{value:"\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u4ed8\u304d\u5168\u4ef6\u53d6\u5f97\uff08RDS\u304b\u3089\uff09",id:"\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u4ed8\u304d\u5168\u4ef6\u53d6\u5f97rds\u304b\u3089",level:3},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u4ed8\u304d\u5546\u54c1\u30ea\u30b9\u30c8",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u4ed8\u304d\u5546\u54c1\u30ea\u30b9\u30c8",level:4},{value:"Update\u64cd\u4f5c",id:"update\u64cd\u4f5c",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5546\u54c1\u8a73\u7d30\u3092\u7de8\u96c6\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5546\u54c1\u8a73\u7d30\u3092\u7de8\u96c6\u3059\u308b",level:3},{value:"Delete\u64cd\u4f5c\uff08\u8ad6\u7406\u524a\u9664\uff09",id:"delete\u64cd\u4f5c\u8ad6\u7406\u524a\u9664",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u30ab\u30bf\u30ed\u30b0\u304b\u3089\u5546\u54c1\u3092\u524a\u9664\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u30ab\u30bf\u30ed\u30b0\u304b\u3089\u5546\u54c1\u3092\u524a\u9664\u3059\u308b",level:3},{value:"\u5b8c\u5168\u306aService\u4f8b",id:"\u5b8c\u5168\u306aservice\u4f8b",level:2},{value:"\u30d0\u30c3\u30c1\u64cd\u4f5c",id:"batch-operations",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u8907\u6570\u306e\u5546\u54c1\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u8907\u6570\u306e\u5546\u54c1\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b",level:3},{value:"\u30c1\u30e3\u30f3\u30af\u5316\u30d0\u30c3\u30c1\u64cd\u4f5c",id:"\u30c1\u30e3\u30f3\u30af\u5316\u30d0\u30c3\u30c1\u64cd\u4f5c",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u79fb\u884c",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u79fb\u884c",level:3},{value:"Copy\u64cd\u4f5c",id:"copy\u64cd\u4f5c",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5546\u54c1\u3092\u5225\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u30af\u30ed\u30fc\u30f3\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5546\u54c1\u3092\u5225\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u30af\u30ed\u30fc\u30f3\u3059\u308b",level:3},{value:"History Service\u306e\u4f7f\u7528",id:"history-service\u306e\u4f7f\u7528",level:2},{value:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4ee5\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8868\u793a\u3059\u308b",id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4ee5\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8868\u793a\u3059\u308b",level:3},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"1. \u5e38\u306bInvoke Context\u3092\u4f7f\u7528\u3059\u308b",id:"1-\u5e38\u306binvoke-context\u3092\u4f7f\u7528\u3059\u308b",level:3},{value:"2. \u697d\u89b3\u7684\u30ed\u30c3\u30af\u3092\u4f7f\u7528\u3059\u308b",id:"2-\u697d\u89b3\u7684\u30ed\u30c3\u30af\u3092\u4f7f\u7528\u3059\u308b",level:3},{value:"3. \u975e\u540c\u671f\u64cd\u4f5c\u3092\u512a\u5148\u3059\u308b",id:"3-\u975e\u540c\u671f\u64cd\u4f5c\u3092\u512a\u5148\u3059\u308b",level:3},{value:"4. DynamoDB\u3068RDS\u30af\u30a8\u30ea\u3092\u7d44\u307f\u5408\u308f\u305b\u308b",id:"4-dynamodb\u3068rds\u30af\u30a8\u30ea\u3092\u7d44\u307f\u5408\u308f\u305b\u308b",level:3}];function l(n){const e={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"service\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",children:"Service\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3"})}),"\n",(0,o.jsx)(e.p,{children:"\u3053\u306e\u30ac\u30a4\u30c9\u3067\u306f\u3001MBC CQRS Serverless\u3067CRUD\u64cd\u4f5c\u3092\u51e6\u7406\u3059\u308b\u30b5\u30fc\u30d3\u30b9\u30af\u30e9\u30b9\u306e\u5b9f\u88c5\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\u3002\u30b5\u30fc\u30d3\u30b9\u306f\u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\u306e\u4e2d\u6838\u3067\u3042\u308a\u3001\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3001\u30b3\u30de\u30f3\u30c9\u3001\u30c7\u30fc\u30bf\u30a2\u30af\u30bb\u30b9\u3092\u8abf\u6574\u3057\u307e\u3059\u3002"}),"\n",(0,o.jsx)(e.h2,{id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",children:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0"}),"\n",(0,o.jsx)(e.p,{children:"\u4ee5\u4e0b\u304c\u5fc5\u8981\u306a\u5834\u5408\u306b\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"\u65b0\u3057\u3044\u30c9\u30e1\u30a4\u30f3\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u30b5\u30fc\u30d3\u30b9\u30ec\u30a4\u30e4\u30fc\u3092\u69cb\u7bc9\u3059\u308b"}),"\n",(0,o.jsx)(e.li,{children:"\u4f5c\u6210\u3001\u8aad\u307f\u53d6\u308a\u3001\u66f4\u65b0\u3001\u524a\u9664\uff08CRUD\uff09\u64cd\u4f5c\u3092\u5b9f\u88c5\u3059\u308b"}),"\n",(0,o.jsx)(e.li,{children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30c7\u30fc\u30bf\u306e\u5206\u96e2\u3092\u51e6\u7406\u3059\u308b"}),"\n",(0,o.jsx)(e.li,{children:"\u4e26\u884c\u66f4\u65b0\u306e\u305f\u3081\u306e\u697d\u89b3\u7684\u30ed\u30c3\u30af\u3092\u4f7f\u7528\u3059\u308b"}),"\n",(0,o.jsx)(e.li,{children:"\u5927\u91cf\u30c7\u30fc\u30bf\u51e6\u7406\u306e\u305f\u3081\u306e\u30d0\u30c3\u30c1\u64cd\u4f5c\u3092\u5b9f\u88c5\u3059\u308b"}),"\n"]}),"\n",(0,o.jsx)(e.h2,{id:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c",children:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c"}),"\n",(0,o.jsxs)(e.table,{children:[(0,o.jsx)(e.thead,{children:(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.th,{children:"\u554f\u984c"}),(0,o.jsx)(e.th,{children:"\u89e3\u6c7a\u7b56"})]})}),(0,o.jsxs)(e.tbody,{children:[(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u76f4\u63a5\u30a2\u30af\u30bb\u30b9\u306fCQRS\u30d1\u30bf\u30fc\u30f3\u3092\u30d0\u30a4\u30d1\u30b9\u3059\u308b"}),(0,o.jsx)(e.td,{children:"\u66f8\u304d\u8fbc\u307f\u306b\u306fCommandService\u3001\u8aad\u307f\u53d6\u308a\u306b\u306fDataService\u3092\u4f7f\u7528\u3059\u308b"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:"\u30c7\u30fc\u30bf\u5909\u66f4\u306e\u76e3\u67fb\u8a3c\u8de1\u304c\u306a\u3044"}),(0,o.jsx)(e.td,{children:"\u30e6\u30fc\u30b6\u30fc\u3068\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3092\u8a18\u9332\u3059\u308b\u305f\u3081\u306binvokeContext\u3092\u6e21\u3059"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:"\u4e26\u884c\u66f4\u65b0\u304c\u4e92\u3044\u3092\u4e0a\u66f8\u304d\u3059\u308b"}),(0,o.jsx)(e.td,{children:"\u697d\u89b3\u7684\u30ed\u30c3\u30af\u306e\u305f\u3081\u306bversion\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u4f7f\u7528\u3059\u308b"})]}),(0,o.jsxs)(e.tr,{children:[(0,o.jsx)(e.td,{children:"\u540c\u671f\u51e6\u7406\u306b\u3088\u308b\u9045\u3044\u30ec\u30b9\u30dd\u30f3\u30b9"}),(0,o.jsx)(e.td,{children:"\u975e\u30d6\u30ed\u30c3\u30ad\u30f3\u30b0\u30b3\u30de\u30f3\u30c9\u767a\u884c\u306e\u305f\u3081\u306bpublishAsync\u3092\u4f7f\u7528\u3059\u308b"})]})]})]}),"\n",(0,o.jsx)(e.h2,{id:"\u57fa\u672c\u7684\u306aservice\u69cb\u9020",children:"\u57fa\u672c\u7684\u306aService\u69cb\u9020"}),"\n",(0,o.jsxs)(e.p,{children:["\u4e00\u822c\u7684\u306a\u30b5\u30fc\u30d3\u30b9\u306f\u3001\u66f8\u304d\u8fbc\u307f\u64cd\u4f5c\u306b",(0,o.jsx)(e.code,{children:"CommandService"}),"\u3001\u8aad\u307f\u53d6\u308a\u64cd\u4f5c\u306b",(0,o.jsx)(e.code,{children:"DataService"}),"\u306e\u4e21\u65b9\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import {\n  CommandService,\n  DataService,\n  generateId,\n  getUserContext,\n  IInvoke,\n  VERSION_FIRST,\n  KEY_SEPARATOR,\n} from "@mbc-cqrs-serverless/core";\nimport { Injectable } from "@nestjs/common";\nimport { ulid } from "ulid";\n\nimport { PrismaService } from "src/prisma";\nimport { ProductCommandDto } from "./dto/product-command.dto";\nimport { ProductDataEntity } from "./entity/product-data.entity";\nimport { CreateProductDto } from "./dto/create-product.dto";\nimport { UpdateProductDto } from "./dto/update-product.dto";\n\nconst PRODUCT_PK_PREFIX = "PRODUCT";\n\n@Injectable()\nexport class ProductService {\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n    private readonly prismaService: PrismaService,\n  ) {}\n\n  // CRUD methods will be implemented below\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"create\u64cd\u4f5c",children:"Create\u64cd\u4f5c"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u65b0\u3057\u3044\u5546\u54c1\u3092\u4f5c\u6210\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u65b0\u3057\u3044\u5546\u54c1\u3092\u4f5c\u6210\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u30e6\u30fc\u30b6\u30fc\u304c\u30ab\u30bf\u30ed\u30b0\u306b\u65b0\u3057\u3044\u5546\u54c1\u3092\u8ffd\u52a0\u3059\u308b\u30d5\u30a9\u30fc\u30e0\u3092\u9001\u4fe1\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u30d5\u30ed\u30fc\uff1aController\u304cCreateProductDto\u3092\u53d7\u4fe1 \u2192 Service\u304c\u30ad\u30fc\u3092\u751f\u6210 \u2192 Command\u304cDynamoDB\u306b\u767a\u884c \u2192 \u30c7\u30fc\u30bf\u304cRDS\u306b\u540c\u671f\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'async create(\n  createDto: CreateProductDto,\n  opts: { invokeContext: IInvoke },\n): Promise<ProductDataEntity> {\n  // Get tenant context from the invoke context\n  const { tenantCode } = getUserContext(opts.invokeContext);\n\n  // Generate PK and SK\n  const pk = `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n  const sk = ulid(); // Use ULID for sortable unique ID\n  const id = generateId(pk, sk);\n\n  // Create command DTO\n  const command = new ProductCommandDto({\n    pk,\n    sk,\n    id,\n    tenantCode,\n    code: sk,\n    type: "PRODUCT",\n    name: createDto.name,\n    version: VERSION_FIRST,\n    attributes: {\n      description: createDto.description,\n      price: createDto.price,\n      category: createDto.category,\n      inStock: createDto.inStock ?? true,\n    },\n  });\n\n  // Publish command (async - returns immediately)\n  const item = await this.commandService.publishAsync(command, {\n    invokeContext: opts.invokeContext,\n  });\n\n  return new ProductDataEntity(item);\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"read\u64cd\u4f5c",children:"Read\u64cd\u4f5c"}),"\n",(0,o.jsx)(e.h3,{id:"\u30ad\u30fc\u306b\u3088\u308b\u5358\u4e00\u53d6\u5f97",children:"\u30ad\u30fc\u306b\u3088\u308b\u5358\u4e00\u53d6\u5f97"}),"\n",(0,o.jsx)(e.h4,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5546\u54c1\u8a73\u7d30\u30da\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5546\u54c1\u8a73\u7d30\u30da\u30fc\u30b8\u3092\u53d6\u5f97\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u30e6\u30fc\u30b6\u30fc\u304c\u5546\u54c1\u8a73\u7d30\u30da\u30fc\u30b8\u306b\u79fb\u52d5\u3057\u3001\u5b8c\u5168\u306a\u5546\u54c1\u30c7\u30fc\u30bf\u304c\u5fc5\u8981\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0\uff1apk\u3068sk\u304c\u3042\u308b\u5834\u5408\u306e\u5358\u4e00\u30a2\u30a4\u30c6\u30e0\u691c\u7d22\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"async findOne(\n  detailDto: { pk: string; sk: string },\n): Promise<ProductDataEntity> {\n  const item = await this.dataService.getItem(detailDto);\n  return new ProductDataEntity(item);\n}\n"})}),"\n",(0,o.jsx)(e.h3,{id:"\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u4ed8\u304d\u5168\u4ef6\u53d6\u5f97rds\u304b\u3089",children:"\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u4ed8\u304d\u5168\u4ef6\u53d6\u5f97\uff08RDS\u304b\u3089\uff09"}),"\n",(0,o.jsx)(e.h4,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u4ed8\u304d\u5546\u54c1\u30ea\u30b9\u30c8",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u4ed8\u304d\u5546\u54c1\u30ea\u30b9\u30c8"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u30e6\u30fc\u30b6\u30fc\u304c\u30ab\u30c6\u30b4\u30ea\u3084\u691c\u7d22\u3067\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u3067\u304d\u308b\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u4ed8\u304d\u5546\u54c1\u30ea\u30b9\u30c8\u3092\u8868\u793a\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"RDS\u3092\u4f7f\u7528\u3059\u308b\u7406\u7531\uff1aDynamoDB\u306f\u8907\u96d1\u306a\u30af\u30a8\u30ea\u306b\u6700\u9069\u5316\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\u3068\u5168\u6587\u691c\u7d22\u306b\u306fPrisma/RDS\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'async findAll(\n  searchDto: {\n    tenantCode: string;\n    category?: string;\n    inStock?: boolean;\n    page?: number;\n    limit?: number;\n  },\n): Promise<{ items: ProductDataEntity[]; total: number }> {\n  const page = searchDto.page ?? 1;\n  const limit = searchDto.limit ?? 20;\n  const skip = (page - 1) * limit;\n\n  // Build where clause\n  const where: any = {\n    tenantCode: searchDto.tenantCode,\n    isDeleted: false,\n  };\n\n  if (searchDto.category) {\n    where.category = searchDto.category;\n  }\n\n  if (searchDto.inStock !== undefined) {\n    where.inStock = searchDto.inStock;\n  }\n\n  // Execute parallel queries for count and data\n  const [total, items] = await Promise.all([\n    this.prismaService.product.count({ where }),\n    this.prismaService.product.findMany({\n      where,\n      take: limit,\n      skip,\n      orderBy: { createdAt: "desc" },\n    }),\n  ]);\n\n  return {\n    total,\n    items: items.map((item) => new ProductDataEntity(item)),\n  };\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"update\u64cd\u4f5c",children:"Update\u64cd\u4f5c"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5546\u54c1\u8a73\u7d30\u3092\u7de8\u96c6\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5546\u54c1\u8a73\u7d30\u3092\u7de8\u96c6\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u30e6\u30fc\u30b6\u30fc\u304c\u7de8\u96c6\u30d5\u30a9\u30fc\u30e0\u3067\u5546\u54c1\u540d\u3084\u4fa1\u683c\u3092\u66f4\u65b0\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u91cd\u8981\uff1a\u697d\u89b3\u7684\u30ed\u30c3\u30af\u3092\u6709\u52b9\u306b\u3057\u3001\u4e26\u884c\u66f4\u65b0\u306e\u7af6\u5408\u3092\u9632\u3050\u305f\u3081\u306bversion\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u542b\u3081\u3066\u304f\u3060\u3055\u3044\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import {\n  CommandPartialInputModel,\n  CommandService,\n  DataService,\n  IInvoke,\n} from "@mbc-cqrs-serverless/core";\nimport { NotFoundException } from "@nestjs/common";\n\nasync update(\n  detailDto: { pk: string; sk: string },\n  updateDto: UpdateProductDto,\n  opts: { invokeContext: IInvoke },\n): Promise<ProductDataEntity> {\n  // First, get the existing item\n  const existing = await this.dataService.getItem(detailDto);\n\n  if (!existing) {\n    throw new NotFoundException("Product not found");\n  }\n\n  // Merge existing attributes with updates\n  const updatedAttributes = {\n    ...existing.attributes,\n    ...updateDto.attributes,\n  };\n\n  // Create partial update command\n  const command: CommandPartialInputModel = {\n    pk: existing.pk,\n    sk: existing.sk,\n    version: existing.version, // Required for optimistic locking\n    name: updateDto.name ?? existing.name,\n    attributes: updatedAttributes,\n  };\n\n  // Publish partial update\n  const item = await this.commandService.publishPartialUpdateAsync(command, {\n    invokeContext: opts.invokeContext,\n  });\n\n  return new ProductDataEntity(item);\n}\n'})}),"\n",(0,o.jsxs)(e.admonition,{title:"version\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u52d5\u4f5c",type:"info",children:[(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"publishPartialUpdateAsync()"})," \u306e ",(0,o.jsx)(e.code,{children:"version"})," \u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u65e2\u5b58\u30a2\u30a4\u30c6\u30e0\u306e\u53d6\u5f97\u65b9\u6cd5\u3092\u5236\u5fa1\u3057\u307e\u3059\uff1a"]}),(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsxs)(e.li,{children:[(0,o.jsx)(e.strong,{children:(0,o.jsx)(e.code,{children:"version > 0"})}),": \u6307\u5b9a\u3055\u308c\u305f\u30d0\u30fc\u30b8\u30e7\u30f3\u756a\u53f7\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u30d0\u30fc\u30b8\u30e7\u30f3\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408\u3001\u30b3\u30de\u30f3\u30c9\u306f\u5931\u6557\u3057\u307e\u3059\uff08\u697d\u89b3\u7684\u30ed\u30c3\u30af\uff09\u3002"]}),"\n",(0,o.jsxs)(e.li,{children:[(0,o.jsx)(e.strong,{children:(0,o.jsx)(e.code,{children:"version <= 0"})})," (\u4f8b\uff1a",(0,o.jsx)(e.code,{children:"VERSION_LATEST = -1"}),"): ",(0,o.jsx)(e.code,{children:"getLatestItem()"})," \u3092\u4f7f\u7528\u3057\u3066\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u81ea\u52d5\u7684\u306b\u53d6\u5f97\u3057\u307e\u3059\u3002"]}),"\n"]}),(0,o.jsxs)(e.p,{children:["\u53b3\u683c\u306a\u697d\u89b3\u7684\u30ed\u30c3\u30af\u306b\u306f ",(0,o.jsx)(e.code,{children:"existing.version"}),"\uff08\u4e0a\u8a18\u306e\u3088\u3046\u306b\uff09\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\u30ad\u30e3\u30c3\u30b7\u30e5\u3057\u3066\u3044\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u306b\u95a2\u4fc2\u306a\u304f\u5e38\u306b\u6700\u65b0\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u66f4\u65b0\u3057\u305f\u3044\u5834\u5408\u306f ",(0,o.jsx)(e.code,{children:"VERSION_LATEST"}),"\uff08-1\uff09\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002"]})]}),"\n",(0,o.jsx)(e.h2,{id:"delete\u64cd\u4f5c\u8ad6\u7406\u524a\u9664",children:"Delete\u64cd\u4f5c\uff08\u8ad6\u7406\u524a\u9664\uff09"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u30ab\u30bf\u30ed\u30b0\u304b\u3089\u5546\u54c1\u3092\u524a\u9664\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u30ab\u30bf\u30ed\u30b0\u304b\u3089\u5546\u54c1\u3092\u524a\u9664\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u7ba1\u7406\u8005\u304c\u5ec3\u6b62\u5546\u54c1\u3092\u524a\u9664\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u8ad6\u7406\u524a\u9664\u306e\u7406\u7531\uff1a\u30c7\u30fc\u30bf\u306f\u7269\u7406\u7684\u306b\u524a\u9664\u3055\u308c\u308b\u306e\u3067\u306f\u306a\u304f\u3001\u524a\u9664\u6e08\u307f\uff08isDeleted=true\uff09\u3068\u3057\u3066\u30de\u30fc\u30af\u3055\u308c\u3001\u76e3\u67fb\u5c65\u6b74\u304c\u4fdd\u6301\u3055\u308c\u307e\u3059\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import {\n  CommandPartialInputModel,\n  CommandService,\n  DataService,\n  IInvoke,\n} from "@mbc-cqrs-serverless/core";\nimport { NotFoundException } from "@nestjs/common";\n\nasync remove(\n  detailDto: { pk: string; sk: string },\n  opts: { invokeContext: IInvoke },\n): Promise<ProductDataEntity> {\n  // Get existing item\n  const existing = await this.dataService.getItem(detailDto);\n\n  if (!existing) {\n    throw new NotFoundException("Product not found");\n  }\n\n  // Create soft delete command\n  const command: CommandPartialInputModel = {\n    pk: existing.pk,\n    sk: existing.sk,\n    version: existing.version,\n    isDeleted: true,\n  };\n\n  const item = await this.commandService.publishPartialUpdateAsync(command, {\n    invokeContext: opts.invokeContext,\n  });\n\n  return new ProductDataEntity(item);\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"\u5b8c\u5168\u306aservice\u4f8b",children:"\u5b8c\u5168\u306aService\u4f8b"}),"\n",(0,o.jsx)(e.p,{children:"\u5b8c\u5168\u306a\u30b5\u30fc\u30d3\u30b9\u5b9f\u88c5\u3092\u793a\u3057\u307e\u3059\uff1a"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import {\n  CommandPartialInputModel,\n  CommandService,\n  DataService,\n  generateId,\n  getUserContext,\n  VERSION_FIRST,\n  KEY_SEPARATOR,\n  IInvoke,\n} from "@mbc-cqrs-serverless/core";\nimport { Injectable, NotFoundException } from "@nestjs/common";\nimport { ulid } from "ulid";\n\nimport { PrismaService } from "src/prisma";\nimport { ProductCommandDto } from "./dto/product-command.dto";\nimport { ProductDataEntity } from "./entity/product-data.entity";\nimport { ProductListEntity } from "./entity/product-list.entity";\nimport { CreateProductDto } from "./dto/create-product.dto";\nimport { UpdateProductDto } from "./dto/update-product.dto";\nimport { SearchProductDto } from "./dto/search-product.dto";\nimport { DetailDto } from "./dto/detail.dto";\n\nconst PRODUCT_PK_PREFIX = "PRODUCT";\n\n@Injectable()\nexport class ProductService {\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n    private readonly prismaService: PrismaService,\n  ) {}\n\n  /**\n   * Create a new product\n   */\n  async create(\n    createDto: CreateProductDto,\n    opts: { invokeContext: IInvoke },\n  ): Promise<ProductDataEntity> {\n    const { tenantCode } = getUserContext(opts.invokeContext);\n\n    const pk = `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n    const sk = ulid();\n    const id = generateId(pk, sk);\n\n    const command = new ProductCommandDto({\n      pk,\n      sk,\n      id,\n      tenantCode,\n      code: sk,\n      type: "PRODUCT",\n      name: createDto.name,\n      version: VERSION_FIRST,\n      attributes: {\n        description: createDto.description,\n        price: createDto.price,\n        category: createDto.category,\n        inStock: createDto.inStock ?? true,\n      },\n    });\n\n    const item = await this.commandService.publishAsync(command, {\n      invokeContext: opts.invokeContext,\n    });\n\n    return new ProductDataEntity(item);\n  }\n\n  /**\n   * Find all products with filtering and pagination\n   */\n  async findAll(searchDto: SearchProductDto): Promise<ProductListEntity> {\n    const page = searchDto.page ?? 1;\n    const limit = searchDto.limit ?? 20;\n    const skip = (page - 1) * limit;\n\n    const where: any = {\n      tenantCode: searchDto.tenantCode,\n      isDeleted: false,\n    };\n\n    if (searchDto.category) {\n      where.category = searchDto.category;\n    }\n\n    if (searchDto.inStock !== undefined) {\n      where.inStock = searchDto.inStock;\n    }\n\n    if (searchDto.search) {\n      where.OR = [\n        { name: { contains: searchDto.search}},\n        { description: { contains: searchDto.search}},\n      ];\n    }\n\n    const [total, items] = await Promise.all([\n      this.prismaService.product.count({ where }),\n      this.prismaService.product.findMany({\n        where,\n        take: limit,\n        skip,\n        orderBy: { createdAt: "desc" },\n      }),\n    ]);\n\n    return new ProductListEntity({\n      total,\n      items: items.map((item) => new ProductDataEntity(item)),\n    });\n  }\n\n  /**\n   * Find one product by key\n   */\n  async findOne(detailDto: DetailDto): Promise<ProductDataEntity> {\n    const item = await this.dataService.getItem(detailDto);\n\n    if (!item) {\n      throw new NotFoundException("Product not found");\n    }\n\n    return new ProductDataEntity(item);\n  }\n\n  /**\n   * Update a product\n   */\n  async update(\n    detailDto: DetailDto,\n    updateDto: UpdateProductDto,\n    opts: { invokeContext: IInvoke },\n  ): Promise<ProductDataEntity> {\n    const existing = await this.dataService.getItem(detailDto);\n\n    if (!existing) {\n      throw new NotFoundException("Product not found");\n    }\n\n    const command: CommandPartialInputModel = {\n      pk: existing.pk,\n      sk: existing.sk,\n      version: existing.version,\n      name: updateDto.name ?? existing.name,\n      attributes: {\n        ...existing.attributes,\n        ...updateDto.attributes,\n      },\n    };\n\n    const item = await this.commandService.publishPartialUpdateAsync(command, {\n      invokeContext: opts.invokeContext,\n    });\n\n    return new ProductDataEntity(item);\n  }\n\n  /**\n   * Soft delete a product\n   */\n  async remove(\n    detailDto: DetailDto,\n    opts: { invokeContext: IInvoke },\n  ): Promise<ProductDataEntity> {\n    const existing = await this.dataService.getItem(detailDto);\n\n    if (!existing) {\n      throw new NotFoundException("Product not found");\n    }\n\n    const command: CommandPartialInputModel = {\n      pk: existing.pk,\n      sk: existing.sk,\n      version: existing.version,\n      isDeleted: true,\n    };\n\n    const item = await this.commandService.publishPartialUpdateAsync(command, {\n      invokeContext: opts.invokeContext,\n    });\n\n    return new ProductDataEntity(item);\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"batch-operations",children:"\u30d0\u30c3\u30c1\u64cd\u4f5c"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u8907\u6570\u306e\u5546\u54c1\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u8907\u6570\u306e\u5546\u54c1\u3092\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u7ba1\u7406\u8005\u304c\u30a4\u30f3\u30dd\u30fc\u30c8\u3059\u308b\u8907\u6570\u306e\u5546\u54c1\u3092\u542b\u3080CSV\u30d5\u30a1\u30a4\u30eb\u3092\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u89e3\u6c7a\u7b56\uff1a\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u5411\u4e0a\u306e\u305f\u3081\u306bPromise.all\u3092\u4f7f\u7528\u3057\u3066\u30a2\u30a4\u30c6\u30e0\u3092\u4e26\u5217\u51e6\u7406\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'async createBatch(\n  items: CreateProductDto[],\n  opts: { invokeContext: IInvoke },\n): Promise<ProductDataEntity[]> {\n  const { tenantCode } = getUserContext(opts.invokeContext);\n  const pk = `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n\n  // Create all commands\n  const commands = items.map((item) => {\n    const sk = ulid();\n    return new ProductCommandDto({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode,\n      code: sk,\n      type: "PRODUCT",\n      name: item.name,\n      version: VERSION_FIRST,\n      attributes: {\n        description: item.description,\n        price: item.price,\n        category: item.category,\n        inStock: item.inStock ?? true,\n      },\n    });\n  });\n\n  // Publish all commands in parallel\n  const results = await Promise.all(\n    commands.map((command) =>\n      this.commandService.publishAsync(command, {\n        invokeContext: opts.invokeContext,\n      }),\n    ),\n  );\n\n  return results.map((item) => new ProductDataEntity(item));\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"\u30c1\u30e3\u30f3\u30af\u5316\u30d0\u30c3\u30c1\u64cd\u4f5c",children:"\u30c1\u30e3\u30f3\u30af\u5316\u30d0\u30c3\u30c1\u64cd\u4f5c"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u79fb\u884c",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5927\u898f\u6a21\u30c7\u30fc\u30bf\u79fb\u884c"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u30ec\u30ac\u30b7\u30fc\u30b7\u30b9\u30c6\u30e0\u304b\u3089\u6570\u5343\u4ef6\u306e\u30ec\u30b3\u30fc\u30c9\u3092\u79fb\u884c\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u554f\u984c\uff1a\u4e00\u5ea6\u306b\u5168\u3066\u51e6\u7406\u3059\u308b\u3068Lambda\u306e\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3084\u30e1\u30e2\u30ea\u306e\u554f\u984c\u304c\u767a\u751f\u3059\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u89e3\u6c7a\u7b56\uff1aLambda\u306e\u5236\u9650\u5185\u306b\u53ce\u3081\u308b\u305f\u3081\u306b100\u30a2\u30a4\u30c6\u30e0\u306e\u30c1\u30e3\u30f3\u30af\u3067\u51e6\u7406\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'async createLargeBatch(\n  items: CreateProductDto[],\n  opts: { invokeContext: IInvoke },\n): Promise<ProductDataEntity[]> {\n  const { tenantCode } = getUserContext(opts.invokeContext);\n  const pk = `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n\n  const chunkSize = 100;\n  const results: ProductDataEntity[] = [];\n\n  for (let i = 0; i < items.length; i += chunkSize) {\n    const chunk = items.slice(i, i + chunkSize);\n\n    const commands = chunk.map((item) => {\n      const sk = ulid();\n      return new ProductCommandDto({\n        pk,\n        sk,\n        id: generateId(pk, sk),\n        tenantCode,\n        code: sk,\n        type: "PRODUCT",\n        name: item.name,\n        version: VERSION_FIRST,\n        attributes: item,\n      });\n    });\n\n    const chunkResults = await Promise.all(\n      commands.map((command) =>\n        this.commandService.publishAsync(command, {\n          invokeContext: opts.invokeContext,\n        }),\n      ),\n    );\n\n    results.push(...chunkResults.map((item) => new ProductDataEntity(item)));\n  }\n\n  return results;\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"copy\u64cd\u4f5c",children:"Copy\u64cd\u4f5c"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u5546\u54c1\u3092\u5225\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u30af\u30ed\u30fc\u30f3\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u5546\u54c1\u3092\u5225\u306e\u30c6\u30ca\u30f3\u30c8\u306b\u30af\u30ed\u30fc\u30f3\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5546\u54c1\u3092\u65b0\u3057\u3044\u30c6\u30ca\u30f3\u30c8\u306b\u30b3\u30d4\u30fc\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8SaaS\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u89e3\u6c7a\u7b56\uff1a\u30bd\u30fc\u30b9\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u8aad\u307f\u53d6\u308a\u3001\u7570\u306a\u308b\u30c6\u30ca\u30f3\u30c8\u306e\u30ad\u30fc\u3067\u65b0\u3057\u3044\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u4f5c\u6210\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import {\n  CommandService,\n  DataService,\n  generateId,\n  IInvoke,\n  KEY_SEPARATOR,\n  VERSION_FIRST,\n} from "@mbc-cqrs-serverless/core";\nimport { NotFoundException } from "@nestjs/common";\nimport { ulid } from "ulid";\n\nasync copy(\n  sourceKey: { pk: string; sk: string },\n  targetTenantCode: string,\n  opts: { invokeContext: IInvoke },\n): Promise<ProductDataEntity> {\n  // Get source item\n  const source = await this.dataService.getItem(sourceKey);\n\n  if (!source) {\n    throw new NotFoundException("Source product not found");\n  }\n\n  // Create new keys for target tenant\n  const pk = `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${targetTenantCode}`;\n  const sk = ulid();\n  const id = generateId(pk, sk);\n\n  // Create command with source data\n  const command = new ProductCommandDto({\n    pk,\n    sk,\n    id,\n    tenantCode: targetTenantCode,\n    code: sk,\n    type: source.type,\n    name: source.name,\n    version: VERSION_FIRST,\n    attributes: source.attributes,\n  });\n\n  const item = await this.commandService.publishAsync(command, {\n    invokeContext: opts.invokeContext,\n  });\n\n  return new ProductDataEntity(item);\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"history-service\u306e\u4f7f\u7528",children:"History Service\u306e\u4f7f\u7528"}),"\n",(0,o.jsx)(e.h3,{id:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4ee5\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8868\u793a\u3059\u308b",children:"\u30e6\u30fc\u30b9\u30b1\u30fc\u30b9\uff1a\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4ee5\u524d\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u8868\u793a\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30b7\u30ca\u30ea\u30aa\uff1a\u7279\u5b9a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u304c\u3069\u306e\u3088\u3046\u3060\u3063\u305f\u304b\u3092\u8868\u793a\u3059\u308b\u76e3\u67fb\u8981\u4ef6\u3002"}),"\n",(0,o.jsx)(e.p,{children:"\u89e3\u6c7a\u7b56\uff1aHistoryService\u3092\u4f7f\u7528\u3057\u3066\u5c65\u6b74\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u7279\u5b9a\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u53d6\u5f97\u3059\u308b\u3002"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'import {\n  addSortKeyVersion,\n  CommandService,\n  DataService,\n  HistoryService,\n} from "@mbc-cqrs-serverless/core";\nimport { Injectable, NotFoundException } from "@nestjs/common";\n\nimport { PrismaService } from "src/prisma";\nimport { ProductDataEntity } from "./entity/product-data.entity";\n\n@Injectable()\nexport class ProductService {\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n    private readonly historyService: HistoryService,\n    private readonly prismaService: PrismaService,\n  ) {}\n\n  async findByVersion(\n    detailDto: { pk: string; sk: string },\n    version: number,\n  ): Promise<ProductDataEntity> {\n    // Add version to SK\n    const skWithVersion = addSortKeyVersion(detailDto.sk, version);\n\n    // Try to get from history\n    let item = await this.historyService.getItem({\n      pk: detailDto.pk,\n      sk: skWithVersion,\n    });\n\n    // Fallback to latest if not in history\n    if (!item) {\n      item = await this.dataService.getItem(detailDto);\n    }\n\n    if (!item) {\n      throw new NotFoundException("Product not found");\n    }\n\n    return new ProductDataEntity(item);\n  }\n}\n'})}),"\n",(0,o.jsx)(e.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,o.jsx)(e.h3,{id:"1-\u5e38\u306binvoke-context\u3092\u4f7f\u7528\u3059\u308b",children:"1. \u5e38\u306bInvoke Context\u3092\u4f7f\u7528\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u76e3\u67fb\u8a3c\u8de1\u306e\u305f\u3081\u306binvoke context\u3092\u6e21\u3057\u307e\u3059\uff1a"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"await this.commandService.publishAsync(command, {\n  invokeContext: opts.invokeContext,\n});\n"})}),"\n",(0,o.jsx)(e.h3,{id:"2-\u697d\u89b3\u7684\u30ed\u30c3\u30af\u3092\u4f7f\u7528\u3059\u308b",children:"2. \u697d\u89b3\u7684\u30ed\u30c3\u30af\u3092\u4f7f\u7528\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u90e8\u5206\u66f4\u65b0\u306b\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u542b\u3081\u307e\u3059\uff1a"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"const command: CommandPartialInputModel = {\n  pk: existing.pk,\n  sk: existing.sk,\n  version: existing.version, // This enables optimistic locking\n  // ...\n};\n"})}),"\n",(0,o.jsx)(e.h3,{id:"3-\u975e\u540c\u671f\u64cd\u4f5c\u3092\u512a\u5148\u3059\u308b",children:"3. \u975e\u540c\u671f\u64cd\u4f5c\u3092\u512a\u5148\u3059\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u30ec\u30b9\u30dd\u30f3\u30b7\u30d6\u6027\u5411\u4e0a\u306e\u305f\u3081\u306b\u975e\u540c\u671f\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// Recommended: Returns immediately\nawait this.commandService.publishAsync(command, opts);\n\n// Use only when you need to wait for processing\nawait this.commandService.publishSync(command, opts);\n"})}),"\n",(0,o.jsx)(e.h3,{id:"4-dynamodb\u3068rds\u30af\u30a8\u30ea\u3092\u7d44\u307f\u5408\u308f\u305b\u308b",children:"4. DynamoDB\u3068RDS\u30af\u30a8\u30ea\u3092\u7d44\u307f\u5408\u308f\u305b\u308b"}),"\n",(0,o.jsx)(e.p,{children:"\u5358\u4e00\u30a2\u30a4\u30c6\u30e0\u306e\u8aad\u307f\u53d6\u308a\u306b\u306fDynamoDB\u3001\u8907\u96d1\u306a\u30af\u30a8\u30ea\u306b\u306fRDS\u3092\u4f7f\u7528\u3057\u307e\u3059\uff1a"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'// Single item: Use DataService (DynamoDB)\nconst item = await this.dataService.getItem({ pk, sk });\n\n// Complex query: Use Prisma (RDS)\nconst items = await this.prismaService.product.findMany({\n  where: { category: "electronics", inStock: true },\n  orderBy: { price: "asc" },\n});\n'})})]})}function m(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(l,{...n})}):l(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>a,x:()=>s});var i=t(6540);const o={},r=i.createContext(o);function a(n){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:a(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);