"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[5365],{1465:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>v,frontMatter:()=>i,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"event-handling-patterns","title":"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30bf\u30fc\u30f3","description":"MBC CQRS Serverless\u3067S3\u3001Step Functions\u3001SQS\u3001DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u304b\u3089\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/event-handling-patterns.md","sourceDirName":".","slug":"/event-handling-patterns","permalink":"/ja/docs/event-handling-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":18,"frontMatter":{"sidebar_position":18,"description":"MBC CQRS Serverless\u3067S3\u3001Step Functions\u3001SQS\u3001DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u304b\u3089\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"\u30e2\u30b8\u30e5\u30fc\u30eb","permalink":"/ja/docs/modules"},"next":{"title":"Data Sync Handler\u306e\u5b9f\u88c5\u4f8b","permalink":"/ja/docs/data-sync-handler-examples"}}');var s=t(4848),o=t(8453);const i={sidebar_position:18,description:"MBC CQRS Serverless\u3067S3\u3001Step Functions\u3001SQS\u3001DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u304b\u3089\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406\u3059\u308b\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u307e\u3059\u3002"},a="\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30bf\u30fc\u30f3",c={},d=[{value:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981",id:"\u30a4\u30d9\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc",id:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc",level:2},{value:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc",id:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc",level:3},{value:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u767b\u9332",id:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u767b\u9332",level:3},{value:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3",id:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3",level:2},{value:"\u57fa\u672c\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",id:"\u57fa\u672c\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"Step Functions\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",id:"step-functions\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"S3\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",id:"s3\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"SQS\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",id:"sqs\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u30cf\u30f3\u30c9\u30e9\u30fc",id:"dynamodb\u30b9\u30c8\u30ea\u30fc\u30e0\u30cf\u30f3\u30c9\u30e9\u30fc",level:2},{value:"\u30c7\u30fc\u30bf\u5909\u66f4\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",id:"\u30c7\u30fc\u30bf\u5909\u66f4\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3068\u30ea\u30c8\u30e9\u30a4",id:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3068\u30ea\u30c8\u30e9\u30a4",level:2},{value:"\u30ea\u30c8\u30e9\u30a4\u30d1\u30bf\u30fc\u30f3\u306e\u4f8b",id:"\u30ea\u30c8\u30e9\u30a4\u30d1\u30bf\u30fc\u30f3\u306e\u4f8b",level:3},{value:"AWS\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30aa\u30d7\u30b7\u30e7\u30f3",id:"aws\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"1. \u51aa\u7b49\u306a\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",id:"1-\u51aa\u7b49\u306a\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"2. \u69cb\u9020\u5316\u30ed\u30ae\u30f3\u30b0",id:"2-\u69cb\u9020\u5316\u30ed\u30ae\u30f3\u30b0",level:3},{value:"3. \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u51e6\u7406",id:"3-\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u51e6\u7406",level:3},{value:"4. \u30b0\u30ec\u30fc\u30b9\u30d5\u30eb\u30c7\u30b0\u30e9\u30c7\u30fc\u30b7\u30e7\u30f3",id:"4-\u30b0\u30ec\u30fc\u30b9\u30d5\u30eb\u30c7\u30b0\u30e9\u30c7\u30fc\u30b7\u30e7\u30f3",level:3},{value:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc",id:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc",level:2},{value:"IDataSyncHandler\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9",id:"idatasynchandler\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9",level:3},{value:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u767b\u9332",id:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u767b\u9332",level:3},{value:"\u8907\u6570\u306e\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc",id:"\u8907\u6570\u306e\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc",level:3},{value:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210",id:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210",level:2},{value:"\u30ab\u30b9\u30bf\u30e0S3\u30a4\u30d9\u30f3\u30c8\u306e\u4f8b",id:"\u30ab\u30b9\u30bf\u30e0s3\u30a4\u30d9\u30f3\u30c8\u306e\u4f8b",level:3},{value:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u5909\u63db\u30e1\u30bd\u30c3\u30c9",id:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u5909\u63db\u30e1\u30bd\u30c3\u30c9",level:3},{value:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30bf\u30fc\u30f3",children:"\u30a4\u30d9\u30f3\u30c8\u51e6\u7406\u30d1\u30bf\u30fc\u30f3"})}),"\n",(0,s.jsx)(n.p,{children:"\u3053\u306e\u30ac\u30a4\u30c9\u3067\u306f\u3001S3\u3001Step Functions\u3001SQS\u3001DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u542b\u3080\u69d8\u3005\u306aAWS\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u3092\u4f7f\u7528\u3057\u305f\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",children:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0"}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u5834\u5408\u306b\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"S3\u304b\u3089\u306e\u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3092\u51e6\u7406\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"Step Functions\u3067\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u8abf\u6574\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"SQS\u304b\u3089\u306e\u975e\u540c\u671f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51e6\u7406\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u3092\u4ecb\u3057\u305f\u30c7\u30fc\u30bf\u5909\u66f4\u306b\u5bfe\u5fdc\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3068\u30ea\u30c8\u30e9\u30a4\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"\u901a\u77e5\u3068\u30a2\u30e9\u30fc\u30e0\u3092\u9001\u4fe1\u3059\u308b"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981",children:"\u30a4\u30d9\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u6982\u8981"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     S3      \u2502\u2500\u2500\u2500\u2500>\u2502             \u2502     \u2502   Event     \u2502\n\u2502   Events    \u2502     \u2502             \u2502\u2500\u2500\u2500\u2500>\u2502  Handler 1  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502             \u2502     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502             \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502    Event    \u2502     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    Step     \u2502\u2500\u2500\u2500\u2500>\u2502   Factory   \u2502\u2500\u2500\u2500\u2500>\u2502   Event     \u2502\n\u2502  Functions  \u2502     \u2502             \u2502     \u2502  Handler 2  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502             \u2502     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502             \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502             \u2502     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     SQS     \u2502\u2500\u2500\u2500\u2500>\u2502             \u2502\u2500\u2500\u2500\u2500>\u2502   Event     \u2502\n\u2502   Events    \u2502     \u2502             \u2502     \u2502  Handler 3  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc",children:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc"}),"\n",(0,s.jsx)(n.h3,{id:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc",children:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306f\u53d7\u4fe1\u30a4\u30d9\u30f3\u30c8\u3092\u9069\u5207\u306a\u30cf\u30f3\u30c9\u30e9\u30fc\u306b\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// event-factory.ts\nimport { Injectable } from '@nestjs/common';\nimport {\n  EventFactory,\n  DefaultEventFactory,\n  IEvent,\n} from '@mbc-cqrs-serverless/core';\nimport { S3Event } from 'aws-lambda';\nimport { StepFunctionsEvent, SQSEvent, DynamoDBStreamEvent } from './types';\n\n// Import event classes\nimport { CsvImportEvent } from './csv-import/event/csv-import.event';\nimport { FileProcessEvent } from './file/event/file-process.event';\nimport { OrderCreatedEvent } from './order/event/order-created.event';\nimport { SendNotificationEvent } from './notification/event/send-notification.event';\n\n@EventFactory()\n@Injectable()\nexport class CustomEventFactory extends DefaultEventFactory {\n  /**\n   * Transform S3 events to domain events (S3\u30a4\u30d9\u30f3\u30c8\u3092\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u306b\u5909\u63db)\n   */\n  async transformS3(event: S3Event): Promise<IEvent[]> {\n    const events: IEvent[] = [];\n\n    for (const record of event.Records) {\n      const bucket = record.s3.bucket.name;\n      const key = decodeURIComponent(record.s3.object.key.replace(/\\+/g, ' '));\n\n      // Route based on S3 key pattern (S3\u30ad\u30fc\u30d1\u30bf\u30fc\u30f3\u306b\u57fa\u3065\u3044\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0)\n      if (key.startsWith('imports/csv/')) {\n        events.push(new CsvImportEvent({\n          bucket,\n          key,\n          eventType: record.eventName,\n          size: record.s3.object.size,\n        }));\n      } else if (key.startsWith('uploads/')) {\n        events.push(new FileProcessEvent({\n          bucket,\n          key,\n          eventType: record.eventName,\n        }));\n      }\n    }\n\n    return events;\n  }\n\n  /**\n   * Transform Step Functions events to domain events (Step Functions\u30a4\u30d9\u30f3\u30c8\u3092\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u306b\u5909\u63db)\n   */\n  async transformStepFunction(event: StepFunctionsEvent): Promise<IEvent[]> {\n    const { type, payload, taskToken } = event;\n\n    switch (type) {\n      case 'CSV_IMPORT':\n        return [new CsvImportEvent({\n          ...payload,\n          taskToken,\n        })];\n\n      case 'ORDER_PROCESS':\n        return [new OrderCreatedEvent({\n          ...payload,\n          taskToken,\n        })];\n\n      default:\n        console.warn(`Unknown Step Function event type: ${type}`);\n        return [];\n    }\n  }\n\n  /**\n   * Transform SQS events to domain events (SQS\u30a4\u30d9\u30f3\u30c8\u3092\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u306b\u5909\u63db)\n   */\n  async transformSqs(event: SQSEvent): Promise<IEvent[]> {\n    const events: IEvent[] = [];\n\n    for (const record of event.Records) {\n      const body = JSON.parse(record.body);\n\n      switch (body.type) {\n        case 'SEND_NOTIFICATION':\n          events.push(new SendNotificationEvent(body));\n          break;\n        // Add more event types as needed (\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u30a4\u30d9\u30f3\u30c8\u30bf\u30a4\u30d7\u3092\u8ffd\u52a0)\n      }\n    }\n\n    return events;\n  }\n\n  /**\n   * Transform DynamoDB stream events to domain events (DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u30a4\u30d9\u30f3\u30c8\u3092\u30c9\u30e1\u30a4\u30f3\u30a4\u30d9\u30f3\u30c8\u306b\u5909\u63db)\n   */\n  async transformDynamodbStream(event: DynamoDBStreamEvent): Promise<IEvent[]> {\n    const events: IEvent[] = [];\n\n    for (const record of event.Records) {\n      if (record.eventName === 'INSERT' || record.eventName === 'MODIFY') {\n        const newImage = record.dynamodb?.NewImage;\n        if (newImage) {\n          // Route based on entity type (\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u30bf\u30a4\u30d7\u306b\u57fa\u3065\u3044\u3066\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0)\n          const pk = newImage.pk?.S || '';\n          if (pk.startsWith('ORDER#')) {\n            events.push(new OrderCreatedEvent({\n              pk,\n              sk: newImage.sk?.S,\n              data: newImage,\n            }));\n          }\n        }\n      }\n    }\n\n    return events;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u767b\u9332",children:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u767b\u9332"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// main.module.ts\nimport { Module } from '@nestjs/common';\nimport { CustomEventFactory } from './event-factory';\n\n@Module({\n  providers: [CustomEventFactory],\n  // ... other configuration\n})\nexport class MainModule {}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3",children:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,s.jsx)(n.h3,{id:"\u57fa\u672c\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",children:"\u57fa\u672c\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// order/event/order-created.event.ts\nexport class OrderCreatedEvent {\n  pk: string;\n  sk: string;\n  orderId: string;\n  tenantCode: string;\n  taskToken?: string;\n\n  constructor(data: Partial<OrderCreatedEvent>) {\n    Object.assign(this, data);\n  }\n}\n\n// order/event/order-created.handler.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { EventHandler, IEventHandler } from '@mbc-cqrs-serverless/core';\nimport { OrderCreatedEvent } from './order-created.event';\nimport { NotificationService } from '../../notification/notification.service';\nimport { InventoryService } from '../../inventory/inventory.service';\n\ninterface OrderProcessingResult {\n  success: boolean;\n  orderId: string;\n}\n\n@EventHandler(OrderCreatedEvent)\n@Injectable()\nexport class OrderCreatedHandler implements IEventHandler<OrderCreatedEvent, OrderProcessingResult> {\n  private readonly logger = new Logger(OrderCreatedHandler.name);\n\n  constructor(\n    private readonly notificationService: NotificationService,\n    private readonly inventoryService: InventoryService,\n  ) {}\n\n  /**\n   * Handle order created event (\u6ce8\u6587\u4f5c\u6210\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406)\n   */\n  async execute(event: OrderCreatedEvent): Promise<OrderProcessingResult> {\n    this.logger.log(`Processing order: ${event.orderId}`);\n\n    try {\n      // Process order-related tasks (\u6ce8\u6587\u95a2\u9023\u30bf\u30b9\u30af\u3092\u51e6\u7406)\n      await Promise.all([\n        this.updateInventory(event),\n        this.sendNotification(event),\n        this.triggerWorkflow(event),\n      ]);\n\n      return {\n        success: true,\n        orderId: event.orderId,\n      };\n    } catch (error) {\n      this.logger.error(`Failed to process order ${event.orderId}:`, error);\n      throw error;\n    }\n  }\n\n  private async updateInventory(event: OrderCreatedEvent): Promise<void> {\n    await this.inventoryService.reserveItems(event.orderId);\n  }\n\n  private async sendNotification(event: OrderCreatedEvent): Promise<void> {\n    await this.notificationService.sendOrderConfirmation(event.orderId);\n  }\n\n  private async triggerWorkflow(event: OrderCreatedEvent): Promise<void> {\n    // Trigger additional workflows if needed (\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u8ffd\u52a0\u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u3092\u30c8\u30ea\u30ac\u30fc)\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-functions\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",children:"Step Functions\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"\u30bf\u30b9\u30af\u30c8\u30fc\u30af\u30f3\u30b5\u30dd\u30fc\u30c8\u3092\u4f7f\u7528\u3057\u3066Step Functions\u304b\u3089\u306e\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// import/event/import-process.event.handler.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  EventHandler,\n  IEventHandler,\n  StepFunctionService,\n  SnsService,\n  SnsEvent,\n} from '@mbc-cqrs-serverless/core';\nimport { ConfigService } from '@nestjs/config';\nimport { ImportProcessEvent } from './import-process.event';\nimport { ImportService } from '../import.service';\n\n// Define SNS event for alarm notifications\nclass AlarmSnsEvent extends SnsEvent {\n  importId: string;\n  bucket: string;\n  key: string;\n  errorMessage: string;\n  timestamp: string;\n}\n\n@EventHandler(ImportProcessEvent)\n@Injectable()\nexport class ImportProcessEventHandler\n  implements IEventHandler<ImportProcessEvent>\n{\n  private readonly logger = new Logger(ImportProcessEventHandler.name);\n  private readonly alarmTopicArn: string;\n\n  constructor(\n    private readonly importService: ImportService,\n    private readonly sfnService: StepFunctionService,\n    private readonly snsService: SnsService,\n    private readonly configService: ConfigService,\n  ) {\n    this.alarmTopicArn = this.configService.get<string>('SNS_ALARM_TOPIC_ARN');\n  }\n\n  /**\n   * Process import with Step Function callback (Step Functions\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u3067\u30a4\u30f3\u30dd\u30fc\u30c8\u3092\u51e6\u7406)\n   */\n  async execute(event: ImportProcessEvent): Promise<{ success: boolean; importId: string }> {\n    this.logger.log(`Processing import: ${event.importId}`);\n\n    try {\n      // Process the import\n      const result = await this.importService.processImport(event);\n\n      // Resume Step Functions execution on success\n      if (event.taskToken) {\n        await this.sfnService.resumeExecution(event.taskToken, result);\n      }\n\n      return { success: true, importId: event.importId };\n    } catch (error) {\n      this.logger.error(`Import failed: ${event.importId}`, error);\n\n      // Send alarm notification (\u30a2\u30e9\u30fc\u30e0\u901a\u77e5\u3092\u9001\u4fe1)\n      await this.sendAlarm(event, error as Error);\n\n      throw error;\n    }\n  }\n\n  private async sendAlarm(event: ImportProcessEvent, error: Error): Promise<void> {\n    const alarmEvent: AlarmSnsEvent = {\n      action: 'IMPORT_ERROR',\n      importId: event.importId,\n      bucket: event.bucket,\n      key: event.key,\n      errorMessage: error.message,\n      timestamp: new Date().toISOString(),\n    };\n\n    await this.snsService.publish(alarmEvent, this.alarmTopicArn);\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"s3\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",children:"S3\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"S3\u304b\u3089\u306e\u30d5\u30a1\u30a4\u30eb\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3092\u51e6\u7406\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// file/event/file-upload.event.ts\nexport class FileUploadEvent {\n  bucket: string;\n  key: string;\n  size: number;\n  eventType: string;\n\n  constructor(data: Partial<FileUploadEvent>) {\n    Object.assign(this, data);\n  }\n}\n\n// file/event/file-upload.handler.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { EventHandler, IEventHandler, S3Service } from '@mbc-cqrs-serverless/core';\nimport { GetObjectCommand } from '@aws-sdk/client-s3';\nimport { FileUploadEvent } from './file-upload.event';\nimport { FileProcessService } from '../file-process.service';\n\ninterface FileProcessingResult {\n  status: 'processed' | 'skipped';\n  fileType?: string;\n  reason?: string;\n}\n\n@EventHandler(FileUploadEvent)\n@Injectable()\nexport class FileUploadHandler implements IEventHandler<FileUploadEvent, FileProcessingResult> {\n  private readonly logger = new Logger(FileUploadHandler.name);\n\n  constructor(\n    private readonly s3Service: S3Service,\n    private readonly fileProcessService: FileProcessService,\n  ) {}\n\n  /**\n   * Process uploaded file (\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305f\u30d5\u30a1\u30a4\u30eb\u3092\u51e6\u7406)\n   */\n  async execute(event: FileUploadEvent): Promise<FileProcessingResult> {\n    this.logger.log(`Processing file: ${event.key}`);\n\n    // Get file content from S3\n    const command = new GetObjectCommand({\n      Bucket: event.bucket,\n      Key: event.key,\n    });\n    const response = await this.s3Service.client.send(command);\n\n    // Determine file type and process accordingly (\u30d5\u30a1\u30a4\u30eb\u30bf\u30a4\u30d7\u3092\u5224\u5b9a\u3057\u3066\u9069\u5207\u306b\u51e6\u7406)\n    const fileExtension = event.key.split('.').pop()?.toLowerCase();\n\n    switch (fileExtension) {\n      case 'csv':\n        await this.fileProcessService.processCsv(response.Body, event);\n        return { status: 'processed', fileType: 'csv' };\n      case 'xlsx':\n      case 'xls':\n        await this.fileProcessService.processExcel(response.Body, event);\n        return { status: 'processed', fileType: fileExtension };\n      case 'pdf':\n        await this.fileProcessService.processPdf(response.Body, event);\n        return { status: 'processed', fileType: 'pdf' };\n      case 'jpg':\n      case 'jpeg':\n      case 'png':\n        await this.fileProcessService.processImage(response.Body, event);\n        return { status: 'processed', fileType: fileExtension };\n      default:\n        this.logger.warn(`Unsupported file type: ${fileExtension}`);\n        return { status: 'skipped', reason: 'Unsupported file type' };\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"sqs\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",children:"SQS\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"SQS\u304b\u3089\u306e\u975e\u540c\u671f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u51e6\u7406\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// notification/event/send-notification.event.ts\nexport class SendNotificationEvent {\n  type: 'EMAIL' | 'SMS' | 'PUSH';\n  recipient: string;\n  subject: string;\n  body: string;\n  templateId?: string;\n  templateData?: Record<string, any>;\n\n  constructor(data: Partial<SendNotificationEvent>) {\n    Object.assign(this, data);\n  }\n}\n\n// notification/event/send-notification.handler.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  EventHandler,\n  IEventHandler,\n  EmailService,\n} from '@mbc-cqrs-serverless/core';\nimport { SendNotificationEvent } from './send-notification.event';\n\ninterface NotificationResult {\n  status: 'sent' | 'skipped';\n  type: 'EMAIL' | 'SMS' | 'PUSH';\n  reason?: string;\n}\n\n@EventHandler(SendNotificationEvent)\n@Injectable()\nexport class SendNotificationHandler\n  implements IEventHandler<SendNotificationEvent, NotificationResult>\n{\n  private readonly logger = new Logger(SendNotificationHandler.name);\n\n  constructor(private readonly emailService: EmailService) {}\n\n  /**\n   * Send notification based on type (\u30bf\u30a4\u30d7\u306b\u57fa\u3065\u3044\u3066\u901a\u77e5\u3092\u9001\u4fe1)\n   */\n  async execute(event: SendNotificationEvent): Promise<NotificationResult> {\n    this.logger.log(`Sending ${event.type} notification to ${event.recipient}`);\n\n    switch (event.type) {\n      case 'EMAIL':\n        return this.sendEmail(event);\n      case 'SMS':\n        return this.sendSms(event);\n      case 'PUSH':\n        return this.sendPush(event);\n      default:\n        throw new Error(`Unknown notification type: ${event.type}`);\n    }\n  }\n\n  private async sendEmail(event: SendNotificationEvent): Promise<NotificationResult> {\n    let body = event.body;\n\n    // Render template if provided (\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0)\n    if (event.templateId && event.templateData) {\n      body = await this.renderTemplate(event.templateId, event.templateData);\n    }\n\n    await this.emailService.sendEmail({\n      toAddrs: [event.recipient],\n      subject: event.subject,\n      body,\n    });\n\n    return { status: 'sent', type: 'EMAIL' };\n  }\n\n  private async sendSms(event: SendNotificationEvent): Promise<NotificationResult> {\n    // Implement SMS sending logic\n    this.logger.log('SMS sending not implemented');\n    return { status: 'skipped', type: 'SMS', reason: 'Not implemented' };\n  }\n\n  private async sendPush(event: SendNotificationEvent): Promise<NotificationResult> {\n    // Implement push notification logic\n    this.logger.log('Push notification not implemented');\n    return { status: 'skipped', type: 'PUSH', reason: 'Not implemented' };\n  }\n\n  private async renderTemplate(\n    templateId: string,\n    data: Record<string, any>,\n  ): Promise<string> {\n    // Template rendering logic\n    return `Template ${templateId} rendered with data`;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"dynamodb\u30b9\u30c8\u30ea\u30fc\u30e0\u30cf\u30f3\u30c9\u30e9\u30fc",children:"DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.h3,{id:"\u30c7\u30fc\u30bf\u5909\u66f4\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",children:"\u30c7\u30fc\u30bf\u5909\u66f4\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"DynamoDB\u306e\u30c7\u30fc\u30bf\u5909\u66f4\u306b\u5bfe\u5fdc\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// sync/event/data-change.event.ts\nexport class DataChangeEvent {\n  pk: string;\n  sk: string;\n  eventType: 'INSERT' | 'MODIFY' | 'REMOVE';\n  oldImage?: Record<string, any>;\n  newImage?: Record<string, any>;\n\n  constructor(data: Partial<DataChangeEvent>) {\n    Object.assign(this, data);\n  }\n}\n\n// sync/event/data-change.handler.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { EventHandler, IEventHandler } from '@mbc-cqrs-serverless/core';\nimport { DataChangeEvent } from './data-change.event';\nimport { ExternalSyncService } from '../external-sync.service';\nimport { CacheService } from '../../cache/cache.service';\n\ninterface DataSyncResult {\n  synced: boolean;\n  type?: string;\n}\n\n@EventHandler(DataChangeEvent)\n@Injectable()\nexport class DataChangeHandler implements IEventHandler<DataChangeEvent, DataSyncResult> {\n  private readonly logger = new Logger(DataChangeHandler.name);\n\n  constructor(\n    private readonly externalSyncService: ExternalSyncService,\n    private readonly cacheService: CacheService,\n  ) {}\n\n  /**\n   * Handle data changes from DynamoDB stream (DynamoDB\u30b9\u30c8\u30ea\u30fc\u30e0\u304b\u3089\u306e\u30c7\u30fc\u30bf\u5909\u66f4\u3092\u51e6\u7406)\n   */\n  async execute(event: DataChangeEvent): Promise<DataSyncResult> {\n    this.logger.log(\n      `Data change: ${event.eventType} on ${event.pk}/${event.sk}`,\n    );\n\n    // Invalidate cache (\u30ad\u30e3\u30c3\u30b7\u30e5\u3092\u7121\u52b9\u5316)\n    await this.cacheService.invalidate(event.pk, event.sk);\n\n    // Sync to external systems based on entity type (\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u30bf\u30a4\u30d7\u306b\u57fa\u3065\u3044\u3066\u5916\u90e8\u30b7\u30b9\u30c6\u30e0\u306b\u540c\u671f)\n    const entityType = event.pk.split('#')[0];\n\n    switch (entityType) {\n      case 'PRODUCT':\n        return this.syncProduct(event);\n      case 'ORDER':\n        return this.syncOrder(event);\n      case 'USER':\n        return this.syncUser(event);\n      default:\n        this.logger.debug(`No external sync for entity type: ${entityType}`);\n        return { synced: false };\n    }\n  }\n\n  private async syncProduct(event: DataChangeEvent): Promise<DataSyncResult> {\n    if (event.eventType === 'REMOVE') {\n      await this.externalSyncService.deleteProduct(event.pk, event.sk);\n    } else {\n      await this.externalSyncService.upsertProduct(event.newImage);\n    }\n    return { synced: true, type: 'PRODUCT' };\n  }\n\n  private async syncOrder(event: DataChangeEvent): Promise<DataSyncResult> {\n    // Sync order to external ERP system (\u5916\u90e8ERP\u30b7\u30b9\u30c6\u30e0\u306b\u6ce8\u6587\u3092\u540c\u671f)\n    await this.externalSyncService.syncOrder(event.newImage);\n    return { synced: true, type: 'ORDER' };\n  }\n\n  private async syncUser(event: DataChangeEvent): Promise<DataSyncResult> {\n    // Sync user to external identity provider (\u5916\u90e8ID\u30d7\u30ed\u30d0\u30a4\u30c0\u30fc\u306b\u30e6\u30fc\u30b6\u30fc\u3092\u540c\u671f)\n    await this.externalSyncService.syncUser(event.newImage);\n    return { synced: true, type: 'USER' };\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3068\u30ea\u30c8\u30e9\u30a4",children:"\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3068\u30ea\u30c8\u30e9\u30a4"}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u30d1\u30bf\u30fc\u30f3\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3068\u30ea\u30c8\u30e9\u30a4\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5\u3059\u308b\u65b9\u6cd5\u3092\u793a\u3057\u3066\u3044\u307e\u3059\u3002\u3053\u308c\u3089\u306f\u3001\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u5185\u3067\u72ec\u81ea\u306b\u4f5c\u6210\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u5b9f\u88c5\u4f8b\u3067\u3059\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"\u30ea\u30c8\u30e9\u30a4\u30d1\u30bf\u30fc\u30f3\u306e\u4f8b",children:"\u30ea\u30c8\u30e9\u30a4\u30d1\u30bf\u30fc\u30f3\u306e\u4f8b"}),"\n",(0,s.jsx)(n.admonition,{title:"\u5b9f\u88c5\u4f8b",type:"info",children:(0,s.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u30ea\u30c8\u30e9\u30a4\u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u306f\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3067\u306f\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002Lambda\u5b9f\u884c\u5185\u3067\u30ea\u30c8\u30e9\u30a4\u6a5f\u80fd\u304c\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u81ea\u5206\u3067\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// common/event/retry.decorator.ts\nimport { Logger } from '@nestjs/common';\n\nexport interface RetryOptions {\n  maxRetries: number;\n  backoffMs: number;\n  backoffMultiplier: number;\n}\n\nconst DEFAULT_RETRY_OPTIONS: RetryOptions = {\n  maxRetries: 3,\n  backoffMs: 1000,\n  backoffMultiplier: 2,\n};\n\n/**\n * Example retry decorator for event handlers (\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u7528\u306e\u30ea\u30c8\u30e9\u30a4\u30c7\u30b3\u30ec\u30fc\u30bf\u30fc\u4f8b)\n */\nexport function WithRetry(options: Partial<RetryOptions> = {}) {\n  const retryOptions = { ...DEFAULT_RETRY_OPTIONS, ...options };\n\n  return function (\n    target: any,\n    propertyKey: string,\n    descriptor: PropertyDescriptor,\n  ) {\n    const originalMethod = descriptor.value;\n    const logger = new Logger(`${target.constructor.name}.${propertyKey}`);\n\n    descriptor.value = async function (...args: any[]) {\n      let lastError: Error;\n      let delay = retryOptions.backoffMs;\n\n      for (let attempt = 1; attempt <= retryOptions.maxRetries; attempt++) {\n        try {\n          return await originalMethod.apply(this, args);\n        } catch (error) {\n          lastError = error;\n          logger.warn(\n            `Attempt ${attempt}/${retryOptions.maxRetries} failed: ${error.message}`,\n          );\n\n          if (attempt < retryOptions.maxRetries) {\n            await new Promise(resolve => setTimeout(resolve, delay));\n            delay *= retryOptions.backoffMultiplier;\n          }\n        }\n      }\n\n      logger.error(`All ${retryOptions.maxRetries} attempts failed`);\n      throw lastError!;\n    };\n\n    return descriptor;\n  };\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"aws\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30aa\u30d7\u30b7\u30e7\u30f3",children:"AWS\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u756a\u74b0\u5883\u3067\u306f\u3001AWS\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30e1\u30ab\u30cb\u30ba\u30e0\u306e\u4f7f\u7528\u3092\u691c\u8a0e\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"SQS\u30ea\u30c8\u30e9\u30a4"}),": SQS\u30ad\u30e5\u30fc\u306e",(0,s.jsx)(n.code,{children:"maxReceiveCount"}),"\u3092\u8a2d\u5b9a\u3057\u3066\u3001\u5931\u6557\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u81ea\u52d5\u7684\u306b\u30ea\u30c8\u30e9\u30a4\u3057\u307e\u3059"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Lambda\u30ea\u30c8\u30e9\u30a4"}),": \u975e\u540c\u671f\u547c\u3073\u51fa\u3057\u306eLambda\u95a2\u6570\u306b\u30ea\u30c8\u30e9\u30a4\u8a2d\u5b9a\u3092\u69cb\u6210\u3057\u307e\u3059"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Step Functions\u30ea\u30c8\u30e9\u30a4"}),": \u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9a\u7fa9\u3067",(0,s.jsx)(n.code,{children:"Retry"}),"\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u4f7f\u7528\u3057\u307e\u3059"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u51aa\u7b49\u306a\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc",children:"1. \u51aa\u7b49\u306a\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface IdempotentResult {\n  skipped?: boolean;\n  processed?: boolean;\n}\n\n// Always check if event was already processed (\u30a4\u30d9\u30f3\u30c8\u304c\u65e2\u306b\u51e6\u7406\u3055\u308c\u305f\u304b\u3069\u3046\u304b\u3092\u5e38\u306b\u30c1\u30a7\u30c3\u30af)\nasync execute(event: OrderEvent): Promise<IdempotentResult> {\n  const existing = await this.prismaService.processedEvent.findUnique({\n    where: { eventId: event.eventId },\n  });\n\n  if (existing) {\n    this.logger.log(`Event ${event.eventId} already processed, skipping`);\n    return { skipped: true };\n  }\n\n  // Process event\n  const result = await this.processEvent(event);\n\n  // Mark as processed\n  await this.prismaService.processedEvent.create({\n    data: { eventId: event.eventId, processedAt: new Date() },\n  });\n\n  return { processed: true, ...result };\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-\u69cb\u9020\u5316\u30ed\u30ae\u30f3\u30b0",children:"2. \u69cb\u9020\u5316\u30ed\u30ae\u30f3\u30b0"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Use structured logging for better observability (\u3088\u308a\u826f\u3044\u53ef\u89b3\u6e2c\u6027\u306e\u305f\u3081\u306b\u69cb\u9020\u5316\u30ed\u30b0\u3092\u4f7f\u7528)\nthis.logger.log({\n  message: 'Processing event',\n  eventType: event.constructor.name,\n  eventId: event.id,\n  tenantCode: event.tenantCode,\n  correlationId: event.correlationId,\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u51e6\u7406",children:"3. \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u51e6\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface TimeoutResult {\n  success: boolean;\n  data?: Record<string, unknown>;\n}\n\n// Implement timeout for long-running operations (\u9577\u6642\u9593\u5b9f\u884c\u3055\u308c\u308b\u64cd\u4f5c\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u5b9f\u88c5)\nasync execute(event: LongRunningEvent): Promise<TimeoutResult> {\n  const timeout = 25000; // 25 seconds (Lambda default is 30s)\n\n  const result = await Promise.race([\n    this.processEvent(event),\n    new Promise<never>((_, reject) =>\n      setTimeout(() => reject(new Error('Operation timeout')), timeout),\n    ),\n  ]);\n\n  return result;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-\u30b0\u30ec\u30fc\u30b9\u30d5\u30eb\u30c7\u30b0\u30e9\u30c7\u30fc\u30b7\u30e7\u30f3",children:"4. \u30b0\u30ec\u30fc\u30b9\u30d5\u30eb\u30c7\u30b0\u30e9\u30c7\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface BatchProcessingResult {\n  processed: number;\n  failed: number;\n}\n\n// Continue processing even if some operations fail (\u4e00\u90e8\u306e\u64cd\u4f5c\u304c\u5931\u6557\u3057\u3066\u3082\u51e6\u7406\u3092\u7d99\u7d9a)\nasync execute(event: BatchEvent): Promise<BatchProcessingResult> {\n  const results: unknown[] = [];\n  const errors: Array<{ item: unknown; error: string }> = [];\n\n  for (const item of event.items) {\n    try {\n      results.push(await this.processItem(item));\n    } catch (error) {\n      errors.push({ item, error: (error as Error).message });\n      // Continue with next item (\u6b21\u306e\u30a2\u30a4\u30c6\u30e0\u306b\u9032\u3080)\n    }\n  }\n\n  if (errors.length > 0) {\n    this.logger.warn(`${errors.length} items failed`, { errors });\n  }\n\n  return { processed: results.length, failed: errors.length };\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc",children:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"\u30c7\u30fc\u30bf\u540c\u671f\u30a4\u30d9\u30f3\u30c8\u306f\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5185\u3067\u6700\u3082\u3088\u304f\u767b\u9332\u3055\u308c\u308b\u30a4\u30d9\u30f3\u30c8\u306e1\u3064\u3067\u3042\u308b\u305f\u3081\u3001\u7279\u306b\u91cd\u8981\u306a\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u3067\u3059\u3002\u3053\u306e\u30a4\u30d9\u30f3\u30c8\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u306f\u3001\u7570\u306a\u308b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u9593\u306e\u30c7\u30fc\u30bf\u6574\u5408\u6027\u3068\u540c\u671f\u3092\u78ba\u4fdd\u3059\u308b\u4e0a\u3067\u91cd\u8981\u306a\u5f79\u5272\u3092\u679c\u305f\u3057\u307e\u3059\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"idatasynchandler\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9",children:"IDataSyncHandler\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9"}),"\n",(0,s.jsxs)(n.p,{children:["\u6163\u4f8b\u3068\u3057\u3066\u3001",(0,s.jsx)(n.code,{children:"IDataSyncHandler"}),"\u3092\u5b9f\u88c5\u3059\u308b\u30af\u30e9\u30b9\u3092\u4f5c\u6210\u3057\u3001up\u3068down\u30e1\u30bd\u30c3\u30c9\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3057\u307e\u3059\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { CommandModel, IDataSyncHandler } from "@mbc-cqrs-serverless/core";\nimport { Injectable, Logger } from "@nestjs/common";\nimport { PrismaService } from "src/prisma";\n\n@Injectable()\nexport class ProductDataSyncRdsHandler implements IDataSyncHandler<void, void> {\n  private readonly logger = new Logger(ProductDataSyncRdsHandler.name);\n\n  constructor(private readonly prismaService: PrismaService) {}\n\n  /**\n   * Sync data from DynamoDB to RDS on create/update (\u4f5c\u6210/\u66f4\u65b0\u6642\u306bDynamoDB\u304b\u3089RDS\u306b\u30c7\u30fc\u30bf\u3092\u540c\u671f)\n   */\n  async up(cmd: CommandModel): Promise<void> {\n    this.logger.debug(\'Syncing to RDS:\', cmd.pk, cmd.sk);\n\n    const { pk, sk, id, code, name, tenantCode, attributes } = cmd;\n\n    await this.prismaService.product.upsert({\n      where: { id },\n      create: {\n        id,\n        pk,\n        sk,\n        code,\n        name,\n        tenantCode,\n        ...attributes,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      },\n      update: {\n        name,\n        ...attributes,\n        updatedAt: new Date(),\n      },\n    });\n  }\n\n  /**\n   * Handle delete/rollback operations (\u524a\u9664/\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u64cd\u4f5c\u3092\u51e6\u7406)\n   */\n  async down(cmd: CommandModel): Promise<void> {\n    this.logger.debug(\'Removing from RDS:\', cmd.pk, cmd.sk);\n\n    await this.prismaService.product.delete({\n      where: { id: cmd.id },\n    }).catch(() => {\n      // Ignore if already deleted (\u65e2\u306b\u524a\u9664\u3055\u308c\u3066\u3044\u308b\u5834\u5408\u306f\u7121\u8996)\n    });\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u767b\u9332",children:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u767b\u9332"}),"\n",(0,s.jsxs)(n.p,{children:["\u30cf\u30f3\u30c9\u30e9\u30fc\u3092",(0,s.jsx)(n.code,{children:"CommandModule"}),"\u306b\u767b\u9332\u3057\u307e\u3059\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { CommandModule } from '@mbc-cqrs-serverless/core';\nimport { ProductDataSyncRdsHandler } from './handler/product-rds.handler';\n\n@Module({\n  imports: [\n    CommandModule.register({\n      tableName: 'product',\n      dataSyncHandlers: [ProductDataSyncRdsHandler],\n    }),\n  ],\n  // ...\n})\nexport class ProductModule {}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u8907\u6570\u306e\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc",children:"\u8907\u6570\u306e\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc"}),"\n",(0,s.jsx)(n.p,{children:"\u7570\u306a\u308b\u540c\u671f\u30bf\u30fc\u30b2\u30c3\u30c8\u306b\u5bfe\u3057\u3066\u8907\u6570\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u767b\u9332\u3067\u304d\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"CommandModule.register({\n  tableName: 'order',\n  dataSyncHandlers: [\n    OrderRdsSyncHandler,      // Sync to RDS for queries\n    OrderElasticSyncHandler,  // Sync to Elasticsearch for search\n    OrderAnalyticsSyncHandler, // Sync to analytics warehouse\n  ],\n}),\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210",children:"\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210"}),"\n",(0,s.jsxs)(n.p,{children:["\u30ab\u30b9\u30bf\u30e0\u30a4\u30d9\u30f3\u30c8\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u3001",(0,s.jsx)(n.code,{children:"@mbc-cqrs-serverless/core"}),"\u304b\u3089",(0,s.jsx)(n.code,{children:"IEvent"}),"\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002\u30a4\u30d9\u30f3\u30c8\u30bd\u30fc\u30b9\u306b\u5fdc\u3058\u3066\u3001",(0,s.jsx)(n.code,{children:"aws-lambda"}),"\u30e9\u30a4\u30d6\u30e9\u30ea\u304b\u3089",(0,s.jsx)(n.code,{children:"SNSEventRecord"}),"\u3001",(0,s.jsx)(n.code,{children:"SQSRecord"}),"\u3001",(0,s.jsx)(n.code,{children:"DynamoDBRecord"}),"\u3001",(0,s.jsx)(n.code,{children:"EventBridgeEvent"}),"\u3001",(0,s.jsx)(n.code,{children:"S3EventRecord"}),"\u306a\u3069\u306e2\u756a\u76ee\u306e\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3082\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"\u30ab\u30b9\u30bf\u30e0s3\u30a4\u30d9\u30f3\u30c8\u306e\u4f8b",children:"\u30ab\u30b9\u30bf\u30e0S3\u30a4\u30d9\u30f3\u30c8\u306e\u4f8b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// custom-s3-import.event.ts\nimport { IEvent } from "@mbc-cqrs-serverless/core";\nimport { S3EventRecord } from "aws-lambda";\n\nexport class CustomS3ImportEvent implements IEvent, Partial<S3EventRecord> {\n  source: string;\n  bucket: string;\n  key: string;\n  size: number;\n  eventType: string;\n\n  static fromS3Record(record: S3EventRecord): CustomS3ImportEvent {\n    const event = new CustomS3ImportEvent();\n    event.source = record.eventSource;\n    event.bucket = record.s3.bucket.name;\n    event.key = record.s3.object.key;\n    event.size = record.s3.object.size;\n    event.eventType = record.eventName;\n    return event;\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u5909\u63db\u30e1\u30bd\u30c3\u30c9",children:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u5909\u63db\u30e1\u30bd\u30c3\u30c9"}),"\n",(0,s.jsx)(n.p,{children:"\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306f\u69d8\u3005\u306aAWS\u30bd\u30fc\u30b9\u304b\u3089\u306e\u30a4\u30d9\u30f3\u30c8\u5909\u63db\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Available transform methods in DefaultEventFactory\ntransformSqs(event: SQSEvent): Promise<IEvent[]>;\ntransformSns(event: SNSEvent): Promise<IEvent[]>;\ntransformDynamodbStream(event: DynamoDBStreamEvent): Promise<IEvent[]>;\ntransformEventBridge(event: EventBridgeEvent<any, any>): Promise<IEvent[]>;\ntransformStepFunction(event: StepFunctionsEvent<any>): Promise<IEvent[]>;\ntransformS3(event: S3Event): Promise<IEvent[]>;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./backend-development",children:"\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u958b\u767a\u30ac\u30a4\u30c9"})," - \u30b3\u30a2\u30d1\u30bf\u30fc\u30f3"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./architecture/step-functions",children:"Step Functions"})," - \u30ef\u30fc\u30af\u30d5\u30ed\u30fc\u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./data-sync-handler-examples",children:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f8b"})," - \u5305\u62ec\u7684\u306a\u540c\u671f\u306e\u4f8b"]}),"\n"]})]})}function v(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);