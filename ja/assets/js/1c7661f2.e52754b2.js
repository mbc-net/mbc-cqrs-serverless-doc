"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[5023],{5733:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"build-todo-app","title":"Todo\u30a2\u30d7\u30ea\u306e\u69cb\u7bc9","description":"CQRS\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u306a\u304c\u3089\u3001\u5b8c\u5168\u306aTodo\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30b9\u30c6\u30c3\u30d7\u30d0\u30a4\u30b9\u30c6\u30c3\u30d7\u3067\u69cb\u7bc9\u3057\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/build-todo-app.md","sourceDirName":".","slug":"/build-todo-app","permalink":"/ja/docs/build-todo-app","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"CQRS\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u306a\u304c\u3089\u3001\u5b8c\u5168\u306aTodo\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30b9\u30c6\u30c3\u30d7\u30d0\u30a4\u30b9\u30c6\u30c3\u30d7\u3067\u69cb\u7bc9\u3057\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"\u30af\u30a4\u30c3\u30af\u30b9\u30bf\u30fc\u30c8\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb","permalink":"/ja/docs/quickstart-tutorial"},"next":{"title":"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3","permalink":"/ja/docs/architecture"}}');var r=t(4848),s=t(8453);const a={description:"CQRS\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u306a\u304c\u3089\u3001\u5b8c\u5168\u306aTodo\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u30b9\u30c6\u30c3\u30d7\u30d0\u30a4\u30b9\u30c6\u30c3\u30d7\u3067\u69cb\u7bc9\u3057\u307e\u3059\u3002"},i="Todo\u30a2\u30d7\u30ea\u306e\u69cb\u7bc9",d={},c=[{value:"\u69cb\u7bc9\u3059\u308b\u3082\u306e",id:"\u69cb\u7bc9\u3059\u308b\u3082\u306e",level:2},{value:"\u524d\u63d0\u6761\u4ef6",id:"\u524d\u63d0\u6761\u4ef6",level:2},{value:"\u30b5\u30f3\u30d7\u30eb\u306e\u5b9f\u884c",id:"\u30b5\u30f3\u30d7\u30eb\u306e\u5b9f\u884c",level:2},{value:"Part 1\uff1a\u57fa\u672c\u7684\u306aCQRS\u5b9f\u88c5\uff08step-02-create\uff09",id:"part-1\u57fa\u672c\u7684\u306acqrs\u5b9f\u88c5step-02-create",level:2},{value:"\u30b9\u30c6\u30c3\u30d71\uff1a\u30d8\u30eb\u30d1\u30fc\u95a2\u6570\u306e\u4f5c\u6210",id:"\u30b9\u30c6\u30c3\u30d71\u30d8\u30eb\u30d1\u30fc\u95a2\u6570\u306e\u4f5c\u6210",level:3},{value:"\u30b9\u30c6\u30c3\u30d72\uff1aDTO\u306e\u5b9a\u7fa9",id:"\u30b9\u30c6\u30c3\u30d72dto\u306e\u5b9a\u7fa9",level:3},{value:"\u30b9\u30c6\u30c3\u30d73\uff1a\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u5b9a\u7fa9",id:"\u30b9\u30c6\u30c3\u30d73\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u5b9a\u7fa9",level:3},{value:"\u30b9\u30c6\u30c3\u30d74\uff1a\u30b5\u30fc\u30d3\u30b9\u306e\u5b9f\u88c5",id:"\u30b9\u30c6\u30c3\u30d74\u30b5\u30fc\u30d3\u30b9\u306e\u5b9f\u88c5",level:3},{value:"\u30b9\u30c6\u30c3\u30d75\uff1a\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u4f5c\u6210",id:"\u30b9\u30c6\u30c3\u30d75\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u4f5c\u6210",level:3},{value:"\u30b9\u30c6\u30c3\u30d76\uff1a\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210",id:"\u30b9\u30c6\u30c3\u30d76\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210",level:3},{value:"Part 2\uff1aRDS\u30c7\u30fc\u30bf\u540c\u671f\uff08step-03-rds-sync\uff09",id:"part-2rds\u30c7\u30fc\u30bf\u540c\u671fstep-03-rds-sync",level:2},{value:"Prisma\u30b9\u30ad\u30fc\u30de\u306e\u66f4\u65b0",id:"prisma\u30b9\u30ad\u30fc\u30de\u306e\u66f4\u65b0",level:3},{value:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210",id:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210",level:3},{value:"\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u767b\u9332",id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u767b\u9332",level:3},{value:"Part 3\uff1a\u8aad\u307f\u53d6\u308a\u64cd\u4f5c\uff08step-04-read\uff09",id:"part-3\u8aad\u307f\u53d6\u308a\u64cd\u4f5cstep-04-read",level:2},{value:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0",id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0",level:3},{value:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0",id:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0",level:3},{value:"Part 4\uff1a\u691c\u7d22\u64cd\u4f5c\uff08step-05-search\uff09",id:"part-4\u691c\u7d22\u64cd\u4f5cstep-05-search",level:2},{value:"\u691c\u7d22DTO\u306e\u4f5c\u6210",id:"\u691c\u7d22dto\u306e\u4f5c\u6210",level:3},{value:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0",id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0-1",level:3},{value:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0",id:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0-1",level:3},{value:"Part 5\uff1a\u66f4\u65b0\u3068\u524a\u9664\uff08step-06-update-delete\uff09",id:"part-5\u66f4\u65b0\u3068\u524a\u9664step-06-update-delete",level:2},{value:"\u66f4\u65b0DTO\u306e\u4f5c\u6210",id:"\u66f4\u65b0dto\u306e\u4f5c\u6210",level:3},{value:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0",id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0-2",level:3},{value:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0",id:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0-2",level:3},{value:"Part 6\uff1a\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7\uff08step-07-sequence\uff09",id:"part-6\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7step-07-sequence",level:2},{value:"\u30b7\u30fc\u30b1\u30f3\u30b9\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",id:"\u30b7\u30fc\u30b1\u30f3\u30b9\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",level:3},{value:"\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u66f4\u65b0",id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u66f4\u65b0",level:3},{value:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0",id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0-3",level:3},{value:"Part 7\uff1a\u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406\uff08complete/with-task\uff09",id:"part-7\u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406completewith-task",level:2},{value:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",id:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",level:3},{value:"\u30bf\u30b9\u30af\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210",id:"\u30bf\u30b9\u30af\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210",level:3},{value:"\u30bf\u30b9\u30af\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210",id:"\u30bf\u30b9\u30af\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210",level:3},{value:"\u30bf\u30b9\u30af\u30ad\u30e5\u30fc\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u4f5c\u6210",id:"\u30bf\u30b9\u30af\u30ad\u30e5\u30fc\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u4f5c\u6210",level:3},{value:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210",id:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210",level:3},{value:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8",id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8",level:2},{value:"\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c",id:"\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c",level:3},{value:"API\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306e\u30c6\u30b9\u30c8",id:"api\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306e\u30c6\u30b9\u30c8",level:3},{value:"\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8",id:"\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8",level:3},{value:"E2E\u30c6\u30b9\u30c8",id:"e2e\u30c6\u30b9\u30c8",level:3},{value:"\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u30ea\u30dd\u30b8\u30c8\u30ea",id:"\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u30ea\u30dd\u30b8\u30c8\u30ea",level:2},{value:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7",id:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"todo\u30a2\u30d7\u30ea\u306e\u69cb\u7bc9",children:"Todo\u30a2\u30d7\u30ea\u306e\u69cb\u7bc9"})}),"\n",(0,r.jsx)(n.p,{children:"\u3053\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u3067\u306f\u3001MBC CQRS Serverless\u3092\u4f7f\u7528\u3057\u3066\u5b8c\u5168\u306aTodo\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u69cb\u7bc9\u3059\u308b\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\u3002CQRS\u30d1\u30bf\u30fc\u30f3\u3001\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3001\u6bb5\u968e\u7684\u306a\u6a5f\u80fd\u8ffd\u52a0\u3092\u5b66\u3073\u307e\u3059\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u3053\u306e\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb\u306f\u3001\u6bb5\u968e\u7684\u306a\u30b9\u30c6\u30c3\u30d7\u3067\u69cb\u6210\u3055\u308c\u305f",(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples",children:"\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9"}),"\u306b\u5f93\u3063\u3066\u3044\u307e\u3059\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u69cb\u7bc9\u3059\u308b\u3082\u306e",children:"\u69cb\u7bc9\u3059\u308b\u3082\u306e"}),"\n",(0,r.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u6a5f\u80fd\u3092\u6301\u3064\u5b8c\u5168\u306b\u6a5f\u80fd\u3059\u308bTodo\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Todo\u306eCRUD\u64cd\u4f5c"}),"\n",(0,r.jsx)(n.li,{children:"\u30b3\u30de\u30f3\u30c9/\u30af\u30a8\u30ea\u5206\u96e2\u306b\u3088\u308bCQRS\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,r.jsx)(n.li,{children:"RDS\u3078\u306e\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u30c7\u30fc\u30bf\u540c\u671f"}),"\n",(0,r.jsx)(n.li,{children:"\u30aa\u30d7\u30b7\u30e7\u30f3\uff1aTodo\u306e\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7"}),"\n",(0,r.jsx)(n.li,{children:"\u30aa\u30d7\u30b7\u30e7\u30f3\uff1a\u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u524d\u63d0\u6761\u4ef6",children:"\u524d\u63d0\u6761\u4ef6"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./quickstart-tutorial",children:"\u30af\u30a4\u30c3\u30af\u30b9\u30bf\u30fc\u30c8\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb"}),"\u3092\u5b8c\u4e86\u3057\u3066\u3044\u308b\u3053\u3068"]}),"\n",(0,r.jsx)(n.li,{children:"NestJS\u306e\u57fa\u672c\u7684\u306a\u7406\u89e3"}),"\n",(0,r.jsx)(n.li,{children:"\u30ed\u30fc\u30ab\u30eb\u958b\u767a\u7528\u306bDocker\u304c\u5b9f\u884c\u4e2d\u3067\u3042\u308b\u3053\u3068"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u30b5\u30f3\u30d7\u30eb\u306e\u5b9f\u884c",children:"\u30b5\u30f3\u30d7\u30eb\u306e\u5b9f\u884c"}),"\n",(0,r.jsx)(n.p,{children:"\u5404\u30b9\u30c6\u30c3\u30d7\u306b\u306f\u5b8c\u5168\u306b\u52d5\u4f5c\u3059\u308b\u30b5\u30f3\u30d7\u30eb\u304c\u3042\u308a\u307e\u3059\u3002\u30b5\u30f3\u30d7\u30eb\u3092\u5b9f\u884c\u3059\u308b\u306b\u306f\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u30b9\u30c6\u30c3\u30d7\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\ncd step-02-create  # \u307e\u305f\u306f\u4ed6\u306e\u30b9\u30c6\u30c3\u30d7\n\n# \u4f9d\u5b58\u95a2\u4fc2\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nnpm install\n\n# \u30bf\u30fc\u30df\u30ca\u30eb1\uff1aDocker\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\nnpm run offline:docker\n\n# \u30bf\u30fc\u30df\u30ca\u30eb2\uff1a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\nnpm run migrate\n\n# \u30bf\u30fc\u30df\u30ca\u30eb3\uff1aserverless offline\u30b5\u30fc\u30d0\u30fc\u3092\u8d77\u52d5\nnpm run offline:sls\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-1\u57fa\u672c\u7684\u306acqrs\u5b9f\u88c5step-02-create",children:"Part 1\uff1a\u57fa\u672c\u7684\u306aCQRS\u5b9f\u88c5\uff08step-02-create\uff09"}),"\n",(0,r.jsx)(n.h3,{id:"\u30b9\u30c6\u30c3\u30d71\u30d8\u30eb\u30d1\u30fc\u95a2\u6570\u306e\u4f5c\u6210",children:"\u30b9\u30c6\u30c3\u30d71\uff1a\u30d8\u30eb\u30d1\u30fc\u95a2\u6570\u306e\u4f5c\u6210"}),"\n",(0,r.jsxs)(n.p,{children:["\u307e\u305a\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u3068\u30bd\u30fc\u30c8\u30ad\u30fc\u3092\u7ba1\u7406\u3059\u308b\u30d8\u30eb\u30d1\u30fc\u95a2\u6570\u3092\u4f5c\u6210\u3057\u307e\u3059\uff08",(0,r.jsx)(n.code,{children:"src/helpers/id.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { KEY_SEPARATOR } from '@mbc-cqrs-serverless/core'\nimport { ulid } from 'ulid'\n\nexport const TODO_PK_PREFIX = 'TODO'\n\nexport function generateTodoPk(tenantCode: string): string {\n  return `${TODO_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`\n}\n\nexport function generateTodoSk(): string {\n  return ulid() // ULID provides time-ordered unique identifiers\uff08ULID\u306f\u6642\u9593\u9806\u306e\u4e00\u610f\u8b58\u5225\u5b50\u3092\u63d0\u4f9b\uff09\n}\n\nexport function parsePk(pk: string): { type: string; tenantCode: string } {\n  if (pk.split(KEY_SEPARATOR).length !== 2) {\n    throw new Error('Invalid PK')\n  }\n  const [type, tenantCode] = pk.split(KEY_SEPARATOR)\n  return { type, tenantCode }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b9\u30c6\u30c3\u30d72dto\u306e\u5b9a\u7fa9",children:"\u30b9\u30c6\u30c3\u30d72\uff1aDTO\u306e\u5b9a\u7fa9"}),"\n",(0,r.jsxs)(n.p,{children:["Todo\u5c5e\u6027DTO\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"dto/todo-attributes.dto.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { ApiProperty } from '@nestjs/swagger'\nimport { IsDateString, IsEnum, IsOptional, IsString } from 'class-validator'\n\n// TodoStatus enum (will be synced with Prisma in step-03)\uff08TodoStatus\u306eenum\u3001step-03\u3067Prisma\u3068\u540c\u671f\uff09\nexport enum TodoStatus {\n  PENDING = 'PENDING',\n  IN_PROGRESS = 'IN_PROGRESS',\n  COMPLETED = 'COMPLETED',\n  CANCELED = 'CANCELED',\n}\n\nexport class TodoAttributes {\n  @IsOptional()\n  @IsString()\n  description?: string\n\n  @IsOptional()\n  @ApiProperty({ enum: TodoStatus })\n  @IsEnum(TodoStatus)\n  status?: TodoStatus\n\n  @IsOptional()\n  @IsDateString()\n  dueDate?: string\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5165\u529bDTO\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"dto/create-todo.dto.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Type } from 'class-transformer'\nimport { IsOptional, IsString, ValidateNested } from 'class-validator'\nimport { TodoAttributes } from './todo-attributes.dto'\n\nexport class CreateTodoDto {\n  @IsString()\n  name: string // The name field is required by CommandEntity\uff08name\u30d5\u30a3\u30fc\u30eb\u30c9\u306fCommandEntity\u3067\u5fc5\u9808\uff09\n\n  @Type(() => TodoAttributes)\n  @ValidateNested()\n  @IsOptional()\n  attributes?: TodoAttributes\n\n  constructor(partial: Partial<CreateTodoDto>) {\n    Object.assign(this, partial)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b9\u30c6\u30c3\u30d73\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u5b9a\u7fa9",children:"\u30b9\u30c6\u30c3\u30d73\uff1a\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u5b9a\u7fa9"}),"\n",(0,r.jsxs)(n.p,{children:["\u30b3\u30de\u30f3\u30c9\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"entity/todo-command.entity.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { CommandEntity } from '@mbc-cqrs-serverless/core'\nimport { TodoAttributes } from '../dto/todo-attributes.dto'\n\nexport class TodoCommandEntity extends CommandEntity {\n  attributes: TodoAttributes\n\n  constructor(partial: Partial<TodoCommandEntity>) {\n    super()\n    Object.assign(this, partial)\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u30b3\u30de\u30f3\u30c9DTO\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"dto/todo-command.dto.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { CommandDto } from '@mbc-cqrs-serverless/core'\nimport { Type } from 'class-transformer'\nimport { IsOptional, ValidateNested } from 'class-validator'\nimport { TodoAttributes } from './todo-attributes.dto'\n\nexport class TodoCommandDto extends CommandDto {\n  @Type(() => TodoAttributes)\n  @ValidateNested()\n  @IsOptional()\n  attributes?: TodoAttributes\n\n  constructor(partial: Partial<TodoCommandDto>) {\n    super()\n    Object.assign(this, partial)\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u30c7\u30fc\u30bf\u30a8\u30f3\u30c6\u30a3\u30c6\u30a3\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"entity/todo-data.entity.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { DataEntity } from '@mbc-cqrs-serverless/core'\nimport { TodoAttributes } from '../dto/todo-attributes.dto'\n\nexport class TodoDataEntity extends DataEntity {\n  attributes: TodoAttributes\n\n  constructor(partial: Partial<TodoDataEntity>) {\n    super(partial)\n    Object.assign(this, partial)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b9\u30c6\u30c3\u30d74\u30b5\u30fc\u30d3\u30b9\u306e\u5b9f\u88c5",children:"\u30b9\u30c6\u30c3\u30d74\uff1a\u30b5\u30fc\u30d3\u30b9\u306e\u5b9f\u88c5"}),"\n",(0,r.jsxs)(n.p,{children:["Todo\u30b5\u30fc\u30d3\u30b9\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"todo.service.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import {\n  CommandService,\n  generateId,\n  getUserContext,\n  IInvoke,\n  VERSION_FIRST,\n} from '@mbc-cqrs-serverless/core'\nimport { Injectable, Logger } from '@nestjs/common'\nimport { generateTodoPk, generateTodoSk, TODO_PK_PREFIX } from 'src/helpers'\nimport { CreateTodoDto } from './dto/create-todo.dto'\nimport { TodoCommandDto } from './dto/todo-command.dto'\nimport { TodoDataEntity } from './entity/todo-data.entity'\n\n@Injectable()\nexport class TodoService {\n  private readonly logger = new Logger(TodoService.name)\n\n  constructor(private readonly commandService: CommandService) {}\n\n  async create(\n    createDto: CreateTodoDto,\n    opts: { invokeContext: IInvoke },\n  ): Promise<TodoDataEntity> {\n    // Get tenant code from user context (JWT token)\uff08\u30e6\u30fc\u30b6\u30fc\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304b\u3089\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\u3092\u53d6\u5f97\uff09\n    const { tenantCode } = getUserContext(opts.invokeContext)\n\n    // Generate partition key and sort key\uff08\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\u3068\u30bd\u30fc\u30c8\u30ad\u30fc\u3092\u751f\u6210\uff09\n    const pk = generateTodoPk(tenantCode)\n    const sk = generateTodoSk()\n\n    // Create command DTO\uff08\u30b3\u30de\u30f3\u30c9DTO\u3092\u4f5c\u6210\uff09\n    const todo = new TodoCommandDto({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode,\n      code: sk,\n      type: TODO_PK_PREFIX,\n      version: VERSION_FIRST, // Version for optimistic locking\uff08\u697d\u89b3\u7684\u30ed\u30c3\u30af\u7528\u30d0\u30fc\u30b8\u30e7\u30f3\uff09\n      name: createDto.name,\n      attributes: createDto.attributes,\n    })\n\n    this.logger.debug('Creating todo:', todo)\n\n    // Publish command to DynamoDB\uff08DynamoDB\u306b\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\uff09\n    const item = await this.commandService.publishAsync(todo, opts)\n\n    return new TodoDataEntity(item as TodoDataEntity)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b9\u30c6\u30c3\u30d75\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u4f5c\u6210",children:"\u30b9\u30c6\u30c3\u30d75\uff1a\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u4f5c\u6210"}),"\n",(0,r.jsxs)(n.p,{children:["\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"todo.controller.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { IInvoke, INVOKE_CONTEXT } from '@mbc-cqrs-serverless/core'\nimport { Body, Controller, Logger, Post } from '@nestjs/common'\nimport { ApiTags } from '@nestjs/swagger'\nimport { CreateTodoDto } from './dto/create-todo.dto'\nimport { TodoDataEntity } from './entity/todo-data.entity'\nimport { TodoService } from './todo.service'\n\n@Controller('api/todo')\n@ApiTags('todo')\nexport class TodoController {\n  private readonly logger = new Logger(TodoController.name)\n\n  constructor(private readonly todoService: TodoService) {}\n\n  @Post('/')\n  async create(\n    @INVOKE_CONTEXT() invokeContext: IInvoke,\n    @Body() createDto: CreateTodoDto,\n  ): Promise<TodoDataEntity> {\n    this.logger.debug('createDto:', createDto)\n    return this.todoService.create(createDto, { invokeContext })\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b9\u30c6\u30c3\u30d76\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210",children:"\u30b9\u30c6\u30c3\u30d76\uff1a\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210"}),"\n",(0,r.jsxs)(n.p,{children:["\u30e2\u30b8\u30e5\u30fc\u30eb\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"todo.module.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { CommandModule } from '@mbc-cqrs-serverless/core'\nimport { Module } from '@nestjs/common'\nimport { TodoController } from './todo.controller'\nimport { TodoService } from './todo.service'\n\n@Module({\n  imports: [\n    CommandModule.register({\n      tableName: 'todo',\n      // Data sync handlers will be added in step-03-rds-sync\uff08\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306fstep-03-rds-sync\u3067\u8ffd\u52a0\uff09\n      // dataSyncHandlers: [TodoDataSyncRdsHandler],\n    }),\n  ],\n  controllers: [TodoController],\n  providers: [TodoService],\n})\nexport class TodoModule {}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-2rds\u30c7\u30fc\u30bf\u540c\u671fstep-03-rds-sync",children:"Part 2\uff1aRDS\u30c7\u30fc\u30bf\u540c\u671f\uff08step-03-rds-sync\uff09"}),"\n",(0,r.jsx)(n.p,{children:"DynamoDB\u304b\u3089RDS\u3078\u306e\u81ea\u52d5\u30c7\u30fc\u30bf\u540c\u671f\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"prisma\u30b9\u30ad\u30fc\u30de\u306e\u66f4\u65b0",children:"Prisma\u30b9\u30ad\u30fc\u30de\u306e\u66f4\u65b0"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"prisma/schema.prisma"}),"\u306bTodoStatus enum\u3068Todo\u30e2\u30c7\u30eb\u3092\u8ffd\u52a0\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-prisma",children:'// Todo status enum\uff08Todo\u30b9\u30c6\u30fc\u30bf\u30b9\u306eenum\uff09\nenum TodoStatus {\n  PENDING\n  IN_PROGRESS\n  COMPLETED\n  CANCELED\n}\n\n// Todo model for RDS (MySQL) - synchronized from DynamoDB\uff08RDS\u7528Todo\u30e2\u30c7\u30eb - DynamoDB\u304b\u3089\u540c\u671f\uff09\nmodel Todo {\n  id         String   @id                        // Unique ID (generated from pk#sk)\uff08\u4e00\u610f\u306eID\u3001pk#sk\u304b\u3089\u751f\u6210\uff09\n  cpk        String                              // Command partition key\uff08\u30b3\u30de\u30f3\u30c9\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\uff09\n  csk        String                              // Command sort key (with version)\uff08\u30b3\u30de\u30f3\u30c9\u30bd\u30fc\u30c8\u30ad\u30fc\u3001\u30d0\u30fc\u30b8\u30e7\u30f3\u4ed8\u304d\uff09\n  pk         String                              // Data partition key: TODO#tenantCode\uff08\u30c7\u30fc\u30bf\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30ad\u30fc\uff09\n  sk         String                              // Data sort key: ULID\uff08\u30c7\u30fc\u30bf\u30bd\u30fc\u30c8\u30ad\u30fc\uff09\n  tenantCode String   @map("tenant_code")        // Tenant code for multi-tenancy\uff08\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30b7\u30fc\u7528\u30c6\u30ca\u30f3\u30c8\u30b3\u30fc\u30c9\uff09\n  seq        Int      @default(0)                // Sequence number (for ordering)\uff08\u4e26\u3079\u66ff\u3048\u7528\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7\uff09\n  code       String                              // Record code (same as sk)\uff08\u30ec\u30b3\u30fc\u30c9\u30b3\u30fc\u30c9\u3001sk\u3068\u540c\u3058\uff09\n  name       String                              // Todo name/title\uff08Todo\u540d/\u30bf\u30a4\u30c8\u30eb\uff09\n  version    Int                                 // Version for optimistic locking\uff08\u697d\u89b3\u7684\u30ed\u30c3\u30af\u7528\u30d0\u30fc\u30b8\u30e7\u30f3\uff09\n  isDeleted  Boolean  @default(false) @map("is_deleted")  // Soft delete flag\uff08\u8ad6\u7406\u524a\u9664\u30d5\u30e9\u30b0\uff09\n  createdBy  String   @default("") @map("created_by")     // Created by user\uff08\u4f5c\u6210\u30e6\u30fc\u30b6\u30fc\uff09\n  createdIp  String   @default("") @map("created_ip")     // Created from IP\uff08\u4f5c\u6210\u5143IP\uff09\n  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(0)\n  updatedBy  String   @default("") @map("updated_by")     // Updated by user\uff08\u66f4\u65b0\u30e6\u30fc\u30b6\u30fc\uff09\n  updatedIp  String   @default("") @map("updated_ip")     // Updated from IP\uff08\u66f4\u65b0\u5143IP\uff09\n  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamp(0)\n\n  // Todo-specific attributes\uff08Todo\u56fa\u6709\u306e\u5c5e\u6027\uff09\n  description String?    @default("") @map("description")  // Description\uff08\u8aac\u660e\uff09\n  status      TodoStatus @default(PENDING) @map("status")  // Status\uff08\u30b9\u30c6\u30fc\u30bf\u30b9\uff09\n  dueDate     DateTime?  @map("due_date")                  // Due date\uff08\u671f\u9650\u65e5\uff09\n\n  // Indexes for efficient queries\uff08\u52b9\u7387\u7684\u306a\u30af\u30a8\u30ea\u7528\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\uff09\n  @@unique([cpk, csk])           // Command table unique constraint\uff08\u30b3\u30de\u30f3\u30c9\u30c6\u30fc\u30d6\u30eb\u306e\u30e6\u30cb\u30fc\u30af\u5236\u7d04\uff09\n  @@unique([pk, sk])             // Data table unique constraint\uff08\u30c7\u30fc\u30bf\u30c6\u30fc\u30d6\u30eb\u306e\u30e6\u30cb\u30fc\u30af\u5236\u7d04\uff09\n  @@unique([tenantCode, code])   // Tenant + code unique constraint\uff08\u30c6\u30ca\u30f3\u30c8+\u30b3\u30fc\u30c9\u306e\u30e6\u30cb\u30fc\u30af\u5236\u7d04\uff09\n  @@index([tenantCode, name])    // Search by tenant and name\uff08\u30c6\u30ca\u30f3\u30c8\u3068\u540d\u524d\u3067\u691c\u7d22\uff09\n  @@map("todos")                 // Table name in database\uff08\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30c6\u30fc\u30d6\u30eb\u540d\uff09\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210",children:"\u30c7\u30fc\u30bf\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210"}),"\n",(0,r.jsxs)(n.p,{children:["RDS\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"handler/todo-rds.handler.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import {\n  CommandModel,\n  IDataSyncHandler,\n  removeSortKeyVersion,\n} from '@mbc-cqrs-serverless/core'\nimport { Injectable, Logger } from '@nestjs/common'\nimport { PrismaService } from 'src/prisma'\nimport { TodoAttributes } from '../dto/todo-attributes.dto'\n\n@Injectable()\nexport class TodoDataSyncRdsHandler implements IDataSyncHandler {\n  private readonly logger = new Logger(TodoDataSyncRdsHandler.name)\n\n  constructor(private readonly prismaService: PrismaService) {}\n\n  // Called when data is created or updated in DynamoDB\uff08DynamoDB\u3067\u30c7\u30fc\u30bf\u304c\u4f5c\u6210\u307e\u305f\u306f\u66f4\u65b0\u3055\u308c\u305f\u6642\u306b\u547c\u3073\u51fa\u3055\u308c\u308b\uff09\n  async up(cmd: CommandModel): Promise<any> {\n    this.logger.debug('Syncing to RDS:', cmd)\n\n    // Remove version suffix from sort key for the data table\uff08\u30c7\u30fc\u30bf\u30c6\u30fc\u30d6\u30eb\u7528\u306b\u30bd\u30fc\u30c8\u30ad\u30fc\u304b\u3089\u30d0\u30fc\u30b8\u30e7\u30f3\u30b5\u30d5\u30a3\u30c3\u30af\u30b9\u3092\u524a\u9664\uff09\n    const sk = removeSortKeyVersion(cmd.sk)\n    const attrs = cmd.attributes as TodoAttributes\n\n    await this.prismaService.todo.upsert({\n      where: { id: cmd.id },\n      // Update existing record\uff08\u65e2\u5b58\u30ec\u30b3\u30fc\u30c9\u3092\u66f4\u65b0\uff09\n      update: {\n        csk: cmd.sk,\n        name: cmd.name,\n        version: cmd.version,\n        seq: cmd.seq,\n        isDeleted: cmd.isDeleted || false,\n        updatedAt: cmd.updatedAt,\n        updatedBy: cmd.updatedBy,\n        updatedIp: cmd.updatedIp,\n        description: attrs?.description,\n        status: attrs?.status,\n        dueDate: attrs?.dueDate,\n      },\n      // Create new record\uff08\u65b0\u898f\u30ec\u30b3\u30fc\u30c9\u3092\u4f5c\u6210\uff09\n      create: {\n        id: cmd.id,\n        cpk: cmd.pk,\n        csk: cmd.sk,\n        pk: cmd.pk,\n        sk,\n        code: sk,\n        name: cmd.name,\n        version: cmd.version,\n        tenantCode: cmd.tenantCode,\n        seq: cmd.seq,\n        createdAt: cmd.createdAt,\n        createdBy: cmd.createdBy,\n        createdIp: cmd.createdIp,\n        updatedAt: cmd.updatedAt,\n        updatedBy: cmd.updatedBy,\n        updatedIp: cmd.updatedIp,\n        description: attrs?.description,\n        status: attrs?.status,\n        dueDate: attrs?.dueDate,\n      },\n    })\n  }\n\n  // Called when data needs to be rolled back\uff08\u30c7\u30fc\u30bf\u306e\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u304c\u5fc5\u8981\u306a\u6642\u306b\u547c\u3073\u51fa\u3055\u308c\u308b\uff09\n  async down(cmd: CommandModel): Promise<any> {\n    this.logger.debug('Rollback requested:', cmd)\n    // Implement rollback logic if needed\uff08\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u30ed\u30fc\u30eb\u30d0\u30c3\u30af\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5\uff09\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u767b\u9332",children:"\u30e2\u30b8\u30e5\u30fc\u30eb\u3078\u306e\u30cf\u30f3\u30c9\u30e9\u30fc\u767b\u9332"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"todo.module.ts"}),"\u3092\u66f4\u65b0\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { CommandModule } from '@mbc-cqrs-serverless/core'\nimport { Module } from '@nestjs/common'\nimport { TodoDataSyncRdsHandler } from './handler/todo-rds.handler'\nimport { TodoController } from './todo.controller'\nimport { TodoService } from './todo.service'\n\n@Module({\n  imports: [\n    CommandModule.register({\n      tableName: 'todo',\n      // Register RDS sync handler to synchronize DynamoDB data to MySQL\uff08RDS\u540c\u671f\u30cf\u30f3\u30c9\u30e9\u30fc\u3092\u767b\u9332\u3057\u3066DynamoDB\u30c7\u30fc\u30bf\u3092MySQL\u306b\u540c\u671f\uff09\n      dataSyncHandlers: [TodoDataSyncRdsHandler],\n    }),\n  ],\n  controllers: [TodoController],\n  providers: [TodoService],\n})\nexport class TodoModule {}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-3\u8aad\u307f\u53d6\u308a\u64cd\u4f5cstep-04-read",children:"Part 3\uff1a\u8aad\u307f\u53d6\u308a\u64cd\u4f5c\uff08step-04-read\uff09"}),"\n",(0,r.jsx)(n.p,{children:"DynamoDB\u304b\u3089\u5358\u4e00\u30a2\u30a4\u30c6\u30e0\u3092\u53d6\u5f97\u3059\u308b\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0",children:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"todo.service.ts"}),"\u306b",(0,r.jsx)(n.code,{children:"findOne"}),"\u30e1\u30bd\u30c3\u30c9\u3092\u8ffd\u52a0\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { DataService, NotFoundException } from '@mbc-cqrs-serverless/core'\n\n@Injectable()\nexport class TodoService {\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService, // Inject DataService\uff08DataService\u3092\u6ce8\u5165\uff09\n  ) {}\n\n  // ... create method ...\n\n  async findOne(pk: string, sk: string): Promise<TodoDataEntity> {\n    this.logger.debug(`Finding todo: pk=${pk}, sk=${sk}`)\n\n    const item = await this.dataService.getItem({ pk, sk })\n\n    if (!item) {\n      throw new NotFoundException(`Todo not found: pk=${pk}, sk=${sk}`)\n    }\n\n    return new TodoDataEntity(item as TodoDataEntity)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0",children:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"@Get(':pk/:sk')\nasync findOne(\n  @Param('pk') pk: string,\n  @Param('sk') sk: string,\n): Promise<TodoDataEntity> {\n  this.logger.debug(`findOne: pk=${pk}, sk=${sk}`)\n  return this.todoService.findOne(pk, sk)\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-4\u691c\u7d22\u64cd\u4f5cstep-05-search",children:"Part 4\uff1a\u691c\u7d22\u64cd\u4f5c\uff08step-05-search\uff09"}),"\n",(0,r.jsx)(n.p,{children:"\u52b9\u7387\u7684\u306a\u30af\u30a8\u30ea\u306e\u305f\u3081\u306bRDS\u3092\u4f7f\u7528\u3057\u305f\u691c\u7d22\u3092\u5b9f\u88c5\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u691c\u7d22dto\u306e\u4f5c\u6210",children:"\u691c\u7d22DTO\u306e\u4f5c\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { ApiPropertyOptional } from '@nestjs/swagger'\nimport { TodoStatus } from '@prisma/client' // Import from Prisma generated types\uff08Prisma\u751f\u6210\u578b\u304b\u3089\u30a4\u30f3\u30dd\u30fc\u30c8\uff09\nimport { IsEnum, IsInt, IsOptional, IsString, Max, Min } from 'class-validator'\nimport { Transform, Type } from 'class-transformer'\n\nexport class SearchTodoDto {\n  @IsOptional()\n  @IsString()\n  @ApiPropertyOptional({ description: 'Search by name (partial match)' })\n  name?: string\n\n  @IsOptional()\n  @IsEnum(TodoStatus)\n  @ApiPropertyOptional({ enum: TodoStatus, description: 'Filter by status' })\n  status?: TodoStatus\n\n  @IsOptional()\n  @Type(() => Number)\n  @IsInt()\n  @Min(1)\n  @ApiPropertyOptional({ description: 'Page number (1-based)', default: 1 })\n  page?: number = 1\n\n  @IsOptional()\n  @Type(() => Number)\n  @IsInt()\n  @Min(1)\n  @Max(100)\n  @ApiPropertyOptional({ description: 'Items per page', default: 10 })\n  limit?: number = 10\n\n  @IsOptional()\n  @IsString()\n  @ApiPropertyOptional({\n    description: 'Sort field',\n    default: 'createdAt',\n    enum: ['name', 'status', 'createdAt', 'updatedAt'],\n  })\n  sortBy?: string = 'createdAt'\n\n  @IsOptional()\n  @IsString()\n  @Transform(({ value }) => value?.toUpperCase())\n  @ApiPropertyOptional({\n    description: 'Sort order',\n    default: 'DESC',\n    enum: ['ASC', 'DESC'],\n  })\n  sortOrder?: 'ASC' | 'DESC' = 'DESC'\n}\n\nexport class SearchTodoResultDto<T> {\n  data: T[]\n  total: number\n  page: number\n  limit: number\n  totalPages: number\n\n  constructor(data: T[], total: number, page: number, limit: number) {\n    this.data = data\n    this.total = total\n    this.page = page\n    this.limit = limit\n    this.totalPages = Math.ceil(total / limit)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0-1",children:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Prisma } from '@prisma/client'\n\nasync findAll(\n  tenantCode: string,\n  searchDto: SearchTodoDto,\n): Promise<SearchTodoResultDto<TodoDataEntity>> {\n  this.logger.debug(`Searching todos for tenant: ${tenantCode}`, searchDto)\n\n  const { name, status, page = 1, limit = 10, sortBy = 'createdAt', sortOrder = 'DESC' } = searchDto\n\n  // Build where clause dynamically\uff08WHERE\u53e5\u3092\u52d5\u7684\u306b\u69cb\u7bc9\uff09\n  const where: Prisma.TodoWhereInput = {\n    tenantCode,\n    isDeleted: false,\n  }\n\n  // Add name filter (partial match)\uff08\u540d\u524d\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u8ffd\u52a0\u3001\u90e8\u5206\u4e00\u81f4\uff09\n  if (name) {\n    where.name = { contains: name }\n  }\n\n  // Add status filter (exact match)\uff08\u30b9\u30c6\u30fc\u30bf\u30b9\u30d5\u30a3\u30eb\u30bf\u30fc\u3092\u8ffd\u52a0\u3001\u5b8c\u5168\u4e00\u81f4\uff09\n  if (status) {\n    where.status = status\n  }\n\n  // Build orderBy clause\uff08ORDER BY\u53e5\u3092\u69cb\u7bc9\uff09\n  const orderBy: Prisma.TodoOrderByWithRelationInput = {\n    [sortBy]: sortOrder.toLowerCase(),\n  }\n\n  // Calculate skip for pagination\uff08\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u7528\u306e\u30b9\u30ad\u30c3\u30d7\u6570\u3092\u8a08\u7b97\uff09\n  const skip = (page - 1) * limit\n\n  // Execute query with pagination\uff08\u30da\u30fc\u30b8\u30cd\u30fc\u30b7\u30e7\u30f3\u4ed8\u304d\u3067\u30af\u30a8\u30ea\u3092\u5b9f\u884c\uff09\n  const [data, total] = await Promise.all([\n    this.prismaService.todo.findMany({\n      where,\n      orderBy,\n      skip,\n      take: limit,\n    }),\n    this.prismaService.todo.count({ where }),\n  ])\n\n  // Map Prisma results to TodoDataEntity\uff08Prisma\u7d50\u679c\u3092TodoDataEntity\u306b\u30de\u30c3\u30d4\u30f3\u30b0\uff09\n  const todos = data.map((item) => new TodoDataEntity({\n    ...item,\n    type: TODO_PK_PREFIX,\n    attributes: {\n      description: item.description,\n      status: item.status,\n      dueDate: item.dueDate?.toISOString(),\n    },\n  } as unknown as TodoDataEntity))\n\n  return new SearchTodoResultDto(todos, total, page, limit)\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0-1",children:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"@Get('/')\nasync findAll(\n  @INVOKE_CONTEXT() invokeContext: IInvoke,\n  @Query() searchDto: SearchTodoDto,\n): Promise<SearchTodoResultDto<TodoDataEntity>> {\n  const { tenantCode } = getUserContext(invokeContext)\n  this.logger.debug(`findAll: tenantCode=${tenantCode}`, searchDto)\n  return this.todoService.findAll(tenantCode, searchDto)\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-5\u66f4\u65b0\u3068\u524a\u9664step-06-update-delete",children:"Part 5\uff1a\u66f4\u65b0\u3068\u524a\u9664\uff08step-06-update-delete\uff09"}),"\n",(0,r.jsx)(n.h3,{id:"\u66f4\u65b0dto\u306e\u4f5c\u6210",children:"\u66f4\u65b0DTO\u306e\u4f5c\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { ApiPropertyOptional } from '@nestjs/swagger'\nimport { IsInt, IsOptional, IsString, Min } from 'class-validator'\nimport { Type } from 'class-transformer'\nimport { TodoAttributes } from './todo-attributes.dto'\n\nexport class UpdateTodoDto {\n  @IsOptional()\n  @IsString()\n  @ApiPropertyOptional({ description: 'Todo name/title' })\n  name?: string\n\n  @IsOptional()\n  @ApiPropertyOptional({ description: 'Todo attributes (description, status, dueDate)' })\n  attributes?: TodoAttributes\n\n  @Type(() => Number)\n  @IsInt()\n  @Min(1)\n  @ApiPropertyOptional({ description: 'Version for optimistic locking' })\n  version: number // Required for optimistic locking\uff08\u697d\u89b3\u7684\u30ed\u30c3\u30af\u306b\u5fc5\u9808\uff09\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0-2",children:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { CommandPartialInputModel } from '@mbc-cqrs-serverless/core'\n\nasync update(\n  pk: string,\n  sk: string,\n  updateDto: UpdateTodoDto,\n  opts: { invokeContext: IInvoke },\n): Promise<TodoDataEntity> {\n  this.logger.debug(`Updating todo: pk=${pk}, sk=${sk}`, updateDto)\n\n  // First, verify the item exists\uff08\u307e\u305a\u30a2\u30a4\u30c6\u30e0\u306e\u5b58\u5728\u3092\u78ba\u8a8d\uff09\n  const currentItem = await this.dataService.getItem({ pk, sk })\n  if (!currentItem) {\n    throw new NotFoundException(`Todo not found: pk=${pk}, sk=${sk}`)\n  }\n\n  // Build the partial update object\uff08\u90e8\u5206\u66f4\u65b0\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u69cb\u7bc9\uff09\n  const partialUpdate: CommandPartialInputModel = {\n    pk,\n    sk,\n    version: updateDto.version, // Required for optimistic locking\uff08\u697d\u89b3\u7684\u30ed\u30c3\u30af\u306b\u5fc5\u9808\uff09\n    ...(updateDto.name !== undefined && { name: updateDto.name }),\n    ...(updateDto.attributes !== undefined && { attributes: updateDto.attributes }),\n  }\n\n  // Publish partial update command\uff08\u90e8\u5206\u66f4\u65b0\u30b3\u30de\u30f3\u30c9\u3092\u767a\u884c\uff09\n  const item = await this.commandService.publishPartialUpdateAsync(partialUpdate, opts)\n\n  return new TodoDataEntity(item as TodoDataEntity)\n}\n\nasync remove(\n  pk: string,\n  sk: string,\n  version: number,\n  opts: { invokeContext: IInvoke },\n): Promise<TodoDataEntity> {\n  this.logger.debug(`Removing todo: pk=${pk}, sk=${sk}, version=${version}`)\n\n  // First, verify the item exists\uff08\u307e\u305a\u30a2\u30a4\u30c6\u30e0\u306e\u5b58\u5728\u3092\u78ba\u8a8d\uff09\n  const currentItem = await this.dataService.getItem({ pk, sk })\n  if (!currentItem) {\n    throw new NotFoundException(`Todo not found: pk=${pk}, sk=${sk}`)\n  }\n\n  // Soft delete by setting isDeleted flag\uff08isDeleted\u30d5\u30e9\u30b0\u3092\u8a2d\u5b9a\u3057\u3066\u8ad6\u7406\u524a\u9664\uff09\n  const item = await this.commandService.publishPartialUpdateAsync(\n    {\n      pk,\n      sk,\n      version,\n      isDeleted: true,\n    },\n    opts,\n  )\n\n  return new TodoDataEntity(item as TodoDataEntity)\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0-2",children:"\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"@Patch(':pk/:sk')\nasync update(\n  @INVOKE_CONTEXT() invokeContext: IInvoke,\n  @Param('pk') pk: string,\n  @Param('sk') sk: string,\n  @Body() updateDto: UpdateTodoDto,\n): Promise<TodoDataEntity> {\n  this.logger.debug(`update: pk=${pk}, sk=${sk}`, updateDto)\n  return this.todoService.update(pk, sk, updateDto, { invokeContext })\n}\n\n@Delete(':pk/:sk')\nasync remove(\n  @INVOKE_CONTEXT() invokeContext: IInvoke,\n  @Param('pk') pk: string,\n  @Param('sk') sk: string,\n  @Query('version') version: number,\n): Promise<TodoDataEntity> {\n  this.logger.debug(`remove: pk=${pk}, sk=${sk}, version=${version}`)\n  return this.todoService.remove(pk, sk, version, { invokeContext })\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-6\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7step-07-sequence",children:"Part 6\uff1a\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7\uff08step-07-sequence\uff09"}),"\n",(0,r.jsx)(n.p,{children:"\u81ea\u52d5\u30a4\u30f3\u30af\u30ea\u30e1\u30f3\u30c8\u306eTodo\u756a\u53f7\u3092\u8ffd\u52a0\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u30b7\u30fc\u30b1\u30f3\u30b9\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",children:"\u30b7\u30fc\u30b1\u30f3\u30b9\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install @mbc-cqrs-serverless/sequence\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u66f4\u65b0",children:"\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { SequencesModule } from '@mbc-cqrs-serverless/sequence'\n\n@Module({\n  imports: [\n    CommandModule.register({\n      tableName: 'todo',\n      dataSyncHandlers: [TodoDataSyncRdsHandler],\n    }),\n    SequencesModule, // Add SequencesModule\uff08SequencesModule\u3092\u8ffd\u52a0\uff09\n  ],\n  // ...\n})\nexport class TodoModule {}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0-3",children:"\u30b5\u30fc\u30d3\u30b9\u306e\u66f4\u65b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { SequencesService } from '@mbc-cqrs-serverless/sequence'\n\n@Injectable()\nexport class TodoService {\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n    private readonly prismaService: PrismaService,\n    private readonly sequencesService: SequencesService, // Inject SequencesService\uff08SequencesService\u3092\u6ce8\u5165\uff09\n  ) {}\n\n  async create(\n    createDto: CreateTodoDto,\n    opts: { invokeContext: IInvoke },\n  ): Promise<TodoDataEntity> {\n    const { tenantCode } = getUserContext(opts.invokeContext)\n\n    // Generate sequential number\uff08\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7\u3092\u751f\u6210\uff09\n    const seqItem = await this.sequencesService.generateSequenceItem(\n      {\n        tenantCode,\n        typeCode: TODO_PK_PREFIX,\n      },\n      opts,\n    )\n\n    this.logger.debug(`Generated sequence number: ${seqItem.formattedNo} for tenant: ${tenantCode}`)\n\n    const pk = generateTodoPk(tenantCode)\n    const sk = generateTodoSk() // SK is still ULID\uff08SK\u306f\u5f15\u304d\u7d9a\u304dULID\uff09\n\n    const todo = new TodoCommandDto({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode,\n      code: sk,\n      type: TODO_PK_PREFIX,\n      version: VERSION_FIRST,\n      seq: seqItem.no, // Store sequence number in seq field\uff08seq\u30d5\u30a3\u30fc\u30eb\u30c9\u306b\u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7\u3092\u683c\u7d0d\uff09\n      name: createDto.name,\n      attributes: createDto.attributes,\n    })\n\n    this.logger.debug('Creating todo with sequence:', todo)\n\n    const item = await this.commandService.publishAsync(todo, opts)\n    return new TodoDataEntity(item as TodoDataEntity)\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"part-7\u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406completewith-task",children:"Part 7\uff1a\u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406\uff08complete/with-task\uff09"}),"\n",(0,r.jsx)(n.p,{children:"\u9577\u6642\u9593\u5b9f\u884c\u3055\u308c\u308bTodo\u64cd\u4f5c\u3092\u975e\u540c\u671f\u3067\u51e6\u7406\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",children:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install @mbc-cqrs-serverless/task\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30bf\u30b9\u30af\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210",children:"\u30bf\u30b9\u30af\u30a4\u30d9\u30f3\u30c8\u306e\u4f5c\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// src/todo/handler/todo-task.event.ts\nimport { TaskQueueEvent } from '@mbc-cqrs-serverless/task'\n\nexport class TodoTaskEvent extends TaskQueueEvent {}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30bf\u30b9\u30af\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210",children:"\u30bf\u30b9\u30af\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u4f5c\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// src/todo/handler/todo-task.event.handler.ts\nimport { EventHandler, IEventHandler } from '@mbc-cqrs-serverless/core'\nimport { Logger } from '@nestjs/common'\nimport { TodoTaskEvent } from './todo-task.event'\n\n@EventHandler(TodoTaskEvent)\nexport class TodoTaskEventHandler implements IEventHandler<TodoTaskEvent> {\n  private readonly logger = new Logger(TodoTaskEventHandler.name)\n\n  async execute(event: TodoTaskEvent): Promise<any> {\n    this.logger.debug('Processing todo task:', event)\n\n    // Implement your async task processing here\uff08\u3053\u3053\u306b\u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406\u3092\u5b9f\u88c5\uff09\n    // e.g., send notification, sync to external system\uff08\u4f8b\uff1a\u901a\u77e5\u9001\u4fe1\u3001\u5916\u90e8\u30b7\u30b9\u30c6\u30e0\u3078\u306e\u540c\u671f\uff09\n\n    return { processed: true }\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30bf\u30b9\u30af\u30ad\u30e5\u30fc\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u4f5c\u6210",children:"\u30bf\u30b9\u30af\u30ad\u30e5\u30fc\u30a4\u30d9\u30f3\u30c8\u30d5\u30a1\u30af\u30c8\u30ea\u30fc\u306e\u4f5c\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// src/my-task/task-queue-event-factory.ts\nimport {\n  ITaskQueueEventFactory,\n  TaskQueueEvent,\n} from '@mbc-cqrs-serverless/task'\nimport { TodoTaskEvent } from '../todo/handler/todo-task.event'\n\nexport class TaskQueueEventFactory implements ITaskQueueEventFactory {\n  async transformTask(event: TaskQueueEvent): Promise<any[]> {\n    return [new TodoTaskEvent().fromSqsRecord(event)]\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210",children:"\u30bf\u30b9\u30af\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u4f5c\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// src/my-task/my-task.module.ts\nimport { TaskModule } from '@mbc-cqrs-serverless/task'\nimport { Module } from '@nestjs/common'\nimport { TaskQueueEventFactory } from './task-queue-event-factory'\n\n@Module({\n  imports: [\n    TaskModule.register({\n      taskQueueEventFactory: TaskQueueEventFactory,\n    }),\n  ],\n  exports: [TaskModule],\n})\nexport class MyTaskModule {}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8",children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30c6\u30b9\u30c8"}),"\n",(0,r.jsx)(n.h3,{id:"\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c",children:"\u30ed\u30fc\u30ab\u30eb\u3067\u5b9f\u884c"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u30bf\u30fc\u30df\u30ca\u30eb1\uff1aDocker\u30b5\u30fc\u30d3\u30b9\u3092\u8d77\u52d5\nnpm run offline:docker\n\n# \u30bf\u30fc\u30df\u30ca\u30eb2\uff1a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3092\u5b9f\u884c\nnpm run migrate\n\n# \u30bf\u30fc\u30df\u30ca\u30eb3\uff1aserverless offline\u3092\u8d77\u52d5\nnpm run offline:sls\n"})}),"\n",(0,r.jsx)(n.h3,{id:"api\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306e\u30c6\u30b9\u30c8",children:"API\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u306e\u30c6\u30b9\u30c8"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Todo\u3092\u4f5c\u6210\ncurl -X POST http://localhost:3000/api/todo \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer <your-token>" \\\n  -d \'{"name": "My First Todo", "attributes": {"description": "Testing CQRS", "status": "PENDING"}}\'\n\n# Todo\u4e00\u89a7\u3092\u53d6\u5f97\ncurl "http://localhost:3000/api/todo?page=1&limit=10" \\\n  -H "Authorization: Bearer <your-token>"\n\n# Todo\u3092\u53d6\u5f97\uff08\u6ce8\uff1apk\u5185\u306e#\u306f%23\u306bURL\u30a8\u30f3\u30b3\u30fc\u30c9\u304c\u5fc5\u8981\uff09\ncurl "http://localhost:3000/api/todo/TODO%23MBC/<sk>" \\\n  -H "Authorization: Bearer <your-token>"\n\n# Todo\u3092\u66f4\u65b0\ncurl -X PATCH "http://localhost:3000/api/todo/TODO%23MBC/<sk>" \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer <your-token>" \\\n  -d \'{"name": "Updated Todo", "version": 1}\'\n\n# Todo\u3092\u524a\u9664\ncurl -X DELETE "http://localhost:3000/api/todo/TODO%23MBC/<sk>?version=1" \\\n  -H "Authorization: Bearer <your-token>"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8",children:"\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8"}),"\n",(0,r.jsxs)(n.p,{children:["\u30b5\u30fc\u30d3\u30b9\u306e\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"todo.service.spec.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Test, TestingModule } from '@nestjs/testing'\nimport { NotFoundException } from '@nestjs/common'\nimport { CommandService, DataService } from '@mbc-cqrs-serverless/core'\nimport { TodoService } from './todo.service'\nimport { PrismaService } from '../prisma/prisma.service'\n\n// Mock getUserContext\uff08getUserContext\u3092\u30e2\u30c3\u30af\uff09\njest.mock('@mbc-cqrs-serverless/core', () => ({\n  ...jest.requireActual('@mbc-cqrs-serverless/core'),\n  getUserContext: jest.fn().mockReturnValue({\n    tenantCode: 'test',\n    userId: 'user-123',\n  }),\n}))\n\ndescribe('TodoService', () => {\n  let service: TodoService\n  let commandService: jest.Mocked<CommandService>\n  let dataService: jest.Mocked<DataService>\n\n  beforeEach(async () => {\n    const mockCommandService = {\n      publishAsync: jest.fn(),\n      publishPartialUpdateAsync: jest.fn(),\n    }\n\n    const mockDataService = {\n      getItem: jest.fn(),\n    }\n\n    const mockPrismaService = {\n      todo: {\n        findMany: jest.fn(),\n        count: jest.fn(),\n      },\n    }\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        TodoService,\n        { provide: CommandService, useValue: mockCommandService },\n        { provide: DataService, useValue: mockDataService },\n        { provide: PrismaService, useValue: mockPrismaService },\n      ],\n    }).compile()\n\n    service = module.get<TodoService>(TodoService)\n    commandService = module.get(CommandService)\n    dataService = module.get(DataService)\n  })\n\n  describe('findOne', () => {\n    it('should return a todo when found', async () => {\n      const mockTodo = { pk: 'TODO#test', sk: '01HXY', name: 'Test' }\n      dataService.getItem.mockResolvedValue(mockTodo as any)\n\n      const result = await service.findOne('TODO#test', '01HXY')\n\n      expect(dataService.getItem).toHaveBeenCalledWith({\n        pk: 'TODO#test',\n        sk: '01HXY',\n      })\n      expect(result.name).toBe('Test')\n    })\n\n    it('should throw NotFoundException when not found', async () => {\n      dataService.getItem.mockResolvedValue(null)\n\n      await expect(service.findOne('TODO#test', 'nonexistent'))\n        .rejects.toThrow(NotFoundException)\n    })\n  })\n})\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm test\n"})}),"\n",(0,r.jsx)(n.h3,{id:"e2e\u30c6\u30b9\u30c8",children:"E2E\u30c6\u30b9\u30c8"}),"\n",(0,r.jsxs)(n.p,{children:["E2E\u30c6\u30b9\u30c8\u3092\u4f5c\u6210\uff08",(0,r.jsx)(n.code,{children:"test/todo.e2e-spec.ts"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Test, TestingModule } from '@nestjs/testing'\nimport { INestApplication, ValidationPipe } from '@nestjs/common'\nimport request from 'supertest'\nimport { TodoController } from '../src/todo/todo.controller'\nimport { TodoService } from '../src/todo/todo.service'\n\n// Mock getUserContext\uff08getUserContext\u3092\u30e2\u30c3\u30af\uff09\njest.mock('@mbc-cqrs-serverless/core', () => ({\n  ...jest.requireActual('@mbc-cqrs-serverless/core'),\n  getUserContext: jest.fn().mockReturnValue({\n    tenantCode: 'test',\n    userId: 'user-123',\n  }),\n  INVOKE_CONTEXT: () => () => {}, // Decorator stub\uff08\u30c7\u30b3\u30ec\u30fc\u30bf\u30b9\u30bf\u30d6\uff09\n}))\n\ndescribe('TodoController (e2e)', () => {\n  let app: INestApplication\n\n  const mockTodoData = {\n    pk: 'TODO#test',\n    sk: '01HXY',\n    name: 'Test Todo',\n    version: 1,\n  }\n\n  beforeAll(async () => {\n    const mockTodoService = {\n      create: jest.fn().mockResolvedValue(mockTodoData),\n      findOne: jest.fn().mockResolvedValue(mockTodoData),\n      findAll: jest.fn().mockResolvedValue({ data: [mockTodoData], total: 1 }),\n      update: jest.fn().mockResolvedValue(mockTodoData),\n      remove: jest.fn().mockResolvedValue({ ...mockTodoData, isDeleted: true }),\n    }\n\n    const moduleFixture: TestingModule = await Test.createTestingModule({\n      controllers: [TodoController],\n      providers: [{ provide: TodoService, useValue: mockTodoService }],\n    }).compile()\n\n    app = moduleFixture.createNestApplication()\n    app.useGlobalPipes(new ValidationPipe({ whitelist: true, transform: true }))\n    await app.init()\n  })\n\n  afterAll(async () => {\n    await app.close()\n  })\n\n  it('POST /api/todo - should create a todo', () => {\n    return request(app.getHttpServer())\n      .post('/api/todo')\n      .send({ name: 'New Todo', attributes: { status: 'PENDING' } })\n      .expect(201)\n  })\n\n  it('GET /api/todo/:pk/:sk - should return a todo', () => {\n    return request(app.getHttpServer())\n      .get('/api/todo/TODO%23TEST/01HXY')\n      .expect(200)\n  })\n\n  it('PATCH /api/todo/:pk/:sk - should update a todo', () => {\n    return request(app.getHttpServer())\n      .patch('/api/todo/TODO%23TEST/01HXY')\n      .send({ name: 'Updated', version: 1 })\n      .expect(200)\n  })\n})\n"})}),"\n",(0,r.jsxs)(n.p,{children:["E2E\u30c6\u30b9\u30c8\u7528\u306eJest\u8a2d\u5b9a\uff08",(0,r.jsx)(n.code,{children:"test/jest-e2e.json"}),"\uff09\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "moduleFileExtensions": ["js", "json", "ts"],\n  "rootDir": ".",\n  "testEnvironment": "node",\n  "testRegex": ".e2e-spec.ts$",\n  "transform": {\n    "^.+\\\\.(t|j)s$": ["ts-jest", { "tsconfig": "<rootDir>/../tsconfig.json" }]\n  },\n  "moduleNameMapper": {\n    "^src/(.*)$": "<rootDir>/../src/$1"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"E2E\u30c6\u30b9\u30c8\u3092\u5b9f\u884c\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm run test:e2e\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u30ea\u30dd\u30b8\u30c8\u30ea",children:"\u30b5\u30f3\u30d7\u30eb\u30b3\u30fc\u30c9\u30ea\u30dd\u30b8\u30c8\u30ea"}),"\n",(0,r.jsx)(n.p,{children:"\u5404\u30b9\u30c6\u30c3\u30d7\u306e\u5b8c\u5168\u306a\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u306f\u4ee5\u4e0b\u3067\u5165\u624b\u3067\u304d\u307e\u3059\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-01-setup",children:"step-01-setup"})," - \u74b0\u5883\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-02-create",children:"step-02-create"})," - \u4f5c\u6210\u64cd\u4f5c"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-03-rds-sync",children:"step-03-rds-sync"})," - RDS\u540c\u671f"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-04-read",children:"step-04-read"})," - \u8aad\u307f\u53d6\u308a\u64cd\u4f5c"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-05-search",children:"step-05-search"})," - \u691c\u7d22\u64cd\u4f5c"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-06-update-delete",children:"step-06-update-delete"})," - \u66f4\u65b0\u3068\u524a\u9664"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/step-07-sequence",children:"step-07-sequence"})," - \u30b7\u30fc\u30b1\u30f3\u30b9\u756a\u53f7"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/complete/basic",children:"complete/basic"})," - \u5b8c\u5168\u306a\u57fa\u672c\u5b9f\u88c5"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/mbc-net/mbc-cqrs-serverless-samples/tree/main/complete/with-task",children:"complete/with-task"})," - \u975e\u540c\u671f\u30bf\u30b9\u30af\u51e6\u7406\u4ed8\u304d"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7",children:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./deployment-guide",children:"\u30c7\u30d7\u30ed\u30a4\u30e1\u30f3\u30c8\u30ac\u30a4\u30c9"})," - AWS\u306b\u30c7\u30d7\u30ed\u30a4"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./testing",children:"\u30c6\u30b9\u30c8"})," - \u30e6\u30cb\u30c3\u30c8\u30c6\u30b9\u30c8\u3068E2E\u30c6\u30b9\u30c8\u3092\u8a18\u8ff0"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./monitoring-logging",children:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0"})," - \u53ef\u89b3\u6e2c\u6027\u3092\u8ffd\u52a0"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var o=t(6540);const r={},s=o.createContext(r);function a(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);