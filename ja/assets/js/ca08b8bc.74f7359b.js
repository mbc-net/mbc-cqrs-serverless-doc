"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[8696],{4016:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"api-integration-guide","title":"API\u7d71\u5408\u30ac\u30a4\u30c9","description":"MBC CQRS Serverless\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u5916\u90e8API\u3068\u7d71\u5408\u3057\u3001Webhook\u3092\u53d7\u4fe1\u3059\u308b\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002","source":"@site/i18n/ja/docusaurus-plugin-content-docs/current/api-integration-guide.md","sourceDirName":".","slug":"/api-integration-guide","permalink":"/ja/docs/api-integration-guide","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"MBC CQRS Serverless\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u5916\u90e8API\u3068\u7d71\u5408\u3057\u3001Webhook\u3092\u53d7\u4fe1\u3059\u308b\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},"sidebar":"tutorialSidebar","previous":{"title":"\u30a4\u30f3\u30dd\u30fc\u30c8/\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30d1\u30bf\u30fc\u30f3","permalink":"/ja/docs/import-export-patterns"},"next":{"title":"\u30c7\u30fc\u30bf\u79fb\u884c\u30d1\u30bf\u30fc\u30f3","permalink":"/ja/docs/data-migration-patterns"}}');var s=r(4848),a=r(8453);const i={description:"MBC CQRS Serverless\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u5916\u90e8API\u3068\u7d71\u5408\u3057\u3001Webhook\u3092\u53d7\u4fe1\u3059\u308b\u65b9\u6cd5\u3092\u5b66\u3073\u307e\u3059\u3002"},o="API\u7d71\u5408\u30ac\u30a4\u30c9",c={},l=[{value:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",level:2},{value:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c",id:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c",level:2},{value:"\u5916\u90e8API\u306e\u547c\u3073\u51fa\u3057",id:"\u5916\u90e8api\u306e\u547c\u3073\u51fa\u3057",level:2},{value:"HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306bfetch\u3092\u4f7f\u7528\u3059\u308b",id:"http\u30ea\u30af\u30a8\u30b9\u30c8\u306bfetch\u3092\u4f7f\u7528\u3059\u308b",level:3},{value:"\u57fa\u672c\u7684\u306aGET\u30ea\u30af\u30a8\u30b9\u30c8",id:"\u57fa\u672c\u7684\u306aget\u30ea\u30af\u30a8\u30b9\u30c8",level:4},{value:"\u30da\u30a4\u30ed\u30fc\u30c9\u4ed8\u304dPOST\u30ea\u30af\u30a8\u30b9\u30c8",id:"\u30da\u30a4\u30ed\u30fc\u30c9\u4ed8\u304dpost\u30ea\u30af\u30a8\u30b9\u30c8",level:4},{value:"Axios\u306e\u4f7f\u7528",id:"axios\u306e\u4f7f\u7528",level:3},{value:"\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a",id:"\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a",level:3},{value:"Webhook\u306e\u53d7\u4fe1",id:"webhook\u306e\u53d7\u4fe1",level:2},{value:"Webhook\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3",id:"webhook\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3",level:3},{value:"Webhook\u7f72\u540d\u306e\u691c\u8a3c",id:"webhook\u7f72\u540d\u306e\u691c\u8a3c",level:3},{value:"\u51aa\u7b49\u306aWebhook\u51e6\u7406",id:"\u51aa\u7b49\u306awebhook\u51e6\u7406",level:3},{value:"\u30ea\u30c8\u30e9\u30a4\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",id:"\u30ea\u30c8\u30e9\u30a4\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",level:2},{value:"\u6307\u6570\u30d0\u30c3\u30af\u30aa\u30d5\u3067\u30ea\u30c8\u30e9\u30a4",id:"\u6307\u6570\u30d0\u30c3\u30af\u30aa\u30d5\u3067\u30ea\u30c8\u30e9\u30a4",level:3},{value:"\u30ea\u30c8\u30e9\u30a4\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u306e\u4f7f\u7528",id:"\u30ea\u30c8\u30e9\u30a4\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u306e\u4f7f\u7528",level:3},{value:"AWS\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30e1\u30ab\u30cb\u30ba\u30e0",id:"aws\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30e1\u30ab\u30cb\u30ba\u30e0",level:3},{value:"\u4f8b\uff1aSQS\u30ea\u30c8\u30e9\u30a4\u8a2d\u5b9a",id:"\u4f8bsqs\u30ea\u30c8\u30e9\u30a4\u8a2d\u5b9a",level:4},{value:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u30d1\u30bf\u30fc\u30f3",id:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u30d1\u30bf\u30fc\u30f3",level:2},{value:"\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u5b9f\u88c5",id:"\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u5b9f\u88c5",level:3},{value:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u306e\u4f7f\u7528",id:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u306e\u4f7f\u7528",level:3},{value:"\u5b9f\u8df5\u4f8b\uff1a\u6c7a\u6e08\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u7d71\u5408",id:"\u5b9f\u8df5\u4f8b\u6c7a\u6e08\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u7d71\u5408",level:2},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"1. \u5e38\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3059\u308b",id:"1-\u5e38\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3059\u308b",level:3},{value:"2. \u51aa\u7b49\u6027\u30ad\u30fc\u3092\u4f7f\u7528\u3059\u308b",id:"2-\u51aa\u7b49\u6027\u30ad\u30fc\u3092\u4f7f\u7528\u3059\u308b",level:3},{value:"3. \u5916\u90e8API\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u30ed\u30b0\u306b\u8a18\u9332\u3059\u308b",id:"3-\u5916\u90e8api\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u30ed\u30b0\u306b\u8a18\u9332\u3059\u308b",level:3},{value:"4. \u90e8\u5206\u7684\u306a\u969c\u5bb3\u3092\u9069\u5207\u306b\u51e6\u7406\u3059\u308b",id:"4-\u90e8\u5206\u7684\u306a\u969c\u5bb3\u3092\u9069\u5207\u306b\u51e6\u7406\u3059\u308b",level:3},{value:"5. Webhook\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u5b89\u5168\u306b\u4fdd\u5b58\u3059\u308b",id:"5-webhook\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u5b89\u5168\u306b\u4fdd\u5b58\u3059\u308b",level:3},{value:"\u95a2\u9023\u60c5\u5831",id:"\u95a2\u9023\u60c5\u5831",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"api\u7d71\u5408\u30ac\u30a4\u30c9",children:"API\u7d71\u5408\u30ac\u30a4\u30c9"})}),"\n",(0,s.jsx)(n.p,{children:"\u3053\u306e\u30ac\u30a4\u30c9\u3067\u306f\u3001MBC CQRS Serverless\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u5916\u90e8API\u3084\u30b5\u30fc\u30d3\u30b9\u3068\u7d71\u5408\u3059\u308b\u65b9\u6cd5\u3092\u8aac\u660e\u3057\u307e\u3059\u3002HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306e\u4f5c\u6210\u3001Webhook\u306e\u51e6\u7406\u3001\u30ea\u30c8\u30e9\u30a4\u30ed\u30b8\u30c3\u30af\u306e\u5b9f\u88c5\u3001\u304a\u3088\u3073\u56de\u5fa9\u529b\u306e\u3042\u308b\u7d71\u5408\u3092\u78ba\u4fdd\u3059\u308b\u305f\u3081\u306e\u30d1\u30bf\u30fc\u30f3\u3092\u5b66\u3073\u307e\u3059\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0",children:"\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3059\u308b\u30bf\u30a4\u30df\u30f3\u30b0"}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u3053\u3068\u304c\u5fc5\u8981\u306a\u5834\u5408\u306b\u3053\u306e\u30ac\u30a4\u30c9\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Lambda\u30cf\u30f3\u30c9\u30e9\u30fc\u3084\u30b5\u30fc\u30d3\u30b9\u304b\u3089external REST API\u3092\u547c\u3073\u51fa\u3059"}),"\n",(0,s.jsx)(n.li,{children:"\u30b5\u30fc\u30c9\u30d1\u30fc\u30c6\u30a3\u30b5\u30fc\u30d3\u30b9\u304b\u3089Webhook\u3092\u53d7\u4fe1\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"\u5916\u90e8API\u547c\u3073\u51fa\u3057\u306e\u30ea\u30c8\u30e9\u30a4\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3092\u5b9f\u88c5\u3059\u308b"}),"\n",(0,s.jsx)(n.li,{children:"\u5916\u90e8\u30b7\u30b9\u30c6\u30e0\u3068\u306e\u56de\u5fa9\u529b\u306e\u3042\u308b\u7d71\u5408\u3092\u69cb\u7bc9\u3059\u308b"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c",children:"\u3053\u306e\u30d1\u30bf\u30fc\u30f3\u304c\u89e3\u6c7a\u3059\u308b\u554f\u984c"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u554f\u984c"}),(0,s.jsx)(n.th,{children:"\u89e3\u6c7a\u7b56"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5916\u90e8API\u547c\u3073\u51fa\u3057\u304c\u65ad\u7d9a\u7684\u306b\u5931\u6557\u3059\u308b"}),(0,s.jsx)(n.td,{children:"\u6307\u6570\u30d0\u30c3\u30af\u30aa\u30d5\u3067\u30ea\u30c8\u30e9\u30a4\u3092\u5b9f\u88c5"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u30b5\u30fc\u30c9\u30d1\u30fc\u30c6\u30a3\u30b5\u30fc\u30d3\u30b9\u304c\u30a2\u30d7\u30ea\u306b\u30a4\u30d9\u30f3\u30c8\u3092\u9001\u4fe1\u3059\u308b"}),(0,s.jsx)(n.td,{children:"\u7f72\u540d\u691c\u8a3c\u4ed8\u304d\u306eWebhook\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3092\u4f5c\u6210"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u304cLambda\u969c\u5bb3\u3092\u5f15\u304d\u8d77\u3053\u3059"}),(0,s.jsx)(n.td,{children:"\u9069\u5207\u306a\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3057\u3001\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u30a8\u30e9\u30fc\u3092\u51e6\u7406"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5916\u90e8API\u306e\u554f\u984c\u3092\u628a\u63e1\u3067\u304d\u306a\u3044"}),(0,s.jsx)(n.td,{children:"\u69cb\u9020\u5316\u30ed\u30b0\u3068\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3092\u8ffd\u52a0"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"\u5916\u90e8api\u306e\u547c\u3073\u51fa\u3057",children:"\u5916\u90e8API\u306e\u547c\u3073\u51fa\u3057"}),"\n",(0,s.jsx)(n.h3,{id:"http\u30ea\u30af\u30a8\u30b9\u30c8\u306bfetch\u3092\u4f7f\u7528\u3059\u308b",children:"HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306bfetch\u3092\u4f7f\u7528\u3059\u308b"}),"\n",(0,s.jsxs)(n.p,{children:["\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306f\u5185\u90e8\u30b5\u30fc\u30d3\u30b9\u3067HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306b",(0,s.jsx)(n.code,{children:"node-fetch"}),"\u3092\u4f7f\u7528\u3057\u3066\u3044\u307e\u3059\u3002\u540c\u3058\u30a2\u30d7\u30ed\u30fc\u30c1\u307e\u305f\u306fNode.js\u4e92\u63db\u306e\u4efb\u610f\u306eHTTP\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f7f\u7528\u3067\u304d\u307e\u3059\u3002"]}),"\n",(0,s.jsx)(n.h4,{id:"\u57fa\u672c\u7684\u306aget\u30ea\u30af\u30a8\u30b9\u30c8",children:"\u57fa\u672c\u7684\u306aGET\u30ea\u30af\u30a8\u30b9\u30c8"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// external-api.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\n\n@Injectable()\nexport class ExternalApiService {\n  private readonly logger = new Logger(ExternalApiService.name);\n  private readonly apiBaseUrl: string;\n  private readonly apiKey: string;\n\n  constructor(private readonly configService: ConfigService) {\n    this.apiBaseUrl = this.configService.get<string>('EXTERNAL_API_URL');\n    this.apiKey = this.configService.get<string>('EXTERNAL_API_KEY');\n  }\n\n  async getResource(resourceId: string): Promise<any> {\n    const url = `${this.apiBaseUrl}/resources/${resourceId}`;\n\n    try {\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${this.apiKey}`,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(`API request failed: ${response.status} ${response.statusText}`);\n      }\n\n      return await response.json();\n    } catch (error) {\n      this.logger.error(`Failed to fetch resource ${resourceId}:`, error);\n      throw error;\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"\u30da\u30a4\u30ed\u30fc\u30c9\u4ed8\u304dpost\u30ea\u30af\u30a8\u30b9\u30c8",children:"\u30da\u30a4\u30ed\u30fc\u30c9\u4ed8\u304dPOST\u30ea\u30af\u30a8\u30b9\u30c8"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"async createResource(data: CreateResourceDto): Promise<any> {\n  const url = `${this.apiBaseUrl}/resources`;\n\n  try {\n    const response = await fetch(url, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.apiKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(data),\n    });\n\n    if (!response.ok) {\n      const errorBody = await response.text();\n      throw new Error(`API request failed: ${response.status} - ${errorBody}`);\n    }\n\n    return await response.json();\n  } catch (error) {\n    this.logger.error('Failed to create resource:', error);\n    throw error;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"axios\u306e\u4f7f\u7528",children:"Axios\u306e\u4f7f\u7528"}),"\n",(0,s.jsx)(n.p,{children:"HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u306b\u306fAxios\u307e\u305f\u306fNestJS HttpModule\u3082\u4f7f\u7528\u3067\u304d\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm install axios\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// external-api.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport axios, { AxiosInstance, AxiosError } from 'axios';\n\n@Injectable()\nexport class ExternalApiService {\n  private readonly logger = new Logger(ExternalApiService.name);\n  private readonly client: AxiosInstance;\n\n  constructor(private readonly configService: ConfigService) {\n    this.client = axios.create({\n      baseURL: this.configService.get<string>('EXTERNAL_API_URL'),\n      timeout: 10000, // 10 second timeout (10\u79d2\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8)\n      headers: {\n        'Authorization': `Bearer ${this.configService.get<string>('EXTERNAL_API_KEY')}`,\n        'Content-Type': 'application/json',\n      },\n    });\n\n    // Response interceptor for logging (\u30ed\u30b0\u7528\u30ec\u30b9\u30dd\u30f3\u30b9\u30a4\u30f3\u30bf\u30fc\u30bb\u30d7\u30bf\u30fc)\n    this.client.interceptors.response.use(\n      (response) => response,\n      (error: AxiosError) => {\n        this.logger.error('API request failed:', {\n          url: error.config?.url,\n          status: error.response?.status,\n          message: error.message,\n        });\n        return Promise.reject(error);\n      },\n    );\n  }\n\n  async getResource(resourceId: string): Promise<any> {\n    const response = await this.client.get(`/resources/${resourceId}`);\n    return response.data;\n  }\n\n  async createResource(data: CreateResourceDto): Promise<any> {\n    const response = await this.client.post('/resources', data);\n    return response.data;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a",children:"\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u306e\u8a2d\u5b9a"}),"\n",(0,s.jsx)(n.p,{children:"Lambda\u304b\u3089API\u3092\u547c\u3073\u51fa\u3059\u969b\u306f\u3001\u5e38\u306b\u9069\u5207\u306a\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Recommended: Set timeout less than Lambda timeout (\u63a8\u5968\uff1aLambda\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3088\u308a\u77ed\u3044\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a)\nconst response = await fetch(url, {\n  method: 'GET',\n  headers: { /* ... */ },\n  signal: AbortSignal.timeout(25000), // 25 seconds - Lambda default is 30s (25\u79d2 - Lambda\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306f30\u79d2)\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"Axios\u306e\u5834\u5408\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const client = axios.create({\n  baseURL: apiUrl,\n  timeout: 25000, // 25 seconds (25\u79d2)\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"webhook\u306e\u53d7\u4fe1",children:"Webhook\u306e\u53d7\u4fe1"}),"\n",(0,s.jsx)(n.h3,{id:"webhook\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3",children:"Webhook\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,s.jsx)(n.p,{children:"\u5916\u90e8\u30b5\u30fc\u30d3\u30b9\u304b\u3089Webhook\u3092\u53d7\u4fe1\u3059\u308b\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// webhook.controller.ts\nimport {\n  Controller,\n  Post,\n  Body,\n  Headers,\n  HttpCode,\n  HttpStatus,\n  BadRequestException,\n  Logger,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation } from '@nestjs/swagger';\nimport { WebhookService } from './webhook.service';\n\n@ApiTags('webhooks')\n@Controller('api/webhooks')\nexport class WebhookController {\n  private readonly logger = new Logger(WebhookController.name);\n\n  constructor(private readonly webhookService: WebhookService) {}\n\n  @Post('payment-provider')\n  @HttpCode(HttpStatus.OK)\n  @ApiOperation({ summary: 'Receive payment provider webhooks' })\n  async handlePaymentWebhook(\n    @Body() payload: any,\n    @Headers('x-signature') signature: string,\n    @Headers('x-timestamp') timestamp: string,\n  ) {\n    this.logger.log(`Received payment webhook: ${payload.event}`);\n\n    // Verify webhook signature (Webhook\u7f72\u540d\u3092\u691c\u8a3c)\n    const isValid = await this.webhookService.verifySignature(\n      payload,\n      signature,\n      timestamp,\n    );\n\n    if (!isValid) {\n      throw new BadRequestException('Invalid webhook signature');\n    }\n\n    // Process the webhook event (Webhook\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406)\n    await this.webhookService.processPaymentEvent(payload);\n\n    return { received: true };\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"webhook\u7f72\u540d\u306e\u691c\u8a3c",children:"Webhook\u7f72\u540d\u306e\u691c\u8a3c"}),"\n",(0,s.jsx)(n.p,{children:"\u30ea\u30af\u30a8\u30b9\u30c8\u304c\u4fe1\u983c\u3067\u304d\u308b\u30bd\u30fc\u30b9\u304b\u3089\u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3059\u308b\u305f\u3081\u3001\u5e38\u306bWebhook\u7f72\u540d\u3092\u691c\u8a3c\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// webhook.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class WebhookService {\n  private readonly logger = new Logger(WebhookService.name);\n  private readonly webhookSecret: string;\n\n  constructor(private readonly configService: ConfigService) {\n    this.webhookSecret = this.configService.get<string>('WEBHOOK_SECRET');\n  }\n\n  /**\n   * Verify webhook signature using HMAC (HMAC\u3092\u4f7f\u7528\u3057\u3066Webhook\u7f72\u540d\u3092\u691c\u8a3c)\n   */\n  async verifySignature(\n    payload: any,\n    signature: string,\n    timestamp: string,\n  ): Promise<boolean> {\n    if (!signature || !timestamp) {\n      return false;\n    }\n\n    // Check timestamp to prevent replay attacks (\u30ea\u30d7\u30ec\u30a4\u653b\u6483\u3092\u9632\u3050\u305f\u3081\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3092\u78ba\u8a8d)\n    const now = Math.floor(Date.now() / 1000);\n    const webhookTime = parseInt(timestamp, 10);\n    const tolerance = 300; // 5 minutes (5\u5206)\n\n    if (Math.abs(now - webhookTime) > tolerance) {\n      this.logger.warn('Webhook timestamp is too old');\n      return false;\n    }\n\n    // Calculate expected signature (\u671f\u5f85\u3055\u308c\u308b\u7f72\u540d\u3092\u8a08\u7b97)\n    const signedPayload = `${timestamp}.${JSON.stringify(payload)}`;\n    const expectedSignature = crypto\n      .createHmac('sha256', this.webhookSecret)\n      .update(signedPayload)\n      .digest('hex');\n\n    // Use timing-safe comparison (\u30bf\u30a4\u30df\u30f3\u30b0\u30bb\u30fc\u30d5\u306a\u6bd4\u8f03\u3092\u4f7f\u7528)\n    try {\n      return crypto.timingSafeEqual(\n        Buffer.from(signature),\n        Buffer.from(expectedSignature),\n      );\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Process payment event based on type (\u30bf\u30a4\u30d7\u306b\u57fa\u3065\u3044\u3066\u6c7a\u6e08\u30a4\u30d9\u30f3\u30c8\u3092\u51e6\u7406)\n   */\n  async processPaymentEvent(payload: any): Promise<void> {\n    const { event, data } = payload;\n\n    switch (event) {\n      case 'payment.completed':\n        await this.handlePaymentCompleted(data);\n        break;\n      case 'payment.failed':\n        await this.handlePaymentFailed(data);\n        break;\n      case 'refund.created':\n        await this.handleRefundCreated(data);\n        break;\n      default:\n        this.logger.warn(`Unhandled webhook event: ${event}`);\n    }\n  }\n\n  private async handlePaymentCompleted(data: any): Promise<void> {\n    // Update order status, trigger notifications, etc. (\u6ce8\u6587\u30b9\u30c6\u30fc\u30bf\u30b9\u306e\u66f4\u65b0\u3001\u901a\u77e5\u306e\u30c8\u30ea\u30ac\u30fc\u306a\u3069)\n    this.logger.log(`Payment completed: ${data.paymentId}`);\n  }\n\n  private async handlePaymentFailed(data: any): Promise<void> {\n    this.logger.log(`Payment failed: ${data.paymentId}`);\n  }\n\n  private async handleRefundCreated(data: any): Promise<void> {\n    this.logger.log(`Refund created: ${data.refundId}`);\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u51aa\u7b49\u306awebhook\u51e6\u7406",children:"\u51aa\u7b49\u306aWebhook\u51e6\u7406"}),"\n",(0,s.jsx)(n.p,{children:"Webhook\u306f\u8907\u6570\u56de\u914d\u4fe1\u3055\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002\u91cd\u8907\u51e6\u7406\u3092\u9632\u3050\u305f\u3081\u306b\u51aa\u7b49\u6027\u30ad\u30fc\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// webhook.service.ts\nimport { PrismaService } from 'src/prisma';\n\n@Injectable()\nexport class WebhookService {\n  constructor(\n    private readonly prismaService: PrismaService,\n    // ...\n  ) {}\n\n  async processPaymentEvent(payload: any): Promise<void> {\n    const webhookId = payload.id;\n\n    // Check if already processed (\u65e2\u306b\u51e6\u7406\u6e08\u307f\u304b\u78ba\u8a8d)\n    const existing = await this.prismaService.processedWebhook.findUnique({\n      where: { webhookId },\n    });\n\n    if (existing) {\n      this.logger.log(`Webhook ${webhookId} already processed, skipping`);\n      return;\n    }\n\n    // Process the webhook (Webhook\u3092\u51e6\u7406)\n    await this.handleEvent(payload);\n\n    // Mark as processed (\u51e6\u7406\u6e08\u307f\u3068\u3057\u3066\u30de\u30fc\u30af)\n    await this.prismaService.processedWebhook.create({\n      data: {\n        webhookId,\n        eventType: payload.event,\n        processedAt: new Date(),\n      },\n    });\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30ea\u30c8\u30e9\u30a4\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0",children:"\u30ea\u30c8\u30e9\u30a4\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0"}),"\n",(0,s.jsx)(n.h3,{id:"\u6307\u6570\u30d0\u30c3\u30af\u30aa\u30d5\u3067\u30ea\u30c8\u30e9\u30a4",children:"\u6307\u6570\u30d0\u30c3\u30af\u30aa\u30d5\u3067\u30ea\u30c8\u30e9\u30a4"}),"\n",(0,s.jsx)(n.p,{children:"\u4e00\u6642\u7684\u306a\u969c\u5bb3\u306b\u5bfe\u3059\u308b\u30ea\u30c8\u30e9\u30a4\u30ed\u30b8\u30c3\u30af\u3092\u5b9f\u88c5\u3057\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// retry.utils.ts\nimport { Logger } from '@nestjs/common';\n\nexport interface RetryOptions {\n  maxRetries: number;\n  baseDelayMs: number;\n  maxDelayMs: number;\n}\n\nconst DEFAULT_OPTIONS: RetryOptions = {\n  maxRetries: 3,\n  baseDelayMs: 1000,\n  maxDelayMs: 10000,\n};\n\n/**\n * Execute a function with exponential backoff retry (\u6307\u6570\u30d0\u30c3\u30af\u30aa\u30d5\u30ea\u30c8\u30e9\u30a4\u3067\u95a2\u6570\u3092\u5b9f\u884c)\n */\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  options: Partial<RetryOptions> = {},\n  logger?: Logger,\n): Promise<T> {\n  const opts = { ...DEFAULT_OPTIONS, ...options };\n  let lastError: Error;\n\n  for (let attempt = 1; attempt <= opts.maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error as Error;\n\n      // Don't retry on client errors (4xx) (\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u30a8\u30e9\u30fc(4xx)\u3067\u306f\u30ea\u30c8\u30e9\u30a4\u3057\u306a\u3044)\n      if (isClientError(error)) {\n        throw error;\n      }\n\n      if (attempt < opts.maxRetries) {\n        const delay = Math.min(\n          opts.baseDelayMs * Math.pow(2, attempt - 1),\n          opts.maxDelayMs,\n        );\n\n        logger?.warn(\n          `Attempt ${attempt}/${opts.maxRetries} failed, retrying in ${delay}ms: ${lastError.message}`,\n        );\n\n        await sleep(delay);\n      }\n    }\n  }\n\n  logger?.error(`All ${opts.maxRetries} attempts failed`);\n  throw lastError!;\n}\n\nfunction isClientError(error: any): boolean {\n  const status = error?.response?.status || error?.status;\n  return status >= 400 && status < 500;\n}\n\nfunction sleep(ms: number): Promise<void> {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u30ea\u30c8\u30e9\u30a4\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u306e\u4f7f\u7528",children:"\u30ea\u30c8\u30e9\u30a4\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u306e\u4f7f\u7528"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// external-api.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { withRetry } from './retry.utils';\n\n@Injectable()\nexport class ExternalApiService {\n  private readonly logger = new Logger(ExternalApiService.name);\n\n  async getResourceWithRetry(resourceId: string): Promise<any> {\n    return withRetry(\n      () => this.getResource(resourceId),\n      { maxRetries: 3, baseDelayMs: 500 },\n      this.logger,\n    );\n  }\n\n  private async getResource(resourceId: string): Promise<any> {\n    const response = await fetch(`${this.apiUrl}/resources/${resourceId}`, {\n      headers: { 'Authorization': `Bearer ${this.apiKey}` },\n    });\n\n    if (!response.ok) {\n      const error = new Error(`API error: ${response.status}`);\n      (error as any).status = response.status;\n      throw error;\n    }\n\n    return response.json();\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"aws\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30e1\u30ab\u30cb\u30ba\u30e0",children:"AWS\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30e1\u30ab\u30cb\u30ba\u30e0"}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u756a\u30ef\u30fc\u30af\u30ed\u30fc\u30c9\u3067\u306f\u3001AWS\u30cd\u30a4\u30c6\u30a3\u30d6\u306e\u30ea\u30c8\u30e9\u30a4\u30e1\u30ab\u30cb\u30ba\u30e0\u306e\u4f7f\u7528\u3092\u691c\u8a0e\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"SQS + Lambda"}),": \u8a2d\u5b9a\u53ef\u80fd\u306a",(0,s.jsx)(n.code,{children:"maxReceiveCount"}),"\u3067\u5931\u6557\u3057\u305f\u30e1\u30c3\u30bb\u30fc\u30b8\u3092\u30ea\u30c8\u30e9\u30a4\u3059\u308b\u3088\u3046\u306bSQS\u3092\u8a2d\u5b9a"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Step Functions"}),": \u30b9\u30c6\u30fc\u30c8\u30de\u30b7\u30f3\u5b9a\u7fa9\u3067\u7d44\u307f\u8fbc\u307f\u306eRetry\u3068Catch\u30d6\u30ed\u30c3\u30af\u3092\u4f7f\u7528"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Lambda Destinations"}),": \u5931\u6557\u3057\u305f\u547c\u3073\u51fa\u3057\u3092\u518d\u51e6\u7406\u306e\u305f\u3081\u306bSQS\u307e\u305f\u306fSNS\u306b\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u4f8bsqs\u30ea\u30c8\u30e9\u30a4\u8a2d\u5b9a",children:"\u4f8b\uff1aSQS\u30ea\u30c8\u30e9\u30a4\u8a2d\u5b9a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# serverless.yml\nresources:\n  Resources:\n    ExternalApiQueue:\n      Type: AWS::SQS::Queue\n      Properties:\n        QueueName: external-api-requests\n        VisibilityTimeout: 60\n        RedrivePolicy:\n          deadLetterTargetArn: !GetAtt DeadLetterQueue.Arn\n          maxReceiveCount: 3  # Retry 3 times before moving to DLQ (DLQ\u306b\u79fb\u52d5\u3059\u308b\u524d\u306b3\u56de\u30ea\u30c8\u30e9\u30a4)\n\n    DeadLetterQueue:\n      Type: AWS::SQS::Queue\n      Properties:\n        QueueName: external-api-dlq\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u30d1\u30bf\u30fc\u30f3",children:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,s.jsx)(n.admonition,{title:"\u63a8\u5968\u4e8b\u9805",type:"info",children:(0,s.jsxs)(n.p,{children:["\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u30d1\u30bf\u30fc\u30f3\u306f\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306b\u7d44\u307f\u8fbc\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u3002API\u547c\u3073\u51fa\u3057\u91cf\u304c\u591a\u3044\u672c\u756a\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u306f\u3001\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u306e\u5b9f\u88c5\u3001\u307e\u305f\u306f",(0,s.jsx)(n.code,{children:"cockatiel"}),"\u3084",(0,s.jsx)(n.code,{children:"opossum"}),"\u306a\u3069\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u4f7f\u7528\u3092\u691c\u8a0e\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]})}),"\n",(0,s.jsx)(n.h3,{id:"\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u5b9f\u88c5",children:"\u30b7\u30f3\u30d7\u30eb\u306a\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u5b9f\u88c5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// circuit-breaker.ts\nexport enum CircuitState {\n  CLOSED = 'CLOSED',     // Normal operation (\u901a\u5e38\u52d5\u4f5c)\n  OPEN = 'OPEN',         // Failing fast (\u9ad8\u901f\u5931\u6557)\n  HALF_OPEN = 'HALF_OPEN', // Testing recovery (\u56de\u5fa9\u30c6\u30b9\u30c8)\n}\n\nexport interface CircuitBreakerOptions {\n  failureThreshold: number;  // Number of failures before opening (\u30aa\u30fc\u30d7\u30f3\u3059\u308b\u307e\u3067\u306e\u5931\u6557\u56de\u6570)\n  resetTimeoutMs: number;    // Time before trying again (\u518d\u8a66\u884c\u307e\u3067\u306e\u6642\u9593)\n}\n\nexport class CircuitBreaker {\n  private state: CircuitState = CircuitState.CLOSED;\n  private failures = 0;\n  private lastFailureTime = 0;\n\n  constructor(private readonly options: CircuitBreakerOptions) {}\n\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\n    if (this.state === CircuitState.OPEN) {\n      if (Date.now() - this.lastFailureTime >= this.options.resetTimeoutMs) {\n        this.state = CircuitState.HALF_OPEN;\n      } else {\n        throw new Error('Circuit breaker is open');\n      }\n    }\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  private onSuccess(): void {\n    this.failures = 0;\n    this.state = CircuitState.CLOSED;\n  }\n\n  private onFailure(): void {\n    this.failures++;\n    this.lastFailureTime = Date.now();\n\n    if (this.failures >= this.options.failureThreshold) {\n      this.state = CircuitState.OPEN;\n    }\n  }\n\n  getState(): CircuitState {\n    return this.state;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u306e\u4f7f\u7528",children:"\u30b5\u30fc\u30ad\u30c3\u30c8\u30d6\u30ec\u30fc\u30ab\u30fc\u306e\u4f7f\u7528"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// external-api.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { CircuitBreaker } from './circuit-breaker';\n\n@Injectable()\nexport class ExternalApiService {\n  private readonly logger = new Logger(ExternalApiService.name);\n  private readonly circuitBreaker: CircuitBreaker;\n\n  constructor() {\n    this.circuitBreaker = new CircuitBreaker({\n      failureThreshold: 5,\n      resetTimeoutMs: 30000, // 30 seconds (30\u79d2)\n    });\n  }\n\n  async getResource(resourceId: string): Promise<any> {\n    try {\n      return await this.circuitBreaker.execute(() =>\n        this.fetchResource(resourceId),\n      );\n    } catch (error) {\n      if ((error as Error).message === 'Circuit breaker is open') {\n        this.logger.warn('Circuit breaker open, using fallback');\n        return this.getFallbackResource(resourceId);\n      }\n      throw error;\n    }\n  }\n\n  private async fetchResource(resourceId: string): Promise<any> {\n    // Actual API call (\u5b9f\u969b\u306eAPI\u547c\u3073\u51fa\u3057)\n    const response = await fetch(`${this.apiUrl}/resources/${resourceId}`);\n    if (!response.ok) throw new Error(`API error: ${response.status}`);\n    return response.json();\n  }\n\n  private getFallbackResource(resourceId: string): any {\n    // Return cached data or default response (\u30ad\u30e3\u30c3\u30b7\u30e5\u3055\u308c\u305f\u30c7\u30fc\u30bf\u307e\u305f\u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8fd4\u3059)\n    return { id: resourceId, status: 'unavailable' };\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b9f\u8df5\u4f8b\u6c7a\u6e08\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u7d71\u5408",children:"\u5b9f\u8df5\u4f8b\uff1a\u6c7a\u6e08\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u7d71\u5408"}),"\n",(0,s.jsx)(n.p,{children:"\u3053\u306e\u4f8b\u306f\u3001\u5916\u90e8\u6c7a\u6e08\u30b2\u30fc\u30c8\u30a6\u30a7\u30a4\u3068\u306e\u5b8c\u5168\u306a\u7d71\u5408\u3092\u793a\u3057\u3066\u3044\u307e\u3059\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// payment-gateway.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport {\n  CommandService,\n  IInvoke,\n  getUserContext,\n} from '@mbc-cqrs-serverless/core';\nimport { withRetry } from './retry.utils';\n\ninterface PaymentRequest {\n  orderId: string;\n  amount: number;\n  currency: string;\n  customerId: string;\n}\n\ninterface PaymentResponse {\n  transactionId: string;\n  status: 'success' | 'failed' | 'pending';\n  message?: string;\n}\n\n@Injectable()\nexport class PaymentGatewayService {\n  private readonly logger = new Logger(PaymentGatewayService.name);\n  private readonly gatewayUrl: string;\n  private readonly apiKey: string;\n\n  constructor(\n    private readonly configService: ConfigService,\n    private readonly commandService: CommandService,\n  ) {\n    this.gatewayUrl = this.configService.get<string>('PAYMENT_GATEWAY_URL');\n    this.apiKey = this.configService.get<string>('PAYMENT_GATEWAY_API_KEY');\n  }\n\n  /**\n   * Process payment with retry and error handling (\u30ea\u30c8\u30e9\u30a4\u3068\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u3067\u6c7a\u6e08\u3092\u51e6\u7406)\n   */\n  async processPayment(\n    request: PaymentRequest,\n    opts: { invokeContext: IInvoke },\n  ): Promise<PaymentResponse> {\n    const { tenantCode } = getUserContext(opts.invokeContext);\n\n    this.logger.log(`Processing payment for order ${request.orderId}`);\n\n    try {\n      const result = await withRetry(\n        () => this.callPaymentGateway(request),\n        { maxRetries: 3, baseDelayMs: 1000 },\n        this.logger,\n      );\n\n      // Record successful payment in command store (\u30b3\u30de\u30f3\u30c9\u30b9\u30c8\u30a2\u306b\u6210\u529f\u3057\u305f\u6c7a\u6e08\u3092\u8a18\u9332)\n      await this.recordPaymentResult(request, result, opts);\n\n      return result;\n    } catch (error) {\n      this.logger.error(`Payment failed for order ${request.orderId}:`, error);\n\n      // Record failed payment attempt (\u5931\u6557\u3057\u305f\u6c7a\u6e08\u8a66\u884c\u3092\u8a18\u9332)\n      await this.recordPaymentResult(\n        request,\n        { transactionId: '', status: 'failed', message: (error as Error).message },\n        opts,\n      );\n\n      throw error;\n    }\n  }\n\n  private async callPaymentGateway(\n    request: PaymentRequest,\n  ): Promise<PaymentResponse> {\n    const response = await fetch(`${this.gatewayUrl}/v1/payments`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${this.apiKey}`,\n        'Content-Type': 'application/json',\n        'Idempotency-Key': request.orderId, // Prevent duplicate charges (\u91cd\u8907\u8ab2\u91d1\u3092\u9632\u6b62)\n      },\n      body: JSON.stringify({\n        amount: request.amount,\n        currency: request.currency,\n        customer_id: request.customerId,\n        metadata: { order_id: request.orderId },\n      }),\n      signal: AbortSignal.timeout(15000), // 15 second timeout (15\u79d2\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8)\n    });\n\n    if (!response.ok) {\n      const errorBody = await response.text();\n      throw new Error(`Payment gateway error: ${response.status} - ${errorBody}`);\n    }\n\n    const data = await response.json();\n\n    return {\n      transactionId: data.id,\n      status: data.status === 'succeeded' ? 'success' : data.status,\n      message: data.message,\n    };\n  }\n\n  private async recordPaymentResult(\n    request: PaymentRequest,\n    result: PaymentResponse,\n    opts: { invokeContext: IInvoke },\n  ): Promise<void> {\n    // Record payment result using CommandService (CommandService\u3092\u4f7f\u7528\u3057\u3066\u6c7a\u6e08\u7d50\u679c\u3092\u8a18\u9332)\n    // Implementation depends on your data model (\u5b9f\u88c5\u306f\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb\u306b\u4f9d\u5b58)\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u5e38\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3059\u308b",children:"1. \u5e38\u306b\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a\u3059\u308b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Set timeout shorter than Lambda timeout (Lambda\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3088\u308a\u77ed\u3044\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\u3092\u8a2d\u5b9a)\nconst response = await fetch(url, {\n  signal: AbortSignal.timeout(25000), // Lambda default is 30s (Lambda\u306e\u30c7\u30d5\u30a9\u30eb\u30c8\u306f30\u79d2)\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-\u51aa\u7b49\u6027\u30ad\u30fc\u3092\u4f7f\u7528\u3059\u308b",children:"2. \u51aa\u7b49\u6027\u30ad\u30fc\u3092\u4f7f\u7528\u3059\u308b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Prevent duplicate API calls (\u91cd\u8907API\u547c\u3073\u51fa\u3057\u3092\u9632\u6b62)\nheaders: {\n  'Idempotency-Key': `${orderId}-${operationType}`,\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-\u5916\u90e8api\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u30ed\u30b0\u306b\u8a18\u9332\u3059\u308b",children:"3. \u5916\u90e8API\u3068\u306e\u3084\u308a\u53d6\u308a\u3092\u30ed\u30b0\u306b\u8a18\u9332\u3059\u308b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"this.logger.log({\n  message: 'External API call',\n  url: endpoint,\n  method: 'POST',\n  duration: endTime - startTime,\n  status: response.status,\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-\u90e8\u5206\u7684\u306a\u969c\u5bb3\u3092\u9069\u5207\u306b\u51e6\u7406\u3059\u308b",children:"4. \u90e8\u5206\u7684\u306a\u969c\u5bb3\u3092\u9069\u5207\u306b\u51e6\u7406\u3059\u308b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Continue processing even if some external calls fail (\u4e00\u90e8\u306e\u5916\u90e8\u547c\u3073\u51fa\u3057\u304c\u5931\u6557\u3057\u3066\u3082\u51e6\u7406\u3092\u7d99\u7d9a)\nconst results = await Promise.allSettled(\n  items.map((item) => this.callExternalApi(item)),\n);\n\nconst succeeded = results.filter((r) => r.status === 'fulfilled');\nconst failed = results.filter((r) => r.status === 'rejected');\n\nif (failed.length > 0) {\n  this.logger.warn(`${failed.length} API calls failed`);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"5-webhook\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u5b89\u5168\u306b\u4fdd\u5b58\u3059\u308b",children:"5. Webhook\u30b7\u30fc\u30af\u30ec\u30c3\u30c8\u3092\u5b89\u5168\u306b\u4fdd\u5b58\u3059\u308b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Use AWS Secrets Manager or SSM Parameter Store (AWS Secrets Manager\u307e\u305f\u306fSSM Parameter Store\u3092\u4f7f\u7528)\nWEBHOOK_SECRET=${ssm:/myapp/webhook-secret}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u95a2\u9023\u60c5\u5831",children:"\u95a2\u9023\u60c5\u5831"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./service-patterns",children:"\u30b5\u30fc\u30d3\u30b9\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3"})," - \u30b3\u30a2\u30b5\u30fc\u30d3\u30b9\u30d1\u30bf\u30fc\u30f3"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./event-handling-patterns",children:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u30d1\u30bf\u30fc\u30f3"})," - \u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./monitoring-logging",children:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3068\u30ed\u30b0"})," - \u30aa\u30d6\u30b6\u30fc\u30d0\u30d3\u30ea\u30c6\u30a3\u306e\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./error-catalog",children:"\u30a8\u30e9\u30fc\u30ab\u30bf\u30ed\u30b0"})," - \u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u30ea\u30d5\u30a1\u30ec\u30f3\u30b9"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var t=r(6540);const s={},a=t.createContext(s);function i(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);