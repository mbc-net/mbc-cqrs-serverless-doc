"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[8756],{9022:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>v,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"architecture/event-sourcing","title":"Event Sourcing Pattern","description":"This document explains the Event Sourcing implementation in MBC CQRS Serverless.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/architecture/event-sourcing.md","sourceDirName":"architecture","slug":"/architecture/event-sourcing","permalink":"/docs/architecture/event-sourcing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"CQRS Pattern Flow","permalink":"/docs/architecture/cqrs-flow"},"next":{"title":"Key Design Patterns","permalink":"/docs/key-patterns"}}');var i=t(4848),s=t(8453);const o={sidebar_position:3},c="Event Sourcing Pattern",a={},l=[{value:"Event Sourcing Overview",id:"event-sourcing-overview",level:2},{value:"Event Lifecycle",id:"event-lifecycle",level:2},{value:"DynamoDB Event Store Schema",id:"dynamodb-event-store-schema",level:2},{value:"Key Structure",id:"key-structure",level:3},{value:"Event Record Example",id:"event-record-example",level:3},{value:"Optimistic Locking",id:"optimistic-locking",level:2},{value:"Version Control Implementation",id:"version-control-implementation",level:3},{value:"Event Processing Pipeline",id:"event-processing-pipeline",level:2},{value:"Event Handler Implementation",id:"event-handler-implementation",level:2},{value:"Benefits of Event Sourcing",id:"benefits-of-event-sourcing",level:2},{value:"Best Practices",id:"best-practices",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"event-sourcing-pattern",children:"Event Sourcing Pattern"})}),"\n",(0,i.jsx)(n.p,{children:"This document explains the Event Sourcing implementation in MBC CQRS Serverless."}),"\n",(0,i.jsx)(n.h2,{id:"event-sourcing-overview",children:"Event Sourcing Overview"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart TB\n    subgraph EventStore\n        ES[(DynamoDB)]\n    end\n\n    subgraph EventFlow\n        Command[Command]\n        Aggregate[Aggregate]\n        Event1[Event 1]\n        Event2[Event 2]\n        Event3[Event 3]\n    end\n\n    subgraph Projections\n        P1[Read Model A]\n        P2[Read Model B]\n        P3[Notification Service]\n    end\n\n    Command --\x3e Aggregate\n    Aggregate --\x3e Event1\n    Aggregate --\x3e Event2\n    Aggregate --\x3e Event3\n\n    Event1 --\x3e ES\n    Event2 --\x3e ES\n    Event3 --\x3e ES\n\n    ES --\x3e P1\n    ES --\x3e P2\n    ES --\x3e P3"}),"\n",(0,i.jsx)(n.h2,{id:"event-lifecycle",children:"Event Lifecycle"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    Cmd->>Agg: Execute Command\n    Agg->>Agg: Validate Business Rules\n    Agg->>Agg: Apply State Change\n    Agg->>ES: Store Event\n    ES->>SNS: Publish Event\n    SNS->>SQS: Fan-out\n    SQS->>EH: Trigger Handler\n    EH->>RM: Update Projection"}),"\n",(0,i.jsx)(n.h2,{id:"dynamodb-event-store-schema",children:"DynamoDB Event Store Schema"}),"\n",(0,i.jsx)(n.h3,{id:"key-structure",children:"Key Structure"}),"\n",(0,i.jsx)(n.p,{children:"The DynamoDB key structure for event storage:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"PK (Partition Key)"}),": ",(0,i.jsx)(n.code,{children:"{TENANT}#{ENTITY_TYPE}"})," (Example: ",(0,i.jsx)(n.code,{children:"TENANT001#ORDER"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SK (Sort Key)"}),": ",(0,i.jsx)(n.code,{children:"{ENTITY_TYPE}#{ID}"})," (Example: ",(0,i.jsx)(n.code,{children:"ORDER#20240101-001"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"event-record-example",children:"Event Record Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "pk": "TENANT001#ORDER",\n  "sk": "ORDER#20240101-001",\n  "version": 3,\n  "type": "OrderCreated",\n  "data": {\n    "orderId": "20240101-001",\n    "customerId": "CUST-001",\n    "items": [],\n    "totalAmount": 15000\n  },\n  "createdAt": "2024-01-01T10:00:00Z",\n  "createdBy": "user-123"\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"optimistic-locking",children:"Optimistic Locking"}),"\n",(0,i.jsx)(n.p,{children:"Explains the optimistic locking mechanism for ensuring data consistency during concurrent updates."}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    C1->>DB: Read v1\n    C2->>DB: Read v1\n    C1->>DB: Update v1 to v2\n    DB--\x3e>C1: Success\n    C2->>DB: Update v1 to v2\n    DB--\x3e>C2: ConditionalCheckFailed\n    C2->>DB: Retry Read v2\n    C2->>DB: Update v2 to v3\n    DB--\x3e>C2: Success"}),"\n",(0,i.jsx)(n.h3,{id:"version-control-implementation",children:"Version Control Implementation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Command Service automatically handles versioning\nawait this.commandService.publishAsync(entity, {\n  invokeContext: context,\n});\n\n// DynamoDB ConditionExpression ensures optimistic locking\n// ConditionExpression: 'attribute_not_exists(pk) OR version = :currentVersion'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"event-processing-pipeline",children:"Event Processing Pipeline"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart LR\n    subgraph EventSource\n        ES[Event Store]\n    end\n\n    subgraph MessageBroker\n        SNS[SNS Topic]\n        SQS1[SQS Queue 1]\n        SQS2[SQS Queue 2]\n        SQS3[SQS Queue 3]\n    end\n\n    subgraph EventHandlers\n        EH1[Projection Handler]\n        EH2[Notification Handler]\n        EH3[Integration Handler]\n    end\n\n    subgraph Outputs\n        RM[(Read Model)]\n        Email[Email Service]\n        ExtAPI[External API]\n    end\n\n    ES --\x3e SNS\n    SNS --\x3e SQS1\n    SNS --\x3e SQS2\n    SNS --\x3e SQS3\n\n    SQS1 --\x3e EH1\n    SQS2 --\x3e EH2\n    SQS3 --\x3e EH3\n\n    EH1 --\x3e RM\n    EH2 --\x3e Email\n    EH3 --\x3e ExtAPI"}),"\n",(0,i.jsx)(n.h2,{id:"event-handler-implementation",children:"Event Handler Implementation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { EventHandler, IEventHandler } from '@mbc-cqrs-serverless/core';\n\n@EventHandler(OrderCreatedEvent)\nexport class OrderCreatedHandler implements IEventHandler<OrderCreatedEvent> {\n  constructor(\n    private readonly notificationService: NotificationService,\n    private readonly readModelService: ReadModelService,\n  ) {}\n\n  async execute(event: OrderCreatedEvent): Promise<void> {\n    // Update read model\n    await this.readModelService.updateOrderSummary(event);\n\n    // Send notification\n    await this.notificationService.sendOrderConfirmation(event);\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"benefits-of-event-sourcing",children:"Benefits of Event Sourcing"}),"\n",(0,i.jsx)(n.p,{children:"Adopting Event Sourcing provides these benefits:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Complete Audit Trail"}),": All state changes are recorded as events"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Time Travel"}),": Reconstruct state at any point in time"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Event Replay"}),": Replay events to rebuild projections"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Debugging"}),": Trace exact sequence of operations"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Analytics"}),": Rich event data for business intelligence"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Integration"}),": Events can trigger external system updates"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.p,{children:"Best practices for effective Event Sourcing:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Immutable Events"}),": Never modify stored events"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Idempotent Handlers"}),": Handle duplicate event delivery gracefully"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Event Versioning"}),": Plan for event schema evolution"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Correlation IDs"}),": Track related events across services"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Dead Letter Queues"}),": Handle failed event processing"]}),"\n"]})]})}function v(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var r=t(6540);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);