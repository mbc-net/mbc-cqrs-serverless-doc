"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[584],{8244:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"backend-development","title":"Backend Development Guide","description":"Comprehensive guide for backend development with MBC CQRS Serverless framework. Learn module structure, service patterns, and best practices.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/backend-development.md","sourceDirName":".","slug":"/backend-development","permalink":"/docs/backend-development","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"sidebar_position":15,"description":"Comprehensive guide for backend development with MBC CQRS Serverless framework. Learn module structure, service patterns, and best practices."},"sidebar":"tutorialSidebar","previous":{"title":"Version Conflict Guide","permalink":"/docs/version-conflict-guide"},"next":{"title":"Building your application","permalink":"/docs/build-your-application"}}');var i=t(4848),a=t(8453);const o={sidebar_position:15,description:"Comprehensive guide for backend development with MBC CQRS Serverless framework. Learn module structure, service patterns, and best practices."},s="Backend Development Guide",d={},c=[{value:"Module Structure",id:"module-structure",level:2},{value:"Standard Module Layout",id:"standard-module-layout",level:3},{value:"Module Registration",id:"module-registration",level:3},{value:"Entity Design",id:"entity-design",level:2},{value:"Command Entity",id:"command-entity",level:3},{value:"Data Entity",id:"data-entity",level:3},{value:"Attributes DTO",id:"attributes-dto",level:3},{value:"Controller Pattern",id:"controller-pattern",level:2},{value:"Standard Controller",id:"standard-controller",level:3},{value:"Service Implementation",id:"service-implementation",level:2},{value:"Basic Service Pattern",id:"basic-service-pattern",level:3},{value:"Data Sync Handler",id:"data-sync-handler",level:2},{value:"RDS Sync Handler",id:"rds-sync-handler",level:3},{value:"Prisma Schema",id:"prisma-schema",level:2},{value:"Standard Model Definition",id:"standard-model-definition",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Source Tracking",id:"1-source-tracking",level:3},{value:"2. Batch Processing",id:"2-batch-processing",level:3},{value:"3. Error Handling",id:"3-error-handling",level:3},{value:"4. Data Consistency",id:"4-data-consistency",level:3},{value:"5. Pagination",id:"5-pagination",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"backend-development-guide",children:"Backend Development Guide"})}),"\n",(0,i.jsx)(n.p,{children:"This guide provides comprehensive patterns and best practices for building backend applications with MBC CQRS Serverless framework. Examples are generalized from production projects."}),"\n",(0,i.jsx)(n.h2,{id:"module-structure",children:"Module Structure"}),"\n",(0,i.jsx)(n.h3,{id:"standard-module-layout",children:"Standard Module Layout"}),"\n",(0,i.jsx)(n.p,{children:"Every domain module follows this consistent structure:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"src/[domain]/\n\u251c\u2500\u2500 dto/\n\u2502   \u251c\u2500\u2500 [domain]-command.dto.ts        # Command input validation\n\u2502   \u251c\u2500\u2500 [domain]-attributes.dto.ts     # Domain-specific attributes\n\u2502   \u2514\u2500\u2500 [domain]-search.dto.ts         # Search parameters\n\u251c\u2500\u2500 entity/\n\u2502   \u251c\u2500\u2500 [domain]-command.entity.ts     # Command entity\n\u2502   \u251c\u2500\u2500 [domain]-data.entity.ts        # Data entity\n\u2502   \u2514\u2500\u2500 [domain]-data-list.entity.ts   # List wrapper\n\u251c\u2500\u2500 handler/\n\u2502   \u2514\u2500\u2500 [domain]-rds.handler.ts        # RDS sync handler\n\u251c\u2500\u2500 [domain].service.ts                # Business logic\n\u251c\u2500\u2500 [domain].controller.ts             # HTTP handlers\n\u2514\u2500\u2500 [domain].module.ts                 # Module definition\n"})}),"\n",(0,i.jsx)(n.h3,{id:"module-registration",children:"Module Registration"}),"\n",(0,i.jsx)(n.p,{children:"Register your module with CommandModule to enable CQRS features:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// product.module.ts\nimport { Module } from '@nestjs/common';\nimport { CommandModule } from '@mbc-cqrs-serverless/core';\nimport { ProductService } from './product.service';\nimport { ProductController } from './product.controller';\nimport { ProductDataSyncRdsHandler } from './handler/product-rds.handler';\n\n@Module({\n  imports: [\n    CommandModule.register({\n      tableName: 'product',\n      dataSyncHandlers: [ProductDataSyncRdsHandler],\n    }),\n  ],\n  controllers: [ProductController],\n  providers: [ProductService],\n  exports: [ProductService],\n})\nexport class ProductModule {}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"entity-design",children:"Entity Design"}),"\n",(0,i.jsx)(n.h3,{id:"command-entity",children:"Command Entity"}),"\n",(0,i.jsx)(n.p,{children:"Command entities represent write operations and include version tracking:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// entity/product-command.entity.ts\nimport { CommandEntity } from '@mbc-cqrs-serverless/core';\nimport { ProductAttributes } from '../dto/product-attributes.dto';\n\nexport class ProductCommandEntity extends CommandEntity {\n  attributes: ProductAttributes;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"data-entity",children:"Data Entity"}),"\n",(0,i.jsx)(n.p,{children:"Data entities represent the read model after processing:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// entity/product-data.entity.ts\nimport { DataEntity } from '@mbc-cqrs-serverless/core';\nimport { ProductAttributes } from '../dto/product-attributes.dto';\n\nexport class ProductDataEntity extends DataEntity {\n  attributes: ProductAttributes;\n}\n\n// entity/product-data-list.entity.ts\nimport { DataListEntity } from '@mbc-cqrs-serverless/core';\nimport { ProductDataEntity } from './product-data.entity';\n\nexport class ProductDataListEntity extends DataListEntity<ProductDataEntity> {\n  items: ProductDataEntity[];\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"attributes-dto",children:"Attributes DTO"}),"\n",(0,i.jsx)(n.p,{children:"Define domain-specific attributes with validation:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// dto/product-attributes.dto.ts\nimport { IsString, IsNumber, IsOptional, ValidateNested, Type } from 'class-validator';\n\nexport class ProductAttributes {\n  @IsString()\n  @IsOptional()\n  category?: string;\n\n  @IsNumber()\n  @IsOptional()\n  price?: number;\n\n  @IsString()\n  @IsOptional()\n  description?: string;\n\n  @Type(() => ProductSpecification)\n  @ValidateNested()\n  @IsOptional()\n  specification?: ProductSpecification;\n}\n\nexport class ProductSpecification {\n  @IsString()\n  @IsOptional()\n  weight?: string;\n\n  @IsString()\n  @IsOptional()\n  dimensions?: string;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"controller-pattern",children:"Controller Pattern"}),"\n",(0,i.jsx)(n.h3,{id:"standard-controller",children:"Standard Controller"}),"\n",(0,i.jsx)(n.p,{children:"Controllers should be thin, delegating business logic to services:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// product.controller.ts\nimport {\n  Controller,\n  Get,\n  Post,\n  Put,\n  Body,\n  Param,\n  Query,\n} from '@nestjs/common';\nimport { INVOKE_CONTEXT, IInvoke, SearchDto } from '@mbc-cqrs-serverless/core';\nimport { ProductService } from './product.service';\nimport { ProductCommandDto } from './dto/product-command.dto';\nimport { ProductDataEntity, ProductDataListEntity } from './entity';\n\n@Controller('api/product')\nexport class ProductController {\n  constructor(private readonly productService: ProductService) {}\n\n  /**\n   * Create or update a product\n   */\n  @Post('/')\n  async publishCommand(\n    @INVOKE_CONTEXT() invokeContext: IInvoke,\n    @Body() cmdDto: ProductCommandDto,\n  ): Promise<ProductDataEntity> {\n    return this.productService.publishCommand(cmdDto, invokeContext);\n  }\n\n  /**\n   * Bulk create/update products\n   */\n  @Post('/bulk')\n  async publishBulkCommands(\n    @INVOKE_CONTEXT() invokeContext: IInvoke,\n    @Body() cmdDtos: ProductCommandDto[],\n  ): Promise<ProductDataEntity[]> {\n    return this.productService.publishBulkCommands(cmdDtos, invokeContext);\n  }\n\n  /**\n   * Get product by PK and SK\n   */\n  @Get('data/:pk/:sk')\n  async getData(\n    @Param('pk') pk: string,\n    @Param('sk') sk: string,\n  ): Promise<ProductDataEntity> {\n    return this.productService.getData(pk, sk);\n  }\n\n  /**\n   * List products by PK\n   */\n  @Get('data/:pk')\n  async listDataByPk(\n    @Param('pk') pk: string,\n    @Query() searchDto: SearchDto,\n  ): Promise<ProductDataListEntity> {\n    return this.productService.listDataByPk(pk, searchDto);\n  }\n\n  /**\n   * Search products\n   */\n  @Get('data')\n  async searchData(\n    @Query() searchDto: SearchDto,\n  ): Promise<ProductDataListEntity> {\n    return this.productService.searchData(searchDto);\n  }\n\n  /**\n   * Resync all data to RDS\n   */\n  @Put('resync-data/:pk')\n  async resyncData(@Param('pk') pk: string): Promise<void> {\n    return this.productService.resyncData(pk);\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"service-implementation",children:"Service Implementation"}),"\n",(0,i.jsx)(n.h3,{id:"basic-service-pattern",children:"Basic Service Pattern"}),"\n",(0,i.jsx)(n.p,{children:"Services contain business logic and orchestrate data operations. Here is a minimal example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// product.service.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  CommandService,\n  DataService,\n  IInvoke,\n  KEY_SEPARATOR,\n  generateId,\n  getUserContext,\n  VERSION_FIRST,\n} from '@mbc-cqrs-serverless/core';\nimport { ulid } from 'ulid';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { ProductCommandDto } from './dto/product-command.dto';\nimport { ProductDataEntity } from './entity';\n\nconst PRODUCT_PK_PREFIX = 'PRODUCT';\n\n@Injectable()\nexport class ProductService {\n  private readonly logger = new Logger(ProductService.name);\n\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n    private readonly prismaService: PrismaService,\n  ) {}\n\n  /**\n   * Create a new product\n   */\n  async create(\n    createDto: { name: string; description?: string },\n    opts: { invokeContext: IInvoke },\n  ): Promise<ProductDataEntity> {\n    const { tenantCode } = getUserContext(opts.invokeContext);\n\n    const pk = `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n    const sk = ulid();\n\n    const command = new ProductCommandDto({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode,\n      code: sk,\n      type: 'PRODUCT',\n      name: createDto.name,\n      version: VERSION_FIRST,\n      attributes: { description: createDto.description },\n    });\n\n    const item = await this.commandService.publishAsync(command, {\n      invokeContext: opts.invokeContext,\n    });\n\n    return new ProductDataEntity(item);\n  }\n\n  /**\n   * Get product by key\n   */\n  async findOne(pk: string, sk: string): Promise<ProductDataEntity> {\n    const item = await this.dataService.getItem({ pk, sk });\n    return new ProductDataEntity(item);\n  }\n}\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"For Complete Service Patterns",type:"tip",children:(0,i.jsxs)(n.p,{children:["For comprehensive CRUD operations, batch processing, optimistic locking, and more advanced patterns, see ",(0,i.jsx)(n.a,{href:"/docs/service-patterns",children:"Service Patterns"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"data-sync-handler",children:"Data Sync Handler"}),"\n",(0,i.jsx)(n.h3,{id:"rds-sync-handler",children:"RDS Sync Handler"}),"\n",(0,i.jsx)(n.p,{children:"Sync data from DynamoDB to RDS for complex queries:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// handler/product-rds.handler.ts\nimport { Injectable, Logger } from '@nestjs/common';\nimport {\n  IDataSyncHandler,\n  CommandModel,\n  removeSortKeyVersion,\n} from '@mbc-cqrs-serverless/core';\nimport { PrismaService } from '../../prisma/prisma.service';\nimport { ProductAttributes } from '../dto/product-attributes.dto';\n\n@Injectable()\nexport class ProductDataSyncRdsHandler implements IDataSyncHandler {\n  private readonly logger = new Logger(ProductDataSyncRdsHandler.name);\n\n  constructor(private readonly prismaService: PrismaService) {}\n\n  /**\n   * Sync command to RDS (upsert)\n   */\n  async up(cmd: CommandModel): Promise<any> {\n    // Remove version suffix from SK\n    const sk = removeSortKeyVersion(cmd.sk);\n    const attrs = cmd.attributes as ProductAttributes;\n\n    try {\n      await this.prismaService.product.upsert({\n        where: { id: cmd.id },\n        update: {\n          pk: cmd.pk,\n          sk: sk,\n          code: cmd.code,\n          name: cmd.name,\n          version: cmd.version,\n          tenantCode: cmd.tenantCode,\n          isDeleted: cmd.isDeleted ?? false,\n          // Map attributes to columns\n          category: attrs?.category,\n          price: attrs?.price,\n          description: attrs?.description,\n          specification: attrs?.specification,\n          // Audit fields\n          createdAt: cmd.createdAt,\n          createdBy: cmd.createdBy ?? '',\n          createdIp: cmd.createdIp ?? '',\n          updatedAt: cmd.updatedAt,\n          updatedBy: cmd.updatedBy ?? '',\n          updatedIp: cmd.updatedIp ?? '',\n        },\n        create: {\n          id: cmd.id,\n          cpk: cmd.pk,\n          csk: cmd.sk,\n          pk: cmd.pk,\n          sk: sk,\n          code: cmd.code,\n          name: cmd.name,\n          version: cmd.version,\n          tenantCode: cmd.tenantCode,\n          isDeleted: cmd.isDeleted ?? false,\n          category: attrs?.category,\n          price: attrs?.price,\n          description: attrs?.description,\n          specification: attrs?.specification,\n          createdAt: cmd.createdAt,\n          createdBy: cmd.createdBy ?? '',\n          createdIp: cmd.createdIp ?? '',\n          updatedAt: cmd.updatedAt,\n          updatedBy: cmd.updatedBy ?? '',\n          updatedIp: cmd.updatedIp ?? '',\n        },\n      });\n\n      this.logger.debug(`Synced product ${cmd.id} to RDS`);\n    } catch (error) {\n      this.logger.error(`Failed to sync product ${cmd.id}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Handle rollback or delete\n   */\n  async down(cmd: CommandModel): Promise<any> {\n    // Soft delete implementation\n    await this.prismaService.product.update({\n      where: { id: cmd.id },\n      data: { isDeleted: true },\n    });\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"prisma-schema",children:"Prisma Schema"}),"\n",(0,i.jsx)(n.h3,{id:"standard-model-definition",children:"Standard Model Definition"}),"\n",(0,i.jsx)(n.p,{children:"Define your Prisma model with CQRS fields:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-prisma",children:'// prisma/schema.prisma\nmodel Product {\n  // CQRS composite keys\n  id     String @id            // PK#SK without version\n  cpk    String                // Command PK\n  csk    String                // Command SK with version\n  pk     String                // Data PK\n  sk     String                // Data SK without version\n\n  // Domain fields\n  code   String\n  name   String\n\n  // Domain-specific\n  category     String?\n  price        Decimal?\n  description  String?\n  specification Json?\n\n  // Multi-tenant\n  tenantCode String\n\n  // Audit fields\n  version   Int\n  isDeleted Boolean  @default(false)\n  createdBy String   @default("")\n  createdIp String   @default("")\n  createdAt DateTime\n  updatedBy String   @default("")\n  updatedIp String   @default("")\n  updatedAt DateTime\n\n  // Indexes\n  @@unique([cpk, csk])\n  @@unique([pk, sk])\n  @@unique([tenantCode, code])\n  @@index([tenantCode, name])\n  @@index([category])\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-source-tracking",children:"1. Source Tracking"}),"\n",(0,i.jsx)(n.p,{children:"Always track the source of operations for debugging:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const opts = {\n  source: getCommandSource(\n    basename(__dirname),      // Module name\n    this.constructor.name,    // Class name\n    'methodName',             // Method name\n  ),\n  invokeContext,\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-batch-processing",children:"2. Batch Processing"}),"\n",(0,i.jsxs)(n.p,{children:["Process large datasets in batches to avoid timeouts. See ",(0,i.jsx)(n.a,{href:"/docs/service-patterns#batch-operations",children:"Service Patterns - Batch Operations"})," for detailed examples."]}),"\n",(0,i.jsx)(n.h3,{id:"3-error-handling",children:"3. Error Handling"}),"\n",(0,i.jsx)(n.p,{children:"Implement proper error handling with logging:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"try {\n  await this.processItem(item);\n} catch (error) {\n  this.logger.error(`Failed to process item ${item.id}:`, error);\n\n  // Send alarm for critical errors\n  if (this.isCriticalError(error)) {\n    await this.snsService.publish({\n      topicArn: this.alarmTopicArn,\n      subject: 'Processing Error',\n      message: JSON.stringify({ item, error: error.message }),\n    });\n  }\n\n  throw error;\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-data-consistency",children:"4. Data Consistency"}),"\n",(0,i.jsx)(n.p,{children:"Use dirty checking to avoid unnecessary syncs:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { isNotCommandDirty } from '@mbc-cqrs-serverless/core';\n\nasync syncData(newData: any, existingData: any): Promise<void> {\n  if (isNotCommandDirty(existingData, newData)) {\n    this.logger.debug('Data unchanged, skipping sync');\n    return;\n  }\n\n  await this.performSync(newData);\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"5-pagination",children:"5. Pagination"}),"\n",(0,i.jsx)(n.p,{children:"Always support pagination for list operations:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"async searchWithPagination(\n  searchDto: SearchDto,\n): Promise<DataListEntity> {\n  const { page = 1, pageSize = 20 } = searchDto;\n\n  const [total, items] = await Promise.all([\n    this.prismaService.entity.count({ where }),\n    this.prismaService.entity.findMany({\n      where,\n      take: pageSize,\n      skip: pageSize * (page - 1),\n      orderBy: [{ createdAt: 'desc' }],\n    }),\n  ]);\n\n  return new DataListEntity({ total, items });\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/service-patterns",children:"Service Patterns"})," - Advanced service implementation patterns"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/data-sync-handler-examples",children:"Data Sync Handler Examples"})," - Comprehensive sync handler examples"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/key-patterns",children:"Key Patterns"})," - PK/SK design patterns"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/multi-tenant-patterns",children:"Multi-Tenant Patterns"})," - Multi-tenant implementation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/import-export-patterns",children:"Import/Export Patterns"})," - Batch data processing"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var r=t(6540);const i={},a=r.createContext(i);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);