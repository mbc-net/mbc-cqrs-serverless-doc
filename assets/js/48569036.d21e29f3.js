"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[2674],{8663:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"deployment-guide","title":"Deployment Guide","description":"Learn how to deploy your MBC CQRS Serverless application to AWS.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/deployment-guide.md","sourceDirName":".","slug":"/deployment-guide","permalink":"/docs/deployment-guide","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"Learn how to deploy your MBC CQRS Serverless application to AWS."},"sidebar":"tutorialSidebar","previous":{"title":"Authentication","permalink":"/docs/authentication"},"next":{"title":"CI/CD with CodePipeline","permalink":"/docs/codepipeline-cicd"}}');var r=i(4848),t=i(8453);const l={description:"Learn how to deploy your MBC CQRS Serverless application to AWS."},o="Deployment Guide",a={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"AWS Account Preparation",id:"aws-account-preparation",level:2},{value:"Required AWS Services",id:"required-aws-services",level:3},{value:"IAM Permissions",id:"iam-permissions",level:3},{value:"CDK Bootstrap",id:"cdk-bootstrap",level:2},{value:"Environment Configuration",id:"environment-configuration",level:2},{value:"Create Environment Config",id:"create-environment-config",level:3},{value:"Environment Variables",id:"environment-variables",level:3},{value:"CDK Stack Structure",id:"cdk-stack-structure",level:2},{value:"Known Issues and Workarounds",id:"known-issues-and-workarounds",level:2},{value:"npm install Errors with Legacy Dependencies",id:"npm-install-errors-with-legacy-dependencies",level:3},{value:"CDK Environment Configuration",id:"cdk-environment-configuration",level:3},{value:"Deploying with CDK",id:"deploying-with-cdk",level:2},{value:"Configure Target Environments",id:"configure-target-environments",level:3},{value:"Synthesize CloudFormation Template",id:"synthesize-cloudformation-template",level:3},{value:"Deploy Stacks",id:"deploy-stacks",level:3},{value:"Deploy with Approval",id:"deploy-with-approval",level:3},{value:"Post-Deployment Verification",id:"post-deployment-verification",level:2},{value:"Check Stack Status",id:"check-stack-status",level:3},{value:"Verify API Gateway",id:"verify-api-gateway",level:3},{value:"Test the Health Endpoint",id:"test-the-health-endpoint",level:3},{value:"Multi-Environment Strategy",id:"multi-environment-strategy",level:2},{value:"Environment Isolation",id:"environment-isolation",level:3},{value:"Resource Naming Convention",id:"resource-naming-convention",level:3},{value:"Rollback",id:"rollback",level:2},{value:"Automatic Rollback",id:"automatic-rollback",level:3},{value:"Deploy Previous Version",id:"deploy-previous-version",level:3},{value:"Cleanup",id:"cleanup",level:2},{value:"Destroy Stack",id:"destroy-stack",level:3},{value:"Selective Cleanup",id:"selective-cleanup",level:3},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"deployment-guide",children:"Deployment Guide"})}),"\n",(0,r.jsx)(n.p,{children:"This guide covers deploying your MBC CQRS Serverless application to AWS using AWS CDK."}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(n.p,{children:"Before deploying, ensure you have:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"AWS CLI installed and configured with appropriate credentials"}),"\n",(0,r.jsx)(n.li,{children:"Node.js 18.x or later"}),"\n",(0,r.jsxs)(n.li,{children:["AWS CDK CLI installed (",(0,r.jsx)(n.code,{children:"npm install -g aws-cdk"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"An AWS account with necessary permissions"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"aws-account-preparation",children:"AWS Account Preparation"}),"\n",(0,r.jsx)(n.h3,{id:"required-aws-services",children:"Required AWS Services"}),"\n",(0,r.jsx)(n.p,{children:"Your application will use the following AWS services:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"API Gateway - HTTP API endpoints"}),"\n",(0,r.jsx)(n.li,{children:"Lambda - Serverless compute"}),"\n",(0,r.jsx)(n.li,{children:"DynamoDB - NoSQL database"}),"\n",(0,r.jsx)(n.li,{children:"RDS (PostgreSQL) - Relational database (optional)"}),"\n",(0,r.jsx)(n.li,{children:"Cognito - User authentication"}),"\n",(0,r.jsx)(n.li,{children:"S3 - File storage"}),"\n",(0,r.jsx)(n.li,{children:"SQS/SNS - Message queuing"}),"\n",(0,r.jsx)(n.li,{children:"Step Functions - Workflow orchestration"}),"\n",(0,r.jsx)(n.li,{children:"CloudWatch - Logging and monitoring"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"iam-permissions",children:"IAM Permissions"}),"\n",(0,r.jsx)(n.p,{children:"The deploying user/role needs permissions for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"CloudFormation (full access)"}),"\n",(0,r.jsx)(n.li,{children:"Lambda, API Gateway, DynamoDB, S3, SQS, SNS, Step Functions"}),"\n",(0,r.jsx)(n.li,{children:"IAM (for creating roles)"}),"\n",(0,r.jsx)(n.li,{children:"CloudWatch Logs"}),"\n",(0,r.jsx)(n.li,{children:"VPC (if using RDS)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"cdk-bootstrap",children:"CDK Bootstrap"}),"\n",(0,r.jsx)(n.p,{children:"Before your first deployment, bootstrap CDK in your AWS account:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk bootstrap aws://YOUR_ACCOUNT_ID/YOUR_REGION\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk bootstrap aws://123456789012/ap-northeast-1\n"})}),"\n",(0,r.jsx)(n.h2,{id:"environment-configuration",children:"Environment Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"create-environment-config",children:"Create Environment Config"}),"\n",(0,r.jsxs)(n.p,{children:["Create environment-specific configuration files in ",(0,r.jsx)(n.code,{children:"infra/config/{env}/index.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// infra/config/dev/index.ts\nimport { ApplicationLogLevel, SystemLogLevel } from 'aws-cdk-lib/aws-lambda';\nimport { Config } from '../type';\n\nconst config: Config = {\n  env: 'dev',\n  appName: 'your-app',\n\n  // Domain configuration\n  domain: {\n    http: 'dev-api.your-domain.com',\n    appsync: 'dev-appsync.your-domain.com',\n  },\n\n  // Existing Cognito User Pool (optional)\n  userPoolId: 'ap-northeast-1_xxxxxxx',\n\n  // VPC Configuration\n  vpc: {\n    id: 'vpc-xxxxxxxxx',\n    subnetIds: ['subnet-xxx1', 'subnet-xxx2'],\n    securityGroupIds: ['sg-xxxxxxxxx'],\n  },\n\n  // RDS Configuration\n  rds: {\n    accountSsmKey: '/your-app/dev/rds/account',\n    endpoint: 'your-rds-endpoint.ap-northeast-1.rds.amazonaws.com',\n    dbName: 'your_app_dev',\n  },\n\n  // Log Level Configuration\n  logLevel: {\n    lambdaSystem: SystemLogLevel.DEBUG,\n    lambdaApplication: ApplicationLogLevel.TRACE,\n    level: 'verbose',\n  },\n\n  frontBaseUrl: 'https://dev.your-domain.com',\n  fromEmailAddress: 'noreply@your-domain.com',\n\n  // WAF Configuration (optional)\n  // wafArn: 'arn:aws:wafv2:ap-northeast-1:YOUR_ACCOUNT:regional/webacl/xxx',\n};\n\nexport default config;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,r.jsxs)(n.p,{children:["Set up environment variables in ",(0,r.jsx)(n.code,{children:".env"})," or through your CI/CD pipeline:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# AWS Configuration\nAWS_REGION=ap-northeast-1\nAWS_ACCOUNT_ID=123456789012\n\n# Application Configuration\nAPP_NAME=your-app\nENVIRONMENT=dev\n\n# Database\nDATABASE_URL=postgresql://user:password@host:5432/dbname\n\n# Cognito\nCOGNITO_USER_POOL_ID=ap-northeast-1_xxxxxxx\nCOGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxx\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cdk-stack-structure",children:"CDK Stack Structure"}),"\n",(0,r.jsx)(n.p,{children:"A typical MBC CQRS Serverless CDK project has the following structure:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"infra/\n\u251c\u2500\u2500 bin/\n\u2502   \u2514\u2500\u2500 infra.ts              # CDK app entry point\n\u251c\u2500\u2500 cdk.json                  # CDK configuration\n\u251c\u2500\u2500 config/\n\u2502   \u251c\u2500\u2500 index.ts              # Config exports and getConfig function\n\u2502   \u251c\u2500\u2500 type.ts               # Config type definitions\n\u2502   \u251c\u2500\u2500 constant.ts           # Constants (e.g., PIPELINE_NAME)\n\u2502   \u251c\u2500\u2500 dev/\n\u2502   \u2502   \u2514\u2500\u2500 index.ts          # Development config\n\u2502   \u251c\u2500\u2500 stg/\n\u2502   \u2502   \u2514\u2500\u2500 index.ts          # Staging config\n\u2502   \u2514\u2500\u2500 prod/\n\u2502       \u2514\u2500\u2500 index.ts          # Production config\n\u2514\u2500\u2500 libs/\n    \u251c\u2500\u2500 infra-stack.ts        # Main infrastructure stack\n    \u251c\u2500\u2500 pipeline-stack.ts     # CI/CD pipeline stack\n    \u2514\u2500\u2500 pipeline-infra-stage.ts # Pipeline infrastructure stage\n"})}),"\n",(0,r.jsx)(n.h2,{id:"known-issues-and-workarounds",children:"Known Issues and Workarounds"}),"\n",(0,r.jsx)(n.h3,{id:"npm-install-errors-with-legacy-dependencies",children:"npm install Errors with Legacy Dependencies"}),"\n",(0,r.jsxs)(n.p,{children:["Some serverless-offline plugins have legacy dependencies that may cause build errors during ",(0,r.jsx)(n.code,{children:"npm install"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"npm error path node_modules/zlib\nnpm error command sh -c node-waf clean || true; node-waf configure build\nnpm error sh: node-waf: command not found\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Workaround: Use the ",(0,r.jsx)(n.code,{children:"--ignore-scripts"})," and ",(0,r.jsx)(n.code,{children:"--legacy-peer-deps"})," flags:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install --legacy-peer-deps --ignore-scripts\nnpx prisma generate  # Run postinstall script manually\n"})}),"\n",(0,r.jsx)(n.h3,{id:"cdk-environment-configuration",children:"CDK Environment Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["The default ",(0,r.jsx)(n.code,{children:"infra/bin/infra.ts"})," template may have empty account/region values, causing errors like:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Invalid S3 bucket name (value: cdk-hnb659fds-assets--)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Ensure your ",(0,r.jsx)(n.code,{children:"infra/bin/infra.ts"})," uses environment variables:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const cdkEnv: cdk.Environment = {\n  account: process.env.CDK_DEFAULT_ACCOUNT,\n  region: process.env.CDK_DEFAULT_REGION || 'ap-northeast-1',\n};\n"})}),"\n",(0,r.jsx)(n.p,{children:"When running CDK commands, the AWS profile automatically provides these values:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"AWS_PROFILE=your-profile cdk synth\n"})}),"\n",(0,r.jsx)(n.h2,{id:"deploying-with-cdk",children:"Deploying with CDK"}),"\n",(0,r.jsx)(n.h3,{id:"configure-target-environments",children:"Configure Target Environments"}),"\n",(0,r.jsxs)(n.p,{children:["The environments to deploy are configured in ",(0,r.jsx)(n.code,{children:"infra/bin/infra.ts"})," by modifying the ",(0,r.jsx)(n.code,{children:"envs"})," array:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// infra/bin/infra.ts\nconst envs: Env[] = ['dev'];  // Add 'stg' or 'prod' as needed\n"})}),"\n",(0,r.jsx)(n.p,{children:"To deploy multiple environments, add them to the array:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const envs: Env[] = ['dev', 'stg', 'prod'];\n"})}),"\n",(0,r.jsx)(n.h3,{id:"synthesize-cloudformation-template",children:"Synthesize CloudFormation Template"}),"\n",(0,r.jsx)(n.p,{children:"First, synthesize the CloudFormation template to verify your configuration:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd infra\ncdk synth\n"})}),"\n",(0,r.jsx)(n.h3,{id:"deploy-stacks",children:"Deploy Stacks"}),"\n",(0,r.jsx)(n.p,{children:"Deploy all configured environment stacks:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk deploy --all\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or deploy a specific environment stack:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk deploy dev-your-app-pipeline-stack\n"})}),"\n",(0,r.jsx)(n.h3,{id:"deploy-with-approval",children:"Deploy with Approval"}),"\n",(0,r.jsx)(n.p,{children:"For deployments that require approval:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk deploy --all --require-approval broadening\n"})}),"\n",(0,r.jsx)(n.h2,{id:"post-deployment-verification",children:"Post-Deployment Verification"}),"\n",(0,r.jsx)(n.h3,{id:"check-stack-status",children:"Check Stack Status"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"aws cloudformation describe-stacks --stack-name YourStackName-dev\n"})}),"\n",(0,r.jsx)(n.h3,{id:"verify-api-gateway",children:"Verify API Gateway"}),"\n",(0,r.jsx)(n.p,{children:"Get the API endpoint from the CloudFormation outputs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"aws cloudformation describe-stacks \\\n  --stack-name YourStackName-dev \\\n  --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \\\n  --output text\n"})}),"\n",(0,r.jsx)(n.h3,{id:"test-the-health-endpoint",children:"Test the Health Endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl https://your-api-endpoint.execute-api.ap-northeast-1.amazonaws.com/health\n"})}),"\n",(0,r.jsx)(n.h2,{id:"multi-environment-strategy",children:"Multi-Environment Strategy"}),"\n",(0,r.jsx)(n.h3,{id:"environment-isolation",children:"Environment Isolation"}),"\n",(0,r.jsx)(n.p,{children:"Best practices for managing multiple environments:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Aspect"}),(0,r.jsx)(n.th,{children:"Development"}),(0,r.jsx)(n.th,{children:"Staging"}),(0,r.jsx)(n.th,{children:"Production"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"AWS Account"}),(0,r.jsx)(n.td,{children:"Shared or dedicated"}),(0,r.jsx)(n.td,{children:"Dedicated"}),(0,r.jsx)(n.td,{children:"Dedicated"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"VPC"}),(0,r.jsx)(n.td,{children:"Shared"}),(0,r.jsx)(n.td,{children:"Dedicated"}),(0,r.jsx)(n.td,{children:"Dedicated"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Database"}),(0,r.jsx)(n.td,{children:"Shared RDS"}),(0,r.jsx)(n.td,{children:"Dedicated RDS"}),(0,r.jsx)(n.td,{children:"Multi-AZ RDS"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Log Level"}),(0,r.jsx)(n.td,{children:"verbose/debug"}),(0,r.jsx)(n.td,{children:"info"}),(0,r.jsx)(n.td,{children:"warn/error"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"resource-naming-convention",children:"Resource Naming Convention"}),"\n",(0,r.jsx)(n.p,{children:"Use consistent naming for resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{app-name}-{environment}-{resource-type}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"myapp-dev-api"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"myapp-dev-dynamodb-command"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"myapp-prod-lambda-handler"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"rollback",children:"Rollback"}),"\n",(0,r.jsx)(n.h3,{id:"automatic-rollback",children:"Automatic Rollback"}),"\n",(0,r.jsx)(n.p,{children:"CloudFormation automatically rolls back if deployment fails. To manually rollback:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"aws cloudformation rollback-stack --stack-name YourStackName-dev\n"})}),"\n",(0,r.jsx)(n.h3,{id:"deploy-previous-version",children:"Deploy Previous Version"}),"\n",(0,r.jsx)(n.p,{children:"To deploy a previous version, use Git to checkout the desired commit and redeploy:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"git checkout <previous-commit>\ncdk deploy --all\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,r.jsx)(n.h3,{id:"destroy-stack",children:"Destroy Stack"}),"\n",(0,r.jsx)(n.p,{children:"To remove all resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk destroy --all\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or destroy a specific environment stack:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cdk destroy dev-your-app-pipeline-stack\n"})}),"\n",(0,r.jsx)(n.p,{children:"Note: This will delete all resources including data. Use with caution."}),"\n",(0,r.jsx)(n.h3,{id:"selective-cleanup",children:"Selective Cleanup"}),"\n",(0,r.jsx)(n.p,{children:"Some resources may have deletion protection. Disable before destroying:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DynamoDB tables with deletion protection"}),"\n",(0,r.jsx)(n.li,{children:"RDS instances with deletion protection"}),"\n",(0,r.jsx)(n.li,{children:"S3 buckets (must be emptied first)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./codepipeline-cicd",children:"CI/CD with CodePipeline"})," - Automate your deployments"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./monitoring-logging",children:"Monitoring and Logging"})," - Set up observability"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"./common-issues",children:"Troubleshooting"})," - Common deployment issues"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>o});var s=i(6540);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);