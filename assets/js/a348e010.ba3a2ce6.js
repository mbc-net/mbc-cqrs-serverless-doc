"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[6831],{9449:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"import","title":"Import","description":"Learn how to use ImportModule for bulk data import with CSV and ZIP file support in MBC CQRS Serverless.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/import.md","sourceDirName":".","slug":"/import","permalink":"/docs/import","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"Learn how to use ImportModule for bulk data import with CSV and ZIP file support in MBC CQRS Serverless."},"sidebar":"tutorialSidebar","previous":{"title":"Directory","permalink":"/docs/directory"},"next":{"title":"Notification","permalink":"/docs/notification-module"}}');var i=n(4848),s=n(8453);const o={description:"Learn how to use ImportModule for bulk data import with CSV and ZIP file support in MBC CQRS Serverless."},d="Import",c={},l=[{value:"Architecture",id:"architecture",level:2},{value:"Installation",id:"installation",level:2},{value:"Module Registration",id:"module-registration",level:2},{value:"Module Options",id:"module-options",level:2},{value:"Core Concepts",id:"core-concepts",level:2},{value:"Import Entity Profile",id:"import-entity-profile",level:3},{value:"Processing Modes",id:"processing-modes",level:3},{value:"Import Status",id:"import-status",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"ImportService Methods",id:"importservice-methods",level:3},{value:"<code>createWithApi(dto: CreateImportDto, options): Promise&lt;ImportEntity&gt;</code>",id:"createwithapidto-createimportdto-options-promiseimportentity",level:4},{value:"<code>handleCsvImport(dto: CreateCsvImportDto, options): Promise&lt;ImportEntity[] | ImportEntity&gt;</code>",id:"handlecsvimportdto-createcsvimportdto-options-promiseimportentity--importentity",level:4},{value:"<code>createZipJob(dto: CreateZipImportDto, options): Promise&lt;ImportEntity&gt;</code>",id:"createzipjobdto-createzipimportdto-options-promiseimportentity",level:4},{value:"<code>updateStatus(key: DetailKey, status: string, payload?, attributes?, notifyId?): Promise&lt;void&gt;</code>",id:"updatestatuskey-detailkey-status-string-payload-attributes-notifyid-promisevoid",level:4},{value:"<code>getImportByKey(key: DetailKey): Promise&lt;ImportEntity&gt;</code>",id:"getimportbykeykey-detailkey-promiseimportentity",level:4},{value:"REST API Endpoints",id:"rest-api-endpoints",level:2},{value:"<code>POST /imports</code>",id:"post-imports",level:3},{value:"<code>POST /imports/csv</code>",id:"post-importscsv",level:3},{value:"<code>POST /imports/zip</code>",id:"post-importszip",level:3},{value:"Implementing Import Strategies",id:"implementing-import-strategies",level:2},{value:"IImportStrategy Interface",id:"iimportstrategy-interface",level:3},{value:"Using BaseImportStrategy",id:"using-baseimportstrategy",level:3},{value:"IProcessStrategy Interface",id:"iprocessstrategy-interface",level:3},{value:"Comparison Status",id:"comparison-status",level:3},{value:"Example ProcessStrategy",id:"example-processstrategy",level:3},{value:"ZIP Finalization Hooks",id:"zip-finalization-hooks",level:2},{value:"ZipFinalizationContext",id:"zipfinalizationcontext",level:3},{value:"DTOs",id:"dtos",level:2},{value:"CreateImportDto",id:"createimportdto",level:3},{value:"CreateCsvImportDto",id:"createcsvimportdto",level:3},{value:"CreateZipImportDto",id:"createzipimportdto",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"CSV File Format",id:"csv-file-format",level:3},{value:"Large File Imports",id:"large-file-imports",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"See Also",id:"see-also",level:2}];function a(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"import",children:"Import"})}),"\n",(0,i.jsx)(t.p,{children:"The ImportModule provides bulk data import capabilities in the MBC CQRS Serverless framework. It supports single record imports, CSV file imports, and ZIP file imports with multiple CSVs."}),"\n",(0,i.jsx)(t.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(t.mermaid,{value:'graph TB\n    subgraph "Import Flow"\n        A["ImportController"] --\x3e B["ImportService"]\n        B --\x3e C["ImportStrategy"]\n        C --\x3e D["ProcessStrategy"]\n        D --\x3e E["CommandService"]\n    end\n\n    subgraph "Processing Modes"\n        F["DIRECT"] --\x3e G["Immediate Processing"]\n        H["STEP_FUNCTION"] --\x3e I["Async via SFN"]\n    end\n\n    subgraph "Storage"\n        J["S3 (CSV/ZIP)"]\n        K["DynamoDB (Import Jobs)"]\n    end'}),"\n",(0,i.jsx)(t.h2,{id:"installation",children:"Installation"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"npm install @mbc-cqrs-serverless/import\n"})}),"\n",(0,i.jsx)(t.h2,{id:"module-registration",children:"Module Registration"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'import { ImportModule } from "@mbc-cqrs-serverless/import";\n\n@Module({\n  imports: [\n    ImportModule.register({\n      enableController: true, // Enable built-in REST controller\n      profiles: [\n        {\n          tableName: "products",\n          importStrategy: ProductImportStrategy,\n          processStrategy: ProductProcessStrategy,\n        },\n      ],\n      imports: [ProductModule], // Modules exporting strategy dependencies\n      zipFinalizationHooks: [BackupToS3Hook], // Optional: Post-import hooks\n    }),\n  ],\n})\nexport class AppModule {}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"module-options",children:"Module Options"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Option"}),(0,i.jsx)(t.th,{children:"Type"}),(0,i.jsx)(t.th,{children:"Required"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"profiles"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"ImportEntityProfile[]"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Array of import configurations for each entity type"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"enableController"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"boolean"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Enable the built-in ImportController endpoints"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"imports"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"ModuleMetadata['imports']"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Modules that export providers needed by strategy classes"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"zipFinalizationHooks"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"Type<IZipFinalizationHook>[]"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Hooks that execute after ZIP import completes"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,i.jsx)(t.h3,{id:"import-entity-profile",children:"Import Entity Profile"}),"\n",(0,i.jsx)(t.p,{children:"Each entity type you want to import requires a profile configuration:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"interface ImportEntityProfile {\n  tableName: string; // Unique identifier for this data type\n  importStrategy: Type<IImportStrategy<any, any>>; // Transform and validate\n  processStrategy: Type<IProcessStrategy<any, any>>; // Compare and map\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"processing-modes",children:"Processing Modes"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Mode"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{children:"Use Case"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"DIRECT"})}),(0,i.jsx)(t.td,{children:"Process CSV immediately in the request"}),(0,i.jsx)(t.td,{children:"Small files (< 100 rows)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"STEP_FUNCTION"})}),(0,i.jsx)(t.td,{children:"Process asynchronously via AWS Step Functions"}),(0,i.jsx)(t.td,{children:"Large files, production imports"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"import-status",children:"Import Status"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Status"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"CREATED"})}),(0,i.jsx)(t.td,{children:"Import job created, waiting to be processed"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"QUEUED"})}),(0,i.jsx)(t.td,{children:"Job queued for processing"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"PROCESSING"})}),(0,i.jsx)(t.td,{children:"Currently being processed"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"COMPLETED"})}),(0,i.jsx)(t.td,{children:"Successfully completed"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"FAILED"})}),(0,i.jsx)(t.td,{children:"Processing failed"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,i.jsx)(t.h3,{id:"importservice-methods",children:"ImportService Methods"}),"\n",(0,i.jsx)(t.h4,{id:"createwithapidto-createimportdto-options-promiseimportentity",children:(0,i.jsx)(t.code,{children:"createWithApi(dto: CreateImportDto, options): Promise<ImportEntity>"})}),"\n",(0,i.jsx)(t.p,{children:"Creates a single import record using the API. The data is transformed and validated using the configured ImportStrategy."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'const importEntity = await this.importService.createWithApi(\n  {\n    tableName: "products",\n    tenantCode: "tenant001",\n    attributes: {\n      code: "PROD001",\n      name: "Product One",\n      price: 100,\n    },\n  },\n  { invokeContext }\n);\n'})}),"\n",(0,i.jsx)(t.h4,{id:"handlecsvimportdto-createcsvimportdto-options-promiseimportentity--importentity",children:(0,i.jsx)(t.code,{children:"handleCsvImport(dto: CreateCsvImportDto, options): Promise<ImportEntity[] | ImportEntity>"})}),"\n",(0,i.jsx)(t.p,{children:"Main router for CSV imports. Delegates to either direct processing or Step Function based on processingMode."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'// DIRECT mode - returns array of created imports\nconst imports = await this.importService.handleCsvImport(\n  {\n    processingMode: "DIRECT",\n    bucket: "my-bucket",\n    key: "imports/products.csv",\n    tableName: "products",\n    tenantCode: "tenant001",\n  },\n  { invokeContext }\n);\n\n// STEP_FUNCTION mode - returns master job entity\nconst masterJob = await this.importService.handleCsvImport(\n  {\n    processingMode: "STEP_FUNCTION",\n    bucket: "my-bucket",\n    key: "imports/products.csv",\n    tableName: "products",\n    tenantCode: "tenant001",\n  },\n  { invokeContext }\n);\n'})}),"\n",(0,i.jsx)(t.h4,{id:"createzipjobdto-createzipimportdto-options-promiseimportentity",children:(0,i.jsx)(t.code,{children:"createZipJob(dto: CreateZipImportDto, options): Promise<ImportEntity>"})}),"\n",(0,i.jsx)(t.p,{children:"Creates a master job for ZIP file import. The ZIP file should contain multiple CSV files."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'const zipJob = await this.importService.createZipJob(\n  {\n    bucket: "my-bucket",\n    key: "imports/bulk-data.zip",\n    tenantCode: "tenant001",\n    sortedFileKeys: ["products.csv", "categories.csv"], // Optional: specify processing order\n    tableName: "products", // Optional: override tableName detection\n  },\n  { invokeContext }\n);\n'})}),"\n",(0,i.jsx)(t.h4,{id:"updatestatuskey-detailkey-status-string-payload-attributes-notifyid-promisevoid",children:(0,i.jsx)(t.code,{children:"updateStatus(key: DetailKey, status: string, payload?, attributes?, notifyId?): Promise<void>"})}),"\n",(0,i.jsx)(t.p,{children:"Updates the status of an import job and sends a notification via SNS."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'await this.importService.updateStatus(\n  { pk: "IMPORT#tenant001", sk: "products#01ABC" },\n  "COMPLETED",\n  { result: { recordsProcessed: 100 } }\n);\n'})}),"\n",(0,i.jsx)(t.h4,{id:"getimportbykeykey-detailkey-promiseimportentity",children:(0,i.jsx)(t.code,{children:"getImportByKey(key: DetailKey): Promise<ImportEntity>"})}),"\n",(0,i.jsx)(t.p,{children:"Retrieves an import entity by its key."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'const importJob = await this.importService.getImportByKey({\n  pk: "IMPORT#tenant001",\n  sk: "products#01ABC",\n});\n'})}),"\n",(0,i.jsx)(t.h2,{id:"rest-api-endpoints",children:"REST API Endpoints"}),"\n",(0,i.jsxs)(t.p,{children:["When ",(0,i.jsx)(t.code,{children:"enableController: true"}),", the following endpoints are available:"]}),"\n",(0,i.jsx)(t.h3,{id:"post-imports",children:(0,i.jsx)(t.code,{children:"POST /imports"})}),"\n",(0,i.jsx)(t.p,{children:"Create a single import record."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "tableName": "products",\n  "tenantCode": "tenant001",\n  "attributes": {\n    "code": "PROD001",\n    "name": "Product One"\n  }\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Response"}),": ",(0,i.jsx)(t.code,{children:"202 Accepted"})]}),"\n",(0,i.jsx)(t.h3,{id:"post-importscsv",children:(0,i.jsx)(t.code,{children:"POST /imports/csv"})}),"\n",(0,i.jsx)(t.p,{children:"Initiate a CSV file import."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "processingMode": "STEP_FUNCTION",\n  "bucket": "my-bucket",\n  "key": "imports/products.csv",\n  "tableName": "products",\n  "tenantCode": "tenant001"\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Response"}),": ",(0,i.jsx)(t.code,{children:"200 OK"})," (DIRECT) / ",(0,i.jsx)(t.code,{children:"202 Accepted"})," (STEP_FUNCTION)"]}),"\n",(0,i.jsx)(t.h3,{id:"post-importszip",children:(0,i.jsx)(t.code,{children:"POST /imports/zip"})}),"\n",(0,i.jsx)(t.p,{children:"Initiate a ZIP file import."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "bucket": "my-bucket",\n  "key": "imports/bulk-data.zip",\n  "tenantCode": "tenant001"\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Response"}),": ",(0,i.jsx)(t.code,{children:"202 Accepted"})]}),"\n",(0,i.jsx)(t.h2,{id:"implementing-import-strategies",children:"Implementing Import Strategies"}),"\n",(0,i.jsx)(t.h3,{id:"iimportstrategy-interface",children:"IImportStrategy Interface"}),"\n",(0,i.jsx)(t.p,{children:"The ImportStrategy handles data transformation and validation:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"interface IImportStrategy<TInput, TAttributesDto> {\n  transform(input: TInput): Promise<TAttributesDto>;\n  validate(data: TAttributesDto): Promise<void>;\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"using-baseimportstrategy",children:"Using BaseImportStrategy"}),"\n",(0,i.jsx)(t.p,{children:"Extend the base class for common functionality:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'import { BaseImportStrategy } from "@mbc-cqrs-serverless/import";\nimport { Injectable } from "@nestjs/common";\n\n@Injectable()\nexport class ProductImportStrategy extends BaseImportStrategy<\n  CsvProductRow,\n  ProductAttributesDto\n> {\n  async transform(input: CsvProductRow): Promise<ProductAttributesDto> {\n    return {\n      code: input.product_code?.trim(),\n      name: input.product_name?.trim(),\n      price: parseFloat(input.price),\n      category: input.category?.trim(),\n    };\n  }\n\n  // validate() is inherited - uses class-validator\n}\n'})}),"\n",(0,i.jsx)(t.h3,{id:"iprocessstrategy-interface",children:"IProcessStrategy Interface"}),"\n",(0,i.jsx)(t.p,{children:"The ProcessStrategy handles comparison with existing data and mapping to commands:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"interface IProcessStrategy<TEntity, TAttributesDto> {\n  compare(\n    importAttributes: TAttributesDto,\n    tenantCode: string\n  ): Promise<ComparisonResult<TEntity>>;\n\n  map(\n    status: ComparisonStatus,\n    importAttributes: TAttributesDto,\n    tenantCode: string,\n    existingData?: TEntity\n  ): Promise<CommandInputModel | CommandPartialInputModel>;\n\n  getCommandService(): CommandService;\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"comparison-status",children:"Comparison Status"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Status"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"NOT_EXIST"})}),(0,i.jsx)(t.td,{children:"Entity does not exist - will create new"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"CHANGED"})}),(0,i.jsx)(t.td,{children:"Entity exists but has changes - will update"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"EQUAL"})}),(0,i.jsx)(t.td,{children:"Entity exists and is identical - will skip"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"example-processstrategy",children:"Example ProcessStrategy"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'import {\n  BaseProcessStrategy,\n  ComparisonResult,\n  ComparisonStatus,\n} from "@mbc-cqrs-serverless/import";\nimport { CommandService, DataService } from "@mbc-cqrs-serverless/core";\nimport { Injectable } from "@nestjs/common";\n\n@Injectable()\nexport class ProductProcessStrategy extends BaseProcessStrategy<\n  ProductEntity,\n  ProductAttributesDto\n> {\n  constructor(\n    private readonly dataService: DataService,\n    private readonly commandService: CommandService\n  ) {\n    super();\n  }\n\n  async compare(\n    importAttributes: ProductAttributesDto,\n    tenantCode: string\n  ): Promise<ComparisonResult<ProductEntity>> {\n    const pk = `PRODUCT#${tenantCode}`;\n    const sk = `PRODUCT#${importAttributes.code}`;\n\n    const existing = await this.dataService.getItem({ pk, sk });\n\n    if (!existing) {\n      return { status: ComparisonStatus.NOT_EXIST };\n    }\n\n    // Compare relevant fields\n    if (\n      existing.name !== importAttributes.name ||\n      existing.attributes?.price !== importAttributes.price\n    ) {\n      return { status: ComparisonStatus.CHANGED, existingData: existing };\n    }\n\n    return { status: ComparisonStatus.EQUAL };\n  }\n\n  async map(\n    status: ComparisonStatus,\n    importAttributes: ProductAttributesDto,\n    tenantCode: string,\n    existingData?: ProductEntity\n  ) {\n    const pk = `PRODUCT#${tenantCode}`;\n    const sk = `PRODUCT#${importAttributes.code}`;\n\n    if (status === ComparisonStatus.NOT_EXIST) {\n      return {\n        pk,\n        sk,\n        code: importAttributes.code,\n        name: importAttributes.name,\n        tenantCode,\n        type: "PRODUCT",\n        attributes: { price: importAttributes.price },\n      };\n    }\n\n    // Update existing\n    return {\n      pk,\n      sk,\n      name: importAttributes.name,\n      version: existingData.version,\n      attributes: {\n        ...existingData.attributes,\n        price: importAttributes.price,\n      },\n    };\n  }\n\n  getCommandService(): CommandService {\n    return this.commandService;\n  }\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"zip-finalization-hooks",children:"ZIP Finalization Hooks"}),"\n",(0,i.jsx)(t.p,{children:"Hooks execute after ZIP import completes. Use them for post-processing tasks."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:'import { IZipFinalizationHook, ZipFinalizationContext } from "@mbc-cqrs-serverless/import";\nimport { S3Service } from "@mbc-cqrs-serverless/core";\nimport { Injectable } from "@nestjs/common";\n\n@Injectable()\nexport class BackupToS3Hook implements IZipFinalizationHook {\n  constructor(private readonly s3Service: S3Service) {}\n\n  async execute(context: ZipFinalizationContext): Promise<void> {\n    const { executionInput, status, results } = context;\n    const { bucket, key } = executionInput.parameters;\n\n    if (status === "COMPLETED") {\n      // Move file to backup location\n      const backupKey = `backup/${new Date().toISOString()}/${key}`;\n      await this.s3Service.copyObject({\n        sourceBucket: bucket,\n        sourceKey: key,\n        destinationBucket: bucket,\n        destinationKey: backupKey,\n      });\n    }\n  }\n}\n'})}),"\n",(0,i.jsx)(t.h3,{id:"zipfinalizationcontext",children:"ZipFinalizationContext"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Property"}),(0,i.jsx)(t.th,{children:"Type"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"event"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"ZipImportSfnEvent"})}),(0,i.jsx)(t.td,{children:"Original Step Function event"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"masterJobKey"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"DetailKey"})}),(0,i.jsx)(t.td,{children:"Key of the master ZIP job"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"results"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"object"})}),(0,i.jsx)(t.td,{children:"Aggregated results (totalRows, processedRows, failedRows)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"status"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"ImportStatusEnum"})}),(0,i.jsx)(t.td,{children:"Final status of the job"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"executionInput"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"any"})}),(0,i.jsx)(t.td,{children:"Original Step Functions execution input"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"dtos",children:"DTOs"}),"\n",(0,i.jsx)(t.h3,{id:"createimportdto",children:"CreateImportDto"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Property"}),(0,i.jsx)(t.th,{children:"Type"}),(0,i.jsx)(t.th,{children:"Required"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"tableName"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Target entity type"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"tenantCode"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Tenant code"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"attributes"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"object"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Import data attributes"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"sourceId"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Source identifier"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"name"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Display name for the import"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"createcsvimportdto",children:"CreateCsvImportDto"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Property"}),(0,i.jsx)(t.th,{children:"Type"}),(0,i.jsx)(t.th,{children:"Required"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"processingMode"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"'DIRECT' | 'STEP_FUNCTION'"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"How to process the CSV"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"bucket"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"S3 bucket name"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"key"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"S3 object key"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"tableName"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Target entity type"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"tenantCode"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Tenant code"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"createzipimportdto",children:"CreateZipImportDto"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Property"}),(0,i.jsx)(t.th,{children:"Type"}),(0,i.jsx)(t.th,{children:"Required"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"bucket"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"S3 bucket name"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"key"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"S3 object key"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"tenantCode"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"Yes"}),(0,i.jsx)(t.td,{children:"Tenant code"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"sortedFileKeys"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string[]"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Process files in this order"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"tableName"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsx)(t.td,{children:"No"}),(0,i.jsx)(t.td,{children:"Override auto-detected tableName"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(t.h3,{id:"csv-file-format",children:"CSV File Format"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Use UTF-8 encoding"}),"\n",(0,i.jsx)(t.li,{children:"Include header row with column names"}),"\n",(0,i.jsx)(t.li,{children:"Column names are trimmed automatically"}),"\n",(0,i.jsx)(t.li,{children:"Values are trimmed automatically"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"large-file-imports",children:"Large File Imports"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.code,{children:"STEP_FUNCTION"})," mode for files with more than 100 rows"]}),"\n",(0,i.jsx)(t.li,{children:"Monitor progress via SNS notifications"}),"\n",(0,i.jsx)(t.li,{children:"Use ZIP imports for related data that must be imported in order"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Invalid rows are logged and skipped in CSV processing"}),"\n",(0,i.jsxs)(t.li,{children:["Use the ",(0,i.jsx)(t.code,{children:"failedRows"})," counter to track failures"]}),"\n",(0,i.jsx)(t.li,{children:"Check import status via API or notifications"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"./import-export-patterns",children:"Import/Export Patterns"})," - Common patterns for data import and export"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"./command-service",children:"Command Service"})," - Command operations used by ProcessStrategy"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"./architecture/step-functions",children:"Step Functions"})," - Async processing infrastructure"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>d});var r=n(6540);const i={},s=r.createContext(i);function o(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);