"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[8889],{7277:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"authentication","title":"Authentication","description":"Learn how to use and customize authentication and authorization.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/authentication.md","sourceDirName":".","slug":"/authentication","permalink":"/docs/authentication","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"Learn how to use and customize authentication and authorization."},"sidebar":"tutorialSidebar","previous":{"title":"Security Best Practices","permalink":"/docs/security-best-practices"},"next":{"title":"Deployment Guide","permalink":"/docs/deployment-guide"}}');var s=t(4848),r=t(8453);const a={description:"Learn how to use and customize authentication and authorization."},i="Authentication",c={},l=[{value:"Authentication",id:"authentication-1",level:2},{value:"Authorization",id:"authorization",level:2},{value:"System Admin Bypass",id:"system-admin-bypass",level:3},{value:"Tenant Verification",id:"tenant-verification",level:2},{value:"Built-in Methods",id:"built-in-methods",level:3},{value:"Security: Tenant Code Header Override",id:"tenant-code-header-security",level:3},{value:"Environment Variable Configuration",id:"environment-variable-configuration",level:3},{value:"Custom Implementation Example",id:"custom-implementation-example",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"authentication",children:"Authentication"})}),"\n",(0,s.jsx)(n.p,{children:"Understanding authentication is crucial for protecting your application's data. This page will guide you through what mbc-cqrs-serverless features to use to implement auth."}),"\n",(0,s.jsx)(n.p,{children:"Before starting, it helps to break down the process into three concepts:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Authentication"}),": Verifies if the user is who they say they are. It requires the user to prove their identity with something they have, such as a username and password."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Session Management"}),": Tracks the user's auth state across requests."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Authorization"}),": Decides what routes and data the user can access."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The examples on this page walk through an ",(0,s.jsx)(n.a,{href:"https://aws.amazon.com/cognito/",children:"Amazon Cognito"})," app client, you can invoke API operations for authentication and authorization of your users."]}),"\n",(0,s.jsx)(n.h2,{id:"authentication-1",children:"Authentication"}),"\n",(0,s.jsxs)(n.p,{children:["We recommend you use ",(0,s.jsx)(n.a,{href:"https://docs.amplify.aws/nextjs/",children:"AWS Amplify"})," to integrate Amazon Cognito with your web and mobile apps. ",(0,s.jsx)("br",{})," Once authenticated, the server will issue a JWT that can be sent as a ",(0,s.jsx)(n.a,{href:"https://datatracker.ietf.org/doc/html/rfc6750",children:"bearer token"})," in an authorization header on subsequent requests to prove authentication."]}),"\n",(0,s.jsx)(n.h2,{id:"authorization",children:"Authorization"}),"\n",(0,s.jsxs)(n.p,{children:["Once a user is authenticated, you can implement authorization to control what the user can access and do within your application. Authorization is orthogonal and independent from authentication. However, authorization requires an authentication mechanism. ",(0,s.jsx)("br",{})," We use optimistic types of authorization check: Checks if the user is authorized to access a route or perform an action using the session data stored in the cookie. Specifically, we implement Role-Based Access Control (RBAC)."]}),"\n",(0,s.jsx)(n.p,{children:"First, let's create a Role enum representing roles in the system:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'// role.enum.ts\nimport { ROLE_SYSTEM_ADMIN } from "@mbc-cqrs-serverless/core";\n\nexport enum Role {\n  SYSTEM_ADMIN = ROLE_SYSTEM_ADMIN,\n  USER = "user",\n  ADMIN = "admin",\n}\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"In more sophisticated systems, you may store roles within a database, or pull them from the external authentication provider."})}),"\n",(0,s.jsx)(n.h3,{id:"system-admin-bypass",children:"System Admin Bypass"}),"\n",(0,s.jsxs)(n.p,{children:["The framework includes a built-in system admin bypass mechanism. When a user has the ",(0,s.jsx)(n.code,{children:"system_admin"})," role (defined as ",(0,s.jsx)(n.code,{children:"ROLE_SYSTEM_ADMIN"})," constant), they automatically pass all role-based authorization checks, regardless of the specific roles required by the endpoint."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// The RolesGuard automatically checks for system_admin role\nprotected async verifyRole(context: ExecutionContext): Promise<boolean> {\n  const requiredRoles = this.reflector.getAllAndOverride<string[]>(...)\n\n  // If no roles required, allow all users\n  if (!requiredRoles || !requiredRoles.length) {\n    return true\n  }\n\n  const userRole = await this.getUserRole(context)\n\n  // System admin bypasses all role checks\n  if (userRole === ROLE_SYSTEM_ADMIN) {\n    return true\n  }\n\n  return requiredRoles.includes(userRole)\n}\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"System Admin Usage",type:"warning",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"system_admin"})," role should be assigned sparingly and only to trusted administrators who need full access to all API endpoints. This role bypasses all role-based restrictions."]})}),"\n",(0,s.jsx)(n.p,{children:"Now that we have a custom Roles enum, we can use it to any route handler."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"@Post()\n@Auth(Role.SYSTEM_ADMIN)\nasync create(\n  @INVOKE_CONTEXT() invokeContext: IInvoke,\n  @Body() createCatDto: CreateCatDto,\n) {\n  return this.catsService.create(createCatDto, { invokeContext })\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Then, we create a helper function that extracts information from the context."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'// Event body example\n// {\n//     "claims": {\n//       "cognito:username": "9999#admin",\n//       "auth_time": 1717576015,\n//       "email_verified": false,\n//       "event_id": "b6642f6e-baf7-4a83-a912-ad559a87c327",\n//       "iat": 1717576015,\n//       "jti": "ee7bef16-0ea5-451a-a715-7e8baf1e6cdc",\n//       "sub": "92ca4f68-9ac6-4080-9ae2-2f02a86206a4",\n//       "token_use": "id",\n//       "custom:tenant": "9999",\n//       "custom:company_code": "999900000",\n//       "custom:member_id": "MEMBER#9999#9999000000#99999",\n//       "custom:roles": "[{\\"tenant\\":\\"\\",\\"role\\":\\"user\\"},{\\"tenant\\":\\"9999\\",\\"role\\":\\"admin\\"}]",\n//       "exp": 1717662415,\n//       "aud": "dnk8y7ii3wled35p3lw0l2cd7",\n//       "iss": "http://localhost:9229/local_2G7noHgW"\n//     }\n//   }\nimport {\n  extractInvokeContext,\n  getAuthorizerClaims,\n  getUserContext,\n  HEADER_TENANT_CODE,\n  IInvoke,\n  UserContext,\n} from "@mbc-cqrs-serverless/core";\nimport { ExecutionContext } from "@nestjs/common";\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"getUserContext"})," function is provided by ",(0,s.jsx)(n.code,{children:"@mbc-cqrs-serverless/core"}),". It automatically extracts ",(0,s.jsx)(n.code,{children:"tenantCode"})," from ",(0,s.jsx)(n.code,{children:"custom:tenant"})," claim and determines ",(0,s.jsx)(n.code,{children:"tenantRole"})," by matching the tenant in the ",(0,s.jsx)(n.code,{children:"custom:roles"})," JSON array."]})}),"\n",(0,s.jsxs)(n.admonition,{title:"Tenant Code Normalization - Breaking Change",type:"danger",children:[(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"tenantCode"})," returned by ",(0,s.jsx)(n.code,{children:"getUserContext()"})," is normalized to lowercase for case-insensitive matching. For example, ",(0,s.jsx)(n.code,{children:"TenantA"}),", ",(0,s.jsx)(n.code,{children:"TENANTA"}),", and ",(0,s.jsx)(n.code,{children:"tenanta"})," are all returned as ",(0,s.jsx)(n.code,{children:"tenanta"}),". This ensures consistent matching with ",(0,s.jsx)(n.code,{children:"role.tenant"})," values in the ",(0,s.jsx)(n.code,{children:"custom:roles"})," claim."]}),(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Impact on partition keys:"})," Since tenant codes are typically included in partition keys (e.g., ",(0,s.jsx)(n.code,{children:"PRODUCT#tenantCode"}),"), this normalization affects data access. If your existing data uses uppercase tenant codes in keys, queries will fail to find that data."]}),(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"See also:"})," ",(0,s.jsx)(n.a,{href:"./data-migration-patterns#tenant-code-normalization-migration",children:"Tenant Code Normalization Migration"})," for migration strategies."]})]}),"\n",(0,s.jsx)(n.p,{children:"If you need custom logic, you can implement your own helper function:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import {\n  extractInvokeContext,\n  getAuthorizerClaims,\n  HEADER_TENANT_CODE,\n  IInvoke,\n  CustomRole,\n} from "@mbc-cqrs-serverless/core";\nimport { ExecutionContext } from "@nestjs/common";\n\ninterface UserContext {\n  userId: string;\n  tenantRole: string;\n  tenantCode: string;\n}\n\nexport const getCustomUserContext = (\n  ctx: IInvoke | ExecutionContext\n): UserContext => {\n  if ("getHandler" in ctx) {\n    ctx = extractInvokeContext(ctx);\n  }\n  const claims = getAuthorizerClaims(ctx);\n\n  const userId = claims.sub;\n  // Normalize tenant code to lowercase for case-insensitive matching\n  const tenantCode = (\n    claims["custom:tenant"] ||\n    (ctx?.event?.headers || {})[HEADER_TENANT_CODE]\n  )?.toLowerCase();\n\n  // Parse roles from JSON array and find matching tenant role\n  const roles = (\n    JSON.parse(claims["custom:roles"] || "[]") as CustomRole[]\n  ).map((role) => ({ ...role, tenant: (role.tenant || "").toLowerCase() }));\n\n  let tenantRole = "";\n  for (const { tenant, role } of roles) {\n    if (tenant === "" || tenant === tenantCode) {\n      tenantRole = role;\n      if (tenant !== "") {\n        break;\n      }\n    }\n  }\n\n  return {\n    userId,\n    tenantRole,\n    tenantCode,\n  };\n};\n'})}),"\n",(0,s.jsx)(n.p,{children:"Finally, we create a CustomRoleGuard class which will compare the roles assigned to the current user to the actual roles required by the current route being processed."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { RolesGuard } from "@mbc-cqrs-serverless/core";\nimport { ExecutionContext, Injectable } from "@nestjs/common";\n\nimport { getUserContext } from "./user.context";\n\n@Injectable()\nexport class CustomRoleGuard extends RolesGuard {\n  protected async getUserRole(context: ExecutionContext): Promise<string> {\n    const userContext = getUserContext(context);\n\n    return userContext.tenantRole;\n  }\n\n  protected async verifyTenant(context: ExecutionContext): Promise<boolean> {\n    const userContext = getUserContext(context);\n\n    return !!userContext.tenantCode;\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"tenant-verification",children:"Tenant Verification"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"RolesGuard"})," includes extensible methods for tenant verification, allowing you to customize cross-tenant access behavior."]}),"\n",(0,s.jsx)(n.admonition,{title:"Version Note",type:"info",children:(0,s.jsxs)(n.p,{children:["Extensible tenant verification methods were added in ",(0,s.jsx)(n.a,{href:"/docs/changelog#v110",children:"version 1.1.0"}),"."]})}),"\n",(0,s.jsx)(n.h3,{id:"built-in-methods",children:"Built-in Methods"}),"\n",(0,s.jsx)(n.p,{children:"The following protected methods can be overridden to customize tenant verification:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Method"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Default Behavior"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"isHeaderOverride()"})}),(0,s.jsx)(n.td,{children:"Detect if tenant code comes from header"}),(0,s.jsxs)(n.td,{children:["Returns true if x-tenant-code header differs from Cognito custom",":tenant"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"canOverrideTenant()"})}),(0,s.jsx)(n.td,{children:"Check if user can override tenant"}),(0,s.jsx)(n.td,{children:"Returns true for system_admin role"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"getCommonTenantCodes()"})}),(0,s.jsx)(n.td,{children:"Get list of common tenant codes"}),(0,s.jsx)(n.td,{children:"Returns common or value from COMMON_TENANT_CODES env var"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"getCrossTenantRoles()"})}),(0,s.jsx)(n.td,{children:"Get roles that can access cross-tenant"}),(0,s.jsx)(n.td,{children:"Returns system_admin or value from CROSS_TENANT_ROLES env var"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"tenant-code-header-security",children:"Security: Tenant Code Header Override"}),"\n",(0,s.jsxs)(n.p,{children:["By default, only users with the ",(0,s.jsx)(n.code,{children:"system_admin"})," role can override the tenant code via the ",(0,s.jsx)(n.code,{children:"x-tenant-code"})," header. This prevents unauthorized cross-tenant access."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// Default behavior in RolesGuard\nprotected canOverrideTenant(context: ExecutionContext): boolean {\n  const userContext = getUserContext(context);\n  const crossTenantRoles = this.getCrossTenantRoles();\n  return crossTenantRoles.includes(userContext.tenantRole);\n}\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"Security Note",type:"warning",children:(0,s.jsxs)(n.p,{children:["In versions prior to v1.1.0, users without a ",(0,s.jsx)(n.code,{children:"custom:tenant"})," Cognito attribute could specify any tenant via the ",(0,s.jsx)(n.code,{children:"x-tenant-code"})," header, potentially accessing data from other tenants. This security issue has been fixed in v1.1.0."]})}),"\n",(0,s.jsx)(n.h3,{id:"environment-variable-configuration",children:"Environment Variable Configuration"}),"\n",(0,s.jsx)(n.p,{children:"You can configure common tenant codes and cross-tenant roles via environment variables:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Comma-separated list of common tenant codes\nCOMMON_TENANT_CODES=common,shared,global\n\n# Comma-separated list of roles that can access cross-tenant data\nCROSS_TENANT_ROLES=system_admin,general_manager\n"})}),"\n",(0,s.jsx)(n.h3,{id:"custom-implementation-example",children:"Custom Implementation Example"}),"\n",(0,s.jsxs)(n.p,{children:["To implement custom cross-tenant access logic, extend ",(0,s.jsx)(n.code,{children:"RolesGuard"})," and override the relevant methods:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { RolesGuard, getUserContext } from \"@mbc-cqrs-serverless/core\";\nimport { ExecutionContext, Injectable } from \"@nestjs/common\";\n\n@Injectable()\nexport class CustomRolesGuard extends RolesGuard {\n  // Allow additional roles to access cross-tenant data\n  protected getCrossTenantRoles(): string[] {\n    return ['system_admin', 'regional_manager', 'auditor'];\n  }\n\n  // Add custom common tenant codes\n  protected getCommonTenantCodes(): string[] {\n    return ['common', 'shared', 'template'];\n  }\n\n  // Custom logic for tenant override permission\n  protected canOverrideTenant(context: ExecutionContext): boolean {\n    const userContext = getUserContext(context);\n\n    // Allow specific users to override tenant\n    if (userContext.tenantRole === 'regional_manager') {\n      // Regional managers can only access tenants in their region\n      return this.isRegionalManagerForTenant(userContext, context);\n    }\n\n    return super.canOverrideTenant(context);\n  }\n\n  private isRegionalManagerForTenant(userContext: UserContext, context: ExecutionContext): boolean {\n    // Custom logic to verify regional access\n    // ...\n  }\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var o=t(6540);const s={},r=o.createContext(s);function a(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);