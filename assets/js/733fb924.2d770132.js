"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[1163],{8037:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"debugging-guide","title":"Debugging Guide","description":"Learn debugging techniques for MBC CQRS Serverless applications.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/debugging-guide.md","sourceDirName":".","slug":"/debugging-guide","permalink":"/docs/debugging-guide","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"description":"Learn debugging techniques for MBC CQRS Serverless applications."},"sidebar":"tutorialSidebar","previous":{"title":"Common Issues","permalink":"/docs/common-issues"},"next":{"title":"Examples","permalink":"/docs/recipes"}}');var t=s(4848),a=s(8453);const o={description:"Learn debugging techniques for MBC CQRS Serverless applications."},r="Debugging Guide",l={},c=[{value:"Local Development Debugging",id:"local-development-debugging",level:2},{value:"Using NestJS REPL",id:"using-nestjs-repl",level:3},{value:"VS Code Debugging",id:"vs-code-debugging",level:3},{value:"Serverless Offline Debugging",id:"serverless-offline-debugging",level:3},{value:"Console Logging",id:"console-logging",level:3},{value:"DynamoDB Debugging",id:"dynamodb-debugging",level:2},{value:"View Table Contents",id:"view-table-contents",level:3},{value:"DynamoDB Streams",id:"dynamodb-streams",level:3},{value:"CloudWatch Logs",id:"cloudwatch-logs",level:2},{value:"Viewing Logs",id:"viewing-logs",level:3},{value:"Log Insights Queries",id:"log-insights-queries",level:3},{value:"Structured Log Analysis",id:"structured-log-analysis",level:3},{value:"Step Functions Debugging",id:"step-functions-debugging",level:2},{value:"Execution History",id:"execution-history",level:3},{value:"Event History",id:"event-history",level:3},{value:"Debug with CloudWatch",id:"debug-with-cloudwatch",level:3},{value:"API Gateway Debugging",id:"api-gateway-debugging",level:2},{value:"Enable Access Logs",id:"enable-access-logs",level:3},{value:"Test Endpoints",id:"test-endpoints",level:3},{value:"X-Ray Tracing",id:"x-ray-tracing",level:2},{value:"CDK-Level Configuration",id:"cdk-level-configuration",level:3},{value:"Optional: SDK-Level Instrumentation",id:"optional-sdk-level-instrumentation",level:3},{value:"Add Custom Segments",id:"add-custom-segments",level:3},{value:"Common Debugging Patterns",id:"common-debugging-patterns",level:2},{value:"Request Correlation",id:"request-correlation",level:3},{value:"Debug Environment Variables",id:"debug-environment-variables",level:3},{value:"Conditional Debugging",id:"conditional-debugging",level:3},{value:"Troubleshooting Checklist",id:"troubleshooting-checklist",level:2},{value:"Local Step Functions Debugging",id:"local-step-functions-debugging",level:2},{value:"Starting Step Functions Local",id:"starting-step-functions-local",level:3},{value:"Creating State Machines Locally",id:"creating-state-machines-locally",level:3},{value:"Starting and Monitoring Executions",id:"starting-and-monitoring-executions",level:3},{value:"Debugging waitForTaskToken",id:"debugging-waitfortasktoken",level:3},{value:"Production Debugging with CloudWatch",id:"production-debugging-with-cloudwatch",level:2},{value:"Lambda Log Analysis",id:"lambda-log-analysis",level:3},{value:"Step Functions Execution Analysis",id:"step-functions-execution-analysis",level:3},{value:"CloudWatch Logs Insights for CQRS",id:"cloudwatch-logs-insights-for-cqrs",level:3},{value:"Version Conflict Debugging",id:"version-conflict-debugging",level:2},{value:"Understanding Version Numbers",id:"understanding-version-numbers",level:3},{value:"Identifying Version Conflicts",id:"identifying-version-conflicts",level:3},{value:"Resolving Version Conflicts",id:"resolving-version-conflicts",level:3},{value:"Inspecting DynamoDB Command History",id:"inspecting-dynamodb-command-history",level:2},{value:"Table Structure",id:"table-structure",level:3},{value:"Querying Command History",id:"querying-command-history",level:3},{value:"Using DynamoDB Admin UI",id:"using-dynamodb-admin-ui",level:3},{value:"Programmatic History Access",id:"programmatic-history-access",level:3},{value:"Common Debugging Scenarios",id:"common-debugging-scenarios",level:2},{value:"Scenario 1: Command Not Appearing in Data Table",id:"scenario-1-command-not-appearing-in-data-table",level:3},{value:"Scenario 2: Step Function Stuck in RUNNING State",id:"scenario-2-step-function-stuck-in-running-state",level:3},{value:"Scenario 3: Duplicate Commands Being Processed",id:"scenario-3-duplicate-commands-being-processed",level:3},{value:"Scenario 4: Data Sync Handler Not Executing",id:"scenario-4-data-sync-handler-not-executing",level:3},{value:"Scenario 5: X-Ray Traces Not Appearing",id:"scenario-5-x-ray-traces-not-appearing",level:3},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"debugging-guide",children:"Debugging Guide"})}),"\n",(0,t.jsx)(n.p,{children:"This guide covers debugging techniques for MBC CQRS Serverless applications in both local and AWS environments."}),"\n",(0,t.jsx)(n.h2,{id:"local-development-debugging",children:"Local Development Debugging"}),"\n",(0,t.jsx)(n.h3,{id:"using-nestjs-repl",children:"Using NestJS REPL"}),"\n",(0,t.jsx)(n.p,{children:"The REPL (Read-Eval-Print Loop) allows interactive debugging:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm run start:repl\n"})}),"\n",(0,t.jsx)(n.p,{children:"In the REPL, you can:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Get a service instance\n> get(TodoService)\nTodoService { ... }\n\n// Call methods directly\n> await get(TodoService).findAll()\n[{ id: '1', title: 'Test' }, ...]\n\n// Show available methods on a service\n> methods(TodoService)\nMethods:\n \u25fb findAll\n \u25fb findOne\n \u25fb create\n \u25fb update\n \u25fb delete\n"})}),"\n",(0,t.jsxs)(n.p,{children:["For more details on NestJS REPL, see the ",(0,t.jsx)(n.a,{href:"https://docs.nestjs.com/recipes/repl",children:"NestJS REPL documentation"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"vs-code-debugging",children:"VS Code Debugging"}),"\n",(0,t.jsxs)(n.p,{children:["Create a ",(0,t.jsx)(n.code,{children:".vscode/launch.json"})," configuration:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "version": "0.2.0",\n  "configurations": [\n    {\n      "type": "node",\n      "request": "launch",\n      "name": "Debug Serverless Offline",\n      "program": "${workspaceFolder}/node_modules/.bin/serverless",\n      "args": ["offline", "start"],\n      "cwd": "${workspaceFolder}/infra-local",\n      "env": {\n        "NODE_ENV": "development"\n      },\n      "console": "integratedTerminal"\n    },\n    {\n      "type": "node",\n      "request": "launch",\n      "name": "Debug Tests",\n      "program": "${workspaceFolder}/node_modules/.bin/jest",\n      "args": ["--runInBand", "--watchAll=false"],\n      "console": "integratedTerminal"\n    }\n  ]\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"serverless-offline-debugging",children:"Serverless Offline Debugging"}),"\n",(0,t.jsx)(n.p,{children:"Enable detailed logging with Serverless Offline:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"SLS_DEBUG=* npm run offline:sls\n"})}),"\n",(0,t.jsx)(n.p,{children:"Or add to serverless.yml:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"custom:\n  serverless-offline:\n    httpPort: 3000\n    lambdaPort: 3002\n    printOutput: true\n"})}),"\n",(0,t.jsx)(n.h3,{id:"console-logging",children:"Console Logging"}),"\n",(0,t.jsx)(n.p,{children:"Use structured logging for easier debugging:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { Logger } from '@nestjs/common';\n\n@Injectable()\nexport class TodoService {\n  private readonly logger = new Logger(TodoService.name);\n\n  async create(dto: CreateTodoDto, invokeContext: IInvoke): Promise<Todo> {\n    this.logger.debug(`Creating todo: ${JSON.stringify(dto)}`);\n\n    try {\n      const result = await this.commandService.publishAsync(entity, { invokeContext });\n      this.logger.log(`Todo created: ${result.id}`);\n      return result;\n    } catch (error) {\n      this.logger.error(`Failed to create todo: ${error.message}`, error.stack);\n      throw error;\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"dynamodb-debugging",children:"DynamoDB Debugging"}),"\n",(0,t.jsx)(n.h3,{id:"view-table-contents",children:"View Table Contents"}),"\n",(0,t.jsx)(n.p,{children:"Using AWS CLI with DynamoDB Local:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# List tables\naws dynamodb list-tables --endpoint-url http://localhost:8000\n\n# Scan table\naws dynamodb scan \\\n  --table-name your-table-name \\\n  --endpoint-url http://localhost:8000\n\n# Query by partition key\naws dynamodb query \\\n  --table-name your-table-name \\\n  --key-condition-expression "pk = :pk" \\\n  --expression-attribute-values \'{":pk":{"S":"TODO#123"}}\' \\\n  --endpoint-url http://localhost:8000\n'})}),"\n",(0,t.jsx)(n.h3,{id:"dynamodb-streams",children:"DynamoDB Streams"}),"\n",(0,t.jsx)(n.p,{children:"Debug stream records:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"@EventHandler(DataSyncEvent)\nexport class DebugHandler implements IEventHandler<DataSyncEvent> {\n  async execute(event: DataSyncEvent): Promise<void> {\n    console.log('Stream record:', JSON.stringify(event.record, null, 2));\n    console.log('Event name:', event.eventName);\n    console.log('New image:', event.newImage);\n    console.log('Old image:', event.oldImage);\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"cloudwatch-logs",children:"CloudWatch Logs"}),"\n",(0,t.jsx)(n.h3,{id:"viewing-logs",children:"Viewing Logs"}),"\n",(0,t.jsx)(n.p,{children:"Use AWS CLI to tail logs:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Find log group\naws logs describe-log-groups --log-group-name-prefix /aws/lambda/your-app\n\n# Tail logs\naws logs tail /aws/lambda/your-app-dev-handler --follow\n\n# Filter logs\naws logs filter-log-events \\\n  --log-group-name /aws/lambda/your-app-dev-handler \\\n  --filter-pattern "ERROR"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"log-insights-queries",children:"Log Insights Queries"}),"\n",(0,t.jsx)(n.p,{children:"Use CloudWatch Logs Insights for advanced queries:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'# Find errors\nfields @timestamp, @message\n| filter @message like /ERROR/\n| sort @timestamp desc\n| limit 100\n\n# Analyze cold starts\nfields @timestamp, @message, @duration\n| filter @type = "REPORT"\n| stats avg(@duration), max(@duration), count(*) by bin(1h)\n\n# Find slow requests\nfields @timestamp, @message, @duration\n| filter @duration > 3000\n| sort @duration desc\n| limit 20\n'})}),"\n",(0,t.jsx)(n.h3,{id:"structured-log-analysis",children:"Structured Log Analysis"}),"\n",(0,t.jsx)(n.p,{children:"If using structured logging:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'fields @timestamp, level, message, context\n| filter level = "error"\n| sort @timestamp desc\n'})}),"\n",(0,t.jsx)(n.h2,{id:"step-functions-debugging",children:"Step Functions Debugging"}),"\n",(0,t.jsx)(n.h3,{id:"execution-history",children:"Execution History"}),"\n",(0,t.jsx)(n.p,{children:"View execution in AWS Console:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Go to Step Functions \u2192 State machines"}),"\n",(0,t.jsx)(n.li,{children:"Select your state machine"}),"\n",(0,t.jsx)(n.li,{children:"Click on an execution"}),"\n",(0,t.jsx)(n.li,{children:"View the visual workflow with step status"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"event-history",children:"Event History"}),"\n",(0,t.jsx)(n.p,{children:"Using AWS CLI:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# List executions\naws stepfunctions list-executions \\\n  --state-machine-arn arn:aws:states:REGION:ACCOUNT:stateMachine:YourMachine\n\n# Get execution details\naws stepfunctions describe-execution \\\n  --execution-arn arn:aws:states:REGION:ACCOUNT:execution:YourMachine:execution-id\n\n# Get execution history\naws stepfunctions get-execution-history \\\n  --execution-arn arn:aws:states:REGION:ACCOUNT:execution:YourMachine:execution-id\n"})}),"\n",(0,t.jsx)(n.h3,{id:"debug-with-cloudwatch",children:"Debug with CloudWatch"}),"\n",(0,t.jsx)(n.p,{children:"Enable logging in Step Functions:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const stateMachine = new sfn.StateMachine(this, 'StateMachine', {\n  definition: definition,\n  logs: {\n    destination: new logs.LogGroup(this, 'StateMachineLogGroup'),\n    level: sfn.LogLevel.ALL,\n  },\n  tracingEnabled: true, // Enable X-Ray\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"api-gateway-debugging",children:"API Gateway Debugging"}),"\n",(0,t.jsx)(n.h3,{id:"enable-access-logs",children:"Enable Access Logs"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const api = new apigateway.HttpApi(this, 'Api');\n\nconst stage = api.defaultStage?.node.defaultChild as apigateway.CfnStage;\nstage.accessLogSettings = {\n  destinationArn: logGroup.logGroupArn,\n  format: JSON.stringify({\n    requestId: '$context.requestId',\n    ip: '$context.identity.sourceIp',\n    method: '$context.httpMethod',\n    path: '$context.path',\n    status: '$context.status',\n    latency: '$context.responseLatency',\n    error: '$context.error.message',\n  }),\n};\n"})}),"\n",(0,t.jsx)(n.h3,{id:"test-endpoints",children:"Test Endpoints"}),"\n",(0,t.jsx)(n.p,{children:"Use curl with verbose output:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'curl -v -X POST https://your-api.execute-api.region.amazonaws.com/todos \\\n  -H "Authorization: Bearer YOUR_TOKEN" \\\n  -H "Content-Type: application/json" \\\n  -d \'{"title": "Test Todo"}\'\n'})}),"\n",(0,t.jsx)(n.h2,{id:"x-ray-tracing",children:"X-Ray Tracing"}),"\n",(0,t.jsxs)(n.p,{children:["X-Ray tracing is automatically enabled at the CDK level for Lambda functions and API Gateway. SDK-level instrumentation with ",(0,t.jsx)(n.code,{children:"aws-xray-sdk"})," is optional for additional tracing capabilities."]}),"\n",(0,t.jsx)(n.h3,{id:"cdk-level-configuration",children:"CDK-Level Configuration"}),"\n",(0,t.jsx)(n.p,{children:"X-Ray is enabled by default in the CDK infrastructure:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Lambda functions have X-Ray tracing enabled by default\nconst handler = new NodejsFunction(this, 'Handler', {\n  // ...\n  tracing: lambda.Tracing.ACTIVE, // Enabled by default\n});\n\n// Step Functions can also enable X-Ray\nconst stateMachine = new sfn.StateMachine(this, 'StateMachine', {\n  definition: definition,\n  tracingEnabled: true, // Enable X-Ray\n});\n"})}),"\n",(0,t.jsx)(n.h3,{id:"optional-sdk-level-instrumentation",children:"Optional: SDK-Level Instrumentation"}),"\n",(0,t.jsx)(n.p,{children:"For more detailed tracing, you can optionally install and configure the X-Ray SDK:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm install aws-xray-sdk\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Optional: Instrument AWS SDK for detailed tracing\nimport * as AWSXRay from 'aws-xray-sdk';\nconst AWS = AWSXRay.captureAWS(require('aws-sdk'));\n"})}),"\n",(0,t.jsx)(n.h3,{id:"add-custom-segments",children:"Add Custom Segments"}),"\n",(0,t.jsx)(n.p,{children:"If you need custom subsegments for detailed tracing:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import * as AWSXRay from 'aws-xray-sdk';\n\nasync function processOrder(orderId: string): Promise<void> {\n  const segment = AWSXRay.getSegment();\n  const subsegment = segment?.addNewSubsegment('ProcessOrder');\n\n  try {\n    subsegment?.addAnnotation('orderId', orderId);\n    // Process order\n    subsegment?.addMetadata('result', { status: 'success' });\n  } catch (error) {\n    subsegment?.addError(error);\n    throw error;\n  } finally {\n    subsegment?.close();\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"common-debugging-patterns",children:"Common Debugging Patterns"}),"\n",(0,t.jsx)(n.h3,{id:"request-correlation",children:"Request Correlation"}),"\n",(0,t.jsx)(n.p,{children:"Add correlation IDs to trace requests:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"@Injectable()\nexport class CorrelationMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    const correlationId = req.headers['x-correlation-id'] || uuidv4();\n    req['correlationId'] = correlationId;\n    res.setHeader('x-correlation-id', correlationId);\n    next();\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"debug-environment-variables",children:"Debug Environment Variables"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Log environment on startup (development only)\nif (process.env.NODE_ENV === 'development') {\n  console.log('Environment:', {\n    NODE_ENV: process.env.NODE_ENV,\n    AWS_REGION: process.env.AWS_REGION,\n    DATABASE_URL: process.env.DATABASE_URL ? '[SET]' : '[NOT SET]',\n  });\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"conditional-debugging",children:"Conditional Debugging"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const DEBUG = process.env.DEBUG === 'true';\n\nfunction debugLog(message: string, data?: any): void {\n  if (DEBUG) {\n    console.log(`[DEBUG] ${message}`, data ? JSON.stringify(data, null, 2) : '');\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting-checklist",children:"Troubleshooting Checklist"}),"\n",(0,t.jsx)(n.p,{children:"When debugging an issue:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reproduce locally"}),": Can you reproduce in local environment?"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Check logs"}),": Review CloudWatch Logs for errors"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Verify configuration"}),": Check environment variables and settings"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Test isolation"}),": Test components individually"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Check permissions"}),": Verify IAM roles and policies"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Review recent changes"}),": What changed since it last worked?"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Check dependencies"}),": Are all services healthy?"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"local-step-functions-debugging",children:"Local Step Functions Debugging"}),"\n",(0,t.jsx)(n.p,{children:"The framework includes support for AWS Step Functions Local, allowing you to test and debug Step Functions workflows in your local development environment."}),"\n",(0,t.jsx)(n.h3,{id:"starting-step-functions-local",children:"Starting Step Functions Local"}),"\n",(0,t.jsx)(n.p,{children:"Step Functions Local runs as a Docker container alongside other local services:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Start all local services including Step Functions\ncd infra-local\ndocker-compose up -d\n"})}),"\n",(0,t.jsx)(n.p,{children:"The Step Functions Local service runs on port 8083 and connects to your local Lambda functions."}),"\n",(0,t.jsx)(n.h3,{id:"creating-state-machines-locally",children:"Creating State Machines Locally"}),"\n",(0,t.jsx)(n.p,{children:"Use the AWS CLI to create state machines in Step Functions Local:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Create state machine from definition\naws stepfunctions create-state-machine \\\n  --endpoint-url http://localhost:8083 \\\n  --name command \\\n  --definition file://state-machine-definition.json \\\n  --role-arn "arn:aws:iam::101010101010:role/DummyRole"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"starting-and-monitoring-executions",children:"Starting and Monitoring Executions"}),"\n",(0,t.jsx)(n.p,{children:"Start and monitor Step Functions executions locally:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Start an execution\naws stepfunctions start-execution \\\n  --endpoint-url http://localhost:8083 \\\n  --state-machine-arn arn:aws:states:ap-northeast-1:101010101010:stateMachine:command \\\n  --input \'{"pk":"TODO#tenant","sk":"item#001@1"}\'\n\n# List executions\naws stepfunctions list-executions \\\n  --endpoint-url http://localhost:8083 \\\n  --state-machine-arn arn:aws:states:ap-northeast-1:101010101010:stateMachine:command\n\n# Get execution history\naws stepfunctions get-execution-history \\\n  --endpoint-url http://localhost:8083 \\\n  --execution-arn arn:aws:states:ap-northeast-1:101010101010:execution:command:execution-id\n'})}),"\n",(0,t.jsx)(n.h3,{id:"debugging-waitfortasktoken",children:"Debugging waitForTaskToken"}),"\n",(0,t.jsx)(n.p,{children:"When debugging Step Functions that use waitForTaskToken (like the command processing workflow), you can manually send task success or failure:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Send task success\naws stepfunctions send-task-success \\\n  --endpoint-url http://localhost:8083 \\\n  --task-token "YOUR_TASK_TOKEN" \\\n  --task-output \'{"Payload":[[{"result":0}]]}\'\n\n# Send task failure\naws stepfunctions send-task-failure \\\n  --endpoint-url http://localhost:8083 \\\n  --task-token "YOUR_TASK_TOKEN" \\\n  --cause "Debug failure" \\\n  --error "TestError"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"production-debugging-with-cloudwatch",children:"Production Debugging with CloudWatch"}),"\n",(0,t.jsx)(n.h3,{id:"lambda-log-analysis",children:"Lambda Log Analysis"}),"\n",(0,t.jsx)(n.p,{children:"Each Lambda function writes logs to CloudWatch. Use these patterns to analyze production issues:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Find log groups for your application\naws logs describe-log-groups \\\n  --log-group-name-prefix /aws/lambda/prod-myapp\n\n# Get recent log events\naws logs get-log-events \\\n  --log-group-name /aws/lambda/prod-myapp-handler \\\n  --log-stream-name '2024/01/15/[$LATEST]abc123' \\\n  --limit 100\n\n# Filter for errors in the last hour\naws logs filter-log-events \\\n  --log-group-name /aws/lambda/prod-myapp-handler \\\n  --start-time $(date -d '1 hour ago' +%s000) \\\n  --filter-pattern \"ERROR\"\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-functions-execution-analysis",children:"Step Functions Execution Analysis"}),"\n",(0,t.jsx)(n.p,{children:"For production Step Functions debugging:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# List failed executions\naws stepfunctions list-executions \\\n  --state-machine-arn arn:aws:states:REGION:ACCOUNT:stateMachine:command \\\n  --status-filter FAILED\n\n# Get detailed execution history\naws stepfunctions get-execution-history \\\n  --execution-arn arn:aws:states:REGION:ACCOUNT:execution:command:exec-id \\\n  --include-execution-data\n\n# Describe execution for input/output\naws stepfunctions describe-execution \\\n  --execution-arn arn:aws:states:REGION:ACCOUNT:execution:command:exec-id\n"})}),"\n",(0,t.jsx)(n.h3,{id:"cloudwatch-logs-insights-for-cqrs",children:"CloudWatch Logs Insights for CQRS"}),"\n",(0,t.jsx)(n.p,{children:"Use these CloudWatch Logs Insights queries tailored for MBC CQRS applications:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'# Find version conflicts\nfields @timestamp, @message\n| filter @message like /version not match|ConditionalCheckFailed/\n| sort @timestamp desc\n| limit 50\n\n# Track command processing\nfields @timestamp, @message\n| filter @message like /publish|publishSync|publishAsync/\n| parse @message "pk=* sk=*" as pk, sk\n| sort @timestamp desc\n| limit 100\n\n# Analyze data sync operations\nfields @timestamp, @message\n| filter @message like /DataSyncHandler|sync_data/\n| sort @timestamp desc\n| limit 100\n\n# Find Step Functions timeouts\nfields @timestamp, @message\n| filter @message like /waitForTaskToken|taskToken/\n| sort @timestamp desc\n| limit 50\n'})}),"\n",(0,t.jsx)(n.h2,{id:"version-conflict-debugging",children:"Version Conflict Debugging"}),"\n",(0,t.jsx)(n.p,{children:"Version conflicts occur when multiple processes attempt to update the same item simultaneously. The framework uses optimistic locking to ensure data consistency."}),"\n",(0,t.jsx)(n.h3,{id:"understanding-version-numbers",children:"Understanding Version Numbers"}),"\n",(0,t.jsx)(n.p,{children:"In MBC CQRS Serverless, version management works as follows:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Sort key (sk) format: ",(0,t.jsx)(n.code,{children:"ITEM#code@version"})," (e.g., ",(0,t.jsx)(n.code,{children:"TODO#001@3"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Version separator: ",(0,t.jsx)(n.code,{children:"@"})]}),"\n",(0,t.jsxs)(n.li,{children:["VERSION_FIRST: ",(0,t.jsx)(n.code,{children:"0"})," (initial version)"]}),"\n",(0,t.jsxs)(n.li,{children:["VERSION_LATEST: ",(0,t.jsx)(n.code,{children:"-1"})," (auto-fetch latest version)"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"identifying-version-conflicts",children:"Identifying Version Conflicts"}),"\n",(0,t.jsx)(n.p,{children:"Check the command table for version history:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Query all versions of an item\naws dynamodb query \\\n  --table-name prod-myapp-command \\\n  --endpoint-url http://localhost:8000 \\\n  --key-condition-expression "pk = :pk AND begins_with(sk, :sk)" \\\n  --expression-attribute-values \'{\n    ":pk": {"S": "TODO#tenant"},\n    ":sk": {"S": "TODO#001@"}\n  }\' \\\n  --scan-index-forward false\n'})}),"\n",(0,t.jsx)(n.h3,{id:"resolving-version-conflicts",children:"Resolving Version Conflicts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Option 1: Use VERSION_LATEST (-1) for auto-versioning\nawait commandService.publishPartialUpdateAsync({\n  pk: 'TODO#tenant',\n  sk: 'TODO#001',\n  version: -1,  // Auto-fetches latest version\n  name: 'Updated Name',\n}, options);\n\n// Option 2: Fetch and retry pattern\nasync function updateWithRetry(pk: string, sk: string, updates: any, maxRetries = 3) {\n  for (let i = 0; i < maxRetries; i++) {\n    try {\n      const latest = await dataService.getItem({ pk, sk });\n      return await commandService.publishPartialUpdateSync({\n        pk,\n        sk,\n        version: latest.version,\n        ...updates,\n      }, options);\n    } catch (error) {\n      if (error.message.includes('version not match') && i < maxRetries - 1) {\n        await new Promise(r => setTimeout(r, 100 * Math.pow(2, i)));\n        continue;\n      }\n      throw error;\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"inspecting-dynamodb-command-history",children:"Inspecting DynamoDB Command History"}),"\n",(0,t.jsx)(n.p,{children:"The command table stores a complete history of all commands, enabling full audit trails and debugging."}),"\n",(0,t.jsx)(n.h3,{id:"table-structure",children:"Table Structure"}),"\n",(0,t.jsx)(n.p,{children:"The framework uses two DynamoDB tables per module:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"{env}-{app}-{module}-command"}),": Stores command history with versions"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"{env}-{app}-{module}-data"}),": Stores current state (latest version)"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"querying-command-history",children:"Querying Command History"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Get the latest version from data table\naws dynamodb get-item \\\n  --table-name dev-myapp-sample-data \\\n  --endpoint-url http://localhost:8000 \\\n  --key \'{"pk":{"S":"TODO#tenant"},"sk":{"S":"TODO#001"}}\'\n\n# Get all command versions\naws dynamodb query \\\n  --table-name dev-myapp-sample-command \\\n  --endpoint-url http://localhost:8000 \\\n  --key-condition-expression "pk = :pk AND begins_with(sk, :sk)" \\\n  --expression-attribute-values \'{\n    ":pk": {"S": "TODO#tenant"},\n    ":sk": {"S": "TODO#001@"}\n  }\' \\\n  --projection-expression "pk, sk, version, createdAt, createdBy, #s, requestId" \\\n  --expression-attribute-names \'{"#s": "source"}\' \\\n  --scan-index-forward false\n\n# Get a specific version\naws dynamodb get-item \\\n  --table-name dev-myapp-sample-command \\\n  --endpoint-url http://localhost:8000 \\\n  --key \'{"pk":{"S":"TODO#tenant"},"sk":{"S":"TODO#001@3"}}\'\n'})}),"\n",(0,t.jsx)(n.h3,{id:"using-dynamodb-admin-ui",children:"Using DynamoDB Admin UI"}),"\n",(0,t.jsx)(n.p,{children:"DynamoDB Admin provides a web interface for browsing local DynamoDB tables:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Access ",(0,t.jsx)(n.a,{href:"http://localhost:8001",children:"http://localhost:8001"})," when running local services"]}),"\n",(0,t.jsxs)(n.li,{children:["Select your table (e.g., ",(0,t.jsx)(n.code,{children:"dev-myapp-sample-command"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Use filters to find specific items by pk or sk"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"programmatic-history-access",children:"Programmatic History Access"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { DynamoDbService } from '@mbc-cqrs-serverless/core';\n\n// Get all versions of an item\nasync function getCommandHistory(pk: string, baseSk: string) {\n  const result = await dynamoDbService.listItemsByPk(\n    commandTableName,\n    pk,\n    {\n      skExpession: 'begins_with(sk, :sk)',\n      skAttributeValues: { ':sk': `${baseSk}@` },\n    },\n    undefined,\n    100,\n    'desc', // Latest first\n  );\n  return result.items;\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"common-debugging-scenarios",children:"Common Debugging Scenarios"}),"\n",(0,t.jsx)(n.h3,{id:"scenario-1-command-not-appearing-in-data-table",children:"Scenario 1: Command Not Appearing in Data Table"}),"\n",(0,t.jsx)(n.p,{children:"Symptoms: Command was published but data table shows old version."}),"\n",(0,t.jsx)(n.p,{children:"Debugging steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check command table for the new version:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'aws dynamodb query --table-name dev-myapp-sample-command \\\n  --endpoint-url http://localhost:8000 \\\n  --key-condition-expression "pk = :pk" \\\n  --expression-attribute-values \'{":pk":{"S":"TODO#tenant"}}\' \\\n  --scan-index-forward false --limit 5\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check DynamoDB Streams is enabled and processing:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Verify LOCAL_DDB_SAMPLE_STREAM is set in .env"}),"\n",(0,t.jsx)(n.li,{children:"Check Lambda logs for stream processing errors"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check Step Functions execution:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws stepfunctions list-executions \\\n  --endpoint-url http://localhost:8083 \\\n  --state-machine-arn arn:aws:states:ap-northeast-1:101010101010:stateMachine:command \\\n  --status-filter RUNNING\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Verify data sync handlers are registered:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Check in your module\n@Module({\n  imports: [\n    CommandModule.register({\n      tableName: 'sample',\n      dataSyncHandlers: [YourSyncHandler], // Ensure registered\n    }),\n  ],\n})\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"scenario-2-step-function-stuck-in-running-state",children:"Scenario 2: Step Function Stuck in RUNNING State"}),"\n",(0,t.jsx)(n.p,{children:"Symptoms: Step Functions execution never completes."}),"\n",(0,t.jsx)(n.p,{children:"Debugging steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Get execution details:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"aws stepfunctions describe-execution \\\n  --endpoint-url http://localhost:8083 \\\n  --execution-arn YOUR_EXECUTION_ARN\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check if waiting for taskToken:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["If stuck at ",(0,t.jsx)(n.code,{children:"wait_prev_command"}),", a previous version is still processing"]}),"\n",(0,t.jsx)(n.li,{children:"Check if the previous command's taskToken callback was sent"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check command table for taskToken:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'aws dynamodb get-item \\\n  --table-name dev-myapp-sample-command \\\n  --endpoint-url http://localhost:8000 \\\n  --key \'{"pk":{"S":"TODO#tenant"},"sk":{"S":"TODO#001@2"}}\' \\\n  --projection-expression "taskToken, version, #s" \\\n  --expression-attribute-names \'{"#s": "status"}\'\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Manually resume if needed (for debugging only):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'aws stepfunctions send-task-success \\\n  --endpoint-url http://localhost:8083 \\\n  --task-token "TASK_TOKEN_FROM_COMMAND" \\\n  --task-output \'{"Payload":[[{"result":0}]]}\'\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"scenario-3-duplicate-commands-being-processed",children:"Scenario 3: Duplicate Commands Being Processed"}),"\n",(0,t.jsx)(n.p,{children:"Symptoms: Same command processed multiple times."}),"\n",(0,t.jsx)(n.p,{children:"Debugging steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check for multiple versions with same data:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'aws dynamodb query --table-name dev-myapp-sample-command \\\n  --endpoint-url http://localhost:8000 \\\n  --key-condition-expression "pk = :pk AND begins_with(sk, :sk)" \\\n  --expression-attribute-values \'{":pk":{"S":"TODO#tenant"},":sk":{"S":"TODO#001@"}}\' \\\n  --projection-expression "sk, version, requestId, createdAt"\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Compare requestId values to identify duplicate submissions"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check if client is retrying on timeout:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Review client-side error handling"}),"\n",(0,t.jsx)(n.li,{children:"Implement idempotency keys"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"scenario-4-data-sync-handler-not-executing",children:"Scenario 4: Data Sync Handler Not Executing"}),"\n",(0,t.jsx)(n.p,{children:"Symptoms: Command saved but external systems not updated."}),"\n",(0,t.jsx)(n.p,{children:"Debugging steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Verify handler is decorated correctly:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"@DataSyncHandler({\n  tableName: 'sample',\n  type: 'custom-sync',\n})\nexport class CustomSyncHandler implements IDataSyncHandler {\n  // ...\n}\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check if handler is discovered:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Enable debug logging: ",(0,t.jsx)(n.code,{children:"DEBUG=* npm run offline"})]}),"\n",(0,t.jsx)(n.li,{children:'Look for "find data sync handlers from decorator" message'}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Add debugging to handler:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"async up(command: CommandModel): Promise<void> {\n  this.logger.debug(`CustomSyncHandler.up called: ${command.pk}#${command.sk}`);\n  // Your sync logic\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"scenario-5-x-ray-traces-not-appearing",children:"Scenario 5: X-Ray Traces Not Appearing"}),"\n",(0,t.jsx)(n.p,{children:"Symptoms: X-Ray service map or traces not visible."}),"\n",(0,t.jsx)(n.p,{children:"Debugging steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Verify X-Ray is enabled in CDK:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Check Lambda function configuration\nconst handler = new NodejsFunction(this, 'Handler', {\n  tracing: lambda.Tracing.ACTIVE, // Should be ACTIVE\n});\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check IAM permissions include X-Ray:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "Effect": "Allow",\n  "Action": [\n    "xray:PutTraceSegments",\n    "xray:PutTelemetryRecords"\n  ],\n  "Resource": "*"\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"For SDK instrumentation, verify setup:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import * as AWSXRay from 'aws-xray-sdk';\n// Must be called before any AWS SDK usage\nconst AWS = AWSXRay.captureAWS(require('aws-sdk'));\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"./common-issues",children:"Common Issues"})," - Known issues and solutions"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"./monitoring-logging",children:"Monitoring and Logging"})," - Set up comprehensive monitoring"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var i=s(6540);const t={},a=i.createContext(t);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);