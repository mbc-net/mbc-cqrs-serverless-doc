"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[4742],{3938:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"multi-tenant-patterns","title":"Multi-Tenant Patterns","description":"Learn how to implement multi-tenant data isolation and cross-tenant operations in MBC CQRS Serverless.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/multi-tenant-patterns.md","sourceDirName":".","slug":"/multi-tenant-patterns","permalink":"/docs/multi-tenant-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"sidebar_position":17,"description":"Learn how to implement multi-tenant data isolation and cross-tenant operations in MBC CQRS Serverless."},"sidebar":"tutorialSidebar","previous":{"title":"Service Implementation Patterns","permalink":"/docs/service-patterns"},"next":{"title":"Import/Export Patterns","permalink":"/docs/import-export-patterns"}}');var s=t(4848),r=t(8453);const o={sidebar_position:17,description:"Learn how to implement multi-tenant data isolation and cross-tenant operations in MBC CQRS Serverless."},i="Multi-Tenant Patterns",d={},c=[{value:"When to Use This Guide",id:"when-to-use-this-guide",level:2},{value:"Multi-Tenant Architecture",id:"multi-tenant-architecture",level:2},{value:"Tenant Context",id:"tenant-context",level:2},{value:"Extracting Tenant Context",id:"extracting-tenant-context",level:3},{value:"Tenant Guard",id:"tenant-guard",level:3},{value:"Data Isolation Patterns",id:"data-isolation-patterns",level:2},{value:"Pattern 1: Tenant in Partition Key",id:"pattern-1-tenant-in-partition-key",level:3},{value:"Pattern 2: Common Tenant for Shared Data",id:"pattern-2-common-tenant-for-shared-data",level:3},{value:"Pattern 3: User-Tenant Association",id:"pattern-3-user-tenant-association",level:3},{value:"Cross-Tenant Operations",id:"cross-tenant-operations",level:2},{value:"Pattern 1: Data Sync Between Tenants",id:"pattern-1-data-sync-between-tenants",level:3},{value:"Pattern 2: Cross-Tenant Reporting",id:"pattern-2-cross-tenant-reporting",level:3},{value:"Tenant Configuration",id:"tenant-configuration",level:2},{value:"Tenant Settings Pattern",id:"tenant-settings-pattern",level:3},{value:"Prisma Multi-Tenant Schema",id:"prisma-multi-tenant-schema",level:2},{value:"RDS Schema for Multi-Tenant",id:"rds-schema-for-multi-tenant",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Always Include Tenant in Queries",id:"1-always-include-tenant-in-queries",level:3},{value:"2. Validate Tenant Access",id:"2-validate-tenant-access",level:3},{value:"3. Tenant-Aware Logging",id:"3-tenant-aware-logging",level:3},{value:"4. Separate System and Tenant Operations",id:"4-separate-system-and-tenant-operations",level:3},{value:"TenantModule API Reference",id:"tenantmodule-api-reference",level:2},{value:"Installation",id:"installation",level:3},{value:"Module Registration",id:"module-registration",level:3},{value:"Module Options",id:"module-options",level:3},{value:"TenantService Methods",id:"tenantservice-methods",level:3},{value:"<code>getTenant(key: DetailKey): Promise&lt;DataModel&gt;</code>",id:"gettenantkey-detailkey-promisedatamodel",level:4},{value:"<code>createCommonTenant(dto, context): Promise&lt;CommandModel&gt;</code>",id:"createcommontenantdto-context-promisecommandmodel",level:4},{value:"<code>createTenant(dto, context): Promise&lt;CommandModel&gt;</code>",id:"createtenantdto-context-promisecommandmodel",level:4},{value:"<code>updateTenant(key, dto, context): Promise&lt;CommandModel&gt;</code>",id:"updatetenantkey-dto-context-promisecommandmodel",level:4},{value:"<code>deleteTenant(key, context): Promise&lt;CommandModel&gt;</code>",id:"deletetenantkey-context-promisecommandmodel",level:4},{value:"<code>addTenantGroup(dto, context): Promise&lt;CommandModel&gt;</code>",id:"addtenantgroupdto-context-promisecommandmodel",level:4},{value:"<code>createTenantGroup(tenantGroupCode, dto, context): Promise&lt;CommandModel&gt;</code>",id:"createtenantgrouptenantgroupcode-dto-context-promisecommandmodel",level:4},{value:"<code>customizeSettingGroups(dto, context): Promise&lt;CommandModel&gt;</code>",id:"customizesettinggroupsdto-context-promisecommandmodel",level:4},{value:"Related Documentation",id:"related-documentation",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"multi-tenant-patterns",children:"Multi-Tenant Patterns"})}),"\n",(0,s.jsx)(n.p,{children:"This guide covers patterns for implementing multi-tenant applications with proper data isolation, shared resources, and cross-tenant operations."}),"\n",(0,s.jsx)(n.h2,{id:"when-to-use-this-guide",children:"When to Use This Guide"}),"\n",(0,s.jsx)(n.p,{children:"Use this guide when you need to:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Isolate data between tenants (customers/organizations)"}),"\n",(0,s.jsx)(n.li,{children:"Share common data across all tenants"}),"\n",(0,s.jsx)(n.li,{children:"Allow users to belong to multiple tenants"}),"\n",(0,s.jsx)(n.li,{children:"Implement tenant-specific configuration"}),"\n",(0,s.jsx)(n.li,{children:"Sync data between tenants"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"multi-tenant-architecture",children:"Multi-Tenant Architecture"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Application                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                  \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502   \u2502  Tenant A   \u2502   \u2502  Tenant B   \u2502   \u2502   Common    \u2502           \u2502\n\u2502   \u2502  PK: X#A    \u2502   \u2502  PK: X#B    \u2502   \u2502  PK: X#common\u2502          \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502          \u2502                 \u2502                  \u2502                  \u2502\n\u2502          \u25bc                 \u25bc                  \u25bc                  \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502                    DynamoDB Table                        \u2502   \u2502\n\u2502   \u2502  PK: ENTITY#tenantCode  |  SK: identifier                \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"tenant-context",children:"Tenant Context"}),"\n",(0,s.jsx)(n.admonition,{title:"Tenant Code Normalization",type:"info",children:(0,s.jsxs)(n.p,{children:["All tenant codes returned by ",(0,s.jsx)(n.code,{children:"getUserContext()"})," are normalized to lowercase. This means ",(0,s.jsx)(n.code,{children:"TenantA"}),", ",(0,s.jsx)(n.code,{children:"TENANTA"}),", and ",(0,s.jsx)(n.code,{children:"tenanta"})," are all treated as ",(0,s.jsx)(n.code,{children:"tenanta"}),". When defining tenant codes in Cognito custom claims or HTTP headers, the case doesn't matter - internally they are always lowercase for consistent matching."]})}),"\n",(0,s.jsx)(n.h3,{id:"extracting-tenant-context",children:"Extracting Tenant Context"}),"\n",(0,s.jsx)(n.p,{children:"Create a helper to extract tenant information from invoke context:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// helpers/context.ts\nimport { IInvoke, getUserContext } from '@mbc-cqrs-serverless/core';\n\nexport interface CustomUserContext {\n  tenantCode: string;\n  userCode: string;\n  userId: string;\n  email?: string;\n  role?: string;\n}\n\n/**\n * Get custom user context from invoke context\n */\nexport function getCustomUserContext(invokeContext: IInvoke): CustomUserContext {\n  const userContext = getUserContext(invokeContext);\n\n  return {\n    tenantCode: userContext.tenantCode || DEFAULT_TENANT_CODE,\n    userCode: userContext.userCode || '',\n    userId: userContext.userId || '',\n    email: userContext.email,\n    role: userContext['custom:role'],\n  };\n}\n\n/**\n * Tenant code for shared/common data across all tenants\n * Use this for master data, settings, and resources shared by all tenants\n */\nexport const TENANT_COMMON = 'common';\n\n/**\n * Default tenant code when no tenant is specified\n * Used in single-tenant mode or when tenant context is not available\n */\nexport const DEFAULT_TENANT_CODE = 'single';\n"})}),"\n",(0,s.jsxs)(n.admonition,{title:"Important: COMMON Constant in Master and Tenant Modules",type:"warning",children:[(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"@mbc-cqrs-serverless/master"})," and ",(0,s.jsx)(n.code,{children:"@mbc-cqrs-serverless/tenant"})," packages define an internal constant ",(0,s.jsx)(n.code,{children:"'COMMON'"})," (uppercase) for the common tenant code."]}),(0,s.jsxs)(n.p,{children:["When using these modules' built-in methods (e.g., ",(0,s.jsx)(n.code,{children:"createCommonTenantSetting"}),", ",(0,s.jsx)(n.code,{children:"createCommonTenant"}),"), they automatically use this ",(0,s.jsx)(n.code,{children:"'COMMON'"})," value internally for data storage."]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// {{In @mbc-cqrs-serverless/master and @mbc-cqrs-serverless/tenant}}\nexport enum SettingTypeEnum {\n  TENANT_COMMON = 'COMMON',  // Internal constant for data storage\n}\n"})}),(0,s.jsxs)(n.p,{children:["Note: Even though the stored value is ",(0,s.jsx)(n.code,{children:"'COMMON'"}),", when you send ",(0,s.jsx)(n.code,{children:"x-tenant-code: COMMON"})," in HTTP headers, ",(0,s.jsx)(n.code,{children:"getUserContext()"})," returns ",(0,s.jsx)(n.code,{children:"'common'"})," (lowercase) due to normalization. For custom implementations, use lowercase ",(0,s.jsx)(n.code,{children:"'common'"})," for consistency with the normalized tenant codes."]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"\n/**\n * Check if user has access to tenant\n */\nexport function hasTenantAccess(\n  userContext: CustomUserContext,\n  targetTenantCode: string,\n): boolean {\n  // System admin can access all tenants\n  if (userContext.role === 'SYSTEM_ADMIN') {\n    return true;\n  }\n\n  // User can only access their own tenant\n  return userContext.tenantCode === targetTenantCode;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"tenant-guard",children:"Tenant Guard"}),"\n",(0,s.jsx)(n.p,{children:"Implement a guard to enforce tenant access:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// guards/tenant.guard.ts\nimport {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { getCustomUserContext, hasTenantAccess } from '../helpers/context';\n\n@Injectable()\nexport class TenantGuard implements CanActivate {\n  canActivate(context: ExecutionContext): boolean {\n    const request = context.switchToHttp().getRequest();\n    const invokeContext = request.invokeContext;\n    const userContext = getCustomUserContext(invokeContext);\n\n    // Get target tenant from path or body\n    const targetTenant = request.params.tenantCode ||\n                        request.body?.tenantCode ||\n                        this.extractTenantFromPk(request.body?.pk);\n\n    if (!targetTenant) {\n      return true; // No tenant specified, will use user's tenant\n    }\n\n    if (!hasTenantAccess(userContext, targetTenant)) {\n      throw new ForbiddenException(\n        `Access denied to tenant: ${targetTenant}`,\n      );\n    }\n\n    return true;\n  }\n\n  private extractTenantFromPk(pk: string | undefined): string | undefined {\n    if (!pk) return undefined;\n    const parts = pk.split('#');\n    return parts.length >= 2 ? parts[1] : undefined;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"data-isolation-patterns",children:"Data Isolation Patterns"}),"\n",(0,s.jsx)(n.h3,{id:"pattern-1-tenant-in-partition-key",children:"Pattern 1: Tenant in Partition Key"}),"\n",(0,s.jsx)(n.p,{children:"Include tenant code in the partition key for complete isolation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Standard tenant isolation pattern\n\nconst PRODUCT_PK_PREFIX = 'PRODUCT';\n\nfunction generateProductPk(tenantCode: string): string {\n  return `${PRODUCT_PK_PREFIX}${KEY_SEPARATOR}${tenantCode}`;\n}\n\n// Example keys:\n// PK: PRODUCT#tenant-a\n// SK: 01HX7MBJK3V9WQBZ7XNDK5ZT2M\n\n// Query all products for a tenant\nasync function listProductsByTenant(tenantCode: string) {\n  const pk = generateProductPk(tenantCode);\n  return dataService.listItemsByPk(pk);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"pattern-2-common-tenant-for-shared-data",children:"Pattern 2: Common Tenant for Shared Data"}),"\n",(0,s.jsx)(n.p,{children:"Use a common tenant code for data shared across all tenants:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Shared data pattern for master data and configurations\n\nconst COMMON_TENANT = 'common';\n\n// System-wide settings\nconst settingsPk = `SETTINGS${KEY_SEPARATOR}${COMMON_TENANT}`;\n\n// User data (users can belong to multiple tenants)\nconst userPk = `USER${KEY_SEPARATOR}${COMMON_TENANT}`;\n\n// Example: Get system-wide email templates\nasync function getEmailTemplates() {\n  return dataService.listItemsByPk(`TEMPLATE${KEY_SEPARATOR}${COMMON_TENANT}`);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"pattern-3-user-tenant-association",children:"Pattern 3: User-Tenant Association"}),"\n",(0,s.jsx)(n.p,{children:"Handle users belonging to multiple tenants:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// user/dto/user-tenant.dto.ts\nexport interface UserTenantAssociation {\n  pk: string;           // USER_TENANT#common\n  sk: string;           // {tenantCode}#{userCode}\n  tenantCode: string;\n  userCode: string;\n  role: string;         // Role within this tenant\n  isDefault: boolean;   // Default tenant for user\n}\n\n// user/user.service.ts\n@Injectable()\nexport class UserService {\n  /**\n   * Get all tenants a user belongs to\n   */\n  async getUserTenants(userCode: string): Promise<UserTenantAssociation[]> {\n    const pk = `USER_TENANT${KEY_SEPARATOR}${COMMON_TENANT}`;\n\n    // Query with SK prefix to find all tenant associations\n    const result = await this.dataService.listItemsByPk(pk, {\n      skPrefix: '', // Get all, then filter\n    });\n\n    return result.items.filter(item =>\n      item.sk.endsWith(`${KEY_SEPARATOR}${userCode}`),\n    );\n  }\n\n  /**\n   * Add user to tenant\n   */\n  async addUserToTenant(\n    userCode: string,\n    tenantCode: string,\n    role: string,\n    invokeContext: IInvoke,\n  ): Promise<void> {\n    const pk = `USER_TENANT${KEY_SEPARATOR}${COMMON_TENANT}`;\n    const sk = `${tenantCode}${KEY_SEPARATOR}${userCode}`;\n\n    await this.commandService.publishSync({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode: COMMON_TENANT,\n      code: `${tenantCode}-${userCode}`,\n      name: `User ${userCode} in ${tenantCode}`,\n      type: 'USER_TENANT',\n      attributes: {\n        userCode,\n        tenantCode,\n        role,\n        isDefault: false,\n      },\n    }, { invokeContext });\n  }\n\n  /**\n   * Switch user's active tenant\n   */\n  async switchTenant(\n    userCode: string,\n    newTenantCode: string,\n    invokeContext: IInvoke,\n  ): Promise<{ token: string }> {\n    // Verify user belongs to tenant\n    const associations = await this.getUserTenants(userCode);\n    const association = associations.find(a =>\n      a.attributes.tenantCode === newTenantCode,\n    );\n\n    if (!association) {\n      throw new ForbiddenException(\n        `User does not belong to tenant: ${newTenantCode}`,\n      );\n    }\n\n    // Generate new token with updated tenant context\n    return this.authService.generateToken({\n      userCode,\n      tenantCode: newTenantCode,\n      role: association.attributes.role,\n    });\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"cross-tenant-operations",children:"Cross-Tenant Operations"}),"\n",(0,s.jsx)(n.h3,{id:"pattern-1-data-sync-between-tenants",children:"Pattern 1: Data Sync Between Tenants"}),"\n",(0,s.jsx)(n.p,{children:"Sync data from one tenant to another (e.g., master data distribution):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// sync/tenant-sync.service.ts\n@Injectable()\nexport class TenantSyncService {\n  private readonly logger = new Logger(TenantSyncService.name);\n\n  constructor(\n    private readonly commandService: CommandService,\n    private readonly dataService: DataService,\n  ) {}\n\n  /**\n   * Sync master data from source to target tenants\n   */\n  async syncMasterData(\n    sourceTenantCode: string,\n    targetTenantCodes: string[],\n    entityType: string,\n    invokeContext: IInvoke,\n  ): Promise<{ synced: number; errors: string[] }> {\n    const sourcePk = `${entityType}${KEY_SEPARATOR}${sourceTenantCode}`;\n    const sourceData = await this.dataService.listItemsByPk(sourcePk);\n\n    let synced = 0;\n    const errors: string[] = [];\n\n    for (const targetTenant of targetTenantCodes) {\n      for (const item of sourceData.items) {\n        try {\n          await this.syncItem(item, targetTenant, invokeContext);\n          synced++;\n        } catch (error) {\n          errors.push(`Failed to sync ${item.id} to ${targetTenant}: ${error.message}`);\n        }\n      }\n    }\n\n    this.logger.log(`Synced ${synced} items to ${targetTenantCodes.length} tenants`);\n    return { synced, errors };\n  }\n\n  private async syncItem(\n    sourceItem: any,\n    targetTenantCode: string,\n    invokeContext: IInvoke,\n  ): Promise<void> {\n    // Create new keys for target tenant\n    const pkParts = sourceItem.pk.split(KEY_SEPARATOR);\n    const entityType = pkParts[0];\n    const targetPk = `${entityType}${KEY_SEPARATOR}${targetTenantCode}`;\n    const targetId = generateId(targetPk, sourceItem.sk);\n\n    await this.commandService.publishSync({\n      pk: targetPk,\n      sk: sourceItem.sk,\n      id: targetId,\n      tenantCode: targetTenantCode,\n      code: sourceItem.code,\n      name: sourceItem.name,\n      type: sourceItem.type,\n      attributes: sourceItem.attributes,\n      // Mark as synced from source\n      metadata: {\n        syncedFrom: sourceItem.id,\n        syncedAt: new Date().toISOString(),\n      },\n    }, { invokeContext });\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"pattern-2-cross-tenant-reporting",children:"Pattern 2: Cross-Tenant Reporting"}),"\n",(0,s.jsx)(n.p,{children:"Aggregate data across tenants for reporting:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// reporting/cross-tenant-report.service.ts\n@Injectable()\nexport class CrossTenantReportService {\n  constructor(private readonly prismaService: PrismaService) {}\n\n  /**\n   * Get aggregated metrics across all tenants\n   */\n  async getSystemMetrics(): Promise<SystemMetrics> {\n    const [totalProducts, productsByTenant, recentOrders] = await Promise.all([\n      // Total count across all tenants\n      this.prismaService.product.count({\n        where: { isDeleted: false },\n      }),\n\n      // Count by tenant\n      this.prismaService.product.groupBy({\n        by: ['tenantCode'],\n        _count: { id: true },\n        where: { isDeleted: false },\n      }),\n\n      // Recent orders across all tenants (admin only)\n      this.prismaService.order.findMany({\n        where: { isDeleted: false },\n        orderBy: { createdAt: 'desc' },\n        take: 100,\n      }),\n    ]);\n\n    return {\n      totalProducts,\n      productsByTenant: productsByTenant.map(t => ({\n        tenantCode: t.tenantCode,\n        count: t._count.id,\n      })),\n      recentOrdersCount: recentOrders.length,\n    };\n  }\n\n  /**\n   * Get tenant-specific metrics\n   */\n  async getTenantMetrics(tenantCode: string): Promise<TenantMetrics> {\n    const [products, orders, users] = await Promise.all([\n      this.prismaService.product.count({\n        where: { tenantCode, isDeleted: false },\n      }),\n      this.prismaService.order.count({\n        where: { tenantCode, isDeleted: false },\n      }),\n      this.prismaService.user.count({\n        where: { tenantCode, isDeleted: false },\n      }),\n    ]);\n\n    return { tenantCode, products, orders, users };\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"tenant-configuration",children:"Tenant Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"tenant-settings-pattern",children:"Tenant Settings Pattern"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// tenant/tenant-settings.service.ts\n@Injectable()\nexport class TenantSettingsService {\n  private readonly settingsCache = new Map<string, TenantSettings>();\n\n  constructor(\n    private readonly dataService: DataService,\n    private readonly commandService: CommandService,\n  ) {}\n\n  /**\n   * Get tenant settings with caching\n   */\n  async getSettings(tenantCode: string): Promise<TenantSettings> {\n    // Check cache first\n    if (this.settingsCache.has(tenantCode)) {\n      return this.settingsCache.get(tenantCode)!;\n    }\n\n    const pk = `SETTINGS${KEY_SEPARATOR}${tenantCode}`;\n    const sk = 'config';\n\n    try {\n      const settings = await this.dataService.getItem({ pk, sk });\n      this.settingsCache.set(tenantCode, settings.attributes);\n      return settings.attributes;\n    } catch (error) {\n      // Return default settings if not found\n      return this.getDefaultSettings();\n    }\n  }\n\n  /**\n   * Update tenant settings\n   */\n  async updateSettings(\n    tenantCode: string,\n    settings: Partial<TenantSettings>,\n    invokeContext: IInvoke,\n  ): Promise<TenantSettings> {\n    const currentSettings = await this.getSettings(tenantCode);\n    const mergedSettings = { ...currentSettings, ...settings };\n\n    const pk = `SETTINGS${KEY_SEPARATOR}${tenantCode}`;\n    const sk = 'config';\n\n    await this.commandService.publishSync({\n      pk,\n      sk,\n      id: generateId(pk, sk),\n      tenantCode,\n      code: 'config',\n      name: 'Tenant Configuration',\n      type: 'SETTINGS',\n      attributes: mergedSettings,\n    }, { invokeContext });\n\n    // Invalidate cache\n    this.settingsCache.delete(tenantCode);\n\n    return mergedSettings;\n  }\n\n  private getDefaultSettings(): TenantSettings {\n    return {\n      timezone: 'Asia/Tokyo',\n      locale: 'ja',\n      dateFormat: 'YYYY-MM-DD',\n      currency: 'JPY',\n      features: {\n        exportEnabled: true,\n        importEnabled: true,\n        apiEnabled: true,\n      },\n    };\n  }\n}\n\nexport interface TenantSettings {\n  timezone: string;\n  locale: string;\n  dateFormat: string;\n  currency: string;\n  features: {\n    exportEnabled: boolean;\n    importEnabled: boolean;\n    apiEnabled: boolean;\n  };\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"prisma-multi-tenant-schema",children:"Prisma Multi-Tenant Schema"}),"\n",(0,s.jsx)(n.h3,{id:"rds-schema-for-multi-tenant",children:"RDS Schema for Multi-Tenant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-prisma",children:'// prisma/schema.prisma\n\n// Base fields for all entities\nmodel Product {\n  id         String   @id\n  pk         String\n  sk         String\n  tenantCode String   // Tenant isolation field\n\n  code       String\n  name       String\n  attributes Json?\n\n  version    Int\n  isDeleted  Boolean  @default(false)\n  createdAt  DateTime\n  createdBy  String   @default("")\n  updatedAt  DateTime\n  updatedBy  String   @default("")\n\n  // Unique constraint includes tenant\n  @@unique([tenantCode, code])\n  @@unique([pk, sk])\n\n  // Index for tenant queries\n  @@index([tenantCode])\n  @@index([tenantCode, name])\n  @@index([tenantCode, createdAt])\n}\n\n// User-Tenant association\nmodel UserTenant {\n  id         String   @id\n  pk         String\n  sk         String\n\n  userCode   String\n  tenantCode String\n  role       String\n  isDefault  Boolean  @default(false)\n\n  createdAt  DateTime\n  updatedAt  DateTime\n\n  @@unique([userCode, tenantCode])\n  @@index([userCode])\n  @@index([tenantCode])\n}\n\n// Tenant settings\nmodel TenantSettings {\n  id         String   @id\n  tenantCode String   @unique\n  settings   Json\n\n  createdAt  DateTime\n  updatedAt  DateTime\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"1-always-include-tenant-in-queries",children:"1. Always Include Tenant in Queries"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Good: Tenant-scoped query\nconst products = await prismaService.product.findMany({\n  where: {\n    tenantCode,\n    isDeleted: false,\n  },\n});\n\n// Bad: Missing tenant scope (data leak risk)\nconst products = await prismaService.product.findMany({\n  where: { isDeleted: false },\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-validate-tenant-access",children:"2. Validate Tenant Access"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Always verify tenant access before operations\nasync updateProduct(\n  productId: string,\n  updateDto: UpdateProductDto,\n  invokeContext: IInvoke,\n): Promise<ProductDataEntity> {\n  const { tenantCode } = getCustomUserContext(invokeContext);\n\n  // Verify product belongs to user's tenant\n  const existing = await this.prismaService.product.findUnique({\n    where: { id: productId },\n  });\n\n  if (existing?.tenantCode !== tenantCode) {\n    throw new ForbiddenException('Access denied');\n  }\n\n  // Proceed with update\n  return this.publishCommand(updateDto, invokeContext);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-tenant-aware-logging",children:"3. Tenant-Aware Logging"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Include tenant in all logs for debugging\nthis.logger.log({\n  message: 'Processing order',\n  tenantCode,\n  orderId,\n  userId: userContext.userId,\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-separate-system-and-tenant-operations",children:"4. Separate System and Tenant Operations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Use separate endpoints for system-wide vs tenant operations\n\n@Controller('api/admin/tenants')\n@UseGuards(SystemAdminGuard)\nexport class TenantAdminController {\n  // System admin operations across tenants\n}\n\n@Controller('api/products')\n@UseGuards(TenantGuard)\nexport class ProductController {\n  // Tenant-scoped operations\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"tenantmodule-api-reference",children:"TenantModule API Reference"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"@mbc-cqrs-serverless/tenant"})," module provides ready-to-use tenant management functionality."]}),"\n",(0,s.jsx)(n.h3,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm install @mbc-cqrs-serverless/tenant\n"})}),"\n",(0,s.jsx)(n.h3,{id:"module-registration",children:"Module Registration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { TenantModule } from '@mbc-cqrs-serverless/tenant';\n\n@Module({\n  imports: [\n    TenantModule.register({\n      enableController: true,\n      dataSyncHandlers: [TenantRdsSyncHandler], // Optional: sync to external systems\n    }),\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"module-options",children:"Module Options"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Option"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"enableController"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"boolean"})}),(0,s.jsx)(n.td,{children:"Enable REST endpoints for tenant CRUD operations"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"dataSyncHandlers"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Type<IDataSyncHandler>[]"})}),(0,s.jsx)(n.td,{children:"Optional handlers to sync tenant data to external systems (e.g., RDS)"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"tenantservice-methods",children:"TenantService Methods"}),"\n",(0,s.jsx)(n.h4,{id:"gettenantkey-detailkey-promisedatamodel",children:(0,s.jsx)(n.code,{children:"getTenant(key: DetailKey): Promise<DataModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Retrieves tenant details based on the given key."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.getTenant({\n  pk: 'TENANT#mbc',\n  sk: 'MASTER',\n});\n"})}),"\n",(0,s.jsx)(n.h4,{id:"createcommontenantdto-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"createCommonTenant(dto, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Creates a common tenant that is shared across the entire system."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.createCommonTenant({\n  name: 'Common',\n  description: 'Shared tenant for common data',\n}, { invokeContext });\n"})}),"\n",(0,s.jsx)(n.h4,{id:"createtenantdto-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"createTenant(dto, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Creates a tenant for an individual entity."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.createTenant({\n  name: 'MBC tenant',\n  code: 'mbc',\n  description: 'Main business tenant',\n}, { invokeContext });\n"})}),"\n",(0,s.jsx)(n.h4,{id:"updatetenantkey-dto-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"updateTenant(key, dto, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Updates an existing tenant's details."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const tenant = await tenantService.updateTenant(\n  { pk: 'TENANT#mbc', sk: 'MASTER' },\n  { name: 'Updated MBC tenant', description: 'Updated description' },\n  { invokeContext },\n);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"deletetenantkey-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"deleteTenant(key, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Deletes a tenant based on the provided key."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"await tenantService.deleteTenant(\n  { pk: 'TENANT#mbc', sk: 'MASTER' },\n  { invokeContext },\n);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"addtenantgroupdto-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"addTenantGroup(dto, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Adds a group to a specific tenant."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"await tenantService.addTenantGroup({\n  tenantCode: 'abc',\n  groupId: '19',\n  role: 'company',\n}, { invokeContext });\n"})}),"\n",(0,s.jsx)(n.h4,{id:"createtenantgrouptenantgroupcode-dto-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"createTenantGroup(tenantGroupCode, dto, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Creates a tenant within a specific tenant group."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"await tenantService.createTenantGroup(\n  'group-001',\n  {\n    code: 'mbc',\n    name: 'MBC Tenant',\n    description: 'Tenant in group-001',\n  },\n  { invokeContext },\n);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"customizesettinggroupsdto-context-promisecommandmodel",children:(0,s.jsx)(n.code,{children:"customizeSettingGroups(dto, context): Promise<CommandModel>"})}),"\n",(0,s.jsx)(n.p,{children:"Customizes the settings of groups associated with a tenant."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"await tenantService.customizeSettingGroups({\n  tenantCode: 'mbc',\n  settingGroups: ['19', '20'],\n  role: 'company',\n}, { invokeContext });\n"})}),"\n",(0,s.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./backend-development",children:"Backend Development Guide"})," - Core patterns"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./key-patterns",children:"Key Patterns"})," - PK/SK design for multi-tenant"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./authentication",children:"Authentication"})," - User authentication"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var a=t(6540);const s={},r=a.createContext(s);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);