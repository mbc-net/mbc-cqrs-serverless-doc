"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[8622],{4433:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"architecture/cdk-infrastructure","title":"CDK Infrastructure","description":"Learn about AWS CDK infrastructure provisioning and system architecture in the MBC CQRS Serverless framework.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/architecture/cdk-infrastructure.md","sourceDirName":"architecture","slug":"/architecture/cdk-infrastructure","permalink":"/docs/architecture/cdk-infrastructure","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"description":"Learn about AWS CDK infrastructure provisioning and system architecture in the MBC CQRS Serverless framework."},"sidebar":"tutorialSidebar","previous":{"title":"UI Setting","permalink":"/docs/ui-setting"},"next":{"title":"Step Functions","permalink":"/docs/architecture/step-functions"}}');var i=t(4848),s=t(8453);const r={sidebar_position:5,description:"Learn about AWS CDK infrastructure provisioning and system architecture in the MBC CQRS Serverless framework."},o="CDK Infrastructure",c={},l=[{value:"System Architecture Overview",id:"system-architecture-overview",level:2},{value:"AWS Resources Created",id:"aws-resources-created",level:2},{value:"Authentication (Cognito)",id:"authentication-cognito",level:3},{value:"API Gateway",id:"api-gateway",level:3},{value:"Lambda Function",id:"lambda-function",level:3},{value:"SNS and SQS (Event-Driven Messaging)",id:"sns-and-sqs-event-driven-messaging",level:3},{value:"S3 Buckets",id:"s3-buckets",level:3},{value:"CloudFront Distributions",id:"cloudfront-distributions",level:3},{value:"AppSync (GraphQL API)",id:"appsync-graphql-api",level:3},{value:"Step Functions State Machines",id:"step-functions-state-machines",level:3},{value:"DynamoDB Event Sources",id:"dynamodb-event-sources",level:3},{value:"Environment Configuration",id:"environment-configuration",level:2},{value:"Configuration Structure",id:"configuration-structure",level:3},{value:"Environment Examples",id:"environment-examples",level:3},{value:"IAM Permissions",id:"iam-permissions",level:2},{value:"Deployment Outputs",id:"deployment-outputs",level:2},{value:"CI/CD Pipeline",id:"cicd-pipeline",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Security",id:"security",level:3},{value:"Performance",id:"performance",level:3},{value:"Monitoring",id:"monitoring",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"cdk-infrastructure",children:"CDK Infrastructure"})}),"\n",(0,i.jsx)(e.p,{children:"This document describes the AWS infrastructure provisioned by the MBC CQRS Serverless framework using AWS CDK. Understanding this architecture helps you customize deployments and troubleshoot issues."}),"\n",(0,i.jsx)(e.h2,{id:"system-architecture-overview",children:"System Architecture Overview"}),"\n",(0,i.jsx)(e.p,{children:"The following diagram shows the complete AWS infrastructure created by the framework:"}),"\n",(0,i.jsx)(e.mermaid,{value:'flowchart TB\n    subgraph Internet\n        Client[Client Applications]\n    end\n\n    subgraph CDN["Content Delivery"]\n        CF_API[CloudFront<br/>API Distribution]\n        CF_Static[CloudFront<br/>Static Assets]\n    end\n\n    subgraph Auth["Authentication"]\n        Cognito[Cognito User Pool]\n        CognitoClient[User Pool Client]\n    end\n\n    subgraph API["API Layer"]\n        APIGW[API Gateway<br/>HTTP API]\n        AppSync[AppSync<br/>GraphQL API]\n    end\n\n    subgraph Compute["Compute Layer"]\n        Lambda[Lambda Function<br/>NestJS Application]\n        Layer[Lambda Layer<br/>Dependencies]\n    end\n\n    subgraph Orchestration["Workflow Orchestration"]\n        SFN_Cmd[Command Handler<br/>State Machine]\n        SFN_Task[Task Handler<br/>State Machine]\n        SFN_Import[Import CSV<br/>State Machine]\n    end\n\n    subgraph Messaging["Event-Driven Messaging"]\n        SNS_Main[SNS Main Topic]\n        SNS_Alarm[SNS Alarm Topic]\n        SQS_Task[Task Queue]\n        SQS_Notify[Notification Queue]\n        SQS_SubTask[Sub-Task Queue]\n        SQS_Import[Import Queue]\n        SQS_DLQ[Dead Letter Queue]\n    end\n\n    subgraph Storage["Data Storage"]\n        DDB[(DynamoDB<br/>Event Store)]\n        S3_Data[(S3 DDB Bucket)]\n        S3_Public[(S3 Public Bucket)]\n        RDS[(RDS Aurora<br/>PostgreSQL)]\n    end\n\n    subgraph Streams["Change Data Capture"]\n        DDB_Stream[DynamoDB Streams]\n    end\n\n    subgraph Network["Network"]\n        VPC[VPC]\n        Subnets[Private Subnets]\n        SG[Security Groups]\n    end\n\n    subgraph Monitoring["Observability"]\n        CW_Logs[CloudWatch Logs]\n        XRay[X-Ray Tracing]\n        CW_Alarms[CloudWatch Alarms]\n    end\n\n    Client --\x3e CF_API\n    Client --\x3e CF_Static\n    CF_API --\x3e APIGW\n    CF_Static --\x3e S3_Public\n\n    APIGW --\x3e Cognito\n    APIGW --\x3e Lambda\n    AppSync --\x3e Lambda\n\n    Lambda --\x3e Layer\n    Lambda --\x3e DDB\n    Lambda --\x3e S3_Data\n    Lambda --\x3e RDS\n    Lambda --\x3e SNS_Main\n    Lambda --\x3e SFN_Cmd\n    Lambda --\x3e SFN_Task\n    Lambda --\x3e SFN_Import\n\n    SNS_Main --\x3e SQS_Task\n    SNS_Main --\x3e SQS_Notify\n    SNS_Main --\x3e SQS_SubTask\n    SNS_Main --\x3e SQS_Import\n    SNS_Alarm --\x3e SQS_DLQ\n\n    SQS_Task --\x3e Lambda\n    SQS_Notify --\x3e Lambda\n    SQS_SubTask --\x3e Lambda\n    SQS_Import --\x3e Lambda\n\n    DDB --\x3e DDB_Stream\n    DDB_Stream --\x3e Lambda\n\n    SFN_Cmd --\x3e Lambda\n    SFN_Task --\x3e Lambda\n    SFN_Import --\x3e Lambda\n    SFN_Import --\x3e S3_Data\n\n    Lambda --\x3e VPC\n    VPC --\x3e Subnets\n    Subnets --\x3e SG\n\n    Lambda --\x3e CW_Logs\n    Lambda --\x3e XRay\n    SFN_Cmd --\x3e CW_Logs\n    SFN_Task --\x3e CW_Logs\n    SFN_Import --\x3e CW_Logs'}),"\n",(0,i.jsx)(e.h2,{id:"aws-resources-created",children:"AWS Resources Created"}),"\n",(0,i.jsx)(e.h3,{id:"authentication-cognito",children:"Authentication (Cognito)"}),"\n",(0,i.jsx)(e.p,{children:"Amazon Cognito provides user authentication and authorization:"}),"\n",(0,i.jsx)(e.mermaid,{value:"flowchart LR\n    subgraph Cognito\n        UP[User Pool]\n        UPC[User Pool Client]\n        CustomAttrs[Custom Attributes]\n    end\n\n    subgraph Attributes\n        tenant[tenant]\n        company[company_code]\n        member[member_id]\n        roles[roles]\n    end\n\n    UP --\x3e UPC\n    UP --\x3e CustomAttrs\n    CustomAttrs --\x3e tenant\n    CustomAttrs --\x3e company\n    CustomAttrs --\x3e member\n    CustomAttrs --\x3e roles"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as cognito from 'aws-cdk-lib/aws-cognito';\n\n// Create User Pool\nconst userPool = new cognito.UserPool(this, 'UserPool', {\n  userPoolName: `${env}-${appName}-user-pool`,\n  selfSignUpEnabled: false,\n  signInAliases: {\n    username: true,\n    preferredUsername: true,\n  },\n  passwordPolicy: {\n    minLength: 6,\n    requireLowercase: false,\n    requireUppercase: false,\n    requireDigits: false,\n    requireSymbols: false,\n  },\n  mfa: cognito.Mfa.OFF,\n  accountRecovery: cognito.AccountRecovery.NONE,\n  deletionProtection: true,\n  customAttributes: {\n    tenant: new cognito.StringAttribute({ maxLen: 50, mutable: true }),\n    company_code: new cognito.StringAttribute({ maxLen: 50, mutable: true }),\n    member_id: new cognito.StringAttribute({ maxLen: 2024, mutable: true }),\n    roles: new cognito.StringAttribute({ mutable: true }),\n  },\n});\n\n// Create User Pool Client\nconst userPoolClient = userPool.addClient('UserPoolClient', {\n  authFlows: {\n    userPassword: true,\n    userSrp: true,\n  },\n});\n"})}),"\n",(0,i.jsx)(e.h3,{id:"api-gateway",children:"API Gateway"}),"\n",(0,i.jsx)(e.p,{children:"HTTP API provides RESTful endpoints with Cognito authorization:"}),"\n",(0,i.jsx)(e.mermaid,{value:'flowchart TB\n    subgraph Routes\n        Health["GET / (Public)"]\n        Event["POST /event/{proxy+} (IAM)"]\n        API["* /{proxy+} (Cognito)"]\n    end\n\n    subgraph Authorization\n        NoAuth[No Auth]\n        IAMAuth[IAM Authorizer]\n        CognitoAuth[Cognito Authorizer]\n    end\n\n    Health --\x3e NoAuth\n    Event --\x3e IAMAuth\n    API --\x3e CognitoAuth'}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as apigatewayv2 from 'aws-cdk-lib/aws-apigatewayv2';\nimport * as apigatewayv2Integrations from 'aws-cdk-lib/aws-apigatewayv2-integrations';\nimport * as apigatewayv2Authorizers from 'aws-cdk-lib/aws-apigatewayv2-authorizers';\n\n// Create HTTP API\nconst httpApi = new apigatewayv2.HttpApi(this, 'HttpApi', {\n  apiName: `${env}-${appName}-api`,\n  corsPreflight: {\n    allowOrigins: ['*'],\n    allowMethods: [apigatewayv2.CorsHttpMethod.ANY],\n    allowHeaders: ['*'],\n    maxAge: cdk.Duration.hours(1),\n  },\n});\n\n// Lambda integration\nconst lambdaIntegration = new apigatewayv2Integrations.HttpLambdaIntegration(\n  'LambdaIntegration',\n  lambdaFunction\n);\n\n// Cognito authorizer\nconst cognitoAuthorizer = new apigatewayv2Authorizers.HttpUserPoolAuthorizer(\n  'CognitoAuthorizer',\n  userPool,\n  { userPoolClients: [userPoolClient] }\n);\n\n// Public health check route\nhttpApi.addRoutes({\n  path: '/',\n  methods: [apigatewayv2.HttpMethod.GET],\n  integration: lambdaIntegration,\n});\n\n// Protected API routes\nhttpApi.addRoutes({\n  path: '/{proxy+}',\n  methods: [\n    apigatewayv2.HttpMethod.GET,\n    apigatewayv2.HttpMethod.POST,\n    apigatewayv2.HttpMethod.PUT,\n    apigatewayv2.HttpMethod.DELETE,\n    apigatewayv2.HttpMethod.PATCH,\n  ],\n  integration: lambdaIntegration,\n  authorizer: cognitoAuthorizer,\n});\n"})}),"\n",(0,i.jsx)(e.h3,{id:"lambda-function",children:"Lambda Function"}),"\n",(0,i.jsx)(e.p,{children:"The main compute layer runs your NestJS application:"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as lambda from 'aws-cdk-lib/aws-lambda';\n\n// Create Lambda Layer for dependencies\nconst lambdaLayer = new lambda.LayerVersion(this, 'MainLayer', {\n  layerVersionName: `${env}-${appName}-main-layer`,\n  code: lambda.Code.fromAsset('dist_layer'),\n  compatibleRuntimes: [lambda.Runtime.NODEJS_20_X],\n  compatibleArchitectures: [lambda.Architecture.ARM_64],\n});\n\n// Create Lambda Function\nconst lambdaFunction = new lambda.Function(this, 'LambdaApi', {\n  functionName: `${env}-${appName}-lambda-api`,\n  runtime: lambda.Runtime.NODEJS_20_X,\n  architecture: lambda.Architecture.ARM_64,\n  handler: 'main.handler',\n  code: lambda.Code.fromAsset('dist'),\n  memorySize: 512,\n  timeout: cdk.Duration.seconds(30),\n  layers: [lambdaLayer],\n  tracing: lambda.Tracing.ACTIVE,\n  loggingFormat: lambda.LoggingFormat.JSON,\n  vpc: vpc,\n  vpcSubnets: { subnets: privateSubnets },\n  securityGroups: securityGroups,\n  environment: {\n    NODE_OPTIONS: '--enable-source-maps',\n    TZ: 'Asia/Tokyo',\n    NODE_ENV: env,\n    APP_NAME: appName,\n    LOG_LEVEL: 'info',\n    S3_BUCKET_NAME: ddbBucket.bucketName,\n    SNS_TOPIC_ARN: mainSnsTopic.topicArn,\n    COGNITO_USER_POOL_ID: userPool.userPoolId,\n    DATABASE_URL: databaseUrl,\n  },\n});\n"})}),"\n",(0,i.jsx)(e.h3,{id:"sns-and-sqs-event-driven-messaging",children:"SNS and SQS (Event-Driven Messaging)"}),"\n",(0,i.jsx)(e.p,{children:"Message routing with filtering for different event types:"}),"\n",(0,i.jsx)(e.mermaid,{value:"flowchart TB\n    SNS[SNS Main Topic]\n\n    subgraph Filters\n        F1[\"action = 'task-execute'\"]\n        F2[\"action IN ['command-status', 'task-status']\"]\n        F3[\"action = 'sub-task-status'\"]\n        F4[\"action = 'import-execute'\"]\n    end\n\n    subgraph Queues\n        Q1[Task Queue]\n        Q2[Notification Queue]\n        Q3[Sub-Task Queue]\n        Q4[Import Queue]\n        DLQ[Dead Letter Queue]\n    end\n\n    SNS --\x3e F1 --\x3e Q1\n    SNS --\x3e F2 --\x3e Q2\n    SNS --\x3e F3 --\x3e Q3\n    SNS --\x3e F4 --\x3e Q4\n    Q1 -.->|Failed messages| DLQ"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as sns from 'aws-cdk-lib/aws-sns';\nimport * as sqs from 'aws-cdk-lib/aws-sqs';\nimport * as subscriptions from 'aws-cdk-lib/aws-sns-subscriptions';\n\n// Create SNS Topics\nconst mainSnsTopic = new sns.Topic(this, 'MainSnsTopic', {\n  topicName: `${env}-${appName}-main-sns`,\n});\n\nconst alarmSnsTopic = new sns.Topic(this, 'AlarmSnsTopic', {\n  topicName: `${env}-${appName}-alarm-sns`,\n});\n\n// Create Dead Letter Queue\nconst taskDlq = new sqs.Queue(this, 'TaskDLQ', {\n  queueName: `${env}-${appName}-task-dead-letter-queue`,\n});\n\n// Create Task Queue with DLQ\nconst taskQueue = new sqs.Queue(this, 'TaskQueue', {\n  queueName: `${env}-${appName}-task-action-queue`,\n  deadLetterQueue: {\n    queue: taskDlq,\n    maxReceiveCount: 5,\n  },\n});\n\n// Create Notification Queue\nconst notificationQueue = new sqs.Queue(this, 'NotificationQueue', {\n  queueName: `${env}-${appName}-notification-queue`,\n});\n\n// Create Import Queue\nconst importQueue = new sqs.Queue(this, 'ImportQueue', {\n  queueName: `${env}-${appName}-import-action-queue`,\n});\n\n// Subscribe queues with message filtering\nmainSnsTopic.addSubscription(\n  new subscriptions.SqsSubscription(taskQueue, {\n    filterPolicy: {\n      action: sns.SubscriptionFilter.stringFilter({\n        allowlist: ['task-execute'],\n      }),\n    },\n  })\n);\n\nmainSnsTopic.addSubscription(\n  new subscriptions.SqsSubscription(notificationQueue, {\n    filterPolicy: {\n      action: sns.SubscriptionFilter.stringFilter({\n        allowlist: ['command-status', 'task-status'],\n      }),\n    },\n    rawMessageDelivery: true,\n  })\n);\n\nmainSnsTopic.addSubscription(\n  new subscriptions.SqsSubscription(importQueue, {\n    filterPolicy: {\n      action: sns.SubscriptionFilter.stringFilter({\n        allowlist: ['import-execute'],\n      }),\n    },\n  })\n);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"s3-buckets",children:"S3 Buckets"}),"\n",(0,i.jsx)(e.p,{children:"Storage for application data and static assets:"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as s3 from 'aws-cdk-lib/aws-s3';\n\n// DynamoDB attributes bucket\nconst ddbBucket = new s3.Bucket(this, 'DdbAttributesBucket', {\n  bucketName: `${env}-${appName}-ddb-attributes`,\n  versioned: false,\n  blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,\n  removalPolicy: cdk.RemovalPolicy.DESTROY,\n  cors: [\n    {\n      allowedMethods: [\n        s3.HttpMethods.GET,\n        s3.HttpMethods.PUT,\n        s3.HttpMethods.POST,\n      ],\n      allowedOrigins: ['*'],\n      allowedHeaders: ['*'],\n      maxAge: 3000,\n    },\n  ],\n});\n\n// Public assets bucket\nconst publicBucket = new s3.Bucket(this, 'PublicBucket', {\n  bucketName: `${env}-${appName}-public`,\n  versioned: false,\n  blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,\n  removalPolicy: cdk.RemovalPolicy.DESTROY,\n});\n\n// Grant Lambda access\nddbBucket.grantReadWrite(lambdaFunction);\npublicBucket.grantReadWrite(lambdaFunction);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"cloudfront-distributions",children:"CloudFront Distributions"}),"\n",(0,i.jsx)(e.p,{children:"CDN for API and static assets with geo-restrictions:"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as cloudfront from 'aws-cdk-lib/aws-cloudfront';\nimport * as origins from 'aws-cdk-lib/aws-cloudfront-origins';\n\n// Origin Access Identity for S3\nconst oai = new cloudfront.OriginAccessIdentity(this, 'OAI');\npublicBucket.grantRead(oai);\n\n// Static assets distribution\nconst staticDistribution = new cloudfront.Distribution(this, 'StaticDistribution', {\n  defaultBehavior: {\n    origin: new origins.S3Origin(publicBucket, {\n      originAccessIdentity: oai,\n    }),\n    viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\n    cachePolicy: cloudfront.CachePolicy.CACHING_OPTIMIZED,\n    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD,\n  },\n  priceClass: cloudfront.PriceClass.PRICE_CLASS_200,\n  geoRestriction: cloudfront.GeoRestriction.allowlist('JP', 'VN'),\n});\n\n// API distribution\nconst apiDistribution = new cloudfront.Distribution(this, 'ApiDistribution', {\n  defaultBehavior: {\n    origin: new origins.HttpOrigin(httpApiDomain, {\n      customHeaders: {\n        'X-Origin-Verify': originVerifyToken,\n      },\n    }),\n    viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,\n    cachePolicy: cloudfront.CachePolicy.CACHING_DISABLED,\n    originRequestPolicy: cloudfront.OriginRequestPolicy.ALL_VIEWER_EXCEPT_HOST_HEADER,\n    responseHeadersPolicy: cloudfront.ResponseHeadersPolicy.CORS_ALLOW_ALL_ORIGINS,\n    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,\n  },\n  priceClass: cloudfront.PriceClass.PRICE_CLASS_200,\n  geoRestriction: cloudfront.GeoRestriction.allowlist('JP', 'VN'),\n});\n"})}),"\n",(0,i.jsx)(e.h3,{id:"appsync-graphql-api",children:"AppSync (GraphQL API)"}),"\n",(0,i.jsx)(e.p,{children:"Real-time GraphQL API with subscriptions:"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as appsync from 'aws-cdk-lib/aws-appsync';\n\n// Create AppSync API\nconst graphqlApi = new appsync.GraphqlApi(this, 'GraphqlApi', {\n  name: `${env}-${appName}-realtime`,\n  definition: appsync.Definition.fromFile('asset/schema.graphql'),\n  authorizationConfig: {\n    defaultAuthorization: {\n      authorizationType: appsync.AuthorizationType.API_KEY,\n      apiKeyConfig: {\n        expires: cdk.Expiration.after(cdk.Duration.days(365)),\n      },\n    },\n    additionalAuthorizationModes: [\n      { authorizationType: appsync.AuthorizationType.IAM },\n      {\n        authorizationType: appsync.AuthorizationType.USER_POOL,\n        userPoolConfig: { userPool },\n      },\n    ],\n  },\n  xrayEnabled: true,\n});\n\n// None data source for local resolvers\nconst noneDataSource = graphqlApi.addNoneDataSource('NoneDataSource');\n\n// Mutation resolver\nnoneDataSource.createResolver('SendMessageResolver', {\n  typeName: 'Mutation',\n  fieldName: 'sendMessage',\n  requestMappingTemplate: appsync.MappingTemplate.fromString(`\n    {\n      \"version\": \"2017-02-28\",\n      \"payload\": $util.toJson($context.arguments.message)\n    }\n  `),\n  responseMappingTemplate: appsync.MappingTemplate.fromString(\n    '$util.toJson($context.result)'\n  ),\n});\n"})}),"\n",(0,i.jsx)(e.h3,{id:"step-functions-state-machines",children:"Step Functions State Machines"}),"\n",(0,i.jsx)(e.p,{children:"Workflow orchestration for long-running processes:"}),"\n",(0,i.jsx)(e.mermaid,{value:'flowchart TB\n    subgraph CommandSM["Command Handler State Machine"]\n        C1[check_version] --\x3e C2{Version OK?}\n        C2 --\x3e|Yes| C3[set_ttl_command]\n        C2 --\x3e|No| C4[wait_prev_command]\n        C2 --\x3e|Error| CF[Fail]\n        C4 --\x3e C3\n        C3 --\x3e C5[history_copy]\n        C5 --\x3e C6[transform_data]\n        C6 --\x3e C7[sync_data_all<br/>Map State]\n        C7 --\x3e C8[finish]\n        C8 --\x3e CS[Success]\n    end\n\n    subgraph TaskSM["Task Handler State Machine"]\n        T1[Map State<br/>Concurrency: 2]\n        T1 --\x3e T2[iterator]\n        T2 --\x3e T3[Complete]\n    end\n\n    subgraph ImportSM["Import CSV State Machine"]\n        I1[Distributed Map<br/>Concurrency: 50]\n        I1 --\x3e I2[csv_rows_handler]\n        I2 --\x3e I3[Complete]\n    end'}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as sfn from 'aws-cdk-lib/aws-stepfunctions';\nimport * as tasks from 'aws-cdk-lib/aws-stepfunctions-tasks';\n\n// Helper function to create Lambda invoke tasks\nconst createLambdaTask = (\n  stateName: string,\n  integrationPattern: sfn.IntegrationPattern = sfn.IntegrationPattern.REQUEST_RESPONSE\n) => {\n  const payload: Record<string, any> = {\n    'source': 'step-function',\n    'context.$': '$$',\n    'input.$': '$',\n  };\n\n  if (integrationPattern === sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN) {\n    payload['taskToken'] = sfn.JsonPath.taskToken;\n  }\n\n  return new tasks.LambdaInvoke(this, stateName, {\n    lambdaFunction,\n    payload: sfn.TaskInput.fromObject(payload),\n    stateName,\n    outputPath: '$.Payload[0][0]',\n    integrationPattern,\n    retryOnServiceExceptions: true,\n  });\n};\n\n// Define states\nconst fail = new sfn.Fail(this, 'fail', {\n  stateName: 'fail',\n  causePath: '$.cause',\n  errorPath: '$.error',\n});\n\nconst success = new sfn.Succeed(this, 'success', {\n  stateName: 'success',\n});\n\nconst finish = createLambdaTask('finish').next(success);\n\n// Map state for parallel data sync\nconst syncData = createLambdaTask('sync_data');\nconst syncDataAll = new sfn.Map(this, 'sync_data_all', {\n  stateName: 'sync_data_all',\n  maxConcurrency: 0, // Unlimited\n  itemsPath: sfn.JsonPath.stringAt('$'),\n})\n  .itemProcessor(syncData)\n  .next(finish);\n\nconst transformData = createLambdaTask('transform_data').next(syncDataAll);\nconst historyCopy = createLambdaTask('history_copy').next(transformData);\nconst setTtlCommand = createLambdaTask('set_ttl_command').next(historyCopy);\n\n// Callback pattern for async waiting\nconst waitPrevCommand = createLambdaTask(\n  'wait_prev_command',\n  sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN\n).next(setTtlCommand);\n\n// Version check choice\nconst checkVersionResult = new sfn.Choice(this, 'check_version_result')\n  .when(sfn.Condition.numberEquals('$.result', 0), setTtlCommand)\n  .when(sfn.Condition.numberEquals('$.result', 1), waitPrevCommand)\n  .when(sfn.Condition.numberEquals('$.result', -1), fail)\n  .otherwise(waitPrevCommand);\n\nconst checkVersion = createLambdaTask('check_version').next(checkVersionResult);\n\n// Create log group\nconst commandSfnLogGroup = new logs.LogGroup(this, 'CommandSfnLogGroup', {\n  logGroupName: `/aws/vendedlogs/states/${prefix}-command-handler-logs`,\n  removalPolicy: cdk.RemovalPolicy.DESTROY,\n  retention: logs.RetentionDays.SIX_MONTHS,\n});\n\n// Create state machine\nconst commandStateMachine = new sfn.StateMachine(this, 'CommandStateMachine', {\n  stateMachineName: `${prefix}command-handler`,\n  definitionBody: sfn.DefinitionBody.fromChainable(checkVersion),\n  tracingEnabled: true,\n  logs: {\n    destination: commandSfnLogGroup,\n    level: sfn.LogLevel.ALL,\n  },\n});\n"})}),"\n",(0,i.jsx)(e.h3,{id:"dynamodb-event-sources",children:"DynamoDB Event Sources"}),"\n",(0,i.jsx)(e.p,{children:"Configure DynamoDB Streams to trigger Lambda:"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"import * as lambdaEventSources from 'aws-cdk-lib/aws-lambda-event-sources';\n\n// Tables to monitor for changes\nconst tableNames = ['tasks', 'sample-command', 'import_tmp'];\n\nfor (const tableName of tableNames) {\n  // Lookup existing table\n  const tableDesc = new cdk.custom_resources.AwsCustomResource(\n    this,\n    `${tableName}-desc`,\n    {\n      onCreate: {\n        service: 'DynamoDB',\n        action: 'describeTable',\n        parameters: { TableName: `${prefix}${tableName}` },\n        physicalResourceId: cdk.custom_resources.PhysicalResourceId.fromResponse(\n          'Table.TableArn'\n        ),\n      },\n      policy: cdk.custom_resources.AwsCustomResourcePolicy.fromSdkCalls({\n        resources: cdk.custom_resources.AwsCustomResourcePolicy.ANY_RESOURCE,\n      }),\n    }\n  );\n\n  const table = dynamodb.Table.fromTableAttributes(this, `${tableName}-table`, {\n    tableArn: tableDesc.getResponseField('Table.TableArn'),\n    tableStreamArn: tableDesc.getResponseField('Table.LatestStreamArn'),\n  });\n\n  // Add event source with INSERT filter\n  lambdaFunction.addEventSource(\n    new lambdaEventSources.DynamoEventSource(table, {\n      startingPosition: lambda.StartingPosition.TRIM_HORIZON,\n      batchSize: 1,\n      filters: [\n        lambda.FilterCriteria.filter({\n          eventName: lambda.FilterRule.isEqual('INSERT'),\n        }),\n      ],\n    })\n  );\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"environment-configuration",children:"Environment Configuration"}),"\n",(0,i.jsx)(e.p,{children:"The framework supports multiple deployment environments:"}),"\n",(0,i.jsx)(e.h3,{id:"configuration-structure",children:"Configuration Structure"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// config/type.ts\nexport interface Config {\n  env: 'dev' | 'stg' | 'prod';\n  appName: string;\n\n  domain: {\n    http: string;      // e.g., api.example.com\n    appsync: string;   // e.g., graphql.example.com\n  };\n\n  userPoolId?: string;  // Optional: use existing Cognito pool\n\n  vpc: {\n    id: string;\n    subnetIds: string[];\n    securityGroupIds: string[];\n  };\n\n  rds: {\n    accountSsmKey: string;  // SSM parameter for DB credentials\n    endpoint: string;\n    dbName: string;\n  };\n\n  logLevel?: {\n    lambdaSystem?: 'INFO' | 'DEBUG';\n    lambdaApplication?: 'TRACE' | 'DEBUG' | 'INFO' | 'WARN' | 'ERROR';\n    level?: 'verbose' | 'debug' | 'info' | 'warn' | 'error';\n  };\n\n  frontBaseUrl: string;\n  fromEmailAddress: string;\n  wafArn?: string;  // Optional: WAF for CloudFront\n\n  ecs?: {\n    maxInstances: number;\n    minInstances: number;\n    cpu: number;\n    memory: number;\n    cpuThreshold?: number;\n    autoRollback?: boolean;\n  };\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"environment-examples",children:"Environment Examples"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Development:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// config/dev/index.ts\nexport const config: Config = {\n  env: 'dev',\n  appName: 'myapp',\n  logLevel: {\n    lambdaSystem: 'DEBUG',\n    lambdaApplication: 'TRACE',\n    level: 'verbose',\n  },\n  // ... other config\n};\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Production:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// config/prod/index.ts\nexport const config: Config = {\n  env: 'prod',\n  appName: 'myapp',\n  logLevel: {\n    lambdaSystem: 'DEBUG',\n    lambdaApplication: 'INFO',\n    level: 'info',\n  },\n  ecs: {\n    maxInstances: 2,\n    minInstances: 1,\n    cpu: 2048,\n    memory: 4096,\n    cpuThreshold: 70,\n    autoRollback: true,\n  },\n  // ... other config\n};\n"})}),"\n",(0,i.jsx)(e.h2,{id:"iam-permissions",children:"IAM Permissions"}),"\n",(0,i.jsx)(e.p,{children:"The Lambda function is granted the following permissions:"}),"\n",(0,i.jsx)(e.mermaid,{value:"flowchart TB\n    Lambda[Lambda Function]\n\n    subgraph Permissions\n        Cognito[Cognito Admin]\n        S3[S3 Read/Write]\n        SNS[SNS Publish]\n        SQS[SQS Send]\n        DDB[DynamoDB CRUD]\n        SFN[Step Functions Execute]\n        SES[SES Send Email]\n        SSM[SSM/KMS Access]\n        AppSync[AppSync Mutation]\n    end\n\n    Lambda --\x3e Cognito\n    Lambda --\x3e S3\n    Lambda --\x3e SNS\n    Lambda --\x3e SQS\n    Lambda --\x3e DDB\n    Lambda --\x3e SFN\n    Lambda --\x3e SES\n    Lambda --\x3e SSM\n    Lambda --\x3e AppSync"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CDK Implementation:"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-typescript",children:"// Cognito permissions\nlambdaFunction.addToRolePolicy(\n  new iam.PolicyStatement({\n    actions: [\n      'cognito-idp:AdminGetUser',\n      'cognito-idp:AdminCreateUser',\n      'cognito-idp:AdminDeleteUser',\n      'cognito-idp:AdminUpdateUserAttributes',\n      'cognito-idp:AdminSetUserPassword',\n      'cognito-idp:AdminResetUserPassword',\n      'cognito-idp:AdminEnableUser',\n      'cognito-idp:AdminDisableUser',\n      'cognito-idp:AdminAddUserToGroup',\n    ],\n    resources: [userPool.userPoolArn],\n  })\n);\n\n// DynamoDB permissions\nlambdaFunction.addToRolePolicy(\n  new iam.PolicyStatement({\n    actions: [\n      'dynamodb:PutItem',\n      'dynamodb:UpdateItem',\n      'dynamodb:GetItem',\n      'dynamodb:Query',\n    ],\n    resources: [`arn:aws:dynamodb:${region}:${account}:table/${prefix}*`],\n  })\n);\n\n// Step Functions permissions\nlambdaFunction.addToRolePolicy(\n  new iam.PolicyStatement({\n    actions: [\n      'states:StartExecution',\n      'states:GetExecutionHistory',\n      'states:DescribeExecution',\n    ],\n    resources: [commandStateMachine.stateMachineArn],\n  })\n);\n\n// SES permissions\nlambdaFunction.addToRolePolicy(\n  new iam.PolicyStatement({\n    actions: ['ses:SendEmail'],\n    resources: ['*'],\n  })\n);\n\n// Grant S3, SNS, SQS access\nddbBucket.grantReadWrite(lambdaFunction);\npublicBucket.grantReadWrite(lambdaFunction);\nmainSnsTopic.grantPublish(lambdaFunction);\nalarmSnsTopic.grantPublish(lambdaFunction);\ntaskQueue.grantSendMessages(lambdaFunction);\nnotificationQueue.grantSendMessages(lambdaFunction);\n"})}),"\n",(0,i.jsx)(e.h2,{id:"deployment-outputs",children:"Deployment Outputs"}),"\n",(0,i.jsx)(e.p,{children:"After deployment, the following outputs are available:"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"Output"}),(0,i.jsx)(e.th,{children:"Description"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"userPoolId"})}),(0,i.jsx)(e.td,{children:"Cognito User Pool ID"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"userPoolClientId"})}),(0,i.jsx)(e.td,{children:"Cognito App Client ID"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"graphqlApiUrl"})}),(0,i.jsx)(e.td,{children:"AppSync GraphQL endpoint"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"graphqlApiKey"})}),(0,i.jsx)(e.td,{children:"AppSync API key"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"httpApiUrl"})}),(0,i.jsx)(e.td,{children:"HTTP API endpoint"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"httpDistributionDomain"})}),(0,i.jsx)(e.td,{children:"CloudFront custom domain"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"stateMachineArn"})}),(0,i.jsx)(e.td,{children:"Command Handler State Machine ARN"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.code,{children:"sfnTaskStateMachineArn"})}),(0,i.jsx)(e.td,{children:"Task Handler State Machine ARN"})]})]})]}),"\n",(0,i.jsx)(e.h2,{id:"cicd-pipeline",children:"CI/CD Pipeline"}),"\n",(0,i.jsx)(e.p,{children:"The framework includes a CodePipeline for automated deployments:"}),"\n",(0,i.jsx)(e.mermaid,{value:"flowchart LR\n    subgraph Source\n        GitHub[GitHub Repository]\n    end\n\n    subgraph Build\n        Test[Run Tests]\n        Synth[CDK Synth]\n    end\n\n    subgraph Deploy\n        Dev[Dev Environment]\n        Stg[Staging Environment]\n        Prod[Production Environment]\n    end\n\n    GitHub --\x3e|develop branch| Test\n    GitHub --\x3e|staging branch| Test\n    GitHub --\x3e|main branch| Test\n    Test --\x3e Synth\n    Synth --\x3e|develop| Dev\n    Synth --\x3e|staging| Stg\n    Synth --\x3e|main| Prod"}),"\n",(0,i.jsx)(e.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(e.h3,{id:"security",children:"Security"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"VPC Isolation"}),": Deploy Lambda in private subnets"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"Secrets Management"}),": Store credentials in SSM Parameter Store with KMS encryption"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"API Security"}),": Use Cognito for authentication, IAM for internal routes"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"S3 Security"}),": Block all public access, use CloudFront OAI"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"performance",children:"Performance"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"Lambda Optimization"}),": Use ARM64 architecture with optimized layers"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"CloudFront Caching"}),": Cache static assets, disable caching for API"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"Connection Pooling"}),": Use RDS Proxy for database connections"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"monitoring",children:"Monitoring"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"CloudWatch Logs"}),": JSON formatted logs with structured data"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"X-Ray Tracing"}),": Enable distributed tracing for debugging"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"CloudWatch Alarms"}),": Set up alerts for failures and latency"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"/docs/architecture/step-functions",children:"Step Functions"})," - Workflow orchestration details"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"/docs/architecture/system-overview",children:"System Overview"})," - High-level architecture"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.a,{href:"/docs/installation",children:"Installation"})," - Getting started guide"]}),"\n"]})]})}function u(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>r,x:()=>o});var a=t(6540);const i={},s=a.createContext(i);function r(n){const e=a.useContext(s);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),a.createElement(s.Provider,{value:e},n.children)}}}]);